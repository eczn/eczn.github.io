<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<title>柏林噪声的原理和实现 | Eczn's Home</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,minimal-ui">
<meta name="format-detection" content="telephone=no">

<style id="CSS_VARS"></style>
<script>
(function() {
console.log('INIT CSS VAR');
function loadCSSVars() {
    const j = localStorage.getItem("CSS_VARS_2" /* STORAGE_KEY.CSS_VARS */);
    const initialVars = initialCSSVars();
    if (!j)
        return initialVars;
    try {
        const result = {
            ...initialVars,
            ...JSON.parse(j)
        };
        console.log('loadCSSVars from storage', result);
        return result;
    }
    catch (error) {
        console.error('load css vars with error', error);
        return initialVars;
    }
}
function renderCSSVars(vars, style) {
    const allDefine = Object.keys(vars).map(k => {
        const v = vars[k];
        const cssValue = typeof v === 'number' ? `${v}px` : v;
        return `--${k}:${cssValue};`;
    }).join('\n');
    if (style) {
        style.innerHTML = `:root { ${allDefine} }`;
    }
    else {
        console.error(`style#CSS_VARS NotFound !`);
    }
}
function initialCSSVars() {
    let rem = 16;
    // 移动端
    if (typeof window !== 'undefined' && window.innerWidth <= 500) {
        rem = Number(((window.innerWidth - 20) / 42).toFixed(1));
        console.log('mobile calculated rem =>', rem);
    }
    return {
        rem,
        enableSmallerFont: false,
        displayToc: 'block',
        fontSmcp: 'source serif pro, serif',
        fontCode: 'consolas, Menlo, monospace',
        fontTitle: 'Noto Serif SC, serif',
        fontArticle: 'source serif pro, LXGW WenKai',
        fontSansSerif: 'sans-serif',
    };
}
window.__initialCSSVars = loadCSSVars();
renderCSSVars(__initialCSSVars, document.querySelector('#CSS_VARS'));
})();
</script>

<link rel="icon" href="/favicon.png"><script defer="defer" src="/js/index.adf98f3e.js"></script><script defer="defer" src="/js/chunk-lib.cbf60312.js"></script><link href="/css/index.791c12afdb2cecbd8bba.css" rel="stylesheet"><link href="/css/chunk-lib.5c7d4887bb8714b00c54.css" rel="stylesheet"></head>
<body x-apple-data-detectors="none">
<noscript>当前浏览器不支持 JavaScript, 建议使用支持 JavaScript 的浏览器来访问此网站 !</noscript>
<div id="rally-bg" style="opacity:0"></div>
<div id="app"><div class="ball-canvas-container"></div><nav class="nav-main --fontSmcp"><div class="_title default-max-width">Eczn&#x27;s Home</div><div class="smcphr"></div><div class="_links default-max-width"><a class="r-link _link clickable r-link" href="/">Home</a><a class="r-link _link clickable r-link" href="/tl/0/">Timeline</a><a class="r-link _link clickable r-link" href="/cate/all/">Category</a><a class="r-link _link clickable r-link" href="/setting/">Setting</a><a class="r-link _link clickable r-link" href="/launchpad/">Launchpad</a></div></nav><div class="std-box rally-page-content default-max-width"><div id="blog-box" class="std-box-content "><div id="start" class="blog-header-main"><div class="_infos"><div class="_info"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="clock" class="svg-inline--fa fa-clock fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256,8C119,8,8,119,8,256S119,504,256,504,504,393,504,256,393,8,256,8Zm92.49,313h0l-20,25a16,16,0,0,1-22.49,2.5h0l-67-49.72a40,40,0,0,1-15-31.23V112a16,16,0,0,1,16-16h32a16,16,0,0,1,16,16V256l58,42.5A16,16,0,0,1,348.49,321Z"></path></svg>2024-12-02</div></div><div class="_title --fontTitle">柏林噪声的原理和实现</div></div><article class="r-article-wrapper"><div class="toc-wrapper"><div class="toc"><div class="toc-item _active" style="padding-left:0em"><a href="#map-demo" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>地图生成器 demo</a></div><div class="toc-item" style="padding-left:0em"><a href="#problem-of-white-noise" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>白噪声的问题</a></div><div class="toc-item" style="padding-left:0em"><a href="#priciple-of-perlin-noise" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>柏林噪声的原理</a></div><div class="toc-item" style="padding-left:0em"><a href="#priciple-of-perlin-noise" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>柏林噪声的 2D 推广</a></div><div class="toc-item" style="padding-left:1em"><a href="#取整的推广：晶格" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>取整的推广：晶格</a></div><div class="toc-item" style="padding-left:1em"><a href="#伪随机数的推广：伪随机向量-(梯度)" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>伪随机数的推广：伪随机向量 (梯度)</a></div><div class="toc-item" style="padding-left:1em"><a href="#晶格顶点的噪声标量" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>晶格顶点的噪声标量</a></div><div class="toc-item" style="padding-left:1em"><a href="#线性插值" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>线性插值</a></div><div class="toc-item" style="padding-left:1em"><a href="#归一化处理" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>归一化处理</a></div><div class="toc-item" style="padding-left:1em"><a href="#完整实现" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>完整实现</a></div><div class="toc-item" style="padding-left:1em"><a href="#效果" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>效果</a></div><div class="toc-item" style="padding-left:0em"><a href="#reference" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>参考</a></div><div class="_index --fontSmcp" data-minimap="Ignore">Indexes</div><div class="smcphr"></div></div></div><div class="r-article"><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这是一篇去年 12 月写完的文章，不过一直感觉对二维推广里的梯度的数学理解不够透彻就忘发了，这两天想查点资料又找到了这篇发现还没发 ... 算了还是先发吧</div><h1 id="map-demo" class="std-title --fontTitle"><a href="#map-demo" class="markdownIt-Anchor">#</a> 地图生成器 demo<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">写这篇的原因是有看一些地图生成算法，里面是利用柏林噪声来实现的，比如将其输出看成是海拔，然后将不同海拔划分为不同地形，据此可以画出下面的地图: </div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><canvas style="width:40em;height:30em"></canvas><div style="display:block;margin-top:.5em;padding-left:1em"><div style="font-size:1.5em;margin-bottom:0.5em;font-weight:1000;font-family:var(--fontTitle)">意西泽恩大陆</div><div style="line-height:1.75em;display:inline-block;margin-right:1em"><div style="width:1.5em;height:1.5em;display:inline-block;border:1px solid  #000;background:rgba(248,248,252,255);vertical-align:middle;margin-right:.5em"></div><span style="display:inline-block;vertical-align:middle">山峰</span></div><div style="line-height:1.75em;display:inline-block;margin-right:1em"><div style="width:1.5em;height:1.5em;display:inline-block;border:1px solid  #000;background:rgba(58,213,77,255);vertical-align:middle;margin-right:.5em"></div><span style="display:inline-block;vertical-align:middle">森林</span></div><div style="line-height:1.75em;display:inline-block;margin-right:1em"><div style="width:1.5em;height:1.5em;display:inline-block;border:1px solid  #000;background:rgba(251,223,144,255);vertical-align:middle;margin-right:.5em"></div><span style="display:inline-block;vertical-align:middle">陆地</span></div><div style="line-height:1.75em;display:inline-block;margin-right:1em"><div style="width:1.5em;height:1.5em;display:inline-block;border:1px solid  #000;background:rgba(64,84,235,255);vertical-align:middle;margin-right:.5em"></div><span style="display:inline-block;vertical-align:middle">湖泊</span></div></div></div><h1 id="problem-of-white-noise" class="std-title --fontTitle"><a href="#problem-of-white-noise" class="markdownIt-Anchor">#</a> 白噪声的问题<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">下面左图是一张典型的白噪声渲染效果，可以看到其相当离散，没有一点规律</div><div class="col-main" style="display:flex;text-align:center;margin-bottom:16px"><div style="width:47.6%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-img-dynamic-wrapper --fontArticle" style="margin:0 auto"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:100.00%"><img class="std-img-dymanic-main r-link __mosaic __loading" src="/tsxs-esm/white-noise-example.7d2e24b975498eb9.png.mosaic.png"/><img class="std-img-dymanic-main" src="/tsxs-esm/white-noise-example.7d2e24b975498eb9.png"/></div></div></div><div style="width:4.7%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"></div><div style="width:47.6%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-img-dynamic-wrapper --fontArticle" style="margin:0 auto"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:100.00%"><img class="std-img-dymanic-main r-link __mosaic __loading" src="/tsxs-esm/perlin-noise-example.3a91291cd1cfe6d2.png.mosaic.png"/><img class="std-img-dymanic-main" src="/tsxs-esm/perlin-noise-example.3a91291cd1cfe6d2.png"/></div></div></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">但是在实际开发中有时需要有一定规律的随机噪声，如 Minecraft 的地图生成，这类场景就不能使用白噪声了，需要单独一种更平滑的噪声了，一般来说行业内通常使用柏林噪声来实现这种带有一定平滑规律的噪声来生成地形，上面右图就是柏林噪声算法生成的效果图，可以感受下跟白噪声的不同。</div><h1 id="priciple-of-perlin-noise" class="std-title --fontTitle"><a href="#priciple-of-perlin-noise" class="markdownIt-Anchor">#</a> 柏林噪声的原理<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><div class="std-inline-code" data-minimap-color="#f5e9e9">柏林噪声 (Perlin Noise)</div> 是由 <div class="std-inline-code" data-minimap-color="#f5e9e9">肯·柏林 (Ken Perlin)</div> 发明的自然噪声生成算法，算法的名字也是作者自己的名字，这个算法很有意思，此处以 x 轴上的点作为参数计算出一维柏林噪声作为 y 轴绘制一个二维坐标系来介绍柏林噪声的原理，具体即下图所示这般，其中的 P0、P、P1 三个点的柏林噪声分别是 r0、N、r1：</div><div class="std-img-dynamic-wrapper --fontArticle"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:49.56%"><div class="std-img-dymanic-main __texttip __loading">loading...</div><img class="std-img-dymanic-main" src="/tsxs-esm/perlin-imageLinearInterpolation.98b59f7fbf7c1b33.svg"/></div></div><ol class="numbering-main" data-minimap-color="#DDDDDD"><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">1.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">P 向下取整得到 P0、向上取整得到 P1。P0 到 P1的距离为 <div class="std-inline-code" data-minimap-color="#f5e9e9">单位距离</div>, 通常取 1</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">2.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">然后将 P0 和 P1 分别当作种子去生成两个伪随机数, 将这两个伪随机数记为 <div class="std-inline-code" data-minimap-color="#f5e9e9">r0</div> 和 <div class="std-inline-code" data-minimap-color="#f5e9e9">r1</div></div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">3.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">随着 P 点移动到 P1 点，对应的 N 即其柏林噪声会均匀从 r0 过渡到 r1</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">4.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">根据上一步的说明, N 的位置可以这样求得：P 点在 <div class="std-inline-code" data-minimap-color="#f5e9e9">线段 P0P1</div> 上的位置百分比是 40%, 从 r0 到 r1 之间划一条线段，在其 40% 的位置就是 P 点对应的柏林噪声了，这个值为 <div class="std-inline-code" data-minimap-color="#f5e9e9">r0 + 40% * (r1 - r0)</div>, 这种处理方式称为线性插值</div></li></ol><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">关于上面提到的伪随机，柏林它使用了一个哈希数组来实现的：</div><div class="std-code"><pre  class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">// hashes.tsx</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token comment">// 这个数组里随机放置了从 0 到 255 共计 256 个整数</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token keyword">const</span> hashes <span class="token operator">=</span> <span class="token punctuation">[</span>
<span class="line-numbers-rows" style="user-select: none;">03</span>  <span class="token number">151</span><span class="token punctuation">,</span><span class="token number">160</span><span class="token punctuation">,</span><span class="token number">137</span><span class="token punctuation">,</span><span class="token number">91</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">131</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">201</span><span class="token punctuation">,</span><span class="token number">95</span><span class="token punctuation">,</span><span class="token number">96</span><span class="token punctuation">,</span><span class="token number">53</span><span class="token punctuation">,</span><span class="token number">194</span><span class="token punctuation">,</span><span class="token number">233</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">04</span>  <span class="token number">225</span><span class="token punctuation">,</span><span class="token number">140</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">,</span><span class="token number">103</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">69</span><span class="token punctuation">,</span><span class="token number">142</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token number">37</span><span class="token punctuation">,</span><span class="token number">240</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">190</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">05</span>  <span class="token number">148</span><span class="token punctuation">,</span><span class="token number">247</span><span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token number">234</span><span class="token punctuation">,</span><span class="token number">75</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">197</span><span class="token punctuation">,</span><span class="token number">62</span><span class="token punctuation">,</span><span class="token number">94</span><span class="token punctuation">,</span><span class="token number">252</span><span class="token punctuation">,</span><span class="token number">219</span><span class="token punctuation">,</span><span class="token number">203</span><span class="token punctuation">,</span><span class="token number">117</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">06</span>  <span class="token number">35</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">57</span><span class="token punctuation">,</span><span class="token number">177</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">,</span><span class="token number">237</span><span class="token punctuation">,</span><span class="token number">149</span><span class="token punctuation">,</span><span class="token number">56</span><span class="token punctuation">,</span><span class="token number">87</span><span class="token punctuation">,</span><span class="token number">174</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">125</span><span class="token punctuation">,</span><span class="token number">136</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">07</span>  <span class="token number">171</span><span class="token punctuation">,</span><span class="token number">168</span><span class="token punctuation">,</span><span class="token number">68</span><span class="token punctuation">,</span><span class="token number">175</span><span class="token punctuation">,</span><span class="token number">74</span><span class="token punctuation">,</span><span class="token number">165</span><span class="token punctuation">,</span><span class="token number">71</span><span class="token punctuation">,</span><span class="token number">134</span><span class="token punctuation">,</span><span class="token number">139</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">166</span><span class="token punctuation">,</span><span class="token number">77</span><span class="token punctuation">,</span><span class="token number">146</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">08</span>  <span class="token number">158</span><span class="token punctuation">,</span><span class="token number">231</span><span class="token punctuation">,</span><span class="token number">83</span><span class="token punctuation">,</span><span class="token number">111</span><span class="token punctuation">,</span><span class="token number">229</span><span class="token punctuation">,</span><span class="token number">122</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">211</span><span class="token punctuation">,</span><span class="token number">133</span><span class="token punctuation">,</span><span class="token number">230</span><span class="token punctuation">,</span><span class="token number">220</span><span class="token punctuation">,</span><span class="token number">105</span><span class="token punctuation">,</span><span class="token number">92</span><span class="token punctuation">,</span><span class="token number">41</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">09</span>  <span class="token number">55</span><span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">245</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">244</span><span class="token punctuation">,</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token number">143</span><span class="token punctuation">,</span><span class="token number">54</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">63</span><span class="token punctuation">,</span><span class="token number">161</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">216</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">10</span>  <span class="token number">73</span><span class="token punctuation">,</span><span class="token number">209</span><span class="token punctuation">,</span><span class="token number">76</span><span class="token punctuation">,</span><span class="token number">132</span><span class="token punctuation">,</span><span class="token number">187</span><span class="token punctuation">,</span><span class="token number">208</span><span class="token punctuation">,</span><span class="token number">89</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">169</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">196</span><span class="token punctuation">,</span><span class="token number">135</span><span class="token punctuation">,</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">116</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">11</span>  <span class="token number">188</span><span class="token punctuation">,</span><span class="token number">159</span><span class="token punctuation">,</span><span class="token number">86</span><span class="token punctuation">,</span><span class="token number">164</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">198</span><span class="token punctuation">,</span><span class="token number">173</span><span class="token punctuation">,</span><span class="token number">186</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">52</span><span class="token punctuation">,</span><span class="token number">217</span><span class="token punctuation">,</span><span class="token number">226</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">12</span>  <span class="token number">250</span><span class="token punctuation">,</span><span class="token number">124</span><span class="token punctuation">,</span><span class="token number">123</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">202</span><span class="token punctuation">,</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token number">147</span><span class="token punctuation">,</span><span class="token number">118</span><span class="token punctuation">,</span><span class="token number">126</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">82</span><span class="token punctuation">,</span><span class="token number">85</span><span class="token punctuation">,</span><span class="token number">212</span><span class="token punctuation">,</span><span class="token number">207</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">13</span>  <span class="token number">206</span><span class="token punctuation">,</span><span class="token number">59</span><span class="token punctuation">,</span><span class="token number">227</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">58</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">182</span><span class="token punctuation">,</span><span class="token number">189</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">223</span><span class="token punctuation">,</span><span class="token number">183</span><span class="token punctuation">,</span><span class="token number">170</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">14</span>  <span class="token number">213</span><span class="token punctuation">,</span><span class="token number">119</span><span class="token punctuation">,</span><span class="token number">248</span><span class="token punctuation">,</span><span class="token number">152</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">154</span><span class="token punctuation">,</span><span class="token number">163</span><span class="token punctuation">,</span><span class="token number">70</span><span class="token punctuation">,</span><span class="token number">221</span><span class="token punctuation">,</span><span class="token number">153</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">155</span><span class="token punctuation">,</span><span class="token number">167</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">15</span>  <span class="token number">43</span><span class="token punctuation">,</span><span class="token number">172</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">129</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token number">253</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">98</span><span class="token punctuation">,</span><span class="token number">108</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token number">79</span><span class="token punctuation">,</span><span class="token number">113</span><span class="token punctuation">,</span><span class="token number">224</span><span class="token punctuation">,</span><span class="token number">232</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">16</span>  <span class="token number">178</span><span class="token punctuation">,</span><span class="token number">185</span><span class="token punctuation">,</span><span class="token number">112</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token punctuation">,</span><span class="token number">218</span><span class="token punctuation">,</span><span class="token number">246</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">228</span><span class="token punctuation">,</span><span class="token number">251</span><span class="token punctuation">,</span><span class="token number">34</span><span class="token punctuation">,</span><span class="token number">242</span><span class="token punctuation">,</span><span class="token number">193</span><span class="token punctuation">,</span><span class="token number">238</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">17</span>  <span class="token number">210</span><span class="token punctuation">,</span><span class="token number">144</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">191</span><span class="token punctuation">,</span><span class="token number">179</span><span class="token punctuation">,</span><span class="token number">162</span><span class="token punctuation">,</span><span class="token number">241</span><span class="token punctuation">,</span><span class="token number">81</span><span class="token punctuation">,</span><span class="token number">51</span><span class="token punctuation">,</span><span class="token number">145</span><span class="token punctuation">,</span><span class="token number">235</span><span class="token punctuation">,</span><span class="token number">249</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">239</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">18</span>  <span class="token number">107</span><span class="token punctuation">,</span><span class="token number">49</span><span class="token punctuation">,</span><span class="token number">192</span><span class="token punctuation">,</span><span class="token number">214</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">181</span><span class="token punctuation">,</span><span class="token number">199</span><span class="token punctuation">,</span><span class="token number">106</span><span class="token punctuation">,</span><span class="token number">157</span><span class="token punctuation">,</span><span class="token number">184</span><span class="token punctuation">,</span><span class="token number">84</span><span class="token punctuation">,</span><span class="token number">204</span><span class="token punctuation">,</span><span class="token number">176</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">19</span>  <span class="token number">115</span><span class="token punctuation">,</span><span class="token number">121</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">127</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">254</span><span class="token punctuation">,</span><span class="token number">138</span><span class="token punctuation">,</span><span class="token number">236</span><span class="token punctuation">,</span><span class="token number">205</span><span class="token punctuation">,</span><span class="token number">93</span><span class="token punctuation">,</span><span class="token number">222</span><span class="token punctuation">,</span><span class="token number">114</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">20</span>  <span class="token number">67</span><span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">243</span><span class="token punctuation">,</span><span class="token number">141</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">195</span><span class="token punctuation">,</span><span class="token number">78</span><span class="token punctuation">,</span><span class="token number">66</span><span class="token punctuation">,</span><span class="token number">215</span><span class="token punctuation">,</span><span class="token number">61</span><span class="token punctuation">,</span><span class="token number">156</span><span class="token punctuation">,</span><span class="token number">180</span>
<span class="line-numbers-rows" style="user-select: none;">21</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">22</span>
<span class="line-numbers-rows" style="user-select: none;">23</span><span class="token comment">/**
<span class="line-numbers-rows" style="user-select: none;">24</span> * 将任意整数n塞到hashes[n % 256]中来得到一个0-255的随机数
<span class="line-numbers-rows" style="user-select: none;">25</span> */</span>
<span class="line-numbers-rows" style="user-select: none;">26</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">rand</span><span class="token punctuation">(</span>n<span class="token operator">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">27</span>  <span class="token keyword">return</span> hashes<span class="token punctuation">[</span>n <span class="token operator">%</span> hashes<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">28</span><span class="token punctuation">}</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">总结一下前面的结论：首先取整得到两个点并求出两个随机数，最后根据 P 的相对位置对随机数做线性插值就得到柏林噪声了，下面实现了一维柏林噪声第一版 <div class="std-inline-code" data-minimap-color="#f5e9e9">perlin1d_v1</div></div><div class="std-code"><pre  class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">// perlin1d_v1.tsx</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token keyword">import</span> <span class="token punctuation">{</span> rand <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./hashes'</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token comment">// 第一版</span>
<span class="line-numbers-rows" style="user-select: none;">04</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">perlin1d_v1</span><span class="token punctuation">(</span>x<span class="token operator">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">05</span>  <span class="token comment">// 向下/向上取整</span>
<span class="line-numbers-rows" style="user-select: none;">06</span>  <span class="token keyword">const</span> x0 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">07</span>  <span class="token keyword">const</span> x1 <span class="token operator">=</span> x0 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">08</span>
<span class="line-numbers-rows" style="user-select: none;">09</span>  <span class="token comment">// 通过这种方式来实现伪随机</span>
<span class="line-numbers-rows" style="user-select: none;">10</span>  <span class="token keyword">const</span> r0 <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span>x0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">11</span>  <span class="token keyword">const</span> r1 <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span>x1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">12</span>
<span class="line-numbers-rows" style="user-select: none;">13</span>  <span class="token comment">// 拿到相对位置</span>
<span class="line-numbers-rows" style="user-select: none;">14</span>  <span class="token keyword">const</span> dx <span class="token operator">=</span> x <span class="token operator">-</span> x0<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">15</span>
<span class="line-numbers-rows" style="user-select: none;">16</span>  <span class="token comment">// 拿到相对位置占的百分比,</span>
<span class="line-numbers-rows" style="user-select: none;">17</span>  <span class="token comment">// 因为取整是 1 因此除 1 就行, 可省略提升性能</span>
<span class="line-numbers-rows" style="user-select: none;">18</span>  <span class="token keyword">const</span> rate <span class="token operator">=</span> dx <span class="token operator">/</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">19</span>
<span class="line-numbers-rows" style="user-select: none;">20</span>  <span class="token comment">// 最后拿到 rate 给 r0 r1 做线性插值</span>
<span class="line-numbers-rows" style="user-select: none;">21</span>  <span class="token keyword">const</span> noise <span class="token operator">=</span> r0 <span class="token operator">+</span> rate <span class="token operator">*</span> <span class="token punctuation">(</span>r1 <span class="token operator">-</span> r0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">22</span>
<span class="line-numbers-rows" style="user-select: none;">23</span>  <span class="token comment">// r0 和 r1 是 0-255 的数, 我们需要返回 0-1 的范围</span>
<span class="line-numbers-rows" style="user-select: none;">24</span>  <span class="token keyword">return</span> noise <span class="token operator">/</span> <span class="token number">255</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">25</span><span class="token punctuation">}</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">注意, perlin1d_v1(x: number) 中 x 一定是要一个连续的实数算法才有意义，如果 x 都是整数那么它本质上跟从 <div class="std-inline-code" data-minimap-color="#f5e9e9">hashes</div> 取随机数一样没有区别, 也就是说如果想拿 canvas 绘制一维柏林噪声曲线那么需要注意将坐标除以 <div class="std-inline-code" data-minimap-color="#f5e9e9">单位数值 n</div> 来将整数坐标系变成带小数的浮点数。</div><div class="col-main" style="display:flex;margin-bottom:16px"><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-para --fontArticle para-center" data-minimap-color="#CCCCCC"><canvas style="width:16em;height:16em"></canvas><div style="display:block">白噪声</div></div></div><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-para --fontArticle para-center" data-minimap-color="#CCCCCC"><canvas style="width:16em;height:16em"></canvas><div style="display:block">柏林噪声 n=1<br/>(注意: 跟左边白噪声一模一样了)</div></div></div></div><div class="col-main" style="display:flex;margin-bottom:16px"><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-para --fontArticle para-center" data-minimap-color="#CCCCCC"><canvas style="width:16em;height:16em"></canvas><div style="display:block">柏林噪声 n=8</div></div></div><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-para --fontArticle para-center" data-minimap-color="#CCCCCC"><canvas style="width:16em;height:16em"></canvas><div style="display:block">柏林噪声 n=32</div></div></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">当 n 变大时，我们可以看到折线转角变少了，而且线也没那么 <div class="std-inline-code" data-minimap-color="#f5e9e9">离散</div> 了，但是折线转角处依然非常陡峭，不够平滑规整，是哪里有问题么？此时需要再次审视 <div class="std-inline-code" data-minimap-color="#f5e9e9">线性插值</div>，如下图所示，随着 x 增加，N 也会从 r0 均匀变大到 r1, 对应的柏林噪声输出也会 <div class="std-inline-code" data-minimap-color="#f5e9e9">均匀线性变大</div>:</div><div class="std-img-dynamic-wrapper --fontArticle"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:49.56%"><div class="std-img-dymanic-main __texttip __loading">loading...</div><img class="std-img-dymanic-main" src="/tsxs-esm/perlin-imageLinearInterpolation.98b59f7fbf7c1b33.svg"/></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">当 P 跨过 P1 的时候，对应的线性插值由于端点变化就会造成突变，从而最终绘制的时候都是不光滑的折角了，即折线连接处不连续</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">若是我们能让这个 <div class="std-inline-code" data-minimap-color="#f5e9e9">折线</div> 变成曲线，那么就能实现噪声的平滑处理了 —— 如下红线所示这样得到的 <div class="std-inline-code" data-minimap-color="#f5e9e9">N&#x27;</div> 就形成了一条光滑的曲线，不再是折角了。</div><div class="std-img-dynamic-wrapper --fontArticle"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:49.56%"><div class="std-img-dymanic-main __texttip __loading">loading...</div><img class="std-img-dymanic-main" src="/tsxs-esm/perlin-imageLinearInterpolationBlending.52f70471d74f517a.svg"/></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">明白了关键还是线性插值后，就知道怎么改了，可以简单按 <div class="std-formula-wrapper" style="display:inline-block"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></div> 作为平滑函数来处理线性插值，得到第 2 版实现 <div class="std-inline-code" data-minimap-color="#f5e9e9">perlin1d_v2</div> 以及绘制效果:</div><div class="std-code"><pre  class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">// perlin1d_v2.tsx</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token keyword">import</span> <span class="token punctuation">{</span> rand <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./hashes'</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token comment">// 第二版</span>
<span class="line-numbers-rows" style="user-select: none;">04</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">perlin1d_v2</span><span class="token punctuation">(</span>x<span class="token operator">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">05</span>  <span class="token comment">// 向下/向上取整</span>
<span class="line-numbers-rows" style="user-select: none;">06</span>  <span class="token keyword">const</span> x0 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">07</span>  <span class="token keyword">const</span> x1 <span class="token operator">=</span> x0 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">08</span>
<span class="line-numbers-rows" style="user-select: none;">09</span>  <span class="token comment">// 通过这种方式来实现伪随机</span>
<span class="line-numbers-rows" style="user-select: none;">10</span>  <span class="token keyword">const</span> r0 <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span>x0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">11</span>  <span class="token keyword">const</span> r1 <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span>x1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">12</span>
<span class="line-numbers-rows" style="user-select: none;">13</span>  <span class="token comment">// 拿到相对位置</span>
<span class="line-numbers-rows" style="user-select: none;">14</span>  <span class="token keyword">const</span> dx <span class="token operator">=</span> x <span class="token operator">-</span> x0<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">15</span>
<span class="line-numbers-rows" style="user-select: none;">16</span>  <span class="token comment">// 拿到相对位置占的百分比,</span>
<span class="line-numbers-rows" style="user-select: none;">17</span>  <span class="token comment">// 因为取整是 1 因此除 1 就行, 可省略提升性能</span>
<span class="line-numbers-rows" style="user-select: none;">18</span>  <span class="token keyword">let</span> rate <span class="token operator">=</span> <span class="token punctuation">(</span>dx <span class="token operator">/</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">19</span>
<span class="line-numbers-rows" style="user-select: none;">20</span>  <span class="token comment">// 对 rate 做平滑处理</span>
<span class="line-numbers-rows" style="user-select: none;">21</span>  rate <span class="token operator">=</span> <span class="token function">blending</span><span class="token punctuation">(</span>rate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">22</span>  
<span class="line-numbers-rows" style="user-select: none;">23</span>  <span class="token comment">// 最后拿到 rate 给 r0 r1 做线性插值</span>
<span class="line-numbers-rows" style="user-select: none;">24</span>  <span class="token keyword">const</span> noise <span class="token operator">=</span> r0 <span class="token operator">+</span> rate <span class="token operator">*</span> <span class="token punctuation">(</span>r1 <span class="token operator">-</span> r0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">25</span>  
<span class="line-numbers-rows" style="user-select: none;">26</span>  <span class="token comment">// r0 和 r1 是 0-255 的数, 我们需要返回 0-1 的范围</span>
<span class="line-numbers-rows" style="user-select: none;">27</span>  <span class="token keyword">return</span> noise <span class="token operator">/</span> <span class="token number">255</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">28</span><span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">29</span>
<span class="line-numbers-rows" style="user-select: none;">30</span><span class="token comment">// 由于 rate 的范围是0到1</span>
<span class="line-numbers-rows" style="user-select: none;">31</span><span class="token comment">// 这样乘会让他变得更小，使得绘制更平滑不突变</span>
<span class="line-numbers-rows" style="user-select: none;">32</span><span class="token keyword">function</span> <span class="token function">blending</span><span class="token punctuation">(</span>rate<span class="token operator">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">33</span>  <span class="token keyword">return</span> rate <span class="token operator">*</span> rate<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">34</span><span class="token punctuation">}</span></pre></div><div class="col-main" style="display:flex;margin-bottom:16px"><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-para --fontArticle para-center" data-minimap-color="#CCCCCC"><canvas style="width:16em;height:16em"></canvas><div style="display:block">f(x)=x, n=8</div></div></div><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-para --fontArticle para-center" data-minimap-color="#CCCCCC"><canvas style="width:16em;height:16em"></canvas><div style="display:block">f(x)=x, n=32</div></div></div></div><div class="col-main" style="display:flex;margin-bottom:16px"><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-para --fontArticle para-center" data-minimap-color="#CCCCCC"><canvas style="width:16em;height:16em"></canvas><div style="display:block">f(x)=x^2, n=8</div></div></div><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-para --fontArticle para-center" data-minimap-color="#CCCCCC"><canvas style="width:16em;height:16em"></canvas><div style="display:block">f(x)=x^2, n=32</div></div></div></div><div class="col-main" style="display:flex;margin-bottom:16px"><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-para --fontArticle para-center" data-minimap-color="#CCCCCC"><canvas style="width:16em;height:16em"></canvas><div style="display:block">f(x)=6x^5-15x^4+10x^3, n=8</div></div></div><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-para --fontArticle para-center" data-minimap-color="#CCCCCC"><canvas style="width:16em;height:16em"></canvas><div style="display:block">f(x)=6x^5-15x^4+10x^3, n=32</div></div></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">效果越来越好，值得注意的是 <div class="std-inline-code" data-minimap-color="#f5e9e9">6x^5-15x^4+10x^3</div> 是柏林提出的，这个效果非常好，这个函数的曲线如下图所示，可以看到类似贝塞尔曲线，它的一阶导数和二阶导数在 x=0 和 x=1 的地方都为 0，这使得其看起来非常光滑（一般来说函数越高次就越光滑）</div><div class="std-img-dynamic-wrapper --fontArticle"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:66.67%"><div class="std-img-dymanic-main __texttip __loading">loading...</div><img class="std-img-dymanic-main" src="/tsxs-esm/desmos-fade.a6b255f132733235.svg"/></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">至此，我们已经算是掌握了柏林噪声的基本原理和过程了，关键是分割整数区间然后取端点对应的随机数，再根据 <div class="std-inline-code" data-minimap-color="#f5e9e9">比例</div> 来做线性插值得到噪声数值，而具体的插值函数是任意的，建议使用柏林提出来的那个 <div class="std-inline-code" data-minimap-color="#f5e9e9">f(x)=6x^5-15x^4+10x^3</div>, 效果非常好。</div><h1 id="priciple-of-perlin-noise" class="std-title --fontTitle"><a href="#priciple-of-perlin-noise" class="markdownIt-Anchor">#</a> 柏林噪声的 2D 推广<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">前面讨论了一维的柏林噪声处理，这里将其从一维数轴推广到二维平面上</div><h2 id="取整的推广：晶格" class="std-title --fontTitle">取整的推广：晶格</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">对于某个点 <div class="std-inline-code" data-minimap-color="#f5e9e9">O(x, y)</div> 的两个坐标分量做向上/向下取整，可以得到一个正方形格子，这个格子称为 <div class="std-inline-code" data-minimap-color="#f5e9e9">晶格 (grid)</div>, 如下图所示, O 点在 P1,P2,P3,P4 所围成的晶格之中：</div><div class="std-img-dynamic-wrapper --fontArticle"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:74.72%"><div class="std-img-dymanic-main __texttip __loading">loading...</div><img class="std-img-dymanic-main" src="/tsxs-esm/perlin-imagePerlinGrid.89ebcaed7fb38bd6.svg"/></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">后续的计算都围绕着这个晶格进行。</div><h2 id="伪随机数的推广：伪随机向量-(梯度)" class="std-title --fontTitle">伪随机数的推广：伪随机向量 (梯度)</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">在前面一维场景中，我们需要将数轴上的点通过 <div class="std-inline-code" data-minimap-color="#f5e9e9">hashes[n % 256]</div> 的方式来生成一个随机数，类比到二维场景，则需要根据 x 和 y 来生成一个伪随机向量，下面的 <div class="std-inline-code" data-minimap-color="#f5e9e9">randVecs</div> 实现了这个功能：</div><div class="std-code"><pre  class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">// hashes-vec.tsx</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token keyword">import</span> <span class="token punctuation">{</span> rand <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./hashes'</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token comment">/** 表示一个向量 */</span>
<span class="line-numbers-rows" style="user-select: none;">04</span><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Vec</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">05</span>  x<span class="token operator">:</span> number<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">06</span>  y<span class="token operator">:</span> number<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">07</span><span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">08</span>
<span class="line-numbers-rows" style="user-select: none;">09</span><span class="token comment">/** 一个向量组 */</span>
<span class="line-numbers-rows" style="user-select: none;">10</span><span class="token keyword">const</span> vecs<span class="token operator">:</span> Vec<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
<span class="line-numbers-rows" style="user-select: none;">11</span>  <span class="token punctuation">{</span> x<span class="token operator">:</span>  <span class="token number">1</span><span class="token punctuation">,</span> y<span class="token operator">:</span>  <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">12</span>  <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> y<span class="token operator">:</span>  <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">13</span>  <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">14</span>  <span class="token punctuation">{</span> x<span class="token operator">:</span>  <span class="token number">1</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">15</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">16</span>
<span class="line-numbers-rows" style="user-select: none;">17</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">randVecs</span><span class="token punctuation">(</span>vec<span class="token operator">:</span> Vec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">18</span>  <span class="token comment">// 将 x 和 y 坐标输入到 rand 生成一个合成的随机数</span>
<span class="line-numbers-rows" style="user-select: none;">19</span>  <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token function">rand</span><span class="token punctuation">(</span>vec<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> vec<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">20</span>  <span class="token comment">// 因为 r 是随机的，因此可以这样随机从 vecs 中选择一个向量</span>
<span class="line-numbers-rows" style="user-select: none;">21</span>  <span class="token keyword">return</span> vecs<span class="token punctuation">[</span>r <span class="token operator">%</span> vecs<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">22</span><span class="token punctuation">}</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">获取你会注意到其中的 <div class="std-inline-code" data-minimap-color="#f5e9e9">向量组 vecs</div>, 它内部其实可以放其他的变量来改变噪声效果，这里选的这四个是为了后面方便处理（后面会提到）</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">因此在二维平面的柏林噪声处理中，晶格的每个顶点都会伪随机到一个向量上，因此会生成四条向量（蓝色箭头）：</div><div class="std-img-dynamic-wrapper --fontArticle"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:74.72%"><div class="std-img-dymanic-main __texttip __loading">loading...</div><img class="std-img-dymanic-main" src="/tsxs-esm/perlin-imagePerlinRandVecs.69acd58741bb0e17.svg"/></div></div><h2 id="晶格顶点的噪声标量" class="std-title --fontTitle">晶格顶点的噪声标量</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">在一维场景的讨论中我们知道线性插值需要知道两个端点和「比例」才能插值，根据这个规则我们可以实现线性插值的函数：</div><div class="std-code"><pre  class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">// lerp.tsx</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token comment">// 线性插值</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">lerp</span><span class="token punctuation">(</span>t<span class="token operator">:</span> number<span class="token punctuation">,</span> v1<span class="token operator">:</span> number<span class="token punctuation">,</span> v2<span class="token operator">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">03</span>  <span class="token keyword">return</span> v1 <span class="token operator">+</span> t <span class="token operator">*</span> <span class="token punctuation">(</span>v2 <span class="token operator">-</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">04</span><span class="token punctuation">}</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">O 点在晶格内的相对位置可以由其到其中一个晶格顶点的向量表示，即下图中深绿色的向量，其他三个都可以由这个深绿色向量唯一确定：</div><div class="std-img-dynamic-wrapper --fontArticle"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:74.72%"><div class="std-img-dymanic-main __texttip __loading">loading...</div><img class="std-img-dymanic-main" src="/tsxs-esm/perlin-imagePerlin2DRate.98fe04d1ff9167af.svg"/></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">可是，线性插值要求的是标量，向量不能作为 <div class="std-inline-code" data-minimap-color="#f5e9e9">lerp</div> 的参数进行调用，要怎么办呢？—— 既要考虑到相对位置的模的大小对标量的影响，又要考虑随机向量的影响，因此将晶格顶点的伪随机向量投影到 <div class="std-inline-code" data-minimap-color="#f5e9e9">相对位置</div> 上相乘得到一个标量作为表征这个晶格顶点的噪声标量：</div><div class="std-img-dynamic-wrapper --fontArticle"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:74.72%"><div class="std-img-dymanic-main __texttip __loading">loading...</div><img class="std-img-dymanic-main" src="/tsxs-esm/perlin-imagePerlinLerp1.1db1bba37ac2fb94.svg"/></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">实际上，上面这样投影计算标量的方式其实就是向量的点乘运算：</div><div class="std-code"><pre  class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">// vec-dot.tsx</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token keyword">import</span> <span class="token punctuation">{</span> Vec <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./hashes-vec'</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">vecDot</span><span class="token punctuation">(</span>v1<span class="token operator">:</span> Vec<span class="token punctuation">,</span> v2<span class="token operator">:</span> Vec<span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">04</span>  <span class="token keyword">return</span> v1<span class="token punctuation">.</span>x <span class="token operator">*</span> v2<span class="token punctuation">.</span>x <span class="token operator">+</span> v1<span class="token punctuation">.</span>y <span class="token operator">*</span> v2<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">05</span><span class="token punctuation">}</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">到此为止，我们可以求出四个晶格顶点的噪声标量，最后一步就是将这四个噪声标量进行线性插值了。</div><h2 id="线性插值" class="std-title --fontTitle">线性插值</h2><ol class="numbering-main" data-minimap-color="#DDDDDD"><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">1.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">拿 P1 P2 的噪声标量做一次插值得到 V1，权重取 O 点在水平方向上的相对位置</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">2.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">拿 P3 P4 的噪声标量做一次插值得到 V2，权重取 O 点在水平方向上的相对位置</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">3.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">将 V1 V2 再做一次插值，权重取 O 点在垂直方向上的相对位置，最后的插值结果即为这个点的二维柏林噪声值了</div></li></ol><h2 id="归一化处理" class="std-title --fontTitle">归一化处理</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">归一化指的是将输出限定在 [-1,1] 或者 [0,1] 的区间内，方便外部调用使用，而上述的二维柏林噪声的取值范围由四个晶格代表的噪声标量来确定，那么它们插值的结果能落在 0 到 1 吗？</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">我们特意选择的四个向量在归一化处理这里就发挥作用了，用符号 <div class="std-formula-wrapper" style="display:inline-block"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span></div> 表示:</div><div class="std-formula-wrapper" style="display:block"><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.6263em;vertical-align:-0.5632em;"></span><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0632em;"><span style="top:-3.0968em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">A</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.0966em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5632em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0632em;"><span style="top:-3.0968em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen">{(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mclose">)}</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5632em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0632em;"><span style="top:-3.0632em;"><span class="pstrut" style="height:2.9663em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5632em;"><span></span></span></span></span></span></span></span></span></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">由于这四个向量不是 <div class="std-formula-wrapper" style="display:inline-block"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">+</span><span class="mord">1</span></span></span></span></div> 就是 <div class="std-formula-wrapper" style="display:inline-block"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mord">1</span></span></span></span></div>, 因此对于任意向量 (x, y) 计算点乘有:</div><div class="std-formula-wrapper" style="display:block"><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.5em;vertical-align:-0.5em;"></span><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1em;"><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1em;"><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">±</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">±</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1em;"><span style="top:-3em;"><span class="pstrut" style="height:2.84em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5em;"><span></span></span></span></span></span></span></span></span></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">我们特意选择的四个向量在归一化处理这里就发挥作用了，上图中有几个已知的等价关系</div><div class="std-formula-wrapper" style="display:block"><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:9.2527em;vertical-align:-4.3763em;"></span><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.8763em;"><span style="top:-7.0363em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span><span style="top:-5.5363em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord">1</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span></span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-0.7837em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span></span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span><span style="top:0.7163em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.3763em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.8763em;"><span style="top:-7.0363em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">x</span><span class="mord">0</span></span></span><span style="top:-5.5363em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">0</span></span></span><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">x</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">0</span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span><span style="top:-0.7837em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">0</span><span class="mclose">)</span></span></span><span style="top:0.7163em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.3763em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.8763em;"><span style="top:-7.0027em;"><span class="pstrut" style="height:2.9663em;"></span><span class="eqn-num"></span></span><span style="top:-5.5027em;"><span class="pstrut" style="height:2.9663em;"></span><span class="eqn-num"></span></span><span style="top:-3.8763em;"><span class="pstrut" style="height:2.9663em;"></span><span class="eqn-num"></span></span><span style="top:-2.3763em;"><span class="pstrut" style="height:2.9663em;"></span><span class="eqn-num"></span></span><span style="top:-0.75em;"><span class="pstrut" style="height:2.9663em;"></span><span class="eqn-num"></span></span><span style="top:0.75em;"><span class="pstrut" style="height:2.9663em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.3763em;"><span></span></span></span></span></span></span></span></span></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">由此计算点积得到 P1 和 P2 对应的噪声标量 V1 和 V2</div><div class="std-formula-wrapper" style="display:block"><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.75em;"><span class="pstrut" style="height:2.84em;"></span><span class="eqn-num"></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:2.84em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span></span></span></span></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">展开可以得到:</div><div class="std-formula-wrapper" style="display:block"><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">±</span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">±</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">±</span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">±</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.75em;"><span class="pstrut" style="height:2.84em;"></span><span class="eqn-num"></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:2.84em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span></span></span></span></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">最后要将 V1 和 V2 通过下面的 lerp 做一次线性插值得到最终结果:</div><div class="std-formula-wrapper" style="display:block"><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord cjk_fallback">最终结果</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord">2</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.75em;"><span class="pstrut" style="height:2.84em;"></span><span class="eqn-num"></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:2.84em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span></span></span></span></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">那么最终结果的取值范围是多少呢？显然，取值范围就是 lerp 的 <div class="std-inline-code" data-minimap-color="#f5e9e9">[a, b]</div>, 即 <div class="std-inline-code" data-minimap-color="#f5e9e9">[V1, V2]</div></div><h2 id="完整实现" class="std-title --fontTitle">完整实现</h2><div class="std-code"><pre  class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">// perlin2d_v1.tsx</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token keyword">import</span> <span class="token punctuation">{</span> lerp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lerp'</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token keyword">import</span> <span class="token punctuation">{</span> vecDot <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./vec-dot'</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token keyword">import</span> <span class="token punctuation">{</span> Vec<span class="token punctuation">,</span> randVecs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./hashes-vec'</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">04</span>
<span class="line-numbers-rows" style="user-select: none;">05</span><span class="token comment">// 2d 第一版</span>
<span class="line-numbers-rows" style="user-select: none;">06</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">perlin2d_v1</span><span class="token punctuation">(</span>x<span class="token operator">:</span> number<span class="token punctuation">,</span> y<span class="token operator">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">07</span>  <span class="token comment">// 对 x y 取整拿到晶格顶点的坐标</span>
<span class="line-numbers-rows" style="user-select: none;">08</span>  <span class="token keyword">const</span> x0 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">09</span>  <span class="token keyword">const</span> x1 <span class="token operator">=</span> x0 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">10</span>  <span class="token keyword">const</span> y0 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">11</span>  <span class="token keyword">const</span> y1 <span class="token operator">=</span> y0 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">12</span>
<span class="line-numbers-rows" style="user-select: none;">13</span>  <span class="token comment">// 四个晶格顶点的坐标</span>
<span class="line-numbers-rows" style="user-select: none;">14</span>  <span class="token keyword">const</span> <span class="token constant">P1</span><span class="token operator">:</span> Vec <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> x0<span class="token punctuation">,</span> y<span class="token operator">:</span> y0 <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">15</span>  <span class="token keyword">const</span> <span class="token constant">P2</span><span class="token operator">:</span> Vec <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> x1<span class="token punctuation">,</span> y<span class="token operator">:</span> y0 <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">16</span>  <span class="token keyword">const</span> <span class="token constant">P3</span><span class="token operator">:</span> Vec <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> x0<span class="token punctuation">,</span> y<span class="token operator">:</span> y1 <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">17</span>  <span class="token keyword">const</span> <span class="token constant">P4</span><span class="token operator">:</span> Vec <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> x1<span class="token punctuation">,</span> y<span class="token operator">:</span> y1 <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">18</span>
<span class="line-numbers-rows" style="user-select: none;">19</span>  <span class="token comment">// 四个晶格顶点对应的伪随机向量</span>
<span class="line-numbers-rows" style="user-select: none;">20</span>  <span class="token keyword">const</span> vec_P1 <span class="token operator">=</span> <span class="token function">randVecs</span><span class="token punctuation">(</span><span class="token constant">P1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">21</span>  <span class="token keyword">const</span> vec_P2 <span class="token operator">=</span> <span class="token function">randVecs</span><span class="token punctuation">(</span><span class="token constant">P2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">22</span>  <span class="token keyword">const</span> vec_P3 <span class="token operator">=</span> <span class="token function">randVecs</span><span class="token punctuation">(</span><span class="token constant">P3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">23</span>  <span class="token keyword">const</span> vec_P4 <span class="token operator">=</span> <span class="token function">randVecs</span><span class="token punctuation">(</span><span class="token constant">P4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">24</span>
<span class="line-numbers-rows" style="user-select: none;">25</span>  <span class="token comment">// 计算四个晶格的随机向量和相对位置的点积</span>
<span class="line-numbers-rows" style="user-select: none;">26</span>  <span class="token keyword">const</span> value_P1 <span class="token operator">=</span> <span class="token function">vecDot</span><span class="token punctuation">(</span>vec_P1<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> x <span class="token operator">-</span> x0<span class="token punctuation">,</span> y<span class="token operator">:</span> y <span class="token operator">-</span> y0 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">27</span>  <span class="token keyword">const</span> value_P2 <span class="token operator">=</span> <span class="token function">vecDot</span><span class="token punctuation">(</span>vec_P2<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> x <span class="token operator">-</span> x1<span class="token punctuation">,</span> y<span class="token operator">:</span> y <span class="token operator">-</span> y0 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">28</span>  <span class="token keyword">const</span> value_P3 <span class="token operator">=</span> <span class="token function">vecDot</span><span class="token punctuation">(</span>vec_P3<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> x <span class="token operator">-</span> x0<span class="token punctuation">,</span> y<span class="token operator">:</span> y <span class="token operator">-</span> y1 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">29</span>  <span class="token keyword">const</span> value_P4 <span class="token operator">=</span> <span class="token function">vecDot</span><span class="token punctuation">(</span>vec_P4<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> x <span class="token operator">-</span> x1<span class="token punctuation">,</span> y<span class="token operator">:</span> y <span class="token operator">-</span> y1 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">30</span>
<span class="line-numbers-rows" style="user-select: none;">31</span>  <span class="token comment">// O 点在 x, y 方向上的相对位置</span>
<span class="line-numbers-rows" style="user-select: none;">32</span>  <span class="token keyword">const</span> dx <span class="token operator">=</span> x <span class="token operator">-</span> x0<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">33</span>  <span class="token keyword">const</span> dy <span class="token operator">=</span> y <span class="token operator">-</span> y0<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">34</span>  <span class="token keyword">const</span> rateX <span class="token operator">=</span> <span class="token function">blending</span><span class="token punctuation">(</span>dx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">35</span>  <span class="token keyword">const</span> rateY <span class="token operator">=</span> <span class="token function">blending</span><span class="token punctuation">(</span>dy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">36</span>
<span class="line-numbers-rows" style="user-select: none;">37</span>  <span class="token keyword">const</span> noise <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>
<span class="line-numbers-rows" style="user-select: none;">38</span>    rateY<span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">39</span>    <span class="token function">lerp</span><span class="token punctuation">(</span>rateX<span class="token punctuation">,</span> value_P1<span class="token punctuation">,</span> value_P2<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">40</span>    <span class="token function">lerp</span><span class="token punctuation">(</span>rateX<span class="token punctuation">,</span> value_P3<span class="token punctuation">,</span> value_P4<span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">41</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">42</span>
<span class="line-numbers-rows" style="user-select: none;">43</span>  <span class="token comment">// 最后归一化处理, noise 的范围是 [-1, 1] 这里需要调整为 [0, 1]</span>
<span class="line-numbers-rows" style="user-select: none;">44</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>noise <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">45</span><span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">46</span>
<span class="line-numbers-rows" style="user-select: none;">47</span><span class="token comment">// 6t^5 -15t^4 + 10t^3</span>
<span class="line-numbers-rows" style="user-select: none;">48</span><span class="token keyword">function</span> <span class="token function">blending</span><span class="token punctuation">(</span>t<span class="token operator">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">49</span>  <span class="token keyword">return</span> t<span class="token operator">*</span><span class="token punctuation">(</span>t<span class="token operator">*</span><span class="token punctuation">(</span>t<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">+</span>t<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">15</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">*</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">50</span><span class="token punctuation">}</span></pre></div><h2 id="效果" class="std-title --fontTitle">效果</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">拿上面实现的 <div class="std-inline-code" data-minimap-color="#f5e9e9">perlin2d_v1</div> 来画一下：</div><div class="col-main" style="display:flex;margin-bottom:16px"><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-para --fontArticle para-center" data-minimap-color="#CCCCCC"><canvas style="width:16em;height:16em"></canvas><div style="display:block">n = 16</div></div></div><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-para --fontArticle para-center" data-minimap-color="#CCCCCC"><canvas style="width:16em;height:16em"></canvas><div style="display:block">n = 32</div></div></div></div><div class="col-main" style="display:flex;margin-bottom:16px"><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-para --fontArticle para-center" data-minimap-color="#CCCCCC"><canvas style="width:16em;height:16em"></canvas><div style="display:block">n = 64</div></div></div><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-para --fontArticle para-center" data-minimap-color="#CCCCCC"><canvas style="width:16em;height:16em"></canvas><div style="display:block">n = 128</div></div></div></div><h1 id="reference" class="std-title --fontTitle"><a href="#reference" class="markdownIt-Anchor">#</a> 参考<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><a href="https://zh.m.wikipedia.org/wiki/Perlin%E5%99%AA%E5%A3%B0" target="_blank" style="background-color:#dfece7" class="std-link --fontSansSerif  _block" data-minimap-color="#dfece7"><span class="std-link-icon r-link" data-src="/get-favicon/zh.m.wikipedia.org?h=1617267483" style="background-image:url(&quot;/get-favicon/zh.m.wikipedia.org?h=1617267483&quot;)"></span><span class="std-link-txt">Wiki - Perlin Noise</span></a></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><a href="https://www.bilibili.com/video/BV11V4y1M7N6" target="_blank" style="background-color:#eee1dd" class="std-link --fontSansSerif  _block" data-minimap-color="#eee1dd"><span class="std-link-icon r-link" data-src="/get-favicon/www.bilibili.com?h=-452185442" style="background-image:url(&quot;/get-favicon/www.bilibili.com?h=-452185442&quot;)"></span><span class="std-link-txt">Minecraft地形生成与柏林噪声 (一) 详解噪声</span></a></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><a href="https://juejin.cn/post/7148448472205639687" target="_blank" style="background-color:#efebde" class="std-link --fontSansSerif  _block" data-minimap-color="#efebde"><span class="std-link-icon r-link" data-src="/get-favicon/juejin.cn?h=991134630" style="background-image:url(&quot;/get-favicon/juejin.cn?h=991134630&quot;)"></span><span class="std-link-txt">图形学的数学基础（四十四）：柏林噪声</span></a></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><a href="https://rtouti.github.io/graphics/perlin-noise-algorithm" target="_blank" style="background-color:#e4dde6" class="std-link --fontSansSerif  _block" data-minimap-color="#e4dde6"><span class="std-link-icon r-link" data-src="/get-favicon/rtouti.github.io?h=13914214215" style="background-image:url(&quot;/get-favicon/rtouti.github.io?h=13914214215&quot;)"></span><span class="std-link-txt">Perlin Noise: A Procedural Generation Algorithm</span></a></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"></div></div></article></div></div><div class="smcphr rally-page-smcphr"></div><div class="std-box rally-giscus-wrapper default-max-width"><div class="std-box-content "></div></div></div>
<script>window.__INITIAL_STATE__ = {"CategoryApiState":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"BlogApiState":{"loaded":true,"loading":false,"error":null,"dataMap":{"perlin-noise":{"type":"tsx","meta":{"id":"perlin-noise","title":"柏林噪声的原理和实现","author":"eczn","time":"2024-12-02T04:03:00.000Z","type":"article","appTitle":"","appIcon":"","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},"tsxDistPath":"./noise-perlin/index.blog.js","ssrContent":"<div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">这是一篇去年 12 月写完的文章，不过一直感觉对二维推广里的梯度的数学理解不够透彻就忘发了，这两天想查点资料又找到了这篇发现还没发 ... 算了还是先发吧</div><h1 id=\"map-demo\" class=\"std-title --fontTitle\"><a href=\"#map-demo\" class=\"markdownIt-Anchor\">#</a> 地图生成器 demo<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">写这篇的原因是有看一些地图生成算法，里面是利用柏林噪声来实现的，比如将其输出看成是海拔，然后将不同海拔划分为不同地形，据此可以画出下面的地图: </div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><canvas style=\"width:40em;height:30em\"></canvas><div style=\"display:block;margin-top:.5em;padding-left:1em\"><div style=\"font-size:1.5em;margin-bottom:0.5em;font-weight:1000;font-family:var(--fontTitle)\">意西泽恩大陆</div><div style=\"line-height:1.75em;display:inline-block;margin-right:1em\"><div style=\"width:1.5em;height:1.5em;display:inline-block;border:1px solid  #000;background:rgba(248,248,252,255);vertical-align:middle;margin-right:.5em\"></div><span style=\"display:inline-block;vertical-align:middle\">山峰</span></div><div style=\"line-height:1.75em;display:inline-block;margin-right:1em\"><div style=\"width:1.5em;height:1.5em;display:inline-block;border:1px solid  #000;background:rgba(58,213,77,255);vertical-align:middle;margin-right:.5em\"></div><span style=\"display:inline-block;vertical-align:middle\">森林</span></div><div style=\"line-height:1.75em;display:inline-block;margin-right:1em\"><div style=\"width:1.5em;height:1.5em;display:inline-block;border:1px solid  #000;background:rgba(251,223,144,255);vertical-align:middle;margin-right:.5em\"></div><span style=\"display:inline-block;vertical-align:middle\">陆地</span></div><div style=\"line-height:1.75em;display:inline-block;margin-right:1em\"><div style=\"width:1.5em;height:1.5em;display:inline-block;border:1px solid  #000;background:rgba(64,84,235,255);vertical-align:middle;margin-right:.5em\"></div><span style=\"display:inline-block;vertical-align:middle\">湖泊</span></div></div></div><h1 id=\"problem-of-white-noise\" class=\"std-title --fontTitle\"><a href=\"#problem-of-white-noise\" class=\"markdownIt-Anchor\">#</a> 白噪声的问题<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">下面左图是一张典型的白噪声渲染效果，可以看到其相当离散，没有一点规律</div><div class=\"col-main\" style=\"display:flex;text-align:center;margin-bottom:16px\"><div style=\"width:47.6%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-img-dynamic-wrapper --fontArticle\" style=\"margin:0 auto\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:100.00%\"><img class=\"std-img-dymanic-main r-link __mosaic __loading\" src=\"/tsxs-esm/white-noise-example.7d2e24b975498eb9.png.mosaic.png\"/><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/white-noise-example.7d2e24b975498eb9.png\"/></div></div></div><div style=\"width:4.7%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"></div><div style=\"width:47.6%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-img-dynamic-wrapper --fontArticle\" style=\"margin:0 auto\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:100.00%\"><img class=\"std-img-dymanic-main r-link __mosaic __loading\" src=\"/tsxs-esm/perlin-noise-example.3a91291cd1cfe6d2.png.mosaic.png\"/><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/perlin-noise-example.3a91291cd1cfe6d2.png\"/></div></div></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">但是在实际开发中有时需要有一定规律的随机噪声，如 Minecraft 的地图生成，这类场景就不能使用白噪声了，需要单独一种更平滑的噪声了，一般来说行业内通常使用柏林噪声来实现这种带有一定平滑规律的噪声来生成地形，上面右图就是柏林噪声算法生成的效果图，可以感受下跟白噪声的不同。</div><h1 id=\"priciple-of-perlin-noise\" class=\"std-title --fontTitle\"><a href=\"#priciple-of-perlin-noise\" class=\"markdownIt-Anchor\">#</a> 柏林噪声的原理<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">柏林噪声 (Perlin Noise)</div> 是由 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">肯·柏林 (Ken Perlin)</div> 发明的自然噪声生成算法，算法的名字也是作者自己的名字，这个算法很有意思，此处以 x 轴上的点作为参数计算出一维柏林噪声作为 y 轴绘制一个二维坐标系来介绍柏林噪声的原理，具体即下图所示这般，其中的 P0、P、P1 三个点的柏林噪声分别是 r0、N、r1：</div><div class=\"std-img-dynamic-wrapper --fontArticle\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:49.56%\"><div class=\"std-img-dymanic-main __texttip __loading\">loading...</div><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/perlin-imageLinearInterpolation.98b59f7fbf7c1b33.svg\"/></div></div><ol class=\"numbering-main\" data-minimap-color=\"#DDDDDD\"><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">1.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">P 向下取整得到 P0、向上取整得到 P1。P0 到 P1的距离为 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">单位距离</div>, 通常取 1</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">2.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">然后将 P0 和 P1 分别当作种子去生成两个伪随机数, 将这两个伪随机数记为 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">r0</div> 和 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">r1</div></div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">3.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">随着 P 点移动到 P1 点，对应的 N 即其柏林噪声会均匀从 r0 过渡到 r1</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">4.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">根据上一步的说明, N 的位置可以这样求得：P 点在 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">线段 P0P1</div> 上的位置百分比是 40%, 从 r0 到 r1 之间划一条线段，在其 40% 的位置就是 P 点对应的柏林噪声了，这个值为 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">r0 + 40% * (r1 - r0)</div>, 这种处理方式称为线性插值</div></li></ol><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">关于上面提到的伪随机，柏林它使用了一个哈希数组来实现的：</div><div class=\"std-code\"><pre  class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">// hashes.tsx</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token comment\">// 这个数组里随机放置了从 0 到 255 共计 256 个整数</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token keyword\">const</span> hashes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span>  <span class=\"token number\">151</span><span class=\"token punctuation\">,</span><span class=\"token number\">160</span><span class=\"token punctuation\">,</span><span class=\"token number\">137</span><span class=\"token punctuation\">,</span><span class=\"token number\">91</span><span class=\"token punctuation\">,</span><span class=\"token number\">90</span><span class=\"token punctuation\">,</span><span class=\"token number\">15</span><span class=\"token punctuation\">,</span><span class=\"token number\">131</span><span class=\"token punctuation\">,</span><span class=\"token number\">13</span><span class=\"token punctuation\">,</span><span class=\"token number\">201</span><span class=\"token punctuation\">,</span><span class=\"token number\">95</span><span class=\"token punctuation\">,</span><span class=\"token number\">96</span><span class=\"token punctuation\">,</span><span class=\"token number\">53</span><span class=\"token punctuation\">,</span><span class=\"token number\">194</span><span class=\"token punctuation\">,</span><span class=\"token number\">233</span><span class=\"token punctuation\">,</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span>  <span class=\"token number\">225</span><span class=\"token punctuation\">,</span><span class=\"token number\">140</span><span class=\"token punctuation\">,</span><span class=\"token number\">36</span><span class=\"token punctuation\">,</span><span class=\"token number\">103</span><span class=\"token punctuation\">,</span><span class=\"token number\">30</span><span class=\"token punctuation\">,</span><span class=\"token number\">69</span><span class=\"token punctuation\">,</span><span class=\"token number\">142</span><span class=\"token punctuation\">,</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token number\">99</span><span class=\"token punctuation\">,</span><span class=\"token number\">37</span><span class=\"token punctuation\">,</span><span class=\"token number\">240</span><span class=\"token punctuation\">,</span><span class=\"token number\">21</span><span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span><span class=\"token number\">23</span><span class=\"token punctuation\">,</span><span class=\"token number\">190</span><span class=\"token punctuation\">,</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span>  <span class=\"token number\">148</span><span class=\"token punctuation\">,</span><span class=\"token number\">247</span><span class=\"token punctuation\">,</span><span class=\"token number\">120</span><span class=\"token punctuation\">,</span><span class=\"token number\">234</span><span class=\"token punctuation\">,</span><span class=\"token number\">75</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">26</span><span class=\"token punctuation\">,</span><span class=\"token number\">197</span><span class=\"token punctuation\">,</span><span class=\"token number\">62</span><span class=\"token punctuation\">,</span><span class=\"token number\">94</span><span class=\"token punctuation\">,</span><span class=\"token number\">252</span><span class=\"token punctuation\">,</span><span class=\"token number\">219</span><span class=\"token punctuation\">,</span><span class=\"token number\">203</span><span class=\"token punctuation\">,</span><span class=\"token number\">117</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span>  <span class=\"token number\">35</span><span class=\"token punctuation\">,</span><span class=\"token number\">11</span><span class=\"token punctuation\">,</span><span class=\"token number\">32</span><span class=\"token punctuation\">,</span><span class=\"token number\">57</span><span class=\"token punctuation\">,</span><span class=\"token number\">177</span><span class=\"token punctuation\">,</span><span class=\"token number\">33</span><span class=\"token punctuation\">,</span><span class=\"token number\">88</span><span class=\"token punctuation\">,</span><span class=\"token number\">237</span><span class=\"token punctuation\">,</span><span class=\"token number\">149</span><span class=\"token punctuation\">,</span><span class=\"token number\">56</span><span class=\"token punctuation\">,</span><span class=\"token number\">87</span><span class=\"token punctuation\">,</span><span class=\"token number\">174</span><span class=\"token punctuation\">,</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span><span class=\"token number\">125</span><span class=\"token punctuation\">,</span><span class=\"token number\">136</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span>  <span class=\"token number\">171</span><span class=\"token punctuation\">,</span><span class=\"token number\">168</span><span class=\"token punctuation\">,</span><span class=\"token number\">68</span><span class=\"token punctuation\">,</span><span class=\"token number\">175</span><span class=\"token punctuation\">,</span><span class=\"token number\">74</span><span class=\"token punctuation\">,</span><span class=\"token number\">165</span><span class=\"token punctuation\">,</span><span class=\"token number\">71</span><span class=\"token punctuation\">,</span><span class=\"token number\">134</span><span class=\"token punctuation\">,</span><span class=\"token number\">139</span><span class=\"token punctuation\">,</span><span class=\"token number\">48</span><span class=\"token punctuation\">,</span><span class=\"token number\">27</span><span class=\"token punctuation\">,</span><span class=\"token number\">166</span><span class=\"token punctuation\">,</span><span class=\"token number\">77</span><span class=\"token punctuation\">,</span><span class=\"token number\">146</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span>  <span class=\"token number\">158</span><span class=\"token punctuation\">,</span><span class=\"token number\">231</span><span class=\"token punctuation\">,</span><span class=\"token number\">83</span><span class=\"token punctuation\">,</span><span class=\"token number\">111</span><span class=\"token punctuation\">,</span><span class=\"token number\">229</span><span class=\"token punctuation\">,</span><span class=\"token number\">122</span><span class=\"token punctuation\">,</span><span class=\"token number\">60</span><span class=\"token punctuation\">,</span><span class=\"token number\">211</span><span class=\"token punctuation\">,</span><span class=\"token number\">133</span><span class=\"token punctuation\">,</span><span class=\"token number\">230</span><span class=\"token punctuation\">,</span><span class=\"token number\">220</span><span class=\"token punctuation\">,</span><span class=\"token number\">105</span><span class=\"token punctuation\">,</span><span class=\"token number\">92</span><span class=\"token punctuation\">,</span><span class=\"token number\">41</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span>  <span class=\"token number\">55</span><span class=\"token punctuation\">,</span><span class=\"token number\">46</span><span class=\"token punctuation\">,</span><span class=\"token number\">245</span><span class=\"token punctuation\">,</span><span class=\"token number\">40</span><span class=\"token punctuation\">,</span><span class=\"token number\">244</span><span class=\"token punctuation\">,</span><span class=\"token number\">102</span><span class=\"token punctuation\">,</span><span class=\"token number\">143</span><span class=\"token punctuation\">,</span><span class=\"token number\">54</span><span class=\"token punctuation\">,</span><span class=\"token number\">65</span><span class=\"token punctuation\">,</span><span class=\"token number\">25</span><span class=\"token punctuation\">,</span><span class=\"token number\">63</span><span class=\"token punctuation\">,</span><span class=\"token number\">161</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">216</span><span class=\"token punctuation\">,</span><span class=\"token number\">80</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">10</span>  <span class=\"token number\">73</span><span class=\"token punctuation\">,</span><span class=\"token number\">209</span><span class=\"token punctuation\">,</span><span class=\"token number\">76</span><span class=\"token punctuation\">,</span><span class=\"token number\">132</span><span class=\"token punctuation\">,</span><span class=\"token number\">187</span><span class=\"token punctuation\">,</span><span class=\"token number\">208</span><span class=\"token punctuation\">,</span><span class=\"token number\">89</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span><span class=\"token number\">169</span><span class=\"token punctuation\">,</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span><span class=\"token number\">196</span><span class=\"token punctuation\">,</span><span class=\"token number\">135</span><span class=\"token punctuation\">,</span><span class=\"token number\">130</span><span class=\"token punctuation\">,</span><span class=\"token number\">116</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">11</span>  <span class=\"token number\">188</span><span class=\"token punctuation\">,</span><span class=\"token number\">159</span><span class=\"token punctuation\">,</span><span class=\"token number\">86</span><span class=\"token punctuation\">,</span><span class=\"token number\">164</span><span class=\"token punctuation\">,</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span><span class=\"token number\">109</span><span class=\"token punctuation\">,</span><span class=\"token number\">198</span><span class=\"token punctuation\">,</span><span class=\"token number\">173</span><span class=\"token punctuation\">,</span><span class=\"token number\">186</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span><span class=\"token number\">52</span><span class=\"token punctuation\">,</span><span class=\"token number\">217</span><span class=\"token punctuation\">,</span><span class=\"token number\">226</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">12</span>  <span class=\"token number\">250</span><span class=\"token punctuation\">,</span><span class=\"token number\">124</span><span class=\"token punctuation\">,</span><span class=\"token number\">123</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span><span class=\"token number\">202</span><span class=\"token punctuation\">,</span><span class=\"token number\">38</span><span class=\"token punctuation\">,</span><span class=\"token number\">147</span><span class=\"token punctuation\">,</span><span class=\"token number\">118</span><span class=\"token punctuation\">,</span><span class=\"token number\">126</span><span class=\"token punctuation\">,</span><span class=\"token number\">255</span><span class=\"token punctuation\">,</span><span class=\"token number\">82</span><span class=\"token punctuation\">,</span><span class=\"token number\">85</span><span class=\"token punctuation\">,</span><span class=\"token number\">212</span><span class=\"token punctuation\">,</span><span class=\"token number\">207</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">13</span>  <span class=\"token number\">206</span><span class=\"token punctuation\">,</span><span class=\"token number\">59</span><span class=\"token punctuation\">,</span><span class=\"token number\">227</span><span class=\"token punctuation\">,</span><span class=\"token number\">47</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span><span class=\"token number\">58</span><span class=\"token punctuation\">,</span><span class=\"token number\">17</span><span class=\"token punctuation\">,</span><span class=\"token number\">182</span><span class=\"token punctuation\">,</span><span class=\"token number\">189</span><span class=\"token punctuation\">,</span><span class=\"token number\">28</span><span class=\"token punctuation\">,</span><span class=\"token number\">42</span><span class=\"token punctuation\">,</span><span class=\"token number\">223</span><span class=\"token punctuation\">,</span><span class=\"token number\">183</span><span class=\"token punctuation\">,</span><span class=\"token number\">170</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">14</span>  <span class=\"token number\">213</span><span class=\"token punctuation\">,</span><span class=\"token number\">119</span><span class=\"token punctuation\">,</span><span class=\"token number\">248</span><span class=\"token punctuation\">,</span><span class=\"token number\">152</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">44</span><span class=\"token punctuation\">,</span><span class=\"token number\">154</span><span class=\"token punctuation\">,</span><span class=\"token number\">163</span><span class=\"token punctuation\">,</span><span class=\"token number\">70</span><span class=\"token punctuation\">,</span><span class=\"token number\">221</span><span class=\"token punctuation\">,</span><span class=\"token number\">153</span><span class=\"token punctuation\">,</span><span class=\"token number\">101</span><span class=\"token punctuation\">,</span><span class=\"token number\">155</span><span class=\"token punctuation\">,</span><span class=\"token number\">167</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">15</span>  <span class=\"token number\">43</span><span class=\"token punctuation\">,</span><span class=\"token number\">172</span><span class=\"token punctuation\">,</span><span class=\"token number\">9</span><span class=\"token punctuation\">,</span><span class=\"token number\">129</span><span class=\"token punctuation\">,</span><span class=\"token number\">22</span><span class=\"token punctuation\">,</span><span class=\"token number\">39</span><span class=\"token punctuation\">,</span><span class=\"token number\">253</span><span class=\"token punctuation\">,</span><span class=\"token number\">19</span><span class=\"token punctuation\">,</span><span class=\"token number\">98</span><span class=\"token punctuation\">,</span><span class=\"token number\">108</span><span class=\"token punctuation\">,</span><span class=\"token number\">110</span><span class=\"token punctuation\">,</span><span class=\"token number\">79</span><span class=\"token punctuation\">,</span><span class=\"token number\">113</span><span class=\"token punctuation\">,</span><span class=\"token number\">224</span><span class=\"token punctuation\">,</span><span class=\"token number\">232</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">16</span>  <span class=\"token number\">178</span><span class=\"token punctuation\">,</span><span class=\"token number\">185</span><span class=\"token punctuation\">,</span><span class=\"token number\">112</span><span class=\"token punctuation\">,</span><span class=\"token number\">104</span><span class=\"token punctuation\">,</span><span class=\"token number\">218</span><span class=\"token punctuation\">,</span><span class=\"token number\">246</span><span class=\"token punctuation\">,</span><span class=\"token number\">97</span><span class=\"token punctuation\">,</span><span class=\"token number\">228</span><span class=\"token punctuation\">,</span><span class=\"token number\">251</span><span class=\"token punctuation\">,</span><span class=\"token number\">34</span><span class=\"token punctuation\">,</span><span class=\"token number\">242</span><span class=\"token punctuation\">,</span><span class=\"token number\">193</span><span class=\"token punctuation\">,</span><span class=\"token number\">238</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">17</span>  <span class=\"token number\">210</span><span class=\"token punctuation\">,</span><span class=\"token number\">144</span><span class=\"token punctuation\">,</span><span class=\"token number\">12</span><span class=\"token punctuation\">,</span><span class=\"token number\">191</span><span class=\"token punctuation\">,</span><span class=\"token number\">179</span><span class=\"token punctuation\">,</span><span class=\"token number\">162</span><span class=\"token punctuation\">,</span><span class=\"token number\">241</span><span class=\"token punctuation\">,</span><span class=\"token number\">81</span><span class=\"token punctuation\">,</span><span class=\"token number\">51</span><span class=\"token punctuation\">,</span><span class=\"token number\">145</span><span class=\"token punctuation\">,</span><span class=\"token number\">235</span><span class=\"token punctuation\">,</span><span class=\"token number\">249</span><span class=\"token punctuation\">,</span><span class=\"token number\">14</span><span class=\"token punctuation\">,</span><span class=\"token number\">239</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">18</span>  <span class=\"token number\">107</span><span class=\"token punctuation\">,</span><span class=\"token number\">49</span><span class=\"token punctuation\">,</span><span class=\"token number\">192</span><span class=\"token punctuation\">,</span><span class=\"token number\">214</span><span class=\"token punctuation\">,</span><span class=\"token number\">31</span><span class=\"token punctuation\">,</span><span class=\"token number\">181</span><span class=\"token punctuation\">,</span><span class=\"token number\">199</span><span class=\"token punctuation\">,</span><span class=\"token number\">106</span><span class=\"token punctuation\">,</span><span class=\"token number\">157</span><span class=\"token punctuation\">,</span><span class=\"token number\">184</span><span class=\"token punctuation\">,</span><span class=\"token number\">84</span><span class=\"token punctuation\">,</span><span class=\"token number\">204</span><span class=\"token punctuation\">,</span><span class=\"token number\">176</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">19</span>  <span class=\"token number\">115</span><span class=\"token punctuation\">,</span><span class=\"token number\">121</span><span class=\"token punctuation\">,</span><span class=\"token number\">50</span><span class=\"token punctuation\">,</span><span class=\"token number\">45</span><span class=\"token punctuation\">,</span><span class=\"token number\">127</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token number\">150</span><span class=\"token punctuation\">,</span><span class=\"token number\">254</span><span class=\"token punctuation\">,</span><span class=\"token number\">138</span><span class=\"token punctuation\">,</span><span class=\"token number\">236</span><span class=\"token punctuation\">,</span><span class=\"token number\">205</span><span class=\"token punctuation\">,</span><span class=\"token number\">93</span><span class=\"token punctuation\">,</span><span class=\"token number\">222</span><span class=\"token punctuation\">,</span><span class=\"token number\">114</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">20</span>  <span class=\"token number\">67</span><span class=\"token punctuation\">,</span><span class=\"token number\">29</span><span class=\"token punctuation\">,</span><span class=\"token number\">24</span><span class=\"token punctuation\">,</span><span class=\"token number\">72</span><span class=\"token punctuation\">,</span><span class=\"token number\">243</span><span class=\"token punctuation\">,</span><span class=\"token number\">141</span><span class=\"token punctuation\">,</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span><span class=\"token number\">195</span><span class=\"token punctuation\">,</span><span class=\"token number\">78</span><span class=\"token punctuation\">,</span><span class=\"token number\">66</span><span class=\"token punctuation\">,</span><span class=\"token number\">215</span><span class=\"token punctuation\">,</span><span class=\"token number\">61</span><span class=\"token punctuation\">,</span><span class=\"token number\">156</span><span class=\"token punctuation\">,</span><span class=\"token number\">180</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">21</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">22</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">23</span><span class=\"token comment\">/**\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">24</span> * 将任意整数n塞到hashes[n % 256]中来得到一个0-255的随机数\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">25</span> */</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">26</span><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">rand</span><span class=\"token punctuation\">(</span>n<span class=\"token operator\">:</span> number<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">27</span>  <span class=\"token keyword\">return</span> hashes<span class=\"token punctuation\">[</span>n <span class=\"token operator\">%</span> hashes<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">28</span><span class=\"token punctuation\">}</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">总结一下前面的结论：首先取整得到两个点并求出两个随机数，最后根据 P 的相对位置对随机数做线性插值就得到柏林噪声了，下面实现了一维柏林噪声第一版 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">perlin1d_v1</div></div><div class=\"std-code\"><pre  class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">// perlin1d_v1.tsx</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> rand <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./hashes'</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token comment\">// 第一版</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">perlin1d_v1</span><span class=\"token punctuation\">(</span>x<span class=\"token operator\">:</span> number<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span>  <span class=\"token comment\">// 向下/向上取整</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span>  <span class=\"token keyword\">const</span> x0 <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span>  <span class=\"token keyword\">const</span> x1 <span class=\"token operator\">=</span> x0 <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span>  <span class=\"token comment\">// 通过这种方式来实现伪随机</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">10</span>  <span class=\"token keyword\">const</span> r0 <span class=\"token operator\">=</span> <span class=\"token function\">rand</span><span class=\"token punctuation\">(</span>x0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">11</span>  <span class=\"token keyword\">const</span> r1 <span class=\"token operator\">=</span> <span class=\"token function\">rand</span><span class=\"token punctuation\">(</span>x1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">12</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">13</span>  <span class=\"token comment\">// 拿到相对位置</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">14</span>  <span class=\"token keyword\">const</span> dx <span class=\"token operator\">=</span> x <span class=\"token operator\">-</span> x0<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">15</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">16</span>  <span class=\"token comment\">// 拿到相对位置占的百分比,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">17</span>  <span class=\"token comment\">// 因为取整是 1 因此除 1 就行, 可省略提升性能</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">18</span>  <span class=\"token keyword\">const</span> rate <span class=\"token operator\">=</span> dx <span class=\"token operator\">/</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">19</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">20</span>  <span class=\"token comment\">// 最后拿到 rate 给 r0 r1 做线性插值</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">21</span>  <span class=\"token keyword\">const</span> noise <span class=\"token operator\">=</span> r0 <span class=\"token operator\">+</span> rate <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>r1 <span class=\"token operator\">-</span> r0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">22</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">23</span>  <span class=\"token comment\">// r0 和 r1 是 0-255 的数, 我们需要返回 0-1 的范围</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">24</span>  <span class=\"token keyword\">return</span> noise <span class=\"token operator\">/</span> <span class=\"token number\">255</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">25</span><span class=\"token punctuation\">}</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">注意, perlin1d_v1(x: number) 中 x 一定是要一个连续的实数算法才有意义，如果 x 都是整数那么它本质上跟从 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">hashes</div> 取随机数一样没有区别, 也就是说如果想拿 canvas 绘制一维柏林噪声曲线那么需要注意将坐标除以 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">单位数值 n</div> 来将整数坐标系变成带小数的浮点数。</div><div class=\"col-main\" style=\"display:flex;margin-bottom:16px\"><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-para --fontArticle para-center\" data-minimap-color=\"#CCCCCC\"><canvas style=\"width:16em;height:16em\"></canvas><div style=\"display:block\">白噪声</div></div></div><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-para --fontArticle para-center\" data-minimap-color=\"#CCCCCC\"><canvas style=\"width:16em;height:16em\"></canvas><div style=\"display:block\">柏林噪声 n=1<br/>(注意: 跟左边白噪声一模一样了)</div></div></div></div><div class=\"col-main\" style=\"display:flex;margin-bottom:16px\"><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-para --fontArticle para-center\" data-minimap-color=\"#CCCCCC\"><canvas style=\"width:16em;height:16em\"></canvas><div style=\"display:block\">柏林噪声 n=8</div></div></div><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-para --fontArticle para-center\" data-minimap-color=\"#CCCCCC\"><canvas style=\"width:16em;height:16em\"></canvas><div style=\"display:block\">柏林噪声 n=32</div></div></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">当 n 变大时，我们可以看到折线转角变少了，而且线也没那么 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">离散</div> 了，但是折线转角处依然非常陡峭，不够平滑规整，是哪里有问题么？此时需要再次审视 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">线性插值</div>，如下图所示，随着 x 增加，N 也会从 r0 均匀变大到 r1, 对应的柏林噪声输出也会 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">均匀线性变大</div>:</div><div class=\"std-img-dynamic-wrapper --fontArticle\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:49.56%\"><div class=\"std-img-dymanic-main __texttip __loading\">loading...</div><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/perlin-imageLinearInterpolation.98b59f7fbf7c1b33.svg\"/></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">当 P 跨过 P1 的时候，对应的线性插值由于端点变化就会造成突变，从而最终绘制的时候都是不光滑的折角了，即折线连接处不连续</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">若是我们能让这个 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">折线</div> 变成曲线，那么就能实现噪声的平滑处理了 —— 如下红线所示这样得到的 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">N&#x27;</div> 就形成了一条光滑的曲线，不再是折角了。</div><div class=\"std-img-dynamic-wrapper --fontArticle\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:49.56%\"><div class=\"std-img-dymanic-main __texttip __loading\">loading...</div><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/perlin-imageLinearInterpolationBlending.52f70471d74f517a.svg\"/></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">明白了关键还是线性插值后，就知道怎么改了，可以简单按 <div class=\"std-formula-wrapper\" style=\"display:inline-block\"><span class=\"katex\"><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></div> 作为平滑函数来处理线性插值，得到第 2 版实现 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">perlin1d_v2</div> 以及绘制效果:</div><div class=\"std-code\"><pre  class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">// perlin1d_v2.tsx</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> rand <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./hashes'</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token comment\">// 第二版</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">perlin1d_v2</span><span class=\"token punctuation\">(</span>x<span class=\"token operator\">:</span> number<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span>  <span class=\"token comment\">// 向下/向上取整</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span>  <span class=\"token keyword\">const</span> x0 <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span>  <span class=\"token keyword\">const</span> x1 <span class=\"token operator\">=</span> x0 <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span>  <span class=\"token comment\">// 通过这种方式来实现伪随机</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">10</span>  <span class=\"token keyword\">const</span> r0 <span class=\"token operator\">=</span> <span class=\"token function\">rand</span><span class=\"token punctuation\">(</span>x0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">11</span>  <span class=\"token keyword\">const</span> r1 <span class=\"token operator\">=</span> <span class=\"token function\">rand</span><span class=\"token punctuation\">(</span>x1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">12</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">13</span>  <span class=\"token comment\">// 拿到相对位置</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">14</span>  <span class=\"token keyword\">const</span> dx <span class=\"token operator\">=</span> x <span class=\"token operator\">-</span> x0<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">15</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">16</span>  <span class=\"token comment\">// 拿到相对位置占的百分比,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">17</span>  <span class=\"token comment\">// 因为取整是 1 因此除 1 就行, 可省略提升性能</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">18</span>  <span class=\"token keyword\">let</span> rate <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>dx <span class=\"token operator\">/</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">19</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">20</span>  <span class=\"token comment\">// 对 rate 做平滑处理</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">21</span>  rate <span class=\"token operator\">=</span> <span class=\"token function\">blending</span><span class=\"token punctuation\">(</span>rate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">22</span>  \n<span class=\"line-numbers-rows\" style=\"user-select: none;\">23</span>  <span class=\"token comment\">// 最后拿到 rate 给 r0 r1 做线性插值</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">24</span>  <span class=\"token keyword\">const</span> noise <span class=\"token operator\">=</span> r0 <span class=\"token operator\">+</span> rate <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>r1 <span class=\"token operator\">-</span> r0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">25</span>  \n<span class=\"line-numbers-rows\" style=\"user-select: none;\">26</span>  <span class=\"token comment\">// r0 和 r1 是 0-255 的数, 我们需要返回 0-1 的范围</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">27</span>  <span class=\"token keyword\">return</span> noise <span class=\"token operator\">/</span> <span class=\"token number\">255</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">28</span><span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">29</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">30</span><span class=\"token comment\">// 由于 rate 的范围是0到1</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">31</span><span class=\"token comment\">// 这样乘会让他变得更小，使得绘制更平滑不突变</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">32</span><span class=\"token keyword\">function</span> <span class=\"token function\">blending</span><span class=\"token punctuation\">(</span>rate<span class=\"token operator\">:</span> number<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">33</span>  <span class=\"token keyword\">return</span> rate <span class=\"token operator\">*</span> rate<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">34</span><span class=\"token punctuation\">}</span></pre></div><div class=\"col-main\" style=\"display:flex;margin-bottom:16px\"><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-para --fontArticle para-center\" data-minimap-color=\"#CCCCCC\"><canvas style=\"width:16em;height:16em\"></canvas><div style=\"display:block\">f(x)=x, n=8</div></div></div><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-para --fontArticle para-center\" data-minimap-color=\"#CCCCCC\"><canvas style=\"width:16em;height:16em\"></canvas><div style=\"display:block\">f(x)=x, n=32</div></div></div></div><div class=\"col-main\" style=\"display:flex;margin-bottom:16px\"><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-para --fontArticle para-center\" data-minimap-color=\"#CCCCCC\"><canvas style=\"width:16em;height:16em\"></canvas><div style=\"display:block\">f(x)=x^2, n=8</div></div></div><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-para --fontArticle para-center\" data-minimap-color=\"#CCCCCC\"><canvas style=\"width:16em;height:16em\"></canvas><div style=\"display:block\">f(x)=x^2, n=32</div></div></div></div><div class=\"col-main\" style=\"display:flex;margin-bottom:16px\"><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-para --fontArticle para-center\" data-minimap-color=\"#CCCCCC\"><canvas style=\"width:16em;height:16em\"></canvas><div style=\"display:block\">f(x)=6x^5-15x^4+10x^3, n=8</div></div></div><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-para --fontArticle para-center\" data-minimap-color=\"#CCCCCC\"><canvas style=\"width:16em;height:16em\"></canvas><div style=\"display:block\">f(x)=6x^5-15x^4+10x^3, n=32</div></div></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">效果越来越好，值得注意的是 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">6x^5-15x^4+10x^3</div> 是柏林提出的，这个效果非常好，这个函数的曲线如下图所示，可以看到类似贝塞尔曲线，它的一阶导数和二阶导数在 x=0 和 x=1 的地方都为 0，这使得其看起来非常光滑（一般来说函数越高次就越光滑）</div><div class=\"std-img-dynamic-wrapper --fontArticle\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:66.67%\"><div class=\"std-img-dymanic-main __texttip __loading\">loading...</div><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/desmos-fade.a6b255f132733235.svg\"/></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">至此，我们已经算是掌握了柏林噪声的基本原理和过程了，关键是分割整数区间然后取端点对应的随机数，再根据 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">比例</div> 来做线性插值得到噪声数值，而具体的插值函数是任意的，建议使用柏林提出来的那个 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">f(x)=6x^5-15x^4+10x^3</div>, 效果非常好。</div><h1 id=\"priciple-of-perlin-noise\" class=\"std-title --fontTitle\"><a href=\"#priciple-of-perlin-noise\" class=\"markdownIt-Anchor\">#</a> 柏林噪声的 2D 推广<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">前面讨论了一维的柏林噪声处理，这里将其从一维数轴推广到二维平面上</div><h2 id=\"取整的推广：晶格\" class=\"std-title --fontTitle\">取整的推广：晶格</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">对于某个点 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">O(x, y)</div> 的两个坐标分量做向上/向下取整，可以得到一个正方形格子，这个格子称为 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">晶格 (grid)</div>, 如下图所示, O 点在 P1,P2,P3,P4 所围成的晶格之中：</div><div class=\"std-img-dynamic-wrapper --fontArticle\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:74.72%\"><div class=\"std-img-dymanic-main __texttip __loading\">loading...</div><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/perlin-imagePerlinGrid.89ebcaed7fb38bd6.svg\"/></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">后续的计算都围绕着这个晶格进行。</div><h2 id=\"伪随机数的推广：伪随机向量-(梯度)\" class=\"std-title --fontTitle\">伪随机数的推广：伪随机向量 (梯度)</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">在前面一维场景中，我们需要将数轴上的点通过 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">hashes[n % 256]</div> 的方式来生成一个随机数，类比到二维场景，则需要根据 x 和 y 来生成一个伪随机向量，下面的 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">randVecs</div> 实现了这个功能：</div><div class=\"std-code\"><pre  class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">// hashes-vec.tsx</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> rand <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./hashes'</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token comment\">/** 表示一个向量 */</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Vec</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span>  x<span class=\"token operator\">:</span> number<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span>  y<span class=\"token operator\">:</span> number<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span><span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span><span class=\"token comment\">/** 一个向量组 */</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">10</span><span class=\"token keyword\">const</span> vecs<span class=\"token operator\">:</span> Vec<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">11</span>  <span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span>  <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span>  <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">12</span>  <span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span>  <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">13</span>  <span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">14</span>  <span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span>  <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">15</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">16</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">17</span><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">randVecs</span><span class=\"token punctuation\">(</span>vec<span class=\"token operator\">:</span> Vec<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">18</span>  <span class=\"token comment\">// 将 x 和 y 坐标输入到 rand 生成一个合成的随机数</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">19</span>  <span class=\"token keyword\">const</span> r <span class=\"token operator\">=</span> <span class=\"token function\">rand</span><span class=\"token punctuation\">(</span><span class=\"token function\">rand</span><span class=\"token punctuation\">(</span>vec<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> vec<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">20</span>  <span class=\"token comment\">// 因为 r 是随机的，因此可以这样随机从 vecs 中选择一个向量</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">21</span>  <span class=\"token keyword\">return</span> vecs<span class=\"token punctuation\">[</span>r <span class=\"token operator\">%</span> vecs<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">22</span><span class=\"token punctuation\">}</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">获取你会注意到其中的 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">向量组 vecs</div>, 它内部其实可以放其他的变量来改变噪声效果，这里选的这四个是为了后面方便处理（后面会提到）</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">因此在二维平面的柏林噪声处理中，晶格的每个顶点都会伪随机到一个向量上，因此会生成四条向量（蓝色箭头）：</div><div class=\"std-img-dynamic-wrapper --fontArticle\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:74.72%\"><div class=\"std-img-dymanic-main __texttip __loading\">loading...</div><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/perlin-imagePerlinRandVecs.69acd58741bb0e17.svg\"/></div></div><h2 id=\"晶格顶点的噪声标量\" class=\"std-title --fontTitle\">晶格顶点的噪声标量</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">在一维场景的讨论中我们知道线性插值需要知道两个端点和「比例」才能插值，根据这个规则我们可以实现线性插值的函数：</div><div class=\"std-code\"><pre  class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">// lerp.tsx</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token comment\">// 线性插值</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">lerp</span><span class=\"token punctuation\">(</span>t<span class=\"token operator\">:</span> number<span class=\"token punctuation\">,</span> v1<span class=\"token operator\">:</span> number<span class=\"token punctuation\">,</span> v2<span class=\"token operator\">:</span> number<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span>  <span class=\"token keyword\">return</span> v1 <span class=\"token operator\">+</span> t <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>v2 <span class=\"token operator\">-</span> v1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span><span class=\"token punctuation\">}</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">O 点在晶格内的相对位置可以由其到其中一个晶格顶点的向量表示，即下图中深绿色的向量，其他三个都可以由这个深绿色向量唯一确定：</div><div class=\"std-img-dynamic-wrapper --fontArticle\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:74.72%\"><div class=\"std-img-dymanic-main __texttip __loading\">loading...</div><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/perlin-imagePerlin2DRate.98fe04d1ff9167af.svg\"/></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">可是，线性插值要求的是标量，向量不能作为 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">lerp</div> 的参数进行调用，要怎么办呢？—— 既要考虑到相对位置的模的大小对标量的影响，又要考虑随机向量的影响，因此将晶格顶点的伪随机向量投影到 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">相对位置</div> 上相乘得到一个标量作为表征这个晶格顶点的噪声标量：</div><div class=\"std-img-dynamic-wrapper --fontArticle\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:74.72%\"><div class=\"std-img-dymanic-main __texttip __loading\">loading...</div><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/perlin-imagePerlinLerp1.1db1bba37ac2fb94.svg\"/></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">实际上，上面这样投影计算标量的方式其实就是向量的点乘运算：</div><div class=\"std-code\"><pre  class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">// vec-dot.tsx</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Vec <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./hashes-vec'</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">vecDot</span><span class=\"token punctuation\">(</span>v1<span class=\"token operator\">:</span> Vec<span class=\"token punctuation\">,</span> v2<span class=\"token operator\">:</span> Vec<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> number <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span>  <span class=\"token keyword\">return</span> v1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">*</span> v2<span class=\"token punctuation\">.</span>x <span class=\"token operator\">+</span> v1<span class=\"token punctuation\">.</span>y <span class=\"token operator\">*</span> v2<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span><span class=\"token punctuation\">}</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">到此为止，我们可以求出四个晶格顶点的噪声标量，最后一步就是将这四个噪声标量进行线性插值了。</div><h2 id=\"线性插值\" class=\"std-title --fontTitle\">线性插值</h2><ol class=\"numbering-main\" data-minimap-color=\"#DDDDDD\"><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">1.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">拿 P1 P2 的噪声标量做一次插值得到 V1，权重取 O 点在水平方向上的相对位置</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">2.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">拿 P3 P4 的噪声标量做一次插值得到 V2，权重取 O 点在水平方向上的相对位置</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">3.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">将 V1 V2 再做一次插值，权重取 O 点在垂直方向上的相对位置，最后的插值结果即为这个点的二维柏林噪声值了</div></li></ol><h2 id=\"归一化处理\" class=\"std-title --fontTitle\">归一化处理</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">归一化指的是将输出限定在 [-1,1] 或者 [0,1] 的区间内，方便外部调用使用，而上述的二维柏林噪声的取值范围由四个晶格代表的噪声标量来确定，那么它们插值的结果能落在 0 到 1 吗？</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">我们特意选择的四个向量在归一化处理这里就发挥作用了，用符号 <div class=\"std-formula-wrapper\" style=\"display:inline-block\"><span class=\"katex\"><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">A</span></span></span></span></div> 表示:</div><div class=\"std-formula-wrapper\" style=\"display:block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.6263em;vertical-align:-0.5632em;\"></span><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0632em;\"><span style=\"top:-3.0968em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord mathnormal\">A</span></span><span style=\"top:-3.2523em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.0966em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg xmlns=\"http://www.w3.org/2000/svg\" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.5632em;\"><span></span></span></span></span></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0632em;\"><span style=\"top:-3.0968em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mopen\">{(</span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span><span class=\"mopen\">(</span><span class=\"mord\">−</span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span><span class=\"mopen\">(</span><span class=\"mord\">−</span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">−</span><span class=\"mord\">1</span><span class=\"mclose\">)</span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">−</span><span class=\"mord\">1</span><span class=\"mclose\">)}</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.5632em;\"><span></span></span></span></span></span></span></span><span class=\"tag\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0632em;\"><span style=\"top:-3.0632em;\"><span class=\"pstrut\" style=\"height:2.9663em;\"></span><span class=\"eqn-num\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.5632em;\"><span></span></span></span></span></span></span></span></span></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">由于这四个向量不是 <div class=\"std-formula-wrapper\" style=\"display:inline-block\"><span class=\"katex\"><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">+</span><span class=\"mord\">1</span></span></span></span></div> 就是 <div class=\"std-formula-wrapper\" style=\"display:inline-block\"><span class=\"katex\"><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">−</span><span class=\"mord\">1</span></span></span></span></div>, 因此对于任意向量 (x, y) 计算点乘有:</div><div class=\"std-formula-wrapper\" style=\"display:block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.5em;vertical-align:-0.5em;\"></span><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1em;\"><span style=\"top:-3.16em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.5em;\"><span></span></span></span></span></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1em;\"><span style=\"top:-3.16em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord\">±</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">±</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.5em;\"><span></span></span></span></span></span></span></span><span class=\"tag\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:2.84em;\"></span><span class=\"eqn-num\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.5em;\"><span></span></span></span></span></span></span></span></span></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">我们特意选择的四个向量在归一化处理这里就发挥作用了，上图中有几个已知的等价关系</div><div class=\"std-formula-wrapper\" style=\"display:block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:9.2527em;vertical-align:-4.3763em;\"></span><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:4.8763em;\"><span style=\"top:-7.0363em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">x</span></span></span><span style=\"top:-5.5363em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span><span style=\"top:-3.91em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord\">1</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span></span></span><span style=\"top:-3.2523em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg xmlns=\"http://www.w3.org/2000/svg\" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span><span style=\"top:-2.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"></span></span><span style=\"top:-0.7837em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord accent\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9663em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord\">2</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span></span></span><span style=\"top:-3.2523em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2355em;\"><span class=\"overlay\" style=\"height:0.714em;width:0.471em;\"><svg xmlns=\"http://www.w3.org/2000/svg\" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span><span style=\"top:0.7163em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:4.3763em;\"><span></span></span></span></span></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:4.8763em;\"><span style=\"top:-7.0363em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mord\">0</span></span></span><span style=\"top:-5.5363em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mord\">0</span></span></span><span style=\"top:-3.91em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mord\">0</span><span class=\"mclose\">)</span></span></span><span style=\"top:-2.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span></span></span><span style=\"top:-0.7837em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mord\">0</span><span class=\"mclose\">)</span></span></span><span style=\"top:0.7163em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:4.3763em;\"><span></span></span></span></span></span></span></span><span class=\"tag\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:4.8763em;\"><span style=\"top:-7.0027em;\"><span class=\"pstrut\" style=\"height:2.9663em;\"></span><span class=\"eqn-num\"></span></span><span style=\"top:-5.5027em;\"><span class=\"pstrut\" style=\"height:2.9663em;\"></span><span class=\"eqn-num\"></span></span><span style=\"top:-3.8763em;\"><span class=\"pstrut\" style=\"height:2.9663em;\"></span><span class=\"eqn-num\"></span></span><span style=\"top:-2.3763em;\"><span class=\"pstrut\" style=\"height:2.9663em;\"></span><span class=\"eqn-num\"></span></span><span style=\"top:-0.75em;\"><span class=\"pstrut\" style=\"height:2.9663em;\"></span><span class=\"eqn-num\"></span></span><span style=\"top:0.75em;\"><span class=\"pstrut\" style=\"height:2.9663em;\"></span><span class=\"eqn-num\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:4.3763em;\"><span></span></span></span></span></span></span></span></span></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">由此计算点积得到 P1 和 P2 对应的噪声标量 V1 和 V2</div><div class=\"std-formula-wrapper\" style=\"display:block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:3em;vertical-align:-1.25em;\"></span><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.75em;\"><span style=\"top:-3.91em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mord\">1</span></span></span><span style=\"top:-2.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mord\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.25em;\"><span></span></span></span></span></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.75em;\"><span style=\"top:-3.91em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span></span></span><span style=\"top:-2.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.25em;\"><span></span></span></span></span></span></span></span><span class=\"tag\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.75em;\"><span style=\"top:-3.75em;\"><span class=\"pstrut\" style=\"height:2.84em;\"></span><span class=\"eqn-num\"></span></span><span style=\"top:-2.25em;\"><span class=\"pstrut\" style=\"height:2.84em;\"></span><span class=\"eqn-num\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.25em;\"><span></span></span></span></span></span></span></span></span></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">展开可以得到:</div><div class=\"std-formula-wrapper\" style=\"display:block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:3em;vertical-align:-1.25em;\"></span><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.75em;\"><span style=\"top:-3.91em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mord\">1</span></span></span><span style=\"top:-2.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mord\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.25em;\"><span></span></span></span></span></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.75em;\"><span style=\"top:-3.91em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord\">±</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">±</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span><span style=\"top:-2.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord\">±</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">±</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.25em;\"><span></span></span></span></span></span></span></span><span class=\"tag\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.75em;\"><span style=\"top:-3.75em;\"><span class=\"pstrut\" style=\"height:2.84em;\"></span><span class=\"eqn-num\"></span></span><span style=\"top:-2.25em;\"><span class=\"pstrut\" style=\"height:2.84em;\"></span><span class=\"eqn-num\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.25em;\"><span></span></span></span></span></span></span></span></span></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">最后要将 V1 和 V2 通过下面的 lerp 做一次线性插值得到最终结果:</div><div class=\"std-formula-wrapper\" style=\"display:block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:3em;vertical-align:-1.25em;\"></span><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.75em;\"><span style=\"top:-3.91em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">er</span><span class=\"mord mathnormal\">p</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">t</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">b</span><span class=\"mclose\">)</span></span></span><span style=\"top:-2.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord cjk_fallback\">最终结果</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.25em;\"><span></span></span></span></span></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.75em;\"><span style=\"top:-3.91em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">b</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mclose\">)</span></span></span><span style=\"top:-2.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">er</span><span class=\"mord mathnormal\">p</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">t</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mord\">2</span><span class=\"mclose\">)</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.25em;\"><span></span></span></span></span></span></span></span><span class=\"tag\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.75em;\"><span style=\"top:-3.75em;\"><span class=\"pstrut\" style=\"height:2.84em;\"></span><span class=\"eqn-num\"></span></span><span style=\"top:-2.25em;\"><span class=\"pstrut\" style=\"height:2.84em;\"></span><span class=\"eqn-num\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.25em;\"><span></span></span></span></span></span></span></span></span></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">那么最终结果的取值范围是多少呢？显然，取值范围就是 lerp 的 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">[a, b]</div>, 即 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">[V1, V2]</div></div><h2 id=\"完整实现\" class=\"std-title --fontTitle\">完整实现</h2><div class=\"std-code\"><pre  class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">// perlin2d_v1.tsx</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> lerp <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./lerp'</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> vecDot <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./vec-dot'</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Vec<span class=\"token punctuation\">,</span> randVecs <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./hashes-vec'</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span><span class=\"token comment\">// 2d 第一版</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">perlin2d_v1</span><span class=\"token punctuation\">(</span>x<span class=\"token operator\">:</span> number<span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> number<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span>  <span class=\"token comment\">// 对 x y 取整拿到晶格顶点的坐标</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span>  <span class=\"token keyword\">const</span> x0 <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span>  <span class=\"token keyword\">const</span> x1 <span class=\"token operator\">=</span> x0 <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">10</span>  <span class=\"token keyword\">const</span> y0 <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">11</span>  <span class=\"token keyword\">const</span> y1 <span class=\"token operator\">=</span> y0 <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">12</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">13</span>  <span class=\"token comment\">// 四个晶格顶点的坐标</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">14</span>  <span class=\"token keyword\">const</span> <span class=\"token constant\">P1</span><span class=\"token operator\">:</span> Vec <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span> x0<span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> y0 <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">15</span>  <span class=\"token keyword\">const</span> <span class=\"token constant\">P2</span><span class=\"token operator\">:</span> Vec <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span> x1<span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> y0 <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">16</span>  <span class=\"token keyword\">const</span> <span class=\"token constant\">P3</span><span class=\"token operator\">:</span> Vec <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span> x0<span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> y1 <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">17</span>  <span class=\"token keyword\">const</span> <span class=\"token constant\">P4</span><span class=\"token operator\">:</span> Vec <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span> x1<span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> y1 <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">18</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">19</span>  <span class=\"token comment\">// 四个晶格顶点对应的伪随机向量</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">20</span>  <span class=\"token keyword\">const</span> vec_P1 <span class=\"token operator\">=</span> <span class=\"token function\">randVecs</span><span class=\"token punctuation\">(</span><span class=\"token constant\">P1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">21</span>  <span class=\"token keyword\">const</span> vec_P2 <span class=\"token operator\">=</span> <span class=\"token function\">randVecs</span><span class=\"token punctuation\">(</span><span class=\"token constant\">P2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">22</span>  <span class=\"token keyword\">const</span> vec_P3 <span class=\"token operator\">=</span> <span class=\"token function\">randVecs</span><span class=\"token punctuation\">(</span><span class=\"token constant\">P3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">23</span>  <span class=\"token keyword\">const</span> vec_P4 <span class=\"token operator\">=</span> <span class=\"token function\">randVecs</span><span class=\"token punctuation\">(</span><span class=\"token constant\">P4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">24</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">25</span>  <span class=\"token comment\">// 计算四个晶格的随机向量和相对位置的点积</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">26</span>  <span class=\"token keyword\">const</span> value_P1 <span class=\"token operator\">=</span> <span class=\"token function\">vecDot</span><span class=\"token punctuation\">(</span>vec_P1<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span> x <span class=\"token operator\">-</span> x0<span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> y <span class=\"token operator\">-</span> y0 <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">27</span>  <span class=\"token keyword\">const</span> value_P2 <span class=\"token operator\">=</span> <span class=\"token function\">vecDot</span><span class=\"token punctuation\">(</span>vec_P2<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span> x <span class=\"token operator\">-</span> x1<span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> y <span class=\"token operator\">-</span> y0 <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">28</span>  <span class=\"token keyword\">const</span> value_P3 <span class=\"token operator\">=</span> <span class=\"token function\">vecDot</span><span class=\"token punctuation\">(</span>vec_P3<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span> x <span class=\"token operator\">-</span> x0<span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> y <span class=\"token operator\">-</span> y1 <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">29</span>  <span class=\"token keyword\">const</span> value_P4 <span class=\"token operator\">=</span> <span class=\"token function\">vecDot</span><span class=\"token punctuation\">(</span>vec_P4<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span> x <span class=\"token operator\">-</span> x1<span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> y <span class=\"token operator\">-</span> y1 <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">30</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">31</span>  <span class=\"token comment\">// O 点在 x, y 方向上的相对位置</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">32</span>  <span class=\"token keyword\">const</span> dx <span class=\"token operator\">=</span> x <span class=\"token operator\">-</span> x0<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">33</span>  <span class=\"token keyword\">const</span> dy <span class=\"token operator\">=</span> y <span class=\"token operator\">-</span> y0<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">34</span>  <span class=\"token keyword\">const</span> rateX <span class=\"token operator\">=</span> <span class=\"token function\">blending</span><span class=\"token punctuation\">(</span>dx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">35</span>  <span class=\"token keyword\">const</span> rateY <span class=\"token operator\">=</span> <span class=\"token function\">blending</span><span class=\"token punctuation\">(</span>dy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">36</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">37</span>  <span class=\"token keyword\">const</span> noise <span class=\"token operator\">=</span> <span class=\"token function\">lerp</span><span class=\"token punctuation\">(</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">38</span>    rateY<span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">39</span>    <span class=\"token function\">lerp</span><span class=\"token punctuation\">(</span>rateX<span class=\"token punctuation\">,</span> value_P1<span class=\"token punctuation\">,</span> value_P2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">40</span>    <span class=\"token function\">lerp</span><span class=\"token punctuation\">(</span>rateX<span class=\"token punctuation\">,</span> value_P3<span class=\"token punctuation\">,</span> value_P4<span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">41</span>  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">42</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">43</span>  <span class=\"token comment\">// 最后归一化处理, noise 的范围是 [-1, 1] 这里需要调整为 [0, 1]</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">44</span>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>noise <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">45</span><span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">46</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">47</span><span class=\"token comment\">// 6t^5 -15t^4 + 10t^3</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">48</span><span class=\"token keyword\">function</span> <span class=\"token function\">blending</span><span class=\"token punctuation\">(</span>t<span class=\"token operator\">:</span> number<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">49</span>  <span class=\"token keyword\">return</span> t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token operator\">+</span>t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">15</span><span class=\"token operator\">+</span><span class=\"token number\">6</span><span class=\"token operator\">*</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">50</span><span class=\"token punctuation\">}</span></pre></div><h2 id=\"效果\" class=\"std-title --fontTitle\">效果</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">拿上面实现的 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">perlin2d_v1</div> 来画一下：</div><div class=\"col-main\" style=\"display:flex;margin-bottom:16px\"><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-para --fontArticle para-center\" data-minimap-color=\"#CCCCCC\"><canvas style=\"width:16em;height:16em\"></canvas><div style=\"display:block\">n = 16</div></div></div><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-para --fontArticle para-center\" data-minimap-color=\"#CCCCCC\"><canvas style=\"width:16em;height:16em\"></canvas><div style=\"display:block\">n = 32</div></div></div></div><div class=\"col-main\" style=\"display:flex;margin-bottom:16px\"><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-para --fontArticle para-center\" data-minimap-color=\"#CCCCCC\"><canvas style=\"width:16em;height:16em\"></canvas><div style=\"display:block\">n = 64</div></div></div><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-para --fontArticle para-center\" data-minimap-color=\"#CCCCCC\"><canvas style=\"width:16em;height:16em\"></canvas><div style=\"display:block\">n = 128</div></div></div></div><h1 id=\"reference\" class=\"std-title --fontTitle\"><a href=\"#reference\" class=\"markdownIt-Anchor\">#</a> 参考<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><a href=\"https://zh.m.wikipedia.org/wiki/Perlin%E5%99%AA%E5%A3%B0\" target=\"_blank\" style=\"background-color:#dfece7\" class=\"std-link --fontSansSerif  _block\" data-minimap-color=\"#dfece7\"><span class=\"std-link-icon r-link\" data-src=\"/get-favicon/zh.m.wikipedia.org?h=1617267483\" style=\"background-image:url(&quot;/get-favicon/zh.m.wikipedia.org?h=1617267483&quot;)\"></span><span class=\"std-link-txt\">Wiki - Perlin Noise</span></a></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><a href=\"https://www.bilibili.com/video/BV11V4y1M7N6\" target=\"_blank\" style=\"background-color:#eee1dd\" class=\"std-link --fontSansSerif  _block\" data-minimap-color=\"#eee1dd\"><span class=\"std-link-icon r-link\" data-src=\"/get-favicon/www.bilibili.com?h=-452185442\" style=\"background-image:url(&quot;/get-favicon/www.bilibili.com?h=-452185442&quot;)\"></span><span class=\"std-link-txt\">Minecraft地形生成与柏林噪声 (一) 详解噪声</span></a></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><a href=\"https://juejin.cn/post/7148448472205639687\" target=\"_blank\" style=\"background-color:#efebde\" class=\"std-link --fontSansSerif  _block\" data-minimap-color=\"#efebde\"><span class=\"std-link-icon r-link\" data-src=\"/get-favicon/juejin.cn?h=991134630\" style=\"background-image:url(&quot;/get-favicon/juejin.cn?h=991134630&quot;)\"></span><span class=\"std-link-txt\">图形学的数学基础（四十四）：柏林噪声</span></a></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><a href=\"https://rtouti.github.io/graphics/perlin-noise-algorithm\" target=\"_blank\" style=\"background-color:#e4dde6\" class=\"std-link --fontSansSerif  _block\" data-minimap-color=\"#e4dde6\"><span class=\"std-link-icon r-link\" data-src=\"/get-favicon/rtouti.github.io?h=13914214215\" style=\"background-image:url(&quot;/get-favicon/rtouti.github.io?h=13914214215&quot;)\"></span><span class=\"std-link-txt\">Perlin Noise: A Procedural Generation Algorithm</span></a></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"></div>","props":{"codeHashes":"// hashes.tsx\n// 这个数组里随机放置了从 0 到 255 共计 256 个整数\nconst hashes = [\n  151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,\n  225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,\n  148,247,120,234,75,0,26,197,62,94,252,219,203,117,\n  35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,\n  171,168,68,175,74,165,71,134,139,48,27,166,77,146,\n  158,231,83,111,229,122,60,211,133,230,220,105,92,41,\n  55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,\n  73,209,76,132,187,208,89,18,169,200,196,135,130,116,\n  188,159,86,164,100,109,198,173,186,3,64,52,217,226,\n  250,124,123,5,202,38,147,118,126,255,82,85,212,207,\n  206,59,227,47,16,58,17,182,189,28,42,223,183,170,\n  213,119,248,152,2,44,154,163,70,221,153,101,155,167,\n  43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,\n  178,185,112,104,218,246,97,228,251,34,242,193,238,\n  210,144,12,191,179,162,241,81,51,145,235,249,14,239,\n  107,49,192,214,31,181,199,106,157,184,84,204,176,\n  115,121,50,45,127,4,150,254,138,236,205,93,222,114,\n  67,29,24,72,243,141,128,195,78,66,215,61,156,180\n];\n\n/**\n * 将任意整数n塞到hashes[n % 256]中来得到一个0-255的随机数\n */\nexport function rand(n: number) {\n  return hashes[n % hashes.length];\n}\n","codePerlin1d_v1":"// perlin1d_v1.tsx\nimport { rand } from './hashes';\n\n// 第一版\nexport function perlin1d_v1(x: number) {\n  // 向下/向上取整\n  const x0 = Math.floor(x);\n  const x1 = x0 + 1;\n\n  // 通过这种方式来实现伪随机\n  const r0 = rand(x0);\n  const r1 = rand(x1);\n\n  // 拿到相对位置\n  const dx = x - x0;\n\n  // 拿到相对位置占的百分比,\n  // 因为取整是 1 因此除 1 就行, 可省略提升性能\n  const rate = dx / 1;\n\n  // 最后拿到 rate 给 r0 r1 做线性插值\n  const noise = r0 + rate * (r1 - r0);\n\n  // r0 和 r1 是 0-255 的数, 我们需要返回 0-1 的范围\n  return noise / 255;\n}\n\n","codePerlin1d_v2":"// perlin1d_v2.tsx\nimport { rand } from './hashes';\n\n// 第二版\nexport function perlin1d_v2(x: number) {\n  // 向下/向上取整\n  const x0 = Math.floor(x);\n  const x1 = x0 + 1;\n\n  // 通过这种方式来实现伪随机\n  const r0 = rand(x0);\n  const r1 = rand(x1);\n\n  // 拿到相对位置\n  const dx = x - x0;\n\n  // 拿到相对位置占的百分比,\n  // 因为取整是 1 因此除 1 就行, 可省略提升性能\n  let rate = (dx / 1);\n\n  // 对 rate 做平滑处理\n  rate = blending(rate);\n  \n  // 最后拿到 rate 给 r0 r1 做线性插值\n  const noise = r0 + rate * (r1 - r0);\n  \n  // r0 和 r1 是 0-255 的数, 我们需要返回 0-1 的范围\n  return noise / 255;\n}\n\n// 由于 rate 的范围是0到1\n// 这样乘会让他变得更小，使得绘制更平滑不突变\nfunction blending(rate: number) {\n  return rate * rate;\n}\n","codeHashesVec":"// hashes-vec.tsx\nimport { rand } from './hashes';\n\n/** 表示一个向量 */\nexport interface Vec {\n  x: number;\n  y: number;\n}\n\n/** 一个向量组 */\nconst vecs: Vec[] = [\n  { x:  1, y:  1 },\n  { x: -1, y:  1 },\n  { x: -1, y: -1 },\n  { x:  1, y: -1 },\n];\n\nexport function randVecs(vec: Vec) {\n  // 将 x 和 y 坐标输入到 rand 生成一个合成的随机数\n  const r = rand(rand(vec.x) + vec.y);\n  // 因为 r 是随机的，因此可以这样随机从 vecs 中选择一个向量\n  return vecs[r % vecs.length];\n}\n","codeLerp":"// lerp.tsx\n// 线性插值\nexport function lerp(t: number, v1: number, v2: number) {\n  return v1 + t * (v2 - v1);\n}\n","codeVecDot":"// vec-dot.tsx\nimport { Vec } from './hashes-vec';\n\nexport function vecDot(v1: Vec, v2: Vec): number {\n  return v1.x * v2.x + v1.y * v2.y;\n}\n","codePerlin2d_v1":"// perlin2d_v1.tsx\nimport { lerp } from './lerp';\nimport { vecDot } from './vec-dot';\nimport { Vec, randVecs } from './hashes-vec';\n\n// 2d 第一版\nexport function perlin2d_v1(x: number, y: number) {\n  // 对 x y 取整拿到晶格顶点的坐标\n  const x0 = Math.floor(x);\n  const x1 = x0 + 1;\n  const y0 = Math.floor(y);\n  const y1 = y0 + 1;\n\n  // 四个晶格顶点的坐标\n  const P1: Vec = { x: x0, y: y0 }\n  const P2: Vec = { x: x1, y: y0 }\n  const P3: Vec = { x: x0, y: y1 }\n  const P4: Vec = { x: x1, y: y1 }\n\n  // 四个晶格顶点对应的伪随机向量\n  const vec_P1 = randVecs(P1);\n  const vec_P2 = randVecs(P2);\n  const vec_P3 = randVecs(P3);\n  const vec_P4 = randVecs(P4);\n\n  // 计算四个晶格的随机向量和相对位置的点积\n  const value_P1 = vecDot(vec_P1, { x: x - x0, y: y - y0 });\n  const value_P2 = vecDot(vec_P2, { x: x - x1, y: y - y0 });\n  const value_P3 = vecDot(vec_P3, { x: x - x0, y: y - y1 });\n  const value_P4 = vecDot(vec_P4, { x: x - x1, y: y - y1 });\n\n  // O 点在 x, y 方向上的相对位置\n  const dx = x - x0;\n  const dy = y - y0;\n  const rateX = blending(dx);\n  const rateY = blending(dy);\n\n  const noise = lerp(\n    rateY,\n    lerp(rateX, value_P1, value_P2),\n    lerp(rateX, value_P3, value_P4)\n  );\n\n  // 最后归一化处理, noise 的范围是 [-1, 1] 这里需要调整为 [0, 1]\n  return (noise + 1) / 2;\n}\n\n// 6t^5 -15t^4 + 10t^3\nfunction blending(t: number) {\n  return t*(t*(t*(10+t*(-15+6*t))));\n}\n"},"tocStack":[{"id":"map-demo","level":1,"text":"地图生成器 demo"},{"id":"problem-of-white-noise","level":1,"text":"白噪声的问题"},{"id":"priciple-of-perlin-noise","level":1,"text":"柏林噪声的原理"},{"id":"priciple-of-perlin-noise","level":1,"text":"柏林噪声的 2D 推广"},{"id":"取整的推广：晶格","level":2,"text":"取整的推广：晶格"},{"id":"伪随机数的推广：伪随机向量-(梯度)","level":2,"text":"伪随机数的推广：伪随机向量 (梯度)"},{"id":"晶格顶点的噪声标量","level":2,"text":"晶格顶点的噪声标量"},{"id":"线性插值","level":2,"text":"线性插值"},{"id":"归一化处理","level":2,"text":"归一化处理"},{"id":"完整实现","level":2,"text":"完整实现"},{"id":"效果","level":2,"text":"效果"},{"id":"reference","level":1,"text":"参考"}]}}},"HomeApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"TimeLineApiState":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"SettingApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"LaunchpadApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}}}</script>
<!--SCRIPT-->
</body>
</html>
