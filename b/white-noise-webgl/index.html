<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<title>从白噪声开始学习 WebGL | Eczn's Home</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,minimal-ui">
<meta name="format-detection" content="telephone=no">

<style id="CSS_VARS"></style>
<script>
(function() {
console.log('INIT CSS VAR');
function loadCSSVars() {
    const j = localStorage.getItem("CSS_VARS_2" /* STORAGE_KEY.CSS_VARS */);
    const initialVars = initialCSSVars();
    if (!j)
        return initialVars;
    try {
        const result = {
            ...initialVars,
            ...JSON.parse(j)
        };
        console.log('loadCSSVars from storage', result);
        return result;
    }
    catch (error) {
        console.error('load css vars with error', error);
        return initialVars;
    }
}
function renderCSSVars(vars, style) {
    const allDefine = Object.keys(vars).map(k => {
        const v = vars[k];
        const cssValue = typeof v === 'number' ? `${v}px` : v;
        return `--${k}:${cssValue};`;
    }).join('\n');
    if (style) {
        style.innerHTML = `:root { ${allDefine} }`;
    }
    else {
        console.error(`style#CSS_VARS NotFound !`);
    }
}
function initialCSSVars() {
    let rem = 16;
    // 移动端
    if (typeof window !== 'undefined' && window.innerWidth <= 500) {
        rem = Number(((window.innerWidth - 20) / 42).toFixed(1));
        console.log('mobile calculated rem =>', rem);
    }
    return {
        rem,
        enableSmallerFont: false,
        displayToc: 'block',
        fontSmcp: 'source serif pro, serif',
        fontCode: 'consolas, Menlo, monospace',
        fontTitle: 'Noto Serif SC, serif',
        fontArticle: 'source serif pro, LXGW WenKai',
        fontSansSerif: 'sans-serif',
    };
}
window.__initialCSSVars = loadCSSVars();
renderCSSVars(__initialCSSVars, document.querySelector('#CSS_VARS'));
})();
</script>

<link rel="icon" href="/favicon.png"><script defer="defer" src="/js/index.f7602db1.js"></script><script defer="defer" src="/js/chunk-lib.cbf60312.js"></script><link href="/css/index.791c12afdb2cecbd8bba.css" rel="stylesheet"><link href="/css/chunk-lib.5c7d4887bb8714b00c54.css" rel="stylesheet"></head>
<body x-apple-data-detectors="none">
<noscript>当前浏览器不支持 JavaScript, 建议使用支持 JavaScript 的浏览器来访问此网站 !</noscript>
<div id="rally-bg" style="opacity:0"></div>
<div id="app"><div class="ball-canvas-container"></div><nav class="nav-main --fontSmcp"><div class="_title default-max-width">Eczn&#x27;s Home</div><div class="smcphr"></div><div class="_links default-max-width"><a class="r-link _link clickable r-link" href="/">Home</a><a class="r-link _link clickable r-link" href="/tl/0/">Timeline</a><a class="r-link _link clickable r-link" href="/cate/all/">Category</a><a class="r-link _link clickable r-link" href="/setting/">Setting</a><a class="r-link _link clickable r-link" href="/launchpad/">Launchpad</a></div></nav><div class="std-box rally-page-content default-max-width"><div id="blog-box" class="std-box-content "><div id="start" class="blog-header-main"><div class="_infos"><div class="_info"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="clock" class="svg-inline--fa fa-clock fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256,8C119,8,8,119,8,256S119,504,256,504,504,393,504,256,393,8,256,8Zm92.49,313h0l-20,25a16,16,0,0,1-22.49,2.5h0l-67-49.72a40,40,0,0,1-15-31.23V112a16,16,0,0,1,16-16h32a16,16,0,0,1,16,16V256l58,42.5A16,16,0,0,1,348.49,321Z"></path></svg>2023-03-29</div></div><div class="_title --fontTitle">从白噪声开始学习 WebGL</div></div><article class="r-article-wrapper"><div class="toc-wrapper"><div class="toc"><div class="toc-item _active" style="padding-left:0em"><a href="#white-noise-audio" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>声音怎么实现</a></div><div class="toc-item" style="padding-left:0em"><a href="#implementation-idea" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>Canvas 绘制思路</a></div><div class="toc-item" style="padding-left:0em"><a href="#webgl-vs-canvas" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>WebGL 还是 Canvas</a></div><div class="toc-item" style="padding-left:0em"><a href="#webgl-render-pipeline" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>WebGL 渲染管线</a></div><div class="toc-item" style="padding-left:1em"><a href="#vertex-shader" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>顶点着色器 (Vertex shader)</a></div><div class="toc-item" style="padding-left:1em"><a href="#primitive-assembly" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>图元装配 (Primitive assembly)</a></div><div class="toc-item" style="padding-left:1em"><a href="#rasterization" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>光栅化 (Rasterization)</a></div><div class="toc-item" style="padding-left:1em"><a href="#fragment-shader" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>片段着色器 (Fragment shader)</a></div><div class="toc-item" style="padding-left:1em"><a href="#testing-and-blending" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>混合和测试 (Testing and blending)</a></div><div class="toc-item" style="padding-left:0em"><a href="#tutorial-coding-glsl-shader" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>快速入门 GLSL 编写着色器</a></div><div class="toc-item" style="padding-left:1em"><a href="#glsl-main" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>main 函数</a></div><div class="toc-item" style="padding-left:1em"><a href="#glsl-vec4" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>vec4 是什么</a></div><div class="toc-item" style="padding-left:1em"><a href="#glsl-attribute" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>attribute 属性</a></div><div class="toc-item" style="padding-left:1em"><a href="#glsl-gl_Position" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>gl_Position</a></div><div class="toc-item" style="padding-left:0em"><a href="#webgl-wh-render-ideas" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>WenGL 绘制思路</a></div><div class="toc-item" style="padding-left:0em"><a href="#white-noise-vertex-shader" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>白噪声顶点着色器</a></div><div class="toc-item" style="padding-left:0em"><a href="#white-noise-fragment-shader" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>白噪声片段着色器</a></div><div class="toc-item" style="padding-left:0em"><a href="#ts-webgl-programming" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>WebGL 编程</a></div><div class="toc-item" style="padding-left:0em"><a href="#links" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>参考</a></div><div class="_index --fontSmcp" data-minimap="Ignore">Indexes</div><div class="smcphr"></div></div></div><div class="r-article"><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">本文介绍白噪声生成, Audio 和 Pixel: </div><div class="std-para --fontArticle para-center" data-minimap-color="#CCCCCC"><canvas width="50" height="240"></canvas></div><div class="button-main --fontSansSerif  normal" style="font-size:inherit"><span>播放</span></div><h1 id="white-noise-audio" class="std-title --fontTitle"><a href="#white-noise-audio" class="markdownIt-Anchor">#</a> 声音怎么实现<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">利用 WebAudio 播放即可，不是本文重点</div><h1 id="implementation-idea" class="std-title --fontTitle"><a href="#implementation-idea" class="markdownIt-Anchor">#</a> Canvas 绘制思路<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">画白噪声单个像素点很容易, 利用 Math.random() 生成随机数即可。</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">然后将这个函数应用到 canvas 画布全部点上即可绘制出来一帧，最后让其动起来即可，具体实现如下:</div><div class="std-code"><pre  class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span>__NO_CODE__</pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">最后在合适的地方 new WhiteNoiseCanvas() 并 init() 即可</div><div class="std-para --fontArticle para-center" data-minimap-color="#CCCCCC"><canvas width="50" height="240"></canvas></div><div class="button-main --fontSansSerif  normal" style="font-size:inherit"><span>播放 (移动端慎点, 卡)</span></div><h1 id="webgl-vs-canvas" class="std-title --fontTitle"><a href="#webgl-vs-canvas" class="markdownIt-Anchor">#</a> WebGL 还是 Canvas<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">上段内容大致描述了绘制过程, 很明显上述过程涉及到遍历全部点的过程, 典型的计算密集型应用。这种场景小尺寸图片画布还好，如果需要绘制 4K 画布的时候就卡的不行了，我们需要一个更高性能的方案 —— webgl, 借助显卡加速来绘制</div><h1 id="webgl-render-pipeline" class="std-title --fontTitle"><a href="#webgl-render-pipeline" class="markdownIt-Anchor">#</a> WebGL 渲染管线<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">大致说来说，渲染管线是渲染像素的整个流程，如图：</div><div class="std-img-dynamic-wrapper --fontArticle"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:71.31%"><div class="std-img-dymanic-main __texttip __loading">loading...</div><img class="std-img-dymanic-main" src="/tsxs-esm/webgl-render-pipeline.aad3a26495389523.svg"/></div></div><h2 id="vertex-shader" class="std-title --fontTitle">顶点着色器 (Vertex shader)</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">通过编写顶点着色器可以让 GPU 帮你做顶点的坐标变换，在 3D 里面可以据此实现摄像机 (Camara)，实现镜头跟踪等特性。</div><div class="std-img-dynamic-wrapper --fontArticle"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:36.97%"><div class="std-img-dymanic-main __texttip __loading">loading...</div><img class="std-img-dymanic-main" src="/tsxs-esm/webgl-vertex-shader.ad3146640b98f138.svg"/></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">在 2D 场景下，这里变换主要是放大缩小等常用变换</div><h2 id="primitive-assembly" class="std-title --fontTitle">图元装配 (Primitive assembly)</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">图元装配是将顶点着色器中输出的顶点组装成指定的图元，直觉上对应物体的 “面”:</div><div class="std-img-dynamic-wrapper --fontArticle"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:20.04%"><div class="std-img-dymanic-main __texttip __loading">loading...</div><img class="std-img-dymanic-main" src="/tsxs-esm/webgl-assembly-mode.ce0800bc2bf1b6f9.svg"/></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">上图没有列出全部的图元装配模式，在本例里只需要三角形 TRIANGLES 即可</div><h2 id="rasterization" class="std-title --fontTitle">光栅化 (Rasterization)</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">将装配好的矢量的图元离散化/像素化，变成由像素组成的图元，这个过程称为光栅化，具体来说：</div><ul class="numbering-main" data-minimap-color="#DDDDDD"><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">管线在光栅化过程中使用了一些光栅化的算法，选择出在图元边界所包围的像素点，最终组成片元。常用的光栅化算法如Bresenham光栅化算法等。</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">如果在顶点着色器中的顶点中设置例如颜色，法线等属性，在光栅化过程对基于顶点对各个像素点做线性插值。</div></li></ul><h2 id="fragment-shader" class="std-title --fontTitle">片段着色器 (Fragment shader)</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">进一步处理上一步光栅化得到的图片像素片段</div><h2 id="testing-and-blending" class="std-title --fontTitle">混合和测试 (Testing and blending)</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这一步会将片段着色器传过来的片段做测试，测试失败的像素直接删除，测试成功的点去保留，并最终渲染到屏幕上。</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">常见的测试主要包括模版测试和深度测试，通过深度测试可以实现物体面的前后顺序，具体不展开了，我这里的白噪声不需要这个。</div><h1 id="tutorial-coding-glsl-shader" class="std-title --fontTitle"><a href="#tutorial-coding-glsl-shader" class="markdownIt-Anchor">#</a> 快速入门 GLSL 编写着色器<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">着色器 (shader) 是一种 GPU 程序, 由 GPU 负责执行。GLSL 即 OpenGL Shading Language, 可以用来编写着色器。</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">GLSL 采用了类 C 的语法，并提供了若干方便的数据结构和选择器，通过 uniform 全局变量将相关参数传入 GLSL 上下文中。</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这里以本例子里用到的顶点着色器为例说明</div><div class="std-code"><pre  class="prismjs glsl rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> position<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>  gl_Position <span class="token operator">=</span> position<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token punctuation">}</span></pre></div><h2 id="glsl-main" class="std-title --fontTitle">main 函数</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">你懂的, 执行入口</div><h2 id="glsl-vec4" class="std-title --fontTitle">vec4 是什么</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">vec4 是一种数据结构，表示一个四维向量, 你可以将它想象为这个结构:</div><div class="std-code"><pre  class="prismjs ts rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token keyword">interface</span> <span class="token class-name">vec4</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">01</span>  x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>  y<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">03</span>  z<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">04</span>  w<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span> <span class="token comment">// 远近</span>
<span class="line-numbers-rows" style="user-select: none;">05</span><span class="token punctuation">}</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">此外还有 vec3, vec2, 这两个是在 vec4 上减去 w 和 z 得到。</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这里提一下选择器这个概念: (语法糖)</div><div class="std-code"><pre  class="prismjs glsl rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">// 构造一个 vec4 存储在 a 变量中</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token keyword">vec4</span> a <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">,</span> <span class="token number">4.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token keyword">vec3</span> b <span class="token operator">=</span> a<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span> <span class="token comment">// (1, 2, 3)</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token keyword">vec2</span> c <span class="token operator">=</span> a<span class="token punctuation">.</span>xy<span class="token punctuation">;</span> <span class="token comment">// (1, 2)</span>
<span class="line-numbers-rows" style="user-select: none;">04</span><span class="token keyword">vec2</span> d <span class="token operator">=</span> a<span class="token punctuation">.</span>yz<span class="token punctuation">;</span> <span class="token comment">// (2, 1) 选择 y z 维并作为 vec2 返回</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">可以通过在变量名后面接 .xyz 的方式快速选择其中的几个维度出来</div><h2 id="glsl-attribute" class="std-title --fontTitle">attribute 属性</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">attribute 标记的变量说明这个变量的取值是从 &quot;缓冲&quot; 取的</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">具体来说，缓冲是是 js 这边发送到 GPU 的一段二进制数据序列，通常情况下缓冲数据包括位置，法向量，纹理坐标，顶点颜色值等，除此之外，缓冲还可以存储任何数据，因为它本质就是一段 buffer</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">而具体到如何从 &quot;缓冲&quot; 得到 &quot;vec4&quot; 这件事，则需要通过 js 进行定义：</div><div class="std-code"><pre  class="prismjs glsl rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token char">'canvas'</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token char">'webgl'</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token comment">// 开辟一块缓冲</span>
<span class="line-numbers-rows" style="user-select: none;">04</span><span class="token keyword">const</span> positionBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">05</span>gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>ARRAY_BUFFER<span class="token punctuation">,</span> positionBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">06</span>
<span class="line-numbers-rows" style="user-select: none;">07</span><span class="token comment">// 取得访问到 position 变量的 location</span>
<span class="line-numbers-rows" style="user-select: none;">08</span><span class="token keyword">const</span> positionAttributeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>
<span class="line-numbers-rows" style="user-select: none;">09</span>  program<span class="token punctuation">,</span> <span class="token comment">// program 为 glsl 编译后的实例, 这里先忽略</span>
<span class="line-numbers-rows" style="user-select: none;">10</span>  <span class="token char">'position'</span> <span class="token comment">// 对应 glsl 程序里的 position 变量名</span>
<span class="line-numbers-rows" style="user-select: none;">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">12</span>
<span class="line-numbers-rows" style="user-select: none;">13</span><span class="token comment">// 用 ts 定义顶点数据 (x,y,z) 一共 3 个点, 数组长度为 9 </span>
<span class="line-numbers-rows" style="user-select: none;">14</span><span class="token keyword">const</span> vertices<span class="token operator">:</span> number<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
<span class="line-numbers-rows" style="user-select: none;">15</span>  <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">16</span>  <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">17</span>   <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">18</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">19</span>
<span class="line-numbers-rows" style="user-select: none;">20</span><span class="token comment">// 写入到缓冲 buffer 中</span>
<span class="line-numbers-rows" style="user-select: none;">21</span>gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>
<span class="line-numbers-rows" style="user-select: none;">22</span>  gl<span class="token punctuation">.</span>ARRAY_BUFFER<span class="token punctuation">,</span>            <span class="token comment">// 表明是 ARRAY_BUFFER</span>
<span class="line-numbers-rows" style="user-select: none;">23</span>  new <span class="token function">Float32Array</span><span class="token punctuation">(</span>vertices<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 构造为 Float32Array 格式</span>
<span class="line-numbers-rows" style="user-select: none;">24</span>  gl<span class="token punctuation">.</span>STATIC_DRAW<span class="token punctuation">,</span>             <span class="token comment">// 我们不会经常改这个顶点数据</span>
<span class="line-numbers-rows" style="user-select: none;">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">26</span>
<span class="line-numbers-rows" style="user-select: none;">27</span><span class="token comment">// 启用 position 属性</span>
<span class="line-numbers-rows" style="user-select: none;">28</span>gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>positionAttributeLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">29</span>
<span class="line-numbers-rows" style="user-select: none;">30</span><span class="token comment">// 告诉如何从缓冲中取值并写到 position 变量上</span>
<span class="line-numbers-rows" style="user-select: none;">31</span>gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>
<span class="line-numbers-rows" style="user-select: none;">32</span>  positionAttributeLocation<span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">33</span>  <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// vertices 数组中每三个赋值到 vec4 position 上</span>
<span class="line-numbers-rows" style="user-select: none;">34</span>     <span class="token comment">// 因此会少一个 w, glsl 会补一个默认值 0</span>
<span class="line-numbers-rows" style="user-select: none;">35</span>  gl<span class="token punctuation">.</span>FLOAT<span class="token punctuation">,</span> <span class="token comment">// 浮点类型</span>
<span class="line-numbers-rows" style="user-select: none;">36</span>  <span class="token keyword">false</span><span class="token punctuation">,</span>    <span class="token comment">// 不需要归一化数据</span>
<span class="line-numbers-rows" style="user-select: none;">37</span>  <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token comment">// 每次迭代运行运动多少内存到下一个数据开始点</span>
<span class="line-numbers-rows" style="user-select: none;">38</span>            <span class="token comment">// 这里 0 代表 单位数量 * 每个单位占用内存 sizeof(type)</span>
<span class="line-numbers-rows" style="user-select: none;">39</span>  <span class="token number">0</span>         <span class="token comment">// 从缓冲起始位置开始读取</span>
<span class="line-numbers-rows" style="user-select: none;">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">可以看见，一般的做法是利用 js 定义顶点数据传入缓冲，并定义属性获取方式，通常定义为三个三个的获取，最后在顶点着色器中就可以使用 position 变量了</div><h2 id="glsl-gl_Position" class="std-title --fontTitle">gl_Position</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">通过赋值内置变量 gl_Position 来告诉外部本次顶点变换后的结果, 在这里可以看见我们没有做任何顶点变换，直接将从缓冲得到的顶点透传出去了。</div><h1 id="webgl-wh-render-ideas" class="std-title --fontTitle"><a href="#webgl-wh-render-ideas" class="markdownIt-Anchor">#</a> WenGL 绘制思路<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">根据前文提到的渲染管线进行思考，用三个顶点绘制出三角形，然后利用片段着色器随机填充三角形即可</div><div class="std-img-dynamic-wrapper --fontArticle"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:23.77%"><div class="std-img-dymanic-main __texttip __loading">loading...</div><img class="std-img-dymanic-main" src="/tsxs-esm/webgl-wh-render-ideas.7f946c99fd0bfe6e.svg"/></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">你可能会问三角形不对，那么可以再加一个三角形构成一个正方形。</div><h1 id="white-noise-vertex-shader" class="std-title --fontTitle"><a href="#white-noise-vertex-shader" class="markdownIt-Anchor">#</a> 白噪声顶点着色器<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">因为不需要什么特殊的顶点处理，所以顶点着色器只需要从缓冲中取得对应点即可</div><div class="std-code"><pre  class="prismjs glsl rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> position<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>  gl_Position <span class="token operator">=</span> position<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token punctuation">}</span></pre></div><h1 id="white-noise-fragment-shader" class="std-title --fontTitle"><a href="#white-noise-fragment-shader" class="markdownIt-Anchor">#</a> 白噪声片段着色器<i data-minimap="Ignore"> ↵ </i></h1><div class="std-code"><pre  class="prismjs glsl rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">// 定义片段着色器</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">GL_ES</span></span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="line-numbers-rows" style="user-select: none;">04</span>
<span class="line-numbers-rows" style="user-select: none;">05</span><span class="token keyword">uniform</span> <span class="token keyword">float</span> u_rand<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">06</span><span class="token keyword">uniform</span> <span class="token keyword">float</span> u_size<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">07</span>
<span class="line-numbers-rows" style="user-select: none;">08</span><span class="token comment">// 随机输出一个在 0 和 1 之间的数</span>
<span class="line-numbers-rows" style="user-select: none;">09</span><span class="token comment">// 这是一个很有意思的随机数生成,</span>
<span class="line-numbers-rows" style="user-select: none;">10</span><span class="token comment">// 具体原理可以 google 下</span>
<span class="line-numbers-rows" style="user-select: none;">11</span><span class="token keyword">float</span> <span class="token function">random2d</span><span class="token punctuation">(</span><span class="token keyword">vec2</span> co<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">12</span>  <span class="token keyword">float</span> a <span class="token operator">=</span> <span class="token number">12.9898</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">13</span>  <span class="token keyword">float</span> b <span class="token operator">=</span> <span class="token number">78.233</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">14</span>  <span class="token keyword">float</span> c <span class="token operator">=</span> <span class="token number">43758.5453</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">15</span>  <span class="token comment">// dot 为点乘</span>
<span class="line-numbers-rows" style="user-select: none;">16</span>  <span class="token comment">// dt = (co.x * a) + (co.y * b)</span>
<span class="line-numbers-rows" style="user-select: none;">17</span>  <span class="token keyword">float</span> dt <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>co<span class="token punctuation">.</span>xy<span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">18</span>  <span class="token keyword">float</span> sn <span class="token operator">=</span> <span class="token function">mod</span><span class="token punctuation">(</span>dt<span class="token punctuation">,</span> <span class="token number">3.14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">19</span>  <span class="token keyword">return</span> <span class="token function">fract</span><span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span>sn<span class="token punctuation">)</span> <span class="token operator">*</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">20</span><span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">21</span>
<span class="line-numbers-rows" style="user-select: none;">22</span><span class="token comment">// 将 x 定在 x - (x % u_size) 区间内</span>
<span class="line-numbers-rows" style="user-select: none;">23</span><span class="token keyword">float</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">24</span>  <span class="token keyword">return</span> x <span class="token operator">-</span> <span class="token function">mod</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> u_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">25</span><span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">26</span>
<span class="line-numbers-rows" style="user-select: none;">27</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">28</span>  <span class="token comment">// gl_FragCoord 代表当前处理的片元坐标</span>
<span class="line-numbers-rows" style="user-select: none;">29</span>  <span class="token comment">// round函数为 四舍五入</span>
<span class="line-numbers-rows" style="user-select: none;">30</span>  <span class="token keyword">vec2</span> coord <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>
<span class="line-numbers-rows" style="user-select: none;">31</span>    <span class="token function">round</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">32</span>    <span class="token function">round</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">33</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">34</span>
<span class="line-numbers-rows" style="user-select: none;">35</span>  <span class="token keyword">float</span> num <span class="token operator">=</span> <span class="token function">random2d</span><span class="token punctuation">(</span>
<span class="line-numbers-rows" style="user-select: none;">36</span>    <span class="token keyword">vec2</span><span class="token punctuation">(</span>
<span class="line-numbers-rows" style="user-select: none;">37</span>      coord<span class="token punctuation">.</span>x <span class="token operator">*</span> u_rand<span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">38</span>      coord<span class="token punctuation">.</span>y <span class="token operator">*</span> u_rand
<span class="line-numbers-rows" style="user-select: none;">39</span>    <span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">40</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">41</span>
<span class="line-numbers-rows" style="user-select: none;">42</span>  <span class="token comment">// num 大于 0.5 的话归到 1.0 否则归到 0</span>
<span class="line-numbers-rows" style="user-select: none;">43</span>  <span class="token keyword">float</span> p <span class="token operator">=</span> <span class="token punctuation">(</span>num <span class="token operator">></span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1.0</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">44</span>
<span class="line-numbers-rows" style="user-select: none;">45</span>  <span class="token comment">// 构成一个 vec4 并通过 gl_FragColor 输出 (rgba 四个值)</span>
<span class="line-numbers-rows" style="user-select: none;">46</span>  gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> p<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">47</span><span class="token punctuation">}</span></pre></div><h1 id="ts-webgl-programming" class="std-title --fontTitle"><a href="#ts-webgl-programming" class="markdownIt-Anchor">#</a> WebGL 编程<i data-minimap="Ignore"> ↵ </i></h1><div class="std-code"><pre  class="prismjs ts rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span>__NO_CODE__</pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">最后 new WhiteNoiseWebgl() 并调用 init 即可</div><div class="std-code"><pre  class="prismjs ts rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token keyword">import</span> <span class="token punctuation">{</span> whiteNoiseWebgl <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./white-noise-webgl'</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">01</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span><span class="token operator">!</span>
<span class="line-numbers-rows" style="user-select: none;">03</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">04</span>canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">05</span>canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">06</span>
<span class="line-numbers-rows" style="user-select: none;">07</span><span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">whiteNoiseWebgl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">08</span>instance<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div><div class="std-para --fontArticle para-center" data-minimap-color="#CCCCCC"><canvas height="240"></canvas></div><div class="button-main --fontSansSerif  normal" style="font-size:inherit"><span>播放</span></div><h1 id="links" class="std-title --fontTitle"><a href="#links" class="markdownIt-Anchor">#</a> 参考<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><a href="https://webglfundamentals.org/webgl/lessons/zh_cn/" target="_blank" style="background-color:#e7f9e2" class="std-link --fontSansSerif  _block" data-minimap-color="#e7f9e2"><span class="std-link-icon r-link" data-src="/get-favicon/webglfundamentals.org?h=1865807710" style="background-image:url(&quot;/get-favicon/webglfundamentals.org?h=1865807710&quot;)"></span><span class="std-link-txt">WebGL 理论基础 - 中文版</span></a></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><a href="https://zhuanlan.zhihu.com/p/465212097" target="_blank" style="background-color:#e3f0e4" class="std-link --fontSansSerif  _block" data-minimap-color="#e3f0e4"><span class="std-link-icon r-link" data-src="/get-favicon/zhuanlan.zhihu.com?h=-1773752767" style="background-image:url(&quot;/get-favicon/zhuanlan.zhihu.com?h=-1773752767&quot;)"></span><span class="std-link-txt">WebGL - 手抓手梳理渲染管线流程</span></a></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><a href="https://zhuanlan.zhihu.com/p/438742595" target="_blank" style="background-color:#f3e8dc" class="std-link --fontSansSerif  _block" data-minimap-color="#f3e8dc"><span class="std-link-icon r-link" data-src="/get-favicon/zhuanlan.zhihu.com?h=-4193751608" style="background-image:url(&quot;/get-favicon/zhuanlan.zhihu.com?h=-4193751608&quot;)"></span><span class="std-link-txt">初识 WebGL ：渲染管线</span></a></div></div></article></div></div><div class="smcphr rally-page-smcphr"></div><div class="std-box rally-giscus-wrapper default-max-width"><div class="std-box-content "></div></div></div>
<script>window.__INITIAL_STATE__ = {"CategoryApiState":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"BlogApiState":{"loaded":true,"loading":false,"error":null,"dataMap":{"white-noise-webgl":{"type":"tsx","meta":{"id":"white-noise-webgl","title":"从白噪声开始学习 WebGL","author":"eczn","time":"2023-03-28T16:34:00.000Z","type":"article","appTitle":"","appIcon":"","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},"tsxDistPath":"./white-noise/index.blog.js","ssrContent":"<div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">本文介绍白噪声生成, Audio 和 Pixel: </div><div class=\"std-para --fontArticle para-center\" data-minimap-color=\"#CCCCCC\"><canvas width=\"50\" height=\"240\"></canvas></div><div class=\"button-main --fontSansSerif  normal\" style=\"font-size:inherit\"><span>播放</span></div><h1 id=\"white-noise-audio\" class=\"std-title --fontTitle\"><a href=\"#white-noise-audio\" class=\"markdownIt-Anchor\">#</a> 声音怎么实现<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">利用 WebAudio 播放即可，不是本文重点</div><h1 id=\"implementation-idea\" class=\"std-title --fontTitle\"><a href=\"#implementation-idea\" class=\"markdownIt-Anchor\">#</a> Canvas 绘制思路<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">画白噪声单个像素点很容易, 利用 Math.random() 生成随机数即可。</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">然后将这个函数应用到 canvas 画布全部点上即可绘制出来一帧，最后让其动起来即可，具体实现如下:</div><div class=\"std-code\"><pre  class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span>__NO_CODE__</pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">最后在合适的地方 new WhiteNoiseCanvas() 并 init() 即可</div><div class=\"std-para --fontArticle para-center\" data-minimap-color=\"#CCCCCC\"><canvas width=\"50\" height=\"240\"></canvas></div><div class=\"button-main --fontSansSerif  normal\" style=\"font-size:inherit\"><span>播放 (移动端慎点, 卡)</span></div><h1 id=\"webgl-vs-canvas\" class=\"std-title --fontTitle\"><a href=\"#webgl-vs-canvas\" class=\"markdownIt-Anchor\">#</a> WebGL 还是 Canvas<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">上段内容大致描述了绘制过程, 很明显上述过程涉及到遍历全部点的过程, 典型的计算密集型应用。这种场景小尺寸图片画布还好，如果需要绘制 4K 画布的时候就卡的不行了，我们需要一个更高性能的方案 —— webgl, 借助显卡加速来绘制</div><h1 id=\"webgl-render-pipeline\" class=\"std-title --fontTitle\"><a href=\"#webgl-render-pipeline\" class=\"markdownIt-Anchor\">#</a> WebGL 渲染管线<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">大致说来说，渲染管线是渲染像素的整个流程，如图：</div><div class=\"std-img-dynamic-wrapper --fontArticle\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:71.31%\"><div class=\"std-img-dymanic-main __texttip __loading\">loading...</div><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/webgl-render-pipeline.aad3a26495389523.svg\"/></div></div><h2 id=\"vertex-shader\" class=\"std-title --fontTitle\">顶点着色器 (Vertex shader)</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">通过编写顶点着色器可以让 GPU 帮你做顶点的坐标变换，在 3D 里面可以据此实现摄像机 (Camara)，实现镜头跟踪等特性。</div><div class=\"std-img-dynamic-wrapper --fontArticle\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:36.97%\"><div class=\"std-img-dymanic-main __texttip __loading\">loading...</div><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/webgl-vertex-shader.ad3146640b98f138.svg\"/></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">在 2D 场景下，这里变换主要是放大缩小等常用变换</div><h2 id=\"primitive-assembly\" class=\"std-title --fontTitle\">图元装配 (Primitive assembly)</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">图元装配是将顶点着色器中输出的顶点组装成指定的图元，直觉上对应物体的 “面”:</div><div class=\"std-img-dynamic-wrapper --fontArticle\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:20.04%\"><div class=\"std-img-dymanic-main __texttip __loading\">loading...</div><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/webgl-assembly-mode.ce0800bc2bf1b6f9.svg\"/></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">上图没有列出全部的图元装配模式，在本例里只需要三角形 TRIANGLES 即可</div><h2 id=\"rasterization\" class=\"std-title --fontTitle\">光栅化 (Rasterization)</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">将装配好的矢量的图元离散化/像素化，变成由像素组成的图元，这个过程称为光栅化，具体来说：</div><ul class=\"numbering-main\" data-minimap-color=\"#DDDDDD\"><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">管线在光栅化过程中使用了一些光栅化的算法，选择出在图元边界所包围的像素点，最终组成片元。常用的光栅化算法如Bresenham光栅化算法等。</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">如果在顶点着色器中的顶点中设置例如颜色，法线等属性，在光栅化过程对基于顶点对各个像素点做线性插值。</div></li></ul><h2 id=\"fragment-shader\" class=\"std-title --fontTitle\">片段着色器 (Fragment shader)</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">进一步处理上一步光栅化得到的图片像素片段</div><h2 id=\"testing-and-blending\" class=\"std-title --fontTitle\">混合和测试 (Testing and blending)</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">这一步会将片段着色器传过来的片段做测试，测试失败的像素直接删除，测试成功的点去保留，并最终渲染到屏幕上。</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">常见的测试主要包括模版测试和深度测试，通过深度测试可以实现物体面的前后顺序，具体不展开了，我这里的白噪声不需要这个。</div><h1 id=\"tutorial-coding-glsl-shader\" class=\"std-title --fontTitle\"><a href=\"#tutorial-coding-glsl-shader\" class=\"markdownIt-Anchor\">#</a> 快速入门 GLSL 编写着色器<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">着色器 (shader) 是一种 GPU 程序, 由 GPU 负责执行。GLSL 即 OpenGL Shading Language, 可以用来编写着色器。</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">GLSL 采用了类 C 的语法，并提供了若干方便的数据结构和选择器，通过 uniform 全局变量将相关参数传入 GLSL 上下文中。</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">这里以本例子里用到的顶点着色器为例说明</div><div class=\"std-code\"><pre  class=\"prismjs glsl rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token keyword\">attribute</span> <span class=\"token keyword\">vec4</span> position<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>  gl_Position <span class=\"token operator\">=</span> position<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token punctuation\">}</span></pre></div><h2 id=\"glsl-main\" class=\"std-title --fontTitle\">main 函数</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">你懂的, 执行入口</div><h2 id=\"glsl-vec4\" class=\"std-title --fontTitle\">vec4 是什么</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">vec4 是一种数据结构，表示一个四维向量, 你可以将它想象为这个结构:</div><div class=\"std-code\"><pre  class=\"prismjs ts rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token keyword\">interface</span> <span class=\"token class-name\">vec4</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span>  x<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>  y<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span>  z<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span>  w<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 远近</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span><span class=\"token punctuation\">}</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">此外还有 vec3, vec2, 这两个是在 vec4 上减去 w 和 z 得到。</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">这里提一下选择器这个概念: (语法糖)</div><div class=\"std-code\"><pre  class=\"prismjs glsl rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">// 构造一个 vec4 存储在 a 变量中</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token keyword\">vec4</span> a <span class=\"token operator\">=</span> <span class=\"token keyword\">vec4</span><span class=\"token punctuation\">(</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token keyword\">vec3</span> b <span class=\"token operator\">=</span> a<span class=\"token punctuation\">.</span>xyz<span class=\"token punctuation\">;</span> <span class=\"token comment\">// (1, 2, 3)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token keyword\">vec2</span> c <span class=\"token operator\">=</span> a<span class=\"token punctuation\">.</span>xy<span class=\"token punctuation\">;</span> <span class=\"token comment\">// (1, 2)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span><span class=\"token keyword\">vec2</span> d <span class=\"token operator\">=</span> a<span class=\"token punctuation\">.</span>yz<span class=\"token punctuation\">;</span> <span class=\"token comment\">// (2, 1) 选择 y z 维并作为 vec2 返回</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">可以通过在变量名后面接 .xyz 的方式快速选择其中的几个维度出来</div><h2 id=\"glsl-attribute\" class=\"std-title --fontTitle\">attribute 属性</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">attribute 标记的变量说明这个变量的取值是从 &quot;缓冲&quot; 取的</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">具体来说，缓冲是是 js 这边发送到 GPU 的一段二进制数据序列，通常情况下缓冲数据包括位置，法向量，纹理坐标，顶点颜色值等，除此之外，缓冲还可以存储任何数据，因为它本质就是一段 buffer</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">而具体到如何从 &quot;缓冲&quot; 得到 &quot;vec4&quot; 这件事，则需要通过 js 进行定义：</div><div class=\"std-code\"><pre  class=\"prismjs glsl rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token keyword\">const</span> canvas <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token char\">'canvas'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token keyword\">const</span> gl <span class=\"token operator\">=</span> canvas<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token char\">'webgl'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token comment\">// 开辟一块缓冲</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span><span class=\"token keyword\">const</span> positionBuffer <span class=\"token operator\">=</span> gl<span class=\"token punctuation\">.</span><span class=\"token function\">createBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span>gl<span class=\"token punctuation\">.</span><span class=\"token function\">bindBuffer</span><span class=\"token punctuation\">(</span>gl<span class=\"token punctuation\">.</span>ARRAY_BUFFER<span class=\"token punctuation\">,</span> positionBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span><span class=\"token comment\">// 取得访问到 position 变量的 location</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span><span class=\"token keyword\">const</span> positionAttributeLocation <span class=\"token operator\">=</span> gl<span class=\"token punctuation\">.</span><span class=\"token function\">getAttribLocation</span><span class=\"token punctuation\">(</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span>  program<span class=\"token punctuation\">,</span> <span class=\"token comment\">// program 为 glsl 编译后的实例, 这里先忽略</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">10</span>  <span class=\"token char\">'position'</span> <span class=\"token comment\">// 对应 glsl 程序里的 position 变量名</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">12</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">13</span><span class=\"token comment\">// 用 ts 定义顶点数据 (x,y,z) 一共 3 个点, 数组长度为 9 </span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">14</span><span class=\"token keyword\">const</span> vertices<span class=\"token operator\">:</span> number<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">15</span>  <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">16</span>  <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">17</span>   <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">18</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">19</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">20</span><span class=\"token comment\">// 写入到缓冲 buffer 中</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">21</span>gl<span class=\"token punctuation\">.</span><span class=\"token function\">bufferData</span><span class=\"token punctuation\">(</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">22</span>  gl<span class=\"token punctuation\">.</span>ARRAY_BUFFER<span class=\"token punctuation\">,</span>            <span class=\"token comment\">// 表明是 ARRAY_BUFFER</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">23</span>  new <span class=\"token function\">Float32Array</span><span class=\"token punctuation\">(</span>vertices<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 构造为 Float32Array 格式</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">24</span>  gl<span class=\"token punctuation\">.</span>STATIC_DRAW<span class=\"token punctuation\">,</span>             <span class=\"token comment\">// 我们不会经常改这个顶点数据</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">25</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">26</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">27</span><span class=\"token comment\">// 启用 position 属性</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">28</span>gl<span class=\"token punctuation\">.</span><span class=\"token function\">enableVertexAttribArray</span><span class=\"token punctuation\">(</span>positionAttributeLocation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">29</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">30</span><span class=\"token comment\">// 告诉如何从缓冲中取值并写到 position 变量上</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">31</span>gl<span class=\"token punctuation\">.</span><span class=\"token function\">vertexAttribPointer</span><span class=\"token punctuation\">(</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">32</span>  positionAttributeLocation<span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">33</span>  <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// vertices 数组中每三个赋值到 vec4 position 上</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">34</span>     <span class=\"token comment\">// 因此会少一个 w, glsl 会补一个默认值 0</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">35</span>  gl<span class=\"token punctuation\">.</span>FLOAT<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 浮点类型</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">36</span>  <span class=\"token keyword\">false</span><span class=\"token punctuation\">,</span>    <span class=\"token comment\">// 不需要归一化数据</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">37</span>  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>        <span class=\"token comment\">// 每次迭代运行运动多少内存到下一个数据开始点</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">38</span>            <span class=\"token comment\">// 这里 0 代表 单位数量 * 每个单位占用内存 sizeof(type)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">39</span>  <span class=\"token number\">0</span>         <span class=\"token comment\">// 从缓冲起始位置开始读取</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">40</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">可以看见，一般的做法是利用 js 定义顶点数据传入缓冲，并定义属性获取方式，通常定义为三个三个的获取，最后在顶点着色器中就可以使用 position 变量了</div><h2 id=\"glsl-gl_Position\" class=\"std-title --fontTitle\">gl_Position</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">通过赋值内置变量 gl_Position 来告诉外部本次顶点变换后的结果, 在这里可以看见我们没有做任何顶点变换，直接将从缓冲得到的顶点透传出去了。</div><h1 id=\"webgl-wh-render-ideas\" class=\"std-title --fontTitle\"><a href=\"#webgl-wh-render-ideas\" class=\"markdownIt-Anchor\">#</a> WenGL 绘制思路<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">根据前文提到的渲染管线进行思考，用三个顶点绘制出三角形，然后利用片段着色器随机填充三角形即可</div><div class=\"std-img-dynamic-wrapper --fontArticle\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:23.77%\"><div class=\"std-img-dymanic-main __texttip __loading\">loading...</div><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/webgl-wh-render-ideas.7f946c99fd0bfe6e.svg\"/></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">你可能会问三角形不对，那么可以再加一个三角形构成一个正方形。</div><h1 id=\"white-noise-vertex-shader\" class=\"std-title --fontTitle\"><a href=\"#white-noise-vertex-shader\" class=\"markdownIt-Anchor\">#</a> 白噪声顶点着色器<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">因为不需要什么特殊的顶点处理，所以顶点着色器只需要从缓冲中取得对应点即可</div><div class=\"std-code\"><pre  class=\"prismjs glsl rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token keyword\">attribute</span> <span class=\"token keyword\">vec4</span> position<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>  gl_Position <span class=\"token operator\">=</span> position<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token punctuation\">}</span></pre></div><h1 id=\"white-noise-fragment-shader\" class=\"std-title --fontTitle\"><a href=\"#white-noise-fragment-shader\" class=\"markdownIt-Anchor\">#</a> 白噪声片段着色器<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-code\"><pre  class=\"prismjs glsl rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">// 定义片段着色器</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">GL_ES</span></span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token keyword\">precision</span> <span class=\"token keyword\">mediump</span> <span class=\"token keyword\">float</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span><span class=\"token keyword\">uniform</span> <span class=\"token keyword\">float</span> u_rand<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span><span class=\"token keyword\">uniform</span> <span class=\"token keyword\">float</span> u_size<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span><span class=\"token comment\">// 随机输出一个在 0 和 1 之间的数</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span><span class=\"token comment\">// 这是一个很有意思的随机数生成,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">10</span><span class=\"token comment\">// 具体原理可以 google 下</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">11</span><span class=\"token keyword\">float</span> <span class=\"token function\">random2d</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">vec2</span> co<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">12</span>  <span class=\"token keyword\">float</span> a <span class=\"token operator\">=</span> <span class=\"token number\">12.9898</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">13</span>  <span class=\"token keyword\">float</span> b <span class=\"token operator\">=</span> <span class=\"token number\">78.233</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">14</span>  <span class=\"token keyword\">float</span> c <span class=\"token operator\">=</span> <span class=\"token number\">43758.5453</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">15</span>  <span class=\"token comment\">// dot 为点乘</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">16</span>  <span class=\"token comment\">// dt = (co.x * a) + (co.y * b)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">17</span>  <span class=\"token keyword\">float</span> dt <span class=\"token operator\">=</span> <span class=\"token function\">dot</span><span class=\"token punctuation\">(</span>co<span class=\"token punctuation\">.</span>xy<span class=\"token punctuation\">,</span> <span class=\"token keyword\">vec2</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">18</span>  <span class=\"token keyword\">float</span> sn <span class=\"token operator\">=</span> <span class=\"token function\">mod</span><span class=\"token punctuation\">(</span>dt<span class=\"token punctuation\">,</span> <span class=\"token number\">3.14</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">19</span>  <span class=\"token keyword\">return</span> <span class=\"token function\">fract</span><span class=\"token punctuation\">(</span><span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>sn<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">20</span><span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">21</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">22</span><span class=\"token comment\">// 将 x 定在 x - (x % u_size) 区间内</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">23</span><span class=\"token keyword\">float</span> <span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">24</span>  <span class=\"token keyword\">return</span> x <span class=\"token operator\">-</span> <span class=\"token function\">mod</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> u_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">25</span><span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">26</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">27</span><span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">28</span>  <span class=\"token comment\">// gl_FragCoord 代表当前处理的片元坐标</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">29</span>  <span class=\"token comment\">// round函数为 四舍五入</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">30</span>  <span class=\"token keyword\">vec2</span> coord <span class=\"token operator\">=</span> <span class=\"token keyword\">vec2</span><span class=\"token punctuation\">(</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">31</span>    <span class=\"token function\">round</span><span class=\"token punctuation\">(</span>gl_FragCoord<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">32</span>    <span class=\"token function\">round</span><span class=\"token punctuation\">(</span>gl_FragCoord<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">33</span>  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">34</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">35</span>  <span class=\"token keyword\">float</span> num <span class=\"token operator\">=</span> <span class=\"token function\">random2d</span><span class=\"token punctuation\">(</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">36</span>    <span class=\"token keyword\">vec2</span><span class=\"token punctuation\">(</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">37</span>      coord<span class=\"token punctuation\">.</span>x <span class=\"token operator\">*</span> u_rand<span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">38</span>      coord<span class=\"token punctuation\">.</span>y <span class=\"token operator\">*</span> u_rand\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">39</span>    <span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">40</span>  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">41</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">42</span>  <span class=\"token comment\">// num 大于 0.5 的话归到 1.0 否则归到 0</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">43</span>  <span class=\"token keyword\">float</span> p <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">></span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token number\">1.0</span> <span class=\"token operator\">:</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">44</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">45</span>  <span class=\"token comment\">// 构成一个 vec4 并通过 gl_FragColor 输出 (rgba 四个值)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">46</span>  gl_FragColor <span class=\"token operator\">=</span> <span class=\"token keyword\">vec4</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">47</span><span class=\"token punctuation\">}</span></pre></div><h1 id=\"ts-webgl-programming\" class=\"std-title --fontTitle\"><a href=\"#ts-webgl-programming\" class=\"markdownIt-Anchor\">#</a> WebGL 编程<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-code\"><pre  class=\"prismjs ts rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span>__NO_CODE__</pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">最后 new WhiteNoiseWebgl() 并调用 init 即可</div><div class=\"std-code\"><pre  class=\"prismjs ts rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> whiteNoiseWebgl <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./white-noise-webgl'</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token keyword\">const</span> canvas <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'canvas'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span>document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>canvas<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span>canvas<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span>innerWidth <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span>canvas<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span>innerHeight <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span><span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">whiteNoiseWebgl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span>instance<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span>canvas<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></div><div class=\"std-para --fontArticle para-center\" data-minimap-color=\"#CCCCCC\"><canvas height=\"240\"></canvas></div><div class=\"button-main --fontSansSerif  normal\" style=\"font-size:inherit\"><span>播放</span></div><h1 id=\"links\" class=\"std-title --fontTitle\"><a href=\"#links\" class=\"markdownIt-Anchor\">#</a> 参考<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><a href=\"https://webglfundamentals.org/webgl/lessons/zh_cn/\" target=\"_blank\" style=\"background-color:#e7f9e2\" class=\"std-link --fontSansSerif  _block\" data-minimap-color=\"#e7f9e2\"><span class=\"std-link-icon r-link\" data-src=\"/get-favicon/webglfundamentals.org?h=1865807710\" style=\"background-image:url(&quot;/get-favicon/webglfundamentals.org?h=1865807710&quot;)\"></span><span class=\"std-link-txt\">WebGL 理论基础 - 中文版</span></a></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><a href=\"https://zhuanlan.zhihu.com/p/465212097\" target=\"_blank\" style=\"background-color:#e3f0e4\" class=\"std-link --fontSansSerif  _block\" data-minimap-color=\"#e3f0e4\"><span class=\"std-link-icon r-link\" data-src=\"/get-favicon/zhuanlan.zhihu.com?h=-1773752767\" style=\"background-image:url(&quot;/get-favicon/zhuanlan.zhihu.com?h=-1773752767&quot;)\"></span><span class=\"std-link-txt\">WebGL - 手抓手梳理渲染管线流程</span></a></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><a href=\"https://zhuanlan.zhihu.com/p/438742595\" target=\"_blank\" style=\"background-color:#f3e8dc\" class=\"std-link --fontSansSerif  _block\" data-minimap-color=\"#f3e8dc\"><span class=\"std-link-icon r-link\" data-src=\"/get-favicon/zhuanlan.zhihu.com?h=-4193751608\" style=\"background-image:url(&quot;/get-favicon/zhuanlan.zhihu.com?h=-4193751608&quot;)\"></span><span class=\"std-link-txt\">初识 WebGL ：渲染管线</span></a></div>","props":{"fileWhiteNoiseWebgl":"import shaderVertexSource from './shader-vertex-source.glsl';\nimport shaderFragmentSource from './shader-fragment-source.glsl';\n\nexport class WhiteNoiseWebgl {\n  private stop = true;\n  private inited = false;\n  private canvas: HTMLCanvasElement | null = null;\n  private gl: WebGLRenderingContext | null = null;\n  private uSize = 4;\n\n  public play = () => {\n    this.stop = !this.stop;\n  }\n\n  public init = (canvas: HTMLCanvasElement) => {\n    this.stop = true;\n    this.inited = true;\n    this.canvas = canvas;\n    const gl = canvas.getContext('webgl')!;\n    this.gl = gl;\n\n    // 视口\n    gl.viewport(0, 0, canvas.width, canvas.height);\n\n    // 创建并编译顶点着色器\n    const vertexShader = gl.createShader(gl.VERTEX_SHADER)!;\n    gl.shaderSource(vertexShader, shaderVertexSource);\n    gl.compileShader(vertexShader); // 编译\n\n    // 编译错误的话打 log\n    if (!gl.getShaderParameter(vertexShader, gl.COMPILE_STATUS)) {\n      console.error(gl.getShaderInfoLog(vertexShader));\n    }\n\n    // 创建并编译片段着色器\n    const fragmentShader = gl.createShader(gl.FRAGMENT_SHADER)!;\n    gl.shaderSource(fragmentShader, shaderFragmentSource);\n    gl.compileShader(fragmentShader); // 编译\n\n    // 编译错误的话打 log\n    if (!gl.getShaderParameter(fragmentShader, gl.COMPILE_STATUS)) {\n      console.error(gl.getShaderInfoLog(fragmentShader));\n    }\n\n    // 创建程序, 并将两个着色器放上去, 最后跟 gl 上下文绑定\n    const program = gl.createProgram()!;\n    gl.attachShader(program, vertexShader);\n    gl.attachShader(program, fragmentShader);\n    gl.linkProgram(program);\n\n    // 错误处理\n    if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {\n      console.error(gl.getProgramInfoLog(program));\n    }\n\n    // 启用 program\n    gl.useProgram(program);\n\n    // 获取顶点着色器的位置属性\n    const positionAttributeLocation = gl.getAttribLocation(program, 'position');\n    const positionBuffer = gl.createBuffer();\n    gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);\n\n    // 定义顶点数据\n    const vertices: number[] = [\n      -1,  1,  0, // 第一个三角形\n      -1, -1,  0,\n       1, -1,  0,\n\n       1, -1,  0, // 第二个三角形\n       1,  1,  0,\n      -1,  1,  0,\n    ];\n\n    // 写入到缓冲 buffer 中\n    gl.bufferData(\n      gl.ARRAY_BUFFER,            // 表明是 ARRAY_BUFFER\n      new Float32Array(vertices), // 构造为 Float32Array 格式\n      gl.STATIC_DRAW,             // 我们不会经常改这个顶点数据\n    );\n    \n    // 启用 position 属性\n    gl.enableVertexAttribArray(positionAttributeLocation);\n\n    // 告诉如何从缓冲中取值并写到 position 变量上\n    gl.vertexAttribPointer(\n      positionAttributeLocation,\n      3, // vertices 数组中每三个赋值到 vec4 position 上\n         // 因此会少一个 w, glsl 会补一个默认值 0\n      gl.FLOAT, // 浮点类型\n      false,    // 不需要归一化数据\n      0,        // 每次迭代运行运动多少内存到下一个数据开始点\n                // 这里 0 代表 单位数量 * 每个单位占用内存 sizeof(type)\n      0         // 从缓冲起始位置开始读取\n    );\n\n    // 获取 uniform 变量的位置\n    // 通过这种方式可以访问到片段着色器里的\n    // u_rand 和 u_size 这两个全局变量\n    const randUniformLocation = gl.getUniformLocation(\n      program, 'u_rand'\n    )!;\n    const sizeUniformLocation = gl.getUniformLocation(\n      program, 'u_size'\n    )!;\n\n    // 绘制一帧\n    const render = () => {\n      // 传递 u_rand 参数到着色器\n      gl.uniform1f(randUniformLocation, Math.random());\n\n      // 传递 u_size 参数到着色器\n      gl.uniform1f(sizeUniformLocation, this.uSize);\n  \n      // 清空画布\n      gl.clearColor(0, 0, 0, 1);\n      gl.clear(gl.COLOR_BUFFER_BIT);\n\n      gl.drawArrays(\n        gl.TRIANGLES, // gl.TRIANGLES 方式进行图元组合\n        0, // 从 0 开始\n        6  // 6 个顶点\n      );\n    }\n\n    const animate = () => {\n      // deinit 结束后动画要暂停\n      if (!this.inited) return;\n\n      if (this.stop) {\n        setTimeout(animate, 50);\n        return;\n      }\n\n      render();\n      requestAnimationFrame(animate);\n    }\n\n    render();\n    animate();\n  }\n\n  public deinit = () => {\n    this.inited = true;\n    this.stop = true;\n    this.canvas = null;\n    this.gl = null;\n  }\n}\n","fileWhiteNoiseCanvas":"import React from 'react';\n\nexport class WhiteNoiseCanvas {\n  private canvas: HTMLCanvasElement | null = null;\n  private g: CanvasRenderingContext2D | null = null;\n  private stop = true;\n  private inited = false;\n\n  public init = (canvas: HTMLCanvasElement) => {\n    this.canvas = canvas;\n    this.g = canvas.getContext('2d')!;\n    this.inited = true;\n\n    // 先绘制一帧, 绘制后暂停\n    this.stop = false;\n    this.render();\n    this.stop = true;\n\n    const animate = () => {\n      // deinit 后结束动画\n      if (!this.inited) return;\n\n      this.render();\n      requestAnimationFrame(animate);\n    }\n\n    animate();\n  }\n\n  public play = () => {\n    this.stop = !this.stop;\n  }\n\n  public deinit = () => {\n    this.inited = false;\n    this.g = null;\n    this.canvas = null;\n  }\n\n  private render = () => {\n    const { g, canvas, stop } = this;\n    if (stop) return; // 说明暂停\n    if (\n      !this.inited\n      || !g\n      || !canvas\n    ) return console.warn('no init');\n\n    // 建一张空白图像\n    const image = g.createImageData(\n      canvas.width,\n      canvas.height\n    );\n\n    // 遍历图像的每一个像素\n    const pixcels = canvas.width * canvas.height;\n    for (let i = 0; i < pixcels; i += 1) {\n      const noise = Math.random() * 255;\n      const d = noise > 127 ? 255 : 0;\n      image.data[i * 4] = d;\n      image.data[i * 4 + 1] = d;\n      image.data[i * 4 + 2] = d;\n      image.data[i * 4 + 3] = 255;\n    }\n\n    // 吧图像绘制到 canvas 上\n    g.putImageData(image, 0, 0);\n  }\n}\n"},"tocStack":[{"id":"white-noise-audio","level":1,"text":"声音怎么实现"},{"id":"implementation-idea","level":1,"text":"Canvas 绘制思路"},{"id":"webgl-vs-canvas","level":1,"text":"WebGL 还是 Canvas"},{"id":"webgl-render-pipeline","level":1,"text":"WebGL 渲染管线"},{"id":"vertex-shader","level":2,"text":"顶点着色器 (Vertex shader)"},{"id":"primitive-assembly","level":2,"text":"图元装配 (Primitive assembly)"},{"id":"rasterization","level":2,"text":"光栅化 (Rasterization)"},{"id":"fragment-shader","level":2,"text":"片段着色器 (Fragment shader)"},{"id":"testing-and-blending","level":2,"text":"混合和测试 (Testing and blending)"},{"id":"tutorial-coding-glsl-shader","level":1,"text":"快速入门 GLSL 编写着色器"},{"id":"glsl-main","level":2,"text":"main 函数"},{"id":"glsl-vec4","level":2,"text":"vec4 是什么"},{"id":"glsl-attribute","level":2,"text":"attribute 属性"},{"id":"glsl-gl_Position","level":2,"text":"gl_Position"},{"id":"webgl-wh-render-ideas","level":1,"text":"WenGL 绘制思路"},{"id":"white-noise-vertex-shader","level":1,"text":"白噪声顶点着色器"},{"id":"white-noise-fragment-shader","level":1,"text":"白噪声片段着色器"},{"id":"ts-webgl-programming","level":1,"text":"WebGL 编程"},{"id":"links","level":1,"text":"参考"}]}}},"HomeApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"TimeLineApiState":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"SettingApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"LaunchpadApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}}}</script>
<!--SCRIPT-->
</body>
</html>
