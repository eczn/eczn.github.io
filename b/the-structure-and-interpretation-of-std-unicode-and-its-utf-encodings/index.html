<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<title>Unicode 标准及其 UTF 编码的构造和解释 | Eczn's Home</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,minimal-ui">
<meta name="format-detection" content="telephone=no">

<style id="CSS_VARS"></style>
<script>
(function() {
console.log('INIT CSS VAR');
function loadCSSVars() {
    const j = localStorage.getItem("CSS_VARS_2" /* STORAGE_KEY.CSS_VARS */);
    const initialVars = initialCSSVars();
    if (!j)
        return initialVars;
    try {
        const result = {
            ...initialVars,
            ...JSON.parse(j)
        };
        console.log('loadCSSVars from storage', result);
        return result;
    }
    catch (error) {
        console.error('load css vars with error', error);
        return initialVars;
    }
}
function renderCSSVars(vars, style) {
    const allDefine = Object.keys(vars).map(k => {
        const v = vars[k];
        const cssValue = typeof v === 'number' ? `${v}px` : v;
        return `--${k}:${cssValue};`;
    }).join('\n');
    if (style) {
        style.innerHTML = `:root { ${allDefine} }`;
    }
    else {
        console.error(`style#CSS_VARS NotFound !`);
    }
}
function initialCSSVars() {
    let rem = 16;
    // 移动端
    if (typeof window !== 'undefined' && window.innerWidth <= 500) {
        rem = Number(((window.innerWidth - 20) / 42).toFixed(1));
        console.log('mobile calculated rem =>', rem);
    }
    return {
        rem,
        enableSmallerFont: false,
        displayToc: 'block',
        fontSmcp: 'source serif pro, serif',
        fontCode: 'consolas, Menlo, monospace',
        fontTitle: 'Noto Serif SC, serif',
        fontArticle: 'source serif pro, LXGW WenKai',
        fontSansSerif: 'sans-serif',
    };
}
window.__initialCSSVars = loadCSSVars();
renderCSSVars(__initialCSSVars, document.querySelector('#CSS_VARS'));
})();
</script>

<link rel="icon" href="/favicon.png"><script defer="defer" src="/js/index.19a91e5a.js"></script><script defer="defer" src="/js/chunk-lib.c90ce4c7.js"></script><link href="/css/index.a1e203ee6781e5bf7bb4.css" rel="stylesheet"><link href="/css/chunk-lib.5c7d4887bb8714b00c54.css" rel="stylesheet"></head>
<body x-apple-data-detectors="none">
<noscript>当前浏览器不支持 JavaScript, 建议使用支持 JavaScript 的浏览器来访问此网站 !</noscript>
<div id="rally-bg" style="opacity:0"></div>
<div id="app"><div class="ball-canvas-container"></div><nav class="nav-main --fontSmcp"><div class="_title default-max-width">Eczn&#x27;s Home</div><div class="smcphr"></div><div class="_links default-max-width"><a class="r-link _link clickable r-link" href="/">Home</a><a class="r-link _link clickable r-link" href="/tl/0/">Timeline</a><a class="r-link _link clickable r-link" href="/cate/all/">Category</a><a class="r-link _link clickable r-link" href="/setting/">Setting</a><a class="r-link _link clickable r-link" href="/launchpad/">Launchpad</a></div></nav><div class="std-box rally-page-content default-max-width"><div id="blog-box" class="std-box-content "><div id="start" class="blog-header-main"><div class="_infos"><div class="_info"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="clock" class="svg-inline--fa fa-clock fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256,8C119,8,8,119,8,256S119,504,256,504,504,393,504,256,393,8,256,8Zm92.49,313h0l-20,25a16,16,0,0,1-22.49,2.5h0l-67-49.72a40,40,0,0,1-15-31.23V112a16,16,0,0,1,16-16h32a16,16,0,0,1,16,16V256l58,42.5A16,16,0,0,1,348.49,321Z"></path></svg>2024-03-31</div></div><div class="_title --fontTitle">Unicode 标准及其 UTF 编码的构造和解释</div></div><article class="r-article-wrapper"><div class="toc-wrapper"><div class="toc"><div class="toc-item _active" style="padding-left:0em"><a href="#what-is-unicode" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>Unicode 是什么 ?</a></div><div class="toc-item" style="padding-left:1em"><a href="#unicode-码点-(code-point)" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>Unicode 码点 (Code Point)</a></div><div class="toc-item" style="padding-left:1em"><a href="#unicode-编码空间-(encoding-space)" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>Unicode 编码空间 (Encoding-Space)</a></div><div class="toc-item" style="padding-left:1em"><a href="#unicode-平面划分-(plane)" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>Unicode 平面划分 (Plane)</a></div><div class="toc-item" style="padding-left:1em"><a href="#unicode-区块-(block)" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>Unicode 区块 (block)</a></div><div class="toc-item" style="padding-left:0em"><a href="#UTF-8" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>UTF-32</a></div><div class="toc-item" style="padding-left:0em"><a href="#UTF-16" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>UTF-16</a></div><div class="toc-item" style="padding-left:1em"><a href="#实现-utf16encodecodepoint" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>实现 utf16EncodeCodePoint</a></div><div class="toc-item" style="padding-left:1em"><a href="#utf-16-demo" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>UTF-16 Demo</a></div><div class="toc-item" style="padding-left:0em"><a href="#utf-16-in-js" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>题外话: JavaScript 里的 UTF-16</a></div><div class="toc-item" style="padding-left:1em"><a href="#如何直接用-unicode-码点来构造-string-?" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>如何直接用 unicode 码点来构造 string ?</a></div><div class="toc-item" style="padding-left:1em"><a href="#🍰.length-为什么是-2-的问题" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>&#x27;🍰&#x27;.length 为什么是 2 的问题</a></div><div class="toc-item" style="padding-left:1em"><a href="#.split()-并不能很好的识别-utf-16-内的字符" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>.split(&#x27;&#x27;) 并不能很好的识别 UTF-16 内的字符</a></div><div class="toc-item" style="padding-left:1em"><a href="#如何将一段-string-转为码点数组-?" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>如何将一段 string 转为码点数组 ?</a></div><div class="toc-item" style="padding-left:0em"><a href="#ucs2-utf16" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>UCS-2 与 UTF-16 的关系</a></div><div class="toc-item" style="padding-left:0em"><a href="#UTF-8" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>UTF-8</a></div><div class="toc-item" style="padding-left:1em"><a href="#utf-8-demo" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>UTF-8 Demo</a></div><div class="toc-item" style="padding-left:0em"><a href="#look-back-to-std-unicode" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>回头看 Unicode 标准</a></div><div class="toc-item" style="padding-left:1em"><a href="#acr:-abstract-character-repertoire-(抽象字符表)-" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>ACR: Abstract Character Repertoire (抽象字符表) </a></div><div class="toc-item" style="padding-left:1em"><a href="#ccs:-coded-character-set-(编码字符集)-" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>CCS: Coded Character Set (编码字符集) </a></div><div class="toc-item" style="padding-left:1em"><a href="#cef:-character-encoding-form-(字符编码方式)-" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>CEF: Character Encoding Form (字符编码方式) </a></div><div class="toc-item" style="padding-left:1em"><a href="#ces:-character-encoding-scheme-(字符编码方案)" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>CES: Character Encoding Scheme (字符编码方案)</a></div><div class="toc-item" style="padding-left:1em"><a href="#tes:-transfer-encoding-syntax-(传输编码句法)" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>TES: Transfer Encoding Syntax (传输编码句法)</a></div><div class="toc-item" style="padding-left:0em"><a href="#-2853124934" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>注意力大集中</a></div><div class="toc-item" style="padding-left:1em"><a href="#中文字符码点连续性问题" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>中文字符码点连续性问题</a></div><div class="toc-item" style="padding-left:1em"><a href="#utf-16-高/低代理打洞的问题" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>UTF-16 高/低代理打洞的问题</a></div><div class="toc-item" style="padding-left:1em"><a href="#utf-24-可行性？" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>UTF-24 可行性？</a></div><div class="toc-item" style="padding-left:1em"><a href="#如何在第一个字节区分是-utf-8-还是-ascii" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>如何在第一个字节区分是 UTF-8 还是 ASCII</a></div><div class="toc-item" style="padding-left:1em"><a href="#utf-8-字节流传输截断问题" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>UTF-8 字节流传输截断问题</a></div><div class="toc-item" style="padding-left:2em"><a href="#进程-stdout-拼接问题" data-minimap-color="#CCCCCC"><span class="_hashtag">###</span>进程 stdout 拼接问题</a></div><div class="toc-item" style="padding-left:0em"><a href="#EOF" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>EOF</a></div><div class="_index --fontSmcp" data-minimap="Ignore">Indexes</div><div class="smcphr"></div></div></div><div class="r-article"><div class="std-img-dynamic-wrapper" style="width:5em;float:right;margin-left:1em"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:100.00%"><div class="std-img-dymanic-main __texttip __loading">loading...</div><img class="std-img-dymanic-main" src="/tsxs-esm/apple.718fff3e244bedf1.svg"/></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><span class="std-sinking --fontTitle">长</span>久以来对 unicode 的一些细节还是不够清晰，因此今天集中注意力深入研究并实现 Unicode 最常用的三种编码 UTF-32/16/8 来获得完全同步 (超长文警告)</div><h1 id="what-is-unicode" class="std-title --fontTitle"><a href="#what-is-unicode" class="markdownIt-Anchor">#</a> Unicode 是什么 ?<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">Unicode 与众所周知的 ASCII 是同一类的东西，是字符编码的一种方案，可以用来将 <div class="std-inline-code" data-minimap-color="#f5e9e9">字符实体</div> 编码到某个整数空间中，比如 Unicode 里的数字 <div class="std-inline-code" data-minimap-color="#f5e9e9">0x0041</div> 对应的是 <div class="std-inline-code" data-minimap-color="#f5e9e9">&#x27;A&#x27;</div>，记作 <div class="std-inline-code" data-minimap-color="#f5e9e9">U+0041</div>，称作 <div class="std-inline-code" data-minimap-color="#f5e9e9">码点 Code Point</div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">截止到 2024，已经有上百亿设备上跑着 Unicode 了，是这个星球上最常见的字符编码方案了，如果哪天发现了外星人需要传点什么东西跟他们做文化交流，完全可以将 Unicode 标准发给他们。</div><h2 id="unicode-码点-(code-point)" class="std-title --fontTitle">Unicode 码点 (Code Point)</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">所谓码点就是我前面提到的那个数字了，Unicode 规范里的每一个字符实体都有唯一的「整数」作为其码点。</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">在现代浏览器上都支持 Unicode 编码，这意味着你在网页上输入的任意一个字符都对应一个码点，在下面这个 Demo 中可以输入字符串并将其转为对应码点信息, 可以试试</div><div class="std-window mode-windowed"><div class="std-window-menus"><div class="std-window-title"><span></span></div><div class="std-window-btns"><div class="std-icon std-window-menu-btn" style="overflow:hidden;border-radius:1em;box-sizing:border-box"></div><div class="std-icon std-window-menu-btn" style="overflow:hidden;border-radius:1em;box-sizing:border-box"></div></div></div><div style="height:auto" class="std-window-content"><div style="padding:2em"><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><input value="ECZN" style="font-size:1rem;margin-bottom:1em;display:block;width:100%;padding:.5em;box-sizing:border-box;border:1px solid #BBB;text-align:center" placeholder="ECZN"/><div style="display:flex;flex-wrap:wrap;justify-content:center"><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f3e6e8;margin:1em"><div style="font-size:2em;background-color:#d0bdc0;display:inline-block;width:2em;height:2em;line-height:2em">E</div><div style="height:1em;line-height:1em;margin-top:.5em">U+0045</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f3e6e8;margin:1em"><div style="font-size:2em;background-color:#d0bdc0;display:inline-block;width:2em;height:2em;line-height:2em">C</div><div style="height:1em;line-height:1em;margin-top:.5em">U+0043</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#dfe6e8;margin:1em"><div style="font-size:2em;background-color:#b3bdc0;display:inline-block;width:2em;height:2em;line-height:2em">Z</div><div style="height:1em;line-height:1em;margin-top:.5em">U+005A</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#dce6e8;margin:1em"><div style="font-size:2em;background-color:#afbdc0;display:inline-block;width:2em;height:2em;line-height:2em">N</div><div style="height:1em;line-height:1em;margin-top:.5em">U+004E</div></div></div></div></div></div></div><div style="display:none;height:0px;background:#BBB">placeholder</div><h2 id="unicode-编码空间-(encoding-space)" class="std-title --fontTitle">Unicode 编码空间 (Encoding-Space)</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">从 Unicode 规范来看，字符所对应的整数「码点」应该是一个 4 字节无符号整数，其编码空间相当大，即 2^32 这么大，但是在这么大的容量目前其实只用了一百一十多万而已，而且在这 100 多万里面还有很多还没用上呢，只是预先划分出来了。</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">Unicode 标准组织为了管理上的方便，提出了两种划分这个整数空间的方式，一种是 Unicode 平面划分，一种是 Unicode 区块划分。</div><h2 id="unicode-平面划分-(plane)" class="std-title --fontTitle">Unicode 平面划分 (Plane)</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">将码点的整数空间以 65536 (即 0x0 到 0xFFFF) 的长度来将这个四字节整数分割成不同的区间，在规范里这些区间的学名叫做平面</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">而这 4 字节证书容量为 2^32 即 4294967296。若以 65536 为区间划分的话刚好也能划分出 65536 个平面，即 <div class="std-inline-code" data-minimap-color="#f5e9e9">0x0000xxxx ~ 0xFFFFxxxx</div>（xxxx 为平面内的偏移）</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">比如最开头的第一个区间 <div class="std-inline-code" data-minimap-color="#f5e9e9">U+00000000</div> 到 <div class="std-inline-code" data-minimap-color="#f5e9e9">U+0000FFFF</div> 是第一个平面，叫做 BMP，英文是 Basic Multilingual Plane, 里面包含了最常用的 65536 个字符，而在其中最前面的 128 个码点含义跟 ASCII 编码保持一致，以此来保证能向下兼容 ASCII</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">再比如，第二个平面是 <div class="std-inline-code" data-minimap-color="#f5e9e9">U+010000</div> 到 <div class="std-inline-code" data-minimap-color="#f5e9e9">U+01FFFF</div>, 名字是 SMP 平面，英文是 Supplementary Multilingual Plane, 字面意思是多语种辅助平面</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">目前 Unicode 官方定义了 17 个平面, 即 <div class="std-inline-code" data-minimap-color="#f5e9e9">U+00xxxx</div> 到 <div class="std-inline-code" data-minimap-color="#f5e9e9">U+10xxxx</div>，这个数量其实相当小，因此书写码点的时候通常会将前面的 0 省略掉，比如第一平面 BMP 的范围是: <div class="std-inline-code" data-minimap-color="#f5e9e9">U+0000</div> 到 <div class="std-inline-code" data-minimap-color="#f5e9e9">U+FFFF</div>；又比如蛋糕的 emoji <div class="std-inline-code" data-minimap-color="#f5e9e9">🍰</div> 这个字符的码点是 <div class="std-inline-code" data-minimap-color="#f5e9e9">U+1F370</div> 因此它位于第二平面 <div class="std-inline-code" data-minimap-color="#f5e9e9">SMP</div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">或许你已经发现了，按 65536 为区间划分的好处了，就是以 16 进制表示的时候，最低 4 位就是平面内的偏移，高位则是平面的序号，比如 <div class="std-inline-code" data-minimap-color="#f5e9e9">U+00xxxx</div> 是第一平面 BMP； <div class="std-inline-code" data-minimap-color="#f5e9e9">U+01xxxx</div> 是第二平面 SMP 以此类推，下面是官方定义的十七个平面定义，其中 4 号 到 13 号只是分配了但还没用到：</div><table style="width:100%;display:block;font-size:75%;text-align:center;border-collapse:collapse;margin-bottom:1em;font-family:var(--fontArticle)"><thead><tr><th style="padding:.5em;border:1px solid #BBB;width:5em">平面编号</th><th style="padding:.5em;border:1px solid #BBB">码点区间</th><th style="padding:.5em;border:1px solid #BBB">英文名</th><th style="padding:.5em;border:1px solid #BBB">中文名</th></tr></thead><tbody><tr><td style="padding:.5em;border:1px solid #BBB">0 号平面</td><td style="padding:.5em;border:1px solid #BBB;font-family:var(--fontCode)">U+000000 - U+00FFFF</td><td style="padding:.5em;border:1px solid #BBB">BMP: Basic Multilingual Plane</td><td style="padding:.5em;border:1px solid #BBB">基本多文种平面</td></tr><tr><td style="padding:.5em;border:1px solid #BBB">1 号平面</td><td style="padding:.5em;border:1px solid #BBB;font-family:var(--fontCode)">U+010000 - U+01FFFF</td><td style="padding:.5em;border:1px solid #BBB">SMP: Supplementary Multilingual Plane</td><td style="padding:.5em;border:1px solid #BBB">多文种补充平面</td></tr><tr><td style="padding:.5em;border:1px solid #BBB">2 号平面</td><td style="padding:.5em;border:1px solid #BBB;font-family:var(--fontCode)">U+020000 - U+02FFFF</td><td style="padding:.5em;border:1px solid #BBB">SIP: Supplementary Ideographic Plane</td><td style="padding:.5em;border:1px solid #BBB">表意文字补充平面</td></tr><tr><td style="padding:.5em;border:1px solid #BBB">3 号平面</td><td style="padding:.5em;border:1px solid #BBB;font-family:var(--fontCode)">U+030000 - U+03FFFF</td><td style="padding:.5em;border:1px solid #BBB">TIP: Tertiary Ideographic Plane</td><td style="padding:.5em;border:1px solid #BBB">表意文字第三平面</td></tr><tr><td style="padding:.5em;border:1px solid #BBB">4 号平面 ~ 13 号平面</td><td style="padding:.5em;border:1px solid #BBB;font-family:var(--fontCode)">U+040000 - U+0DFFFF</td><td style="padding:.5em;border:1px solid #BBB">已分配，但尚未使用</td><td style="padding:.5em;border:1px solid #BBB">/</td></tr><tr><td style="padding:.5em;border:1px solid #BBB">14 号平面</td><td style="padding:.5em;border:1px solid #BBB;font-family:var(--fontCode)">U+0E0000 - U+0EFFFF</td><td style="padding:.5em;border:1px solid #BBB">SSP: Supplementary Special-purpose Plane</td><td style="padding:.5em;border:1px solid #BBB">特别用途补充平面</td></tr><tr><td style="padding:.5em;border:1px solid #BBB">15 号平面</td><td style="padding:.5em;border:1px solid #BBB;font-family:var(--fontCode)">U+0F0000 - U+0FFFFF</td><td style="padding:.5em;border:1px solid #BBB">PUA-A: Private Use Area-A</td><td style="padding:.5em;border:1px solid #BBB">保留作为私人使用区 (A区)</td></tr><tr><td style="padding:.5em;border:1px solid #BBB">16 号平面</td><td style="padding:.5em;border:1px solid #BBB;font-family:var(--fontCode)">U+100000 - U+10FFFF</td><td style="padding:.5em;border:1px solid #BBB">PUA-B: Private Use Area-B</td><td style="padding:.5em;border:1px solid #BBB">保留作为私人使用区 (B区)</td></tr></tbody></table><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">更具体平面的完整分配规则可以查看规范官网：</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><a href="https://www.unicode.org/roadmaps/index.html" target="_blank" style="background-color:#e6f6f6" class="std-link --fontSansSerif  _block" data-minimap-color="#e6f6f6"><span class="std-link-icon r-link" data-src="/get-favicon/www.unicode.org?h=182773085" style="background-image:url(&quot;/get-favicon/www.unicode.org?h=182773085&quot;)"></span><span class="std-link-txt">Unicode Roadmap Define</span></a></div><h2 id="unicode-区块-(block)" class="std-title --fontTitle">Unicode 区块 (block)</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">Block 是对 Plane 进一步的划分，比如在 BMP 0x0000~0xFFFF 这个平面中，最开始的 128 位是 ASCII 编码, 从官网给出的 Plane 划分来看，区块就是表格上的这些格子：</div><div class="std-img-dynamic-wrapper"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:69.79%"><img class="std-img-dymanic-main r-link __mosaic __loading" src="/tsxs-esm/unicode-bmp.587739de631defec.png.mosaic.png"/><img class="std-img-dymanic-main" src="/tsxs-esm/unicode-bmp.587739de631defec.png"/></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">其中最开头的 C0-Controls 加上 Basic Latain 其实就对应了 ASCII 编码，而汉字编码，主要存到 CKJ 区块中等等 —— 总之区块是对平面的再划分，一个平面上可以有很多区块，具体区块可以看 Unicode 官网说明</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><a href="https://www.unicode.org/roadmaps/index.html" target="_blank" style="background-color:#e6f6f6" class="std-link --fontSansSerif  _block" data-minimap-color="#e6f6f6"><span class="std-link-icon r-link" data-src="/get-favicon/www.unicode.org?h=182773085" style="background-image:url(&quot;/get-favicon/www.unicode.org?h=182773085&quot;)"></span><span class="std-link-txt">Unicode Roadmap Define</span></a></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">前面 Unicode 平面里的 15 和 16 号平面是所谓的 <div class="std-inline-code" data-minimap-color="#f5e9e9">A区</div> 和 <div class="std-inline-code" data-minimap-color="#f5e9e9">B区</div> 这两个区间是保留给开发者随意定义的。而除了这两个平面外，在第一平面 BMP 内下面这个区块 0xE000 ~ 0xF8FF 也是一样的功能，用来用作 private use 的，共计 6400 个：</div><div class="std-img-dynamic-wrapper"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:114.33%"><img class="std-img-dymanic-main r-link __mosaic __loading" src="/tsxs-esm/bmp-private-use-area.67f51430862c5521.png.mosaic.png"/><img class="std-img-dymanic-main" src="/tsxs-esm/bmp-private-use-area.67f51430862c5521.png"/></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">比如苹果系统的「 U+F8FF」图标就是在上面这个 Block 内的：(注意如果你不是苹果系统看不到这个 🍎 字符)</div><div class="std-window mode-windowed"><div class="std-window-menus"><div class="std-window-title"><span></span></div><div class="std-window-btns"><div class="std-icon std-window-menu-btn" style="overflow:hidden;border-radius:1em;box-sizing:border-box"></div><div class="std-icon std-window-menu-btn" style="overflow:hidden;border-radius:1em;box-sizing:border-box"></div></div></div><div style="height:auto" class="std-window-content"><div style="padding:2em"><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><input value="🍎" style="font-size:1rem;margin-bottom:1em;display:block;width:100%;padding:.5em;box-sizing:border-box;border:1px solid #BBB;text-align:center" placeholder="🍎"/><div style="display:flex;flex-wrap:wrap;justify-content:center"><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e5e9e8;margin:1em"><div style="font-size:2em;background-color:#bdc2c1;display:inline-block;width:2em;height:2em;line-height:2em"></div><div style="height:1em;line-height:1em;margin-top:.5em">U+F8FF</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f3dfeb;margin:1em"><div style="font-size:2em;background-color:#d1b4c5;display:inline-block;width:2em;height:2em;line-height:2em">🍎</div><div style="height:1em;line-height:1em;margin-top:.5em">U+1F34E</div></div></div></div></div></div></div><div style="display:none;height:0px;background:#BBB">placeholder</div><h1 id="UTF-8" class="std-title --fontTitle"><a href="#UTF-8" class="markdownIt-Anchor">#</a> UTF-32<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">介绍完前面的码点和码点编码空间的平面和区块分配后，我们来讨论一下如何将码点编码成字节流 —— 这个工作几乎是 unicode 相关开发中最核心最重要的部分，即将码点编码成字节流，或者反过来将字节流解析为码点</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">前面提到，一个码点就是一个 uint32，因此一个一眼丁真的 unicode 编码办法就是将所有码点转成 4 字节无符号整数 —— 而这样的编码方式就是 UTF-32，它也因此得名 32</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">比如说将 <div class="std-inline-code" data-minimap-color="#f5e9e9">&quot;Hello, 世界&quot;</div> 表达成对应码点并对齐到 4 字节整数</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span>字符    码点    对齐到 <span class="token number">4</span> 字节整数
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token string">'H'</span> <span class="token operator">=></span> <span class="token constant">U</span><span class="token operator">+</span><span class="token number">48</span> <span class="token operator">=></span> <span class="token number">0x00000048</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token string">'e'</span> <span class="token operator">=></span> <span class="token constant">U</span><span class="token operator">+</span><span class="token number">65</span> <span class="token operator">=></span> <span class="token number">0x00000065</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token string">'l'</span> <span class="token operator">=></span> <span class="token constant">U</span><span class="token operator">+</span>6C <span class="token operator">=></span> <span class="token number">0x0000006C</span>
<span class="line-numbers-rows" style="user-select: none;">04</span><span class="token string">'l'</span> <span class="token operator">=></span> <span class="token constant">U</span><span class="token operator">+</span>6C <span class="token operator">=></span> <span class="token number">0x0000006C</span>
<span class="line-numbers-rows" style="user-select: none;">05</span><span class="token string">'o'</span> <span class="token operator">=></span> <span class="token constant">U</span><span class="token operator">+</span>6F <span class="token operator">=></span> <span class="token number">0x0000006F</span>
<span class="line-numbers-rows" style="user-select: none;">06</span><span class="token string">','</span> <span class="token operator">=></span> <span class="token constant">U</span><span class="token operator">+</span>2C <span class="token operator">=></span> <span class="token number">0x0000002C</span>
<span class="line-numbers-rows" style="user-select: none;">07</span><span class="token string">' '</span> <span class="token operator">=></span> <span class="token constant">U</span><span class="token operator">+</span><span class="token number">20</span> <span class="token operator">=></span> <span class="token number">0x00000020</span>
<span class="line-numbers-rows" style="user-select: none;">08</span><span class="token string">'世'</span> <span class="token operator">=></span> <span class="token constant">U</span><span class="token operator">+</span><span class="token number">4E16</span> <span class="token operator">=></span> <span class="token number">0x00004E16</span>
<span class="line-numbers-rows" style="user-select: none;">09</span><span class="token string">'界'</span> <span class="token operator">=></span> <span class="token constant">U</span><span class="token operator">+</span>754C <span class="token operator">=></span> <span class="token number">0x0000754C</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">再将上述对齐后的整数拼接在一起得到这样一段 Buffer 作为 UTF-32 字节流：</div><div class="buffer-view nth-0"><style></style><div class="buffer-view-header"><div class="std-icon  icon-bit-switch" style="height:2em;width:2em;overflow:hidden;display:inline-block;box-sizing:border-box"></div><div class="buffer-view-state"><div>cursor=0x0000</div><div>length=40</div><div><a download="UTF-32 例子 (大端).txt" href="">download</a></div></div></div><div class="buffer-view-ranges"><div class="_line-range">0x0000</div><div class="_line-range">0x0010</div><div class="_line-range">0x0020</div></div><div class="buffer-view-lines"><div class="buffer-view-line"><div class="_hex-num" data-index="0">00</div><div class="_hex-num" data-index="1">00</div><div class="_hex-num" data-index="2">FE</div><div class="_hex-num" data-index="3">FF</div><div class="_hex-num"> </div><div class="_hex-num" data-index="4">00</div><div class="_hex-num" data-index="5">00</div><div class="_hex-num" data-index="6">00</div><div class="_hex-num" data-index="7">48</div><div class="_hex-num"> </div><div class="_hex-num" data-index="8">00</div><div class="_hex-num" data-index="9">00</div><div class="_hex-num" data-index="10">00</div><div class="_hex-num" data-index="11">65</div><div class="_hex-num"> </div><div class="_hex-num" data-index="12">00</div><div class="_hex-num" data-index="13">00</div><div class="_hex-num" data-index="14">00</div><div class="_hex-num" data-index="15">6C</div></div><div class="buffer-view-line"><div class="_hex-num" data-index="16">00</div><div class="_hex-num" data-index="17">00</div><div class="_hex-num" data-index="18">00</div><div class="_hex-num" data-index="19">6C</div><div class="_hex-num"> </div><div class="_hex-num" data-index="20">00</div><div class="_hex-num" data-index="21">00</div><div class="_hex-num" data-index="22">00</div><div class="_hex-num" data-index="23">6F</div><div class="_hex-num"> </div><div class="_hex-num" data-index="24">00</div><div class="_hex-num" data-index="25">00</div><div class="_hex-num" data-index="26">00</div><div class="_hex-num" data-index="27">2C</div><div class="_hex-num"> </div><div class="_hex-num" data-index="28">00</div><div class="_hex-num" data-index="29">00</div><div class="_hex-num" data-index="30">00</div><div class="_hex-num" data-index="31">20</div></div><div class="buffer-view-line"><div class="_hex-num" data-index="32">00</div><div class="_hex-num" data-index="33">00</div><div class="_hex-num" data-index="34">4E</div><div class="_hex-num" data-index="35">16</div><div class="_hex-num"> </div><div class="_hex-num" data-index="36">00</div><div class="_hex-num" data-index="37">00</div><div class="_hex-num" data-index="38">75</div><div class="_hex-num" data-index="39">4C</div><div class="_hex-num"> </div><div class="_hex-num"> </div></div></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">你可能会发现开头的四个字节 <div class="std-inline-code" data-minimap-color="#f5e9e9">0x0000FEFF</div> 貌似没有用到，实际这四个字节叫做 UTF BOM (Byte Order Mark) 是用来标记字节序的，此处表明是大端字节序，表示高位字节存储在左边，而如果是 <div class="std-inline-code" data-minimap-color="#f5e9e9">0xFEFF0000</div> 则代表是小端存储，此时高 16 位和低 16 位顺序要调转一下，即：</div><div class="buffer-view nth-0"><style></style><div class="buffer-view-header"><div class="std-icon  icon-bit-switch" style="height:2em;width:2em;overflow:hidden;display:inline-block;box-sizing:border-box"></div><div class="buffer-view-state"><div>cursor=0x0000</div><div>length=40</div><div><a download="UTF-32 例子 (小端).txt" href="">download</a></div></div></div><div class="buffer-view-ranges"><div class="_line-range">0x0000</div><div class="_line-range">0x0010</div><div class="_line-range">0x0020</div></div><div class="buffer-view-lines"><div class="buffer-view-line"><div class="_hex-num" data-index="0">FE</div><div class="_hex-num" data-index="1">FF</div><div class="_hex-num" data-index="2">00</div><div class="_hex-num" data-index="3">00</div><div class="_hex-num"> </div><div class="_hex-num" data-index="4">00</div><div class="_hex-num" data-index="5">48</div><div class="_hex-num" data-index="6">00</div><div class="_hex-num" data-index="7">00</div><div class="_hex-num"> </div><div class="_hex-num" data-index="8">00</div><div class="_hex-num" data-index="9">65</div><div class="_hex-num" data-index="10">00</div><div class="_hex-num" data-index="11">00</div><div class="_hex-num"> </div><div class="_hex-num" data-index="12">00</div><div class="_hex-num" data-index="13">6C</div><div class="_hex-num" data-index="14">00</div><div class="_hex-num" data-index="15">00</div></div><div class="buffer-view-line"><div class="_hex-num" data-index="16">00</div><div class="_hex-num" data-index="17">6C</div><div class="_hex-num" data-index="18">00</div><div class="_hex-num" data-index="19">00</div><div class="_hex-num"> </div><div class="_hex-num" data-index="20">00</div><div class="_hex-num" data-index="21">6F</div><div class="_hex-num" data-index="22">00</div><div class="_hex-num" data-index="23">00</div><div class="_hex-num"> </div><div class="_hex-num" data-index="24">00</div><div class="_hex-num" data-index="25">2C</div><div class="_hex-num" data-index="26">00</div><div class="_hex-num" data-index="27">00</div><div class="_hex-num"> </div><div class="_hex-num" data-index="28">00</div><div class="_hex-num" data-index="29">20</div><div class="_hex-num" data-index="30">00</div><div class="_hex-num" data-index="31">00</div></div><div class="buffer-view-line"><div class="_hex-num" data-index="32">4E</div><div class="_hex-num" data-index="33">16</div><div class="_hex-num" data-index="34">00</div><div class="_hex-num" data-index="35">00</div><div class="_hex-num"> </div><div class="_hex-num" data-index="36">75</div><div class="_hex-num" data-index="37">4C</div><div class="_hex-num" data-index="38">00</div><div class="_hex-num" data-index="39">00</div><div class="_hex-num"> </div><div class="_hex-num"> </div></div></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">上述两种字节序都可以下载下来看看 (注意 VSCode 目前并不支持 UTF-32 编码, mac 的话用系统自带的编辑器就行了, vim 也可以)</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">看到这里可能很多人会问：FEFF 是随便写的吗？—— 涉及到后文的概念，可以先忽略，后文会解答</div><h1 id="UTF-16" class="std-title --fontTitle"><a href="#UTF-16" class="markdownIt-Anchor">#</a> UTF-16<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">由于 UTF-32 是一种定长编码，缺点就是比较大，并没有被广泛使用，实际场景中用的比较多的是 utf16 和 utf8，现在来看看 utf16 是怎么编码的吧</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">考虑到大多数人只使用第一平面，即 0x0000-0xFFFF, utf16 就是针对这种现象进行编码设计</div><ul class="numbering-main" data-minimap-color="#DDDDDD"><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">情况一：第一平面 BMP 内的字符，即 0x000000-0x00FFFF 中的字符直接用 2 字节存储，即直接存储低 16 位即可</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">情况二：后续 16 个平面，即 0x010000-0x10FFFF 中的字符使用 4 字节存储</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">其他情况：大于 0x10FFFF 的无法使用 UTF-16 进行编码</div></li></ul><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">那么，当我正在处理一段字节流的时候，比如我读取到 0xABCD，此时要怎么判断读取的这两个字节是对应情况一还是情况二的四字节的前半部分呢？</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这里看似无解，但是 Unicode 标准单独给第一平面挖了一段 Block 来解决这个问题：在第一平面 0x0000 - 0xFFFF 中的 0xD800 - 0xDFFF 这段并没有编码含义，而是保留给 UTF-16 来使用：</div><div class="std-img-dynamic-wrapper"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:35.82%"><img class="std-img-dymanic-main r-link __mosaic __loading" src="/tsxs-esm/D800-DFFF.4bb58d8ee238882a.png.mosaic.png"/><img class="std-img-dymanic-main" src="/tsxs-esm/D800-DFFF.4bb58d8ee238882a.png"/></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">利用这个区块，具体一点来说在处理字节流两字节两字节进行读取解析的时候，如果读取的两个字节不在这个区间，就是情况一，比如前面的 0xABCD 就不在这个区间，因此应该将其当作情况一来处理；而如果遇到在这个区间内的时候，说明此时读取的不是第一平面内的码点，应该按情况二来处理，此时额外读取后两个字节组成四个字节来解析。</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">再进一步来看，情况二中提到用 4 个字节来编码，这 4 字节又分为前后两个部分，每个部分各 2 个字节，对于这「2 个字节」如果：</div><ol class="numbering-main" data-minimap-color="#DDDDDD"><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">1.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">位于 high-half surrogates 中，称为高代理；范围是 0xD800 - 0xDBFF, 换成二进制为 110110/0000000000 - 110110/1111111111，即以 0b110110 开头的情况为高代理</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">2.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">位于 low-half surrogates 中，称为低代理；范围是 0xDC00 - 0xDFFF，换成二进制为 110111/0000000000 - 110111/1111111111，即以 0b110111 开头的情况为低代理</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">3.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">高低代理中的低 10 位是有效位，一共 20 位将其取出拼接在一起存储为 TMP</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">4.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">UTF-16 标准规定 TMP = 码点 - 0x10000, 此时将 TMP 加上 0x10000 即可得到码点 (后面会说为什么要减去 0x10000)</div></li></ol><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">情况二的 4 个字节分成前后两部分，其中，前面两个字节的前 6 位二进制固定为 110110，后面两个字节的前 6 位二进制固定为 110111, 前后部分各剩余 10 位二进制是码点减去 0x10000 的结果 —— 也就是说通过放弃 BMP 的一部分空间，将两个代理的低 10 位拼接来编码其他平面的码点。</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">好吧，看到这里估计都被绕晕了，我上面写的规则貌似很复杂，其实实际很好理解，关键在于「放弃 BMP 的一部分空间，用两个代理的方式凑出 20 位来编码其他平面的码点」</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这里手把手给一个例子：我将以下面 <div class="std-inline-code" data-minimap-color="#f5e9e9">🍰 (U+1F370)</div> 这个 emoji 来说明如何将其码点 0x1F370 编码为 UTF-16 字节流：</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">// ⬇️ 🍰 的 unicode 码点 (0x1F370 的二进制形式)</span>
<span class="line-numbers-rows" style="user-select: none;">01</span>　  <span class="token number">1</span> <span class="token number">11110011</span> <span class="token number">01110000</span>   <span class="token comment">// ⬅️ 码点需要先减去 0x10000</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>　<span class="token operator">-</span> <span class="token number">1</span> <span class="token number">00000000</span> <span class="token number">00000000</span>   <span class="token comment">//</span>
<span class="line-numbers-rows" style="user-select: none;">03</span>　<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token comment">// ⬇️ 高代理（两字节） ⬇️ 低代理（两字节）</span>
<span class="line-numbers-rows" style="user-select: none;">04</span>　    <span class="token number">11110011</span> <span class="token number">01110000</span>    <span class="token number">1101100000111100</span>  <span class="token number">1101111101110000</span>
<span class="line-numbers-rows" style="user-select: none;">05</span>　    aaaaaabb bbbbbbbb    <span class="token constant">HHHHHH</span><span class="token operator">**</span><span class="token operator">**</span>aaaaaa  LLLLLLbbbbbbbbbb
<span class="line-numbers-rows" style="user-select: none;">06</span>　                         将高低代理对写在一起就构成四字节的 utf16
<span class="line-numbers-rows" style="user-select: none;">07</span>　                         <span class="token number">0xD83C</span> <span class="token number">0xDF70</span>
<span class="line-numbers-rows" style="user-select: none;">08</span>　<span class="token comment">// ⚠️ 注意:</span>
<span class="line-numbers-rows" style="user-select: none;">09</span>　<span class="token comment">// 1. HHHHHH 代表固定的高代理头, 110110 (0xD800 到 0xDBFF)</span>
<span class="line-numbers-rows" style="user-select: none;">10</span>　<span class="token comment">//    LLLLLL 代表固定的低代理头, 110111</span>
<span class="line-numbers-rows" style="user-select: none;">11</span>　<span class="token comment">// 2. 上述标 a 标 b 的部分其实就对应右边的标 a 标 b 部分,</span>
<span class="line-numbers-rows" style="user-select: none;">12</span>　<span class="token comment">//    从低位往左边填充，填完就就填 0 （也就是标星号 * 的那部分）</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">上述例子中标 * 的部分实际上就是平面的序号减一，这也说明了为什么要减去 0x10000：避免在高低代理对的 20 位整数空间中重复编码第一平面，而由于最多只能带 20 位，因此大于 0x100000 的码点是不能用 UTF-16 进行编码的。</div><h2 id="实现-utf16encodecodepoint" class="std-title --fontTitle">实现 utf16EncodeCodePoint</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">根据前面的讨论来实现 UTF-16 编码器的核心部分: 将给定的一个码点转为对应字节 number[] 数组, 比如说:</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token function">utf16EncodeCodePoint</span><span class="token punctuation">(</span><span class="token number">0x6C38</span><span class="token punctuation">)</span> <span class="token comment">// 永 (码点为 U+6C38)</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token comment">// => [0x6C, 0x38]</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token function">utf16EncodeCodePoint</span><span class="token punctuation">(</span><span class="token number">0x1F370</span><span class="token punctuation">)</span> <span class="token comment">// 🍰 (码点为 U+1F370)</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token comment">// => [0xD8, 0x3C, 0xDF, 0x70]</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">下面给一个我的实现:</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">/**
<span class="line-numbers-rows" style="user-select: none;">01</span> * high-half surrogates 0xD800 0xDBFF
<span class="line-numbers-rows" style="user-select: none;">02</span> * low-half surrogates 0xDC00 0xDFFF
<span class="line-numbers-rows" style="user-select: none;">03</span> * surrogates 0xD800-0xDFFFF
<span class="line-numbers-rows" style="user-select: none;">04</span> * @param codePoint 给定码点
<span class="line-numbers-rows" style="user-select: none;">05</span> * @returns 返回二字节或四字节 number[]
<span class="line-numbers-rows" style="user-select: none;">06</span> */</span>
<span class="line-numbers-rows" style="user-select: none;">07</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">utf16EncodeCodePoint</span><span class="token punctuation">(</span>codePoint<span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> number<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">08</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>codePoint <span class="token operator">&lt;</span> <span class="token number">0x10000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 第一平面 (BMP)</span>
<span class="line-numbers-rows" style="user-select: none;">09</span>    <span class="token keyword">const</span> byte0 <span class="token operator">=</span> <span class="token punctuation">(</span>codePoint <span class="token operator">&amp;</span> <span class="token number">0b1111111100000000</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">10</span>    <span class="token keyword">const</span> byte1 <span class="token operator">=</span> codePoint <span class="token operator">&amp;</span> <span class="token number">0b0000000011111111</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">11</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span>byte0<span class="token punctuation">,</span> byte1<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">12</span>  <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">13</span>
<span class="line-numbers-rows" style="user-select: none;">14</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>codePoint <span class="token operator">>=</span> <span class="token number">0x100000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">15</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'不支持大于 0x100000 的码点'</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">16</span>  <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">17</span>
<span class="line-numbers-rows" style="user-select: none;">18</span>  <span class="token comment">// 需要减去 0x10000 避免对第一平面重复编码</span>
<span class="line-numbers-rows" style="user-select: none;">19</span>  <span class="token keyword">const</span> buf <span class="token operator">=</span> <span class="token punctuation">(</span>codePoint <span class="token operator">-</span> <span class="token number">0x10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">20</span>
<span class="line-numbers-rows" style="user-select: none;">21</span>  <span class="token keyword">const</span> l10 <span class="token operator">=</span> <span class="token punctuation">(</span>buf <span class="token operator">&amp;</span> <span class="token number">0b00000000001111111111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">22</span>  <span class="token keyword">const</span> h10 <span class="token operator">=</span> <span class="token punctuation">(</span>buf <span class="token operator">&amp;</span> <span class="token number">0b11111111110000000000</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">23</span>
<span class="line-numbers-rows" style="user-select: none;">24</span>  <span class="token keyword">const</span> h16 <span class="token operator">=</span> h10 <span class="token operator">|</span> <span class="token number">0b1101100000000000</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">25</span>  <span class="token keyword">const</span> l16 <span class="token operator">=</span> l10 <span class="token operator">|</span> <span class="token number">0b1101110000000000</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">26</span>
<span class="line-numbers-rows" style="user-select: none;">27</span>  <span class="token keyword">return</span> <span class="token punctuation">[</span>
<span class="line-numbers-rows" style="user-select: none;">28</span>    <span class="token punctuation">(</span>h16 <span class="token operator">&amp;</span> <span class="token number">0b1111111100000000</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">29</span>    <span class="token punctuation">(</span>h16 <span class="token operator">&amp;</span> <span class="token number">0b0000000011111111</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">30</span>    <span class="token punctuation">(</span>l16 <span class="token operator">&amp;</span> <span class="token number">0b1111111100000000</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">31</span>    <span class="token punctuation">(</span>l16 <span class="token operator">&amp;</span> <span class="token number">0b0000000011111111</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">32</span>  <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">33</span><span class="token punctuation">}</span></pre></div><h2 id="utf-16-demo" class="std-title --fontTitle">UTF-16 Demo</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">下面是根据我的 UTF-16 编码器写的 Demo, 可以下载下来看看能不能打开</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><input value="🍰 在这输入字符串将其编码为 UTF-16 流并在下面的 BufferView 中展示" style="font-size:1rem;margin-bottom:1em;display:block;width:100%;padding:.5em;box-sizing:border-box;border:1px solid #BBB" placeholder="🍰 在这输入字符串将其编码为 UTF-16 流并在下面的 BufferView 中展示"/><div class="buffer-view nth-0"><style></style><div class="buffer-view-header"><div class="std-icon  icon-bit-switch" style="height:2em;width:2em;overflow:hidden;display:inline-block;box-sizing:border-box"></div><div class="buffer-view-state"><div>cursor=0x0000</div><div>length=90</div><div><a download="UTF-16 大端 Demo.txt" href="">download</a></div></div></div><div class="buffer-view-ranges"><div class="_line-range">0x0000</div><div class="_line-range">0x0010</div><div class="_line-range">0x0020</div><div class="_line-range">0x0030</div><div class="_line-range">0x0040</div><div class="_line-range">0x0050</div></div><div class="buffer-view-lines"><div class="buffer-view-line"><div class="_hex-num" data-index="0">FE</div><div class="_hex-num" data-index="1">FF</div><div class="_hex-num" data-index="2">D8</div><div class="_hex-num" data-index="3">3C</div><div class="_hex-num"> </div><div class="_hex-num" data-index="4">DF</div><div class="_hex-num" data-index="5">70</div><div class="_hex-num" data-index="6">00</div><div class="_hex-num" data-index="7">20</div><div class="_hex-num"> </div><div class="_hex-num" data-index="8">57</div><div class="_hex-num" data-index="9">28</div><div class="_hex-num" data-index="10">8F</div><div class="_hex-num" data-index="11">D9</div><div class="_hex-num"> </div><div class="_hex-num" data-index="12">8F</div><div class="_hex-num" data-index="13">93</div><div class="_hex-num" data-index="14">51</div><div class="_hex-num" data-index="15">65</div></div><div class="buffer-view-line"><div class="_hex-num" data-index="16">5B</div><div class="_hex-num" data-index="17">57</div><div class="_hex-num" data-index="18">7B</div><div class="_hex-num" data-index="19">26</div><div class="_hex-num"> </div><div class="_hex-num" data-index="20">4E</div><div class="_hex-num" data-index="21">32</div><div class="_hex-num" data-index="22">5C</div><div class="_hex-num" data-index="23">06</div><div class="_hex-num"> </div><div class="_hex-num" data-index="24">51</div><div class="_hex-num" data-index="25">76</div><div class="_hex-num" data-index="26">7F</div><div class="_hex-num" data-index="27">16</div><div class="_hex-num"> </div><div class="_hex-num" data-index="28">78</div><div class="_hex-num" data-index="29">01</div><div class="_hex-num" data-index="30">4E</div><div class="_hex-num" data-index="31">3A</div></div><div class="buffer-view-line"><div class="_hex-num" data-index="32">00</div><div class="_hex-num" data-index="33">20</div><div class="_hex-num" data-index="34">00</div><div class="_hex-num" data-index="35">55</div><div class="_hex-num"> </div><div class="_hex-num" data-index="36">00</div><div class="_hex-num" data-index="37">54</div><div class="_hex-num" data-index="38">00</div><div class="_hex-num" data-index="39">46</div><div class="_hex-num"> </div><div class="_hex-num" data-index="40">00</div><div class="_hex-num" data-index="41">2D</div><div class="_hex-num" data-index="42">00</div><div class="_hex-num" data-index="43">31</div><div class="_hex-num"> </div><div class="_hex-num" data-index="44">00</div><div class="_hex-num" data-index="45">36</div><div class="_hex-num" data-index="46">00</div><div class="_hex-num" data-index="47">20</div></div><div class="buffer-view-line"><div class="_hex-num" data-index="48">6D</div><div class="_hex-num" data-index="49">41</div><div class="_hex-num" data-index="50">5E</div><div class="_hex-num" data-index="51">76</div><div class="_hex-num"> </div><div class="_hex-num" data-index="52">57</div><div class="_hex-num" data-index="53">28</div><div class="_hex-num" data-index="54">4E</div><div class="_hex-num" data-index="55">0B</div><div class="_hex-num"> </div><div class="_hex-num" data-index="56">97</div><div class="_hex-num" data-index="57">62</div><div class="_hex-num" data-index="58">76</div><div class="_hex-num" data-index="59">84</div><div class="_hex-num"> </div><div class="_hex-num" data-index="60">00</div><div class="_hex-num" data-index="61">20</div><div class="_hex-num" data-index="62">00</div><div class="_hex-num" data-index="63">42</div></div><div class="buffer-view-line"><div class="_hex-num" data-index="64">00</div><div class="_hex-num" data-index="65">75</div><div class="_hex-num" data-index="66">00</div><div class="_hex-num" data-index="67">66</div><div class="_hex-num"> </div><div class="_hex-num" data-index="68">00</div><div class="_hex-num" data-index="69">66</div><div class="_hex-num" data-index="70">00</div><div class="_hex-num" data-index="71">65</div><div class="_hex-num"> </div><div class="_hex-num" data-index="72">00</div><div class="_hex-num" data-index="73">72</div><div class="_hex-num" data-index="74">00</div><div class="_hex-num" data-index="75">56</div><div class="_hex-num"> </div><div class="_hex-num" data-index="76">00</div><div class="_hex-num" data-index="77">69</div><div class="_hex-num" data-index="78">00</div><div class="_hex-num" data-index="79">65</div></div><div class="buffer-view-line"><div class="_hex-num" data-index="80">00</div><div class="_hex-num" data-index="81">77</div><div class="_hex-num" data-index="82">00</div><div class="_hex-num" data-index="83">20</div><div class="_hex-num"> </div><div class="_hex-num" data-index="84">4E</div><div class="_hex-num" data-index="85">2D</div><div class="_hex-num" data-index="86">5C</div><div class="_hex-num" data-index="87">55</div><div class="_hex-num"> </div><div class="_hex-num" data-index="88">79</div><div class="_hex-num" data-index="89">3A</div><div class="_hex-num"> </div></div></div></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">注意，与 UTF-32 类似，UTF-16 也需要指定开头的 BOM，此处开头的 0xFEFF 代表大端存储，此时的编码叫做 <div class="std-inline-code" data-minimap-color="#f5e9e9">UTF-16 BE</div> (big-endian) 如果需要小端存储则需要将 BOM 设置为 <div class="std-inline-code" data-minimap-color="#f5e9e9">0xFFFE</div> 并把后续高低字节序调转一下 (我的实现都是大端，比较好理解）</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">比如 <div class="std-inline-code" data-minimap-color="#f5e9e9">世界</div> 对应的大端编码 <div class="std-inline-code" data-minimap-color="#f5e9e9">UTF-16 BE</div> 为 0xFE, 0xFF 0x4E, 0x16, 0x75, 0x4C 此时其小端编码 <div class="std-inline-code" data-minimap-color="#f5e9e9">UTF-16 LE</div> (little-endian) 的结果为:</div><div class="buffer-view nth-0"><style></style><div class="buffer-view-header"><div class="std-icon  icon-bit-switch" style="height:2em;width:2em;overflow:hidden;display:inline-block;box-sizing:border-box"></div><div class="buffer-view-state"><div>cursor=0x0000</div><div>length=6</div><div><a download="UTF-16 小端 Demo.txt" href="">download</a></div></div></div><div class="buffer-view-ranges"><div class="_line-range">0x0000</div></div><div class="buffer-view-lines"><div class="buffer-view-line"><div class="_hex-num" data-index="0">FF</div><div class="_hex-num" data-index="1">FE</div><div class="_hex-num" data-index="2">16</div><div class="_hex-num" data-index="3">4E</div><div class="_hex-num"> </div><div class="_hex-num" data-index="4">4C</div><div class="_hex-num" data-index="5">75</div><div class="_hex-num"> </div><div class="_hex-num"> </div></div></div></div><h1 id="utf-16-in-js" class="std-title --fontTitle"><a href="#utf-16-in-js" class="markdownIt-Anchor">#</a> 题外话: JavaScript 里的 UTF-16<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">JS 里 string 底层是用 UTF-16 编码的，因此可这样验证前面 <div class="std-inline-code" data-minimap-color="#f5e9e9">🍰 U+1F370</div> 的编码结果 0xD83C 和 0xDF70 :</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'\uD83C\uDF70'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token comment">// 将会输出 '🍰'</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">从这也可以看到，JS 里可以用 \uAAAA 的方式来通过 UTF-16 编码流来构造字符串。</div><h2 id="如何直接用-unicode-码点来构造-string-?" class="std-title --fontTitle">如何直接用 unicode 码点来构造 string ?</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">除了直接用 UTF-16 编码流，JS 也可以直接给定码点来构造字符串:</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'\u{1F370}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token comment">// U+1F370 是 🍰 的码点, 将会输出 '🍰'</span></pre></div><h2 id="🍰.length-为什么是-2-的问题" class="std-title --fontTitle">&#x27;🍰&#x27;.length 为什么是 2 的问题</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">其实就是下面这种现象：</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'🍰'</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token comment">// => 2</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">原因：js string 是 UTF-16 编码的，而 🍰 的编码需要走情况 2 来编码，最终结果是 0xD83C 0xDF70，统共 4 字节，而 length 是两字节算一个字符（UTF-16）因此最后 🍰 这类位于第二平面的码点在 js string 里 length 就是 2 了</div><h2 id=".split()-并不能很好的识别-utf-16-内的字符" class="std-title --fontTitle">.split(&#x27;&#x27;) 并不能很好的识别 UTF-16 内的字符</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">.split 并不会识别 UTF-16 高低代理对，因此会出现这个问题：</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token string">'🍰 Hello'</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token comment">// => ['\uD83C', '\uDF70', ' ', 'H', 'e', 'l', 'l', 'o']</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">可以看到，🍰 的高/低代理对被完全拆开了，无法正常显示了，很多场景下不符合预期，此时可以通过下面这两种方式都将 string 按 UTF-16 序进行切割，避免这类问题：</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'🍰 Hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token comment">// => ['🍰', ' ', 'H', 'e', 'l', 'l', 'o']</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token punctuation">[</span><span class="token operator">...</span><span class="token string">'🍰 Hello'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">04</span><span class="token comment">// => ['🍰', ' ', 'H', 'e', 'l', 'l', 'o']</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">当然，也可以手动 for 循环遍历字符串来自己拆（判断在不在高低代理区块即可）</div><h2 id="如何将一段-string-转为码点数组-?" class="std-title --fontTitle">如何将一段 string 转为码点数组 ?</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">用前面提到的 Array.from 将字符拆开后再通过 codePointAt 方法取到码点:</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'🍰 🍉'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>ch <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">01</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ch<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'=>U+</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ch<span class="token punctuation">.</span><span class="token function">codePointAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token comment">// 将会输出</span>
<span class="line-numbers-rows" style="user-select: none;">04</span><span class="token comment">// '🍰'=>U+1f370</span>
<span class="line-numbers-rows" style="user-select: none;">05</span><span class="token comment">// ' '=>U+20</span>
<span class="line-numbers-rows" style="user-select: none;">06</span><span class="token comment">// '🍉'=>U+1f349</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">下面是根据上面这段写的一个小 demo (跟开头那个是同一个 Demo 组件)</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><input value="🍰 🍉" style="font-size:1rem;margin-bottom:1em;display:block;width:100%;padding:.5em;box-sizing:border-box;border:1px solid #BBB;text-align:center" placeholder="🍰 🍉"/><div style="display:flex;flex-wrap:wrap;justify-content:center"><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e2dfeb;margin:1em"><div style="font-size:2em;background-color:#b7b4c5;display:inline-block;width:2em;height:2em;line-height:2em">🍰</div><div style="height:1em;line-height:1em;margin-top:.5em">U+1F370</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#ece6e8;margin:1em"><div style="font-size:2em;background-color:#c7bdc0;display:inline-block;width:2em;height:2em;line-height:2em"> </div><div style="height:1em;line-height:1em;margin-top:.5em">U+0020</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f2dfeb;margin:1em"><div style="font-size:2em;background-color:#cfb4c5;display:inline-block;width:2em;height:2em;line-height:2em">🍉</div><div style="height:1em;line-height:1em;margin-top:.5em">U+1F349</div></div></div></div><h1 id="ucs2-utf16" class="std-title --fontTitle"><a href="#ucs2-utf16" class="markdownIt-Anchor">#</a> UCS-2 与 UTF-16 的关系<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">UCS-2 是在 UTF-16 出现之前常用的 Unicode 编码方式：</div><ul class="numbering-main" data-minimap-color="#DDDDDD"><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">UCS-2 是成立于 1984 年的 UCS 组织于 1990 年提出的</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">而 UTF-16 是成立于 1991 年的 Unicode 组织于 1996 年提出</div></li></ul><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">UCS-2 早于 UTF-16 提出，其核心是用两字节编码第一平面 BMP 0x0000 到 0xFFFF 共计 65536 个字符，后来设计的 UTF-16 也考虑到这一点进行设计，对应的就是前面提到过的 UTF-16 情况一</div><h1 id="UTF-8" class="std-title --fontTitle"><a href="#UTF-8" class="markdownIt-Anchor">#</a> UTF-8<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">终于来到 UTF-8 了，它是一种变长编码，特点是最小可以一字节使用，在一字节的时候编码规则跟 ASCII 一样，实现了兼容，具体的规则如下</div><ol class="numbering-main" data-minimap-color="#DDDDDD"><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">1.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">对于长度为 1 字节的字符，将最高位设置为 0, 其余 7 位设置为 Unicode 码点。值得注意的是, ASCII 字符在 Unicode 字符集中占据了前 128 个码点。也就是说, UTF-8 编码可以向下兼容 ASCII 码, 这意味着我们可以直接使用 UTF-8 来打开年代久远的 ASCII 文本文件。</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">2.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">对于长度为 n 字节的字符 (n &gt; 1), 将首个字节的高 n 位都设置为 1，第 n+1 位设置为 0；从第二个字节开始，将每个字节的高 2 位都设置为 10；其余所有位用于填充字符的 Unicode 码点。</div></li></ol><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">下面以「永」字为例：</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">//　     unicode 码点               UTF-8</span>
<span class="line-numbers-rows" style="user-select: none;">01</span>永    <span class="token number">11011000</span> <span class="token number">0111000</span>    <span class="token number">11100110</span> <span class="token number">10110000</span> <span class="token number">10111000</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>　                        <span class="token operator">--</span><span class="token operator">--</span>     <span class="token operator">--</span>       <span class="token operator">--</span>
<span class="line-numbers-rows" style="user-select: none;">03</span>　                                 <span class="token number">10</span> 开头   <span class="token number">10</span> 开头   
<span class="line-numbers-rows" style="user-select: none;">04</span>　        第一个字节开头的 <span class="token number">1110</span> 代表总共 <span class="token number">3</span> 个字节
<span class="line-numbers-rows" style="user-select: none;">05</span>　        其后每一个字节的开头都是 <span class="token number">10</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">06</span>　        <span class="token function">然后将码点按位填充到剩下的位得到最终结果</span>
<span class="line-numbers-rows" style="user-select: none;">07</span>　        <span class="token punctuation">(</span>转 <span class="token number">16</span> 进制后为<span class="token operator">:</span> <span class="token number">0xE6</span> <span class="token number">0xB0</span> <span class="token number">0xB8</span><span class="token punctuation">)</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">核心是确定 utf 头总共多少字节，然后将码点位填充上去即可，下面给一个我自己的编码实现：</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">/** 将单个码点转为 utf-8 编码 */</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">utf8EncodeCodePoint</span><span class="token punctuation">(</span>codePoint<span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> number<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>  <span class="token comment">// 0b01111111 及以下的情况跟 ASCII 保持一致，直接返回即可</span>
<span class="line-numbers-rows" style="user-select: none;">03</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>codePoint <span class="token operator">&lt;=</span> <span class="token number">0b01111111</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">04</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span>codePoint<span class="token punctuation">]</span>
<span class="line-numbers-rows" style="user-select: none;">05</span>  <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">06</span>
<span class="line-numbers-rows" style="user-select: none;">07</span>  <span class="token comment">// 先将 codePoint 按 0b10 + 6 位的方式隔开成 number[]</span>
<span class="line-numbers-rows" style="user-select: none;">08</span>  <span class="token keyword">const</span> result<span class="token operator">:</span> number<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">09</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">10</span>    <span class="token keyword">const</span> _6bit <span class="token operator">=</span> codePoint <span class="token operator">&amp;</span> <span class="token number">0b111111</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">11</span>    <span class="token keyword">const</span> _8bit <span class="token operator">=</span> <span class="token number">0b10000000</span> <span class="token operator">|</span> _6bit<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">12</span>    result<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>_8bit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">13</span>    codePoint <span class="token operator">=</span> codePoint <span class="token operator">>></span> <span class="token number">6</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">14</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>codePoint <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">15</span>  <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">16</span>
<span class="line-numbers-rows" style="user-select: none;">17</span>  <span class="token comment">// 处理 `utf 头`</span>
<span class="line-numbers-rows" style="user-select: none;">18</span>  <span class="token keyword">const</span> header <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> result<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">19</span>  <span class="token keyword">const</span> restBits <span class="token operator">=</span> <span class="token number">8</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> result<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">20</span>
<span class="line-numbers-rows" style="user-select: none;">21</span>  <span class="token comment">// 判断第一位放不得下 header</span>
<span class="line-numbers-rows" style="user-select: none;">22</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> restBits<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0b111111</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">23</span>    <span class="token keyword">const</span> headerByte <span class="token operator">=</span> <span class="token punctuation">(</span>header <span class="token operator">&lt;&lt;</span> restBits<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">24</span>    result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0b111111</span><span class="token punctuation">)</span> <span class="token operator">|</span> headerByte<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">25</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">26</span>    <span class="token comment">// 放不下则单独开一个字节塞到最前面</span>
<span class="line-numbers-rows" style="user-select: none;">27</span>    result<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>header <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>restBits <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">28</span>  <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">29</span>
<span class="line-numbers-rows" style="user-select: none;">30</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">31</span><span class="token punctuation">}</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">下面是解码的实现：</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">/**
<span class="line-numbers-rows" style="user-select: none;">01</span> * 将 arr 当作 utf-8 buffer 进行解码，将其解码位码点数组
<span class="line-numbers-rows" style="user-select: none;">02</span> */</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">utf8Decode</span><span class="token punctuation">(</span>arr<span class="token operator">:</span> ArrayLike<span class="token operator">&lt;</span>number<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">04</span>  <span class="token keyword">let</span> result<span class="token operator">:</span> number<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">05</span>  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">06</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">07</span>    <span class="token keyword">const</span> firstByte <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">08</span>
<span class="line-numbers-rows" style="user-select: none;">09</span>    <span class="token comment">// 先扫描 utf 头搞到总长度</span>
<span class="line-numbers-rows" style="user-select: none;">10</span>    <span class="token keyword">let</span> scanner <span class="token operator">=</span> <span class="token number">0b10000000</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">11</span>    <span class="token keyword">let</span> utfLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">12</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>firstByte <span class="token operator">&amp;</span> scanner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">13</span>      utfLength <span class="token operator">++</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">14</span>      scanner <span class="token operator">=</span> scanner <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">15</span>    <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">16</span>
<span class="line-numbers-rows" style="user-select: none;">17</span>    <span class="token comment">// 第一位通过前面的 scanner 就能快速取出其有效的数据位</span>
<span class="line-numbers-rows" style="user-select: none;">18</span>    <span class="token keyword">let</span> buf <span class="token operator">=</span> firstByte <span class="token operator">&amp;</span> <span class="token punctuation">(</span>scanner <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">19</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> offset <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> offset <span class="token operator">&lt;</span> utfLength<span class="token punctuation">;</span> offset <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">20</span>      buf <span class="token operator">=</span> buf <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">21</span>      buf <span class="token operator">=</span> buf <span class="token operator">|</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i <span class="token operator">+</span> offset<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0b00111111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">22</span>    <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">23</span>
<span class="line-numbers-rows" style="user-select: none;">24</span>    result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">25</span>    i <span class="token operator">=</span> i <span class="token operator">+</span> utfLength<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">26</span>  <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">27</span>
<span class="line-numbers-rows" style="user-select: none;">28</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">29</span><span class="token punctuation">}</span></pre></div><h2 id="utf-8-demo" class="std-title --fontTitle">UTF-8 Demo</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">我用上面的实现的 utf-8 编解码做了一个 Demo: </div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><input value="🍰 在这输入字符串将其编码为 UTF-8 流并在下面的 BufferView 中展示" style="font-size:1rem;margin-bottom:1em;display:block;width:100%;padding:.5em;box-sizing:border-box;border:1px solid #BBB" placeholder="🍰 在这输入字符串将其编码为 UTF-8 流并在下面的 BufferView 中展示"/><div class="buffer-view nth-0"><style></style><div class="buffer-view-header"><div class="std-icon  icon-bit-switch" style="height:2em;width:2em;overflow:hidden;display:inline-block;box-sizing:border-box"></div><div class="buffer-view-state"><div>cursor=0x0000</div><div>length=87</div><div><a download="UTF-8 Demo.txt" href="">download</a></div></div></div><div class="buffer-view-ranges"><div class="_line-range">0x0000</div><div class="_line-range">0x0010</div><div class="_line-range">0x0020</div><div class="_line-range">0x0030</div><div class="_line-range">0x0040</div><div class="_line-range">0x0050</div></div><div class="buffer-view-lines"><div class="buffer-view-line"><div class="_hex-num" data-index="0">F0</div><div class="_hex-num" data-index="1">9F</div><div class="_hex-num" data-index="2">8D</div><div class="_hex-num" data-index="3">B0</div><div class="_hex-num"> </div><div class="_hex-num" data-index="4">20</div><div class="_hex-num" data-index="5">E5</div><div class="_hex-num" data-index="6">9C</div><div class="_hex-num" data-index="7">A8</div><div class="_hex-num"> </div><div class="_hex-num" data-index="8">E8</div><div class="_hex-num" data-index="9">BF</div><div class="_hex-num" data-index="10">99</div><div class="_hex-num" data-index="11">E8</div><div class="_hex-num"> </div><div class="_hex-num" data-index="12">BE</div><div class="_hex-num" data-index="13">93</div><div class="_hex-num" data-index="14">E5</div><div class="_hex-num" data-index="15">85</div></div><div class="buffer-view-line"><div class="_hex-num" data-index="16">A5</div><div class="_hex-num" data-index="17">E5</div><div class="_hex-num" data-index="18">AD</div><div class="_hex-num" data-index="19">97</div><div class="_hex-num"> </div><div class="_hex-num" data-index="20">E7</div><div class="_hex-num" data-index="21">AC</div><div class="_hex-num" data-index="22">A6</div><div class="_hex-num" data-index="23">E4</div><div class="_hex-num"> </div><div class="_hex-num" data-index="24">B8</div><div class="_hex-num" data-index="25">B2</div><div class="_hex-num" data-index="26">E5</div><div class="_hex-num" data-index="27">B0</div><div class="_hex-num"> </div><div class="_hex-num" data-index="28">86</div><div class="_hex-num" data-index="29">E5</div><div class="_hex-num" data-index="30">85</div><div class="_hex-num" data-index="31">B6</div></div><div class="buffer-view-line"><div class="_hex-num" data-index="32">E7</div><div class="_hex-num" data-index="33">BC</div><div class="_hex-num" data-index="34">96</div><div class="_hex-num" data-index="35">E7</div><div class="_hex-num"> </div><div class="_hex-num" data-index="36">A0</div><div class="_hex-num" data-index="37">81</div><div class="_hex-num" data-index="38">E4</div><div class="_hex-num" data-index="39">B8</div><div class="_hex-num"> </div><div class="_hex-num" data-index="40">BA</div><div class="_hex-num" data-index="41">20</div><div class="_hex-num" data-index="42">55</div><div class="_hex-num" data-index="43">54</div><div class="_hex-num"> </div><div class="_hex-num" data-index="44">46</div><div class="_hex-num" data-index="45">2D</div><div class="_hex-num" data-index="46">38</div><div class="_hex-num" data-index="47">20</div></div><div class="buffer-view-line"><div class="_hex-num" data-index="48">E6</div><div class="_hex-num" data-index="49">B5</div><div class="_hex-num" data-index="50">81</div><div class="_hex-num" data-index="51">E5</div><div class="_hex-num"> </div><div class="_hex-num" data-index="52">B9</div><div class="_hex-num" data-index="53">B6</div><div class="_hex-num" data-index="54">E5</div><div class="_hex-num" data-index="55">9C</div><div class="_hex-num"> </div><div class="_hex-num" data-index="56">A8</div><div class="_hex-num" data-index="57">E4</div><div class="_hex-num" data-index="58">B8</div><div class="_hex-num" data-index="59">8B</div><div class="_hex-num"> </div><div class="_hex-num" data-index="60">E9</div><div class="_hex-num" data-index="61">9D</div><div class="_hex-num" data-index="62">A2</div><div class="_hex-num" data-index="63">E7</div></div><div class="buffer-view-line"><div class="_hex-num" data-index="64">9A</div><div class="_hex-num" data-index="65">84</div><div class="_hex-num" data-index="66">20</div><div class="_hex-num" data-index="67">42</div><div class="_hex-num"> </div><div class="_hex-num" data-index="68">75</div><div class="_hex-num" data-index="69">66</div><div class="_hex-num" data-index="70">66</div><div class="_hex-num" data-index="71">65</div><div class="_hex-num"> </div><div class="_hex-num" data-index="72">72</div><div class="_hex-num" data-index="73">56</div><div class="_hex-num" data-index="74">69</div><div class="_hex-num" data-index="75">65</div><div class="_hex-num"> </div><div class="_hex-num" data-index="76">77</div><div class="_hex-num" data-index="77">20</div><div class="_hex-num" data-index="78">E4</div><div class="_hex-num" data-index="79">B8</div></div><div class="buffer-view-line"><div class="_hex-num" data-index="80">AD</div><div class="_hex-num" data-index="81">E5</div><div class="_hex-num" data-index="82">B1</div><div class="_hex-num" data-index="83">95</div><div class="_hex-num"> </div><div class="_hex-num" data-index="84">E7</div><div class="_hex-num" data-index="85">A4</div><div class="_hex-num" data-index="86">BA</div><div class="_hex-num"> </div><div class="_hex-num"> </div></div></div></div></div><h1 id="look-back-to-std-unicode" class="std-title --fontTitle"><a href="#look-back-to-std-unicode" class="markdownIt-Anchor">#</a> 回头看 Unicode 标准<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">前面主要讨论了 Unicode 的编码，但是编码部分只是 Unicode 标准的一部分，此处更具体的记录一下 Unicode 的诞生细节：</div><ol class="numbering-main" data-minimap-color="#DDDDDD"><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">1.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">Unicode 1987 年提出，目的是提供一种统一的字符编码</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">2.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">标准由 Unicode Consortium（Unicode 组织/联盟）维护，这个联盟的宗旨是让 Unicode 取代其他的编码，成为唯一标准</div></li></ol><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">根据 Unicode 组织的网站上的 <div class="std-inline-code" data-minimap-color="#f5e9e9">Unicode 技术报告 #17</div> 显示，前面我写的那些编码方式只是整个 Unicode 标准一部分而已：</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><a href="https://www.unicode.org/reports/tr17/tr17-3.html" target="_blank" style="background-color:#e2f8de" class="std-link --fontSansSerif  _block" data-minimap-color="#e2f8de"><span class="std-link-icon r-link" data-src="/get-favicon/www.unicode.org?h=11477315382" style="background-image:url(&quot;/get-favicon/www.unicode.org?h=11477315382&quot;)"></span><span class="std-link-txt">Unicode 技术报告 UTR#17</span></a></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">根据这份报告，Unicode 标准主要有五个部分构成，或者称为 <div class="std-inline-code" data-minimap-color="#f5e9e9">五层模型</div>:</div><h2 id="acr:-abstract-character-repertoire-(抽象字符表)-" class="std-title --fontTitle">ACR: Abstract Character Repertoire (抽象字符表) </h2><blockquote lang="en" class="std-quote"><span class="std-quote-text">the set of characters to be encoded, e.g., some alphabet or symbol set</span><span class="std-quote-by">UTR#17 原文</span></blockquote><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">就是字符集收录，相当于字典，比如 🍰 就在 ACR 中, 比如我们的汉字也都在 Unicode 字符集中，称为 ACR</div><h2 id="ccs:-coded-character-set-(编码字符集)-" class="std-title --fontTitle">CCS: Coded Character Set (编码字符集) </h2><blockquote lang="en" class="std-quote"><span class="std-quote-text">a mapping from an abstract character repertoire to a set of non-negative integers</span><span class="std-quote-by">UTR#17 原文</span></blockquote><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">ACR 里每一个字符到码点的映射关系，将这些映射关系放置在 CCS 中，这其实就是 🍰 映射到其码点 U+1F370，定义了所有字符到码点的映射关系</div><h2 id="cef:-character-encoding-form-(字符编码方式)-" class="std-title --fontTitle">CEF: Character Encoding Form (字符编码方式) </h2><blockquote lang="en" class="std-quote"><span class="std-quote-text">a mapping from a set of non-negative integers (from a CCS) to a set of sequences of particular code units of some specified width, such as bytes</span><span class="std-quote-by">UTR#17 原文</span></blockquote><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">定义了码点如何编码为特定的 bit 位宽的「码元」，比如:</div><ul class="numbering-main" data-minimap-color="#DDDDDD"><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">UTF-32 直接用 4 字节将码点当成 uint32 无符号整数进行编码，其一个码元是 4 字节</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">UTF-16, 一个码元是 2 字节，根据读取到的第一个码元的范围，分两种情况:</div></li><li class="numbering-item"><ol class="numbering-main" data-minimap-color="#DDDDDD"><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">1.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">码点位于 BMP 平面的 0x0000 ~ 0xFFFF 这个区间的时候直接用一个码元即两个字节进行编码</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">2.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">码元在后续平面，此时通过高低代理的方式将 20 位码点信息编码到 4 字节 2 个码元中</div></li></ol></li><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">UTF-8 用 1 字节的变长编码形式进行编码, 其码元位宽就是 1 字节, 而从其编码细节来看首字节最大可指定变长编码的长度为 7，因此最大可以有 8 个码元</div></li><li class="numbering-item"><ol class="numbering-main" data-minimap-color="#DDDDDD"><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">1.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">0b0xxxxxxx: 能编码的位数是 7，跟 ASCII 刚好对应</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">2.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">0b10xxxxxx 0b10xxxxxx: 能编码的位数是 12 位</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">3.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">0b110xxxxx 0b10xxxxxx 0b10xxxxxx: 能编码的位数是 17 位</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">4.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">0b1110xxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx: 能编码的位数是 22 位</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">5.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">0b11110xxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx: 能编码的位数是 27 位</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">6.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">0b111110xx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx: 能编码的位数是 32 位</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">7.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">0b1111110x 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx: 能编码的位数是 37 位, 已经超过 32 位了，实际不可能出现</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-decimal">8.</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">0b11111110 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx: 能编码的位数是 42 位，已经超过 32 位了，实际不可能出现</div></li></ol></li></ul><h2 id="ces:-character-encoding-scheme-(字符编码方案)" class="std-title --fontTitle">CES: Character Encoding Scheme (字符编码方案)</h2><blockquote lang="en" class="std-quote"><span class="std-quote-text">a mapping from a set of sequences of codes units (from one or more CEFs) to a serialized sequence of bytes</span><span class="std-quote-by">UTR#17 原文</span></blockquote><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这层其实比较薄，就是将码点填充到前面 CEF 所允许那些位里面去，最后输出为 byte 流</div><h2 id="tes:-transfer-encoding-syntax-(传输编码句法)" class="std-title --fontTitle">TES: Transfer Encoding Syntax (传输编码句法)</h2><blockquote lang="en" class="std-quote"><span class="std-quote-text">a reversible transform of encoded data. This data may or may not contain textual data</span><span class="std-quote-by">UTR#17 原文</span></blockquote><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">我理解是在传输的过程中检测 UTF 编码的语法机制，比如两个 case：</div><ul class="numbering-main" data-minimap-color="#DDDDDD"><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">HTML 里指定编码: <div class="std-inline-code" data-minimap-color="#f5e9e9">&lt;meta charset=&quot;utf-8&quot; /&gt;</div></div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">Unicode UTF-32 和 UTF-16 里面出现的 BOM: FEFF0000 来表明大小端的情况也算是</div></li></ul><h1 id="-2853124934" class="std-title --fontTitle"><a href="#-2853124934" class="markdownIt-Anchor">#</a> 注意力大集中<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这里写一下我在实现过程中注意到的几个问题，也许日后有机会参与 unicode 的完全重构的时候再认真考虑一下这几个问题（虽然这个 connecting the dots 绝不可能发生 ....）</div><h2 id="中文字符码点连续性问题" class="std-title --fontTitle">中文字符码点连续性问题</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">网上一个关于码点的设计问题：（算是五层模型里 CCS 的问题）</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><input value="一二三四五甲乙丙丁戊ABCDE" style="font-size:1rem;margin-bottom:1em;display:block;width:100%;padding:.5em;box-sizing:border-box;border:1px solid #BBB;text-align:center" placeholder="一二三四五甲乙丙丁戊ABCDE"/><div style="display:flex;flex-wrap:wrap;justify-content:center"><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#eee9e8;margin:1em"><div style="font-size:2em;background-color:#cac2c0;display:inline-block;width:2em;height:2em;line-height:2em">一</div><div style="height:1em;line-height:1em;margin-top:.5em">U+4E00</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#efe9e8;margin:1em"><div style="font-size:2em;background-color:#cbc2c0;display:inline-block;width:2em;height:2em;line-height:2em">二</div><div style="height:1em;line-height:1em;margin-top:.5em">U+4E8C</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#efe9e8;margin:1em"><div style="font-size:2em;background-color:#cbc2c0;display:inline-block;width:2em;height:2em;line-height:2em">三</div><div style="height:1em;line-height:1em;margin-top:.5em">U+4E09</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e4efe8;margin:1em"><div style="font-size:2em;background-color:#bacac0;display:inline-block;width:2em;height:2em;line-height:2em">四</div><div style="height:1em;line-height:1em;margin-top:.5em">U+56DB</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f1e9e8;margin:1em"><div style="font-size:2em;background-color:#cec2c0;display:inline-block;width:2em;height:2em;line-height:2em">五</div><div style="height:1em;line-height:1em;margin-top:.5em">U+4E94</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e0ece8;margin:1em"><div style="font-size:2em;background-color:#b6c6c0;display:inline-block;width:2em;height:2em;line-height:2em">甲</div><div style="height:1em;line-height:1em;margin-top:.5em">U+7532</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e6e9e8;margin:1em"><div style="font-size:2em;background-color:#bdc2c0;display:inline-block;width:2em;height:2em;line-height:2em">乙</div><div style="height:1em;line-height:1em;margin-top:.5em">U+4E59</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f2e9e8;margin:1em"><div style="font-size:2em;background-color:#cfc2c0;display:inline-block;width:2em;height:2em;line-height:2em">丙</div><div style="height:1em;line-height:1em;margin-top:.5em">U+4E19</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#eee9e8;margin:1em"><div style="font-size:2em;background-color:#cac2c0;display:inline-block;width:2em;height:2em;line-height:2em">丁</div><div style="height:1em;line-height:1em;margin-top:.5em">U+4E01</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e2e0e8;margin:1em"><div style="font-size:2em;background-color:#b8b5c0;display:inline-block;width:2em;height:2em;line-height:2em">戊</div><div style="height:1em;line-height:1em;margin-top:.5em">U+620A</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f2e6e8;margin:1em"><div style="font-size:2em;background-color:#d0bdc0;display:inline-block;width:2em;height:2em;line-height:2em">A</div><div style="height:1em;line-height:1em;margin-top:.5em">U+0041</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f2e6e8;margin:1em"><div style="font-size:2em;background-color:#d0bdc0;display:inline-block;width:2em;height:2em;line-height:2em">B</div><div style="height:1em;line-height:1em;margin-top:.5em">U+0042</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f3e6e8;margin:1em"><div style="font-size:2em;background-color:#d0bdc0;display:inline-block;width:2em;height:2em;line-height:2em">C</div><div style="height:1em;line-height:1em;margin-top:.5em">U+0043</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f3e6e8;margin:1em"><div style="font-size:2em;background-color:#d0bdc0;display:inline-block;width:2em;height:2em;line-height:2em">D</div><div style="height:1em;line-height:1em;margin-top:.5em">U+0044</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f3e6e8;margin:1em"><div style="font-size:2em;background-color:#d0bdc0;display:inline-block;width:2em;height:2em;line-height:2em">E</div><div style="height:1em;line-height:1em;margin-top:.5em">U+0045</div></div></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">发现了吗？汉字的 <div class="std-inline-code" data-minimap-color="#f5e9e9">一二三四甲乙丙丁</div> 在码点上并不是连续的, 而 ABCD 这些就是连续的，不过还好汉语拼音声母 ㄅBo ㄆPo ㄇMo ㄈFo ㄉDe 或者日语假名 あa いi うu えe おo 是符合正序排列的</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><input value="ㄅㄆㄇㄈㄉあいうえお" style="font-size:1rem;margin-bottom:1em;display:block;width:100%;padding:.5em;box-sizing:border-box;border:1px solid #BBB;text-align:center" placeholder="ㄅㄆㄇㄈㄉあいうえお"/><div style="display:flex;flex-wrap:wrap;justify-content:center"><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e4efe8;margin:1em"><div style="font-size:2em;background-color:#bbcbc0;display:inline-block;width:2em;height:2em;line-height:2em">ㄅ</div><div style="height:1em;line-height:1em;margin-top:.5em">U+3105</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e4efe8;margin:1em"><div style="font-size:2em;background-color:#bbcbc0;display:inline-block;width:2em;height:2em;line-height:2em">ㄆ</div><div style="height:1em;line-height:1em;margin-top:.5em">U+3106</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e4efe8;margin:1em"><div style="font-size:2em;background-color:#bbcbc0;display:inline-block;width:2em;height:2em;line-height:2em">ㄇ</div><div style="height:1em;line-height:1em;margin-top:.5em">U+3107</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e4efe8;margin:1em"><div style="font-size:2em;background-color:#bbcbc0;display:inline-block;width:2em;height:2em;line-height:2em">ㄈ</div><div style="height:1em;line-height:1em;margin-top:.5em">U+3108</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e4efe8;margin:1em"><div style="font-size:2em;background-color:#bbcbc0;display:inline-block;width:2em;height:2em;line-height:2em">ㄉ</div><div style="height:1em;line-height:1em;margin-top:.5em">U+3109</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#ddeee8;margin:1em"><div style="font-size:2em;background-color:#b1cac0;display:inline-block;width:2em;height:2em;line-height:2em">あ</div><div style="height:1em;line-height:1em;margin-top:.5em">U+3042</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#ddeee8;margin:1em"><div style="font-size:2em;background-color:#b1cac0;display:inline-block;width:2em;height:2em;line-height:2em">い</div><div style="height:1em;line-height:1em;margin-top:.5em">U+3044</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#ddeee8;margin:1em"><div style="font-size:2em;background-color:#b1cac0;display:inline-block;width:2em;height:2em;line-height:2em">う</div><div style="height:1em;line-height:1em;margin-top:.5em">U+3046</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#deeee8;margin:1em"><div style="font-size:2em;background-color:#b2cac0;display:inline-block;width:2em;height:2em;line-height:2em">え</div><div style="height:1em;line-height:1em;margin-top:.5em">U+3048</div></div><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#dfeee8;margin:1em"><div style="font-size:2em;background-color:#b3cac0;display:inline-block;width:2em;height:2em;line-height:2em">お</div><div style="height:1em;line-height:1em;margin-top:.5em">U+304A</div></div></div></div><h2 id="utf-16-高/低代理打洞的问题" class="std-title --fontTitle">UTF-16 高/低代理打洞的问题</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">前面的具体讨论中已经清楚，现在的 Unicode BMP 平面定义里单独给 UTF-16 做了高低代理区间的打洞来实现 20 位码点的编码</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这个方式太 hack 了，我其实不太喜欢，但是这又是 trade-off 的艺术，UTF-16 其实非常好的兼顾了编码的时间复杂度和空间复杂度</div><h2 id="utf-24-可行性？" class="std-title --fontTitle">UTF-24 可行性？</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">UTF-16 通过高低代理对的方式编排了 20 位 bits，而这 20 位中高 4 位代表所在的 unicode 平面，低 16 位代表其平面的偏移 —— 总之 20 位足够编排 16 个平面了，如果期望包含全部的 17 个平面，用 21 位就行了，那么在这种情况下为什么没有 UTF-20 或 21 或 UTF-24 的编码方式呢？</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">理论上应该可行，不过估计会被狂喷，因为我在 zhihu 上问过</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><a href="https://www.zhihu.com/question/651260057" target="_blank" style="background-color:#e4e7ea" class="std-link --fontSansSerif  _line" data-minimap-color="#e4e7ea"><span class="std-link-icon r-link" data-src="/get-favicon/www.zhihu.com?h=9638207561" style="background-image:url(&quot;/get-favicon/www.zhihu.com?h=9638207561&quot;)"></span><span class="std-link-txt">知乎 - 为什么没有 UTF-24 ？</span></a></div><h2 id="如何在第一个字节区分是-utf-8-还是-ascii" class="std-title --fontTitle">如何在第一个字节区分是 UTF-8 还是 ASCII</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">由于 UTF-8 是单字节编码，因此它没有 BOM，在这种情况下如果是纯英文文档 UTF-8 将跟 ASCII 输出一模一样的结果，而如果其中混入一两个中文 —— 这种情况下编辑器就不好判断该用哪个编码了, 可能就会出现你在浏览纯英文本的时候碰到一两个乱码这种情况</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">当然现代编辑器谁不支持 UTF-8 ?（我这里其实点草了微软系统里的记事本）</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这个问题其实见仁见智，不过 UTF-8 确实可以带一个 BOM，这个 BOM 其实就只是标记了这是一个 UTF-8 文档，比如 VSCode 就支持这种带 BOM 的 utf8 编码:</div><div class="std-img-dynamic-wrapper"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:21.76%"><img class="std-img-dymanic-main r-link __mosaic __loading" src="/tsxs-esm/vscode-onsave.b6bd483a395a9ad3.png.mosaic.png"/><img class="std-img-dymanic-main" src="/tsxs-esm/vscode-onsave.b6bd483a395a9ad3.png"/></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">下面我构造了一个带 BOM 的 UTF-8 例子，为 <div class="std-inline-code" data-minimap-color="#f5e9e9">0xEF 0xBB 0xBF</div> 可以下载看看：</div><div class="buffer-view nth-0"><style></style><div class="buffer-view-header"><div class="std-icon  icon-bit-switch" style="height:2em;width:2em;overflow:hidden;display:inline-block;box-sizing:border-box"></div><div class="buffer-view-state"><div>cursor=0x0000</div><div>length=7</div><div><a download="UTF-8 with BOM 例子.txt" href="">download</a></div></div></div><div class="buffer-view-ranges"><div class="_line-range">0x0000</div></div><div class="buffer-view-lines"><div class="buffer-view-line"><div class="_hex-num" data-index="0">EF</div><div class="_hex-num" data-index="1">BB</div><div class="_hex-num" data-index="2">BF</div><div class="_hex-num" data-index="3">F0</div><div class="_hex-num"> </div><div class="_hex-num" data-index="4">9F</div><div class="_hex-num" data-index="5">8D</div><div class="_hex-num" data-index="6">B0</div><div class="_hex-num"> </div><div class="_hex-num"> </div></div></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">为什么是 <div class="std-inline-code" data-minimap-color="#f5e9e9">0xEF 0xBB 0xBF</div> 呢？ 我们不妨将其当成正常 UTF-8 流进行解析：</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token number">0xEF</span> <span class="token operator">=></span> <span class="token number">11101111</span> <span class="token punctuation">(</span>开头 <span class="token number">1110</span> 代表一共 <span class="token number">3</span> 字节<span class="token punctuation">,</span> 低 <span class="token number">4</span> 位是有效位<span class="token operator">:</span> <span class="token number">1111</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token number">0xBB</span> <span class="token operator">=></span> <span class="token number">10111011</span> <span class="token punctuation">(</span>低 <span class="token number">6</span> 位是有效位<span class="token operator">:</span> <span class="token number">111011</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token number">0xBF</span> <span class="token operator">=></span> <span class="token number">10111111</span> <span class="token punctuation">(</span>低 <span class="token number">6</span> 位是有效位<span class="token operator">:</span> <span class="token number">111111</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">03</span>有效位拼接后得到 <span class="token number">0b1111111011111111</span>
<span class="line-numbers-rows" style="user-select: none;">04</span>转成十六进制恰好就是 <span class="token number">0xFEFF</span> 这恰好就是 <span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">16</span> 的 <span class="token constant">BOM</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">换个角度来说，0xEF 0xBB 0xBF 最后会被当成码点 0xFEFF 被编辑器识别，它在编码层面是有意义的比如你可以这样构造它:</div><div class="std-code"><pre class="prismjs ts rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">// Node REPL</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token operator">></span> str <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0xEF</span><span class="token punctuation">,</span> <span class="token number">0xBB</span><span class="token punctuation">,</span> <span class="token number">0xBF</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token comment">// => 显示为 'A'</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token operator">></span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">04</span><span class="token comment">// => 2 实际为 '\uFEFFA', 只是显示不出 0xFEFF 了</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">实际上 0xFEFF 除了用作 BOM 外，实际它还可以是一个合法的码点，即所谓的零宽度空格 ZWNBSP:</div><div class="std-img-dynamic-wrapper"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:70.22%"><img class="std-img-dymanic-main r-link __mosaic __loading" src="/tsxs-esm/U+FEFF.257a1b9e382662c2.png.mosaic.png"/><img class="std-img-dymanic-main" src="/tsxs-esm/U+FEFF.257a1b9e382662c2.png"/></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><a href="https://compart.com/en/unicode/U+FEFF" target="_blank" style="background-color:#f5e4f0" class="std-link --fontSansSerif  _block" data-minimap-color="#f5e4f0"><span class="std-link-icon r-link" data-src="/get-favicon/compart.com?h=-13628651562" style="background-image:url(&quot;/get-favicon/compart.com?h=-13628651562&quot;)"></span><span class="std-link-txt">U+FEFF - (BOM, ZWNBSP)</span></a></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这下懂了吧，在首字节插入 U+FEFF 零宽度空格就能区分 ASCII 和 UTF-8 编码啦，这其实也是一种 trade-off 的艺术，单独定义了一个特殊码点用来实现特殊功能</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">此外这个零宽度空格在 Ctrl+A 全选的时候也会选中复制到剪贴板，在粘贴到 SQL 命令行写入 UTF-8 的时候有可能会遇到问题（如果 DB 不支持带 BOM 的 UTF-8 就 GG 了）</div><h2 id="utf-8-字节流传输截断问题" class="std-title --fontTitle">UTF-8 字节流传输截断问题</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">还是以零宽度空格的 0xEF 0xBB 0xBF 来说：</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token number">0xEF</span> <span class="token operator">=></span> <span class="token number">11101111</span> <span class="token punctuation">(</span>开头 <span class="token number">1110</span> 代表一共 <span class="token number">3</span> 字节<span class="token punctuation">,</span> 低 <span class="token number">4</span> 位是有效位<span class="token operator">:</span> <span class="token number">1111</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token number">0xBB</span> <span class="token operator">=></span> <span class="token number">10111011</span> <span class="token punctuation">(</span>低 <span class="token number">6</span> 位是有效位<span class="token operator">:</span> <span class="token number">111011</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>0cBF <span class="token operator">=></span> <span class="token number">10111111</span> <span class="token punctuation">(</span>低 <span class="token number">6</span> 位是有效位<span class="token operator">:</span> <span class="token number">111111</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">03</span>有效位拼接后得到 <span class="token number">0b1111111011111111</span>
<span class="line-numbers-rows" style="user-select: none;">04</span>转成十六进制恰好就是 <span class="token number">0xFEFF</span> 这恰好就是 <span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">16</span> 的 <span class="token constant">BOM</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">试想如果只传输了 0xEF 就 TCP 断开或者服务端掉线了, 我这里就构造了这样的情况，服务返回了一个错误的 utf-8 字节流导致浏览器乱码的情况:</div><div class="std-code"><pre class="prismjs ts rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">01</span>http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html; charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">03</span>  res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0xEF</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">04</span>  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">05</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div><div class="std-img-dynamic-wrapper"><div class="std-img-dynamic" data-minimap="Rect" style="padding-bottom:44.08%"><img class="std-img-dymanic-main r-link __mosaic __loading" src="/tsxs-esm/utf8-decode-error.f13ac8390394bde4.png.mosaic.png"/><img class="std-img-dymanic-main" src="/tsxs-esm/utf8-decode-error.f13ac8390394bde4.png"/></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这种情况可能到处都有，只是日常都不怎么考虑到。</div><h3 id="进程-stdout-拼接问题" class="std-title --fontTitle">进程 stdout 拼接问题</h3><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">stdout 也是一段一段的字节流，可能两段输出就断在 UTF-8 的首字节了，具体来说，&#x27;永&#x27; 这个字可以用 UTF-8 编码为:</div><div class="buffer-view nth-0"><style></style><div class="buffer-view-header"><div class="std-icon  icon-bit-switch" style="height:2em;width:2em;overflow:hidden;display:inline-block;box-sizing:border-box"></div><div class="buffer-view-state"><div>cursor=0x0000</div><div>length=3</div><div><a download="UTF-8 永.txt" href="">download</a></div></div></div><div class="buffer-view-ranges"><div class="_line-range">0x0000</div></div><div class="buffer-view-lines"><div class="buffer-view-line"><div class="_hex-num" data-index="0">E6</div><div class="_hex-num" data-index="1">B0</div><div class="_hex-num" data-index="2">B8</div><div class="_hex-num"> </div><div class="_hex-num"> </div><div class="_hex-num"> </div></div></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">当我们监听 stdout 并收集 ondata 输出的时候，有可能不会一步到位，而是在中间截断得到两段 buffer (短文本很难遇到，长文本就经常遇到了)：</div><div class="std-code"><pre class="prismjs ts rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token operator">&lt;</span>Buffer <span class="token constant">E6</span><span class="token operator">></span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token operator">&lt;</span>Buffer <span class="token constant">B0</span> <span class="token constant">B8</span><span class="token operator">></span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">如果此时这样处理就会乱码了：</div><div class="std-code"><pre class="prismjs ts rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token operator">&lt;</span>Buffer <span class="token constant">E6</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token operator">&lt;</span>Buffer <span class="token constant">B0</span> <span class="token constant">B8</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">我们需要将其 concat 成单个 buffer 后再 toString 这样才没问题。</div><div class="std-code"><pre class="prismjs ts rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span>Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
<span class="line-numbers-rows" style="user-select: none;">01</span>  <span class="token operator">&lt;</span>Buffer <span class="token constant">E6</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>  <span class="token operator">&lt;</span>Buffer <span class="token constant">B0</span> <span class="token constant">B8</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这个 case 我是遇到过的，当时是调用的是 buffers.join(&#x27;&#x27;) 来拼接，实际这样就是给每个子元素跑一次 toString 在将其加起来，导致最后出现乱码的问题。</div><h1 id="EOF" class="std-title --fontTitle"><a href="#EOF" class="markdownIt-Anchor">#</a> EOF<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">好了，这篇长文终于写完了，这里写一下总结：</div><ul class="numbering-main" data-minimap-color="#DDDDDD"><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">Unicode 编码空间、码点、平面、区块</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">UTF-32: 将码点当成 4 字节 uint32 进行存储</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">UTF-16: 第一平面内的直接用 2 字节存储；后续平面的则通过高低代理对的方式填充 20 位 bits 进行码点的编码，这 20 位里高 4 位是平面编号，低 16 位是在平面内的偏移 —— 也因此要减去 0x10000 来避免对第一平面的重复编码</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">UTF-8: 通过 UTF-8 头的方式控制的变长编码，将编码位提出后提取并拼接有效载荷即可将码点编码进去</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">UCS-2: 即第一平面，UTF-16 可以完全兼容它</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">ASCII: 低 128 位，UTF-8 能完全兼容它</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">JavaScript 里的 UTF-16: 由于编码的原因可能会造成一些有趣的 case</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">Unicode 五层模型: ACR、CCS、CEF、CES、TES</div></li><li class="numbering-item"><div class="numbering-marker numbering-marker-rect"></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">对 Unicode 的个人思考</div></li></ul><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">不好，前面太集中了，现在开始注意力涣散了 ...</div></div></article></div></div><div class="smcphr rally-page-smcphr"></div><div class="std-box rally-giscus-wrapper default-max-width"><div class="std-box-content "></div></div></div>
<script>window.__INITIAL_STATE__ = {"CategoryApiState":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"BlogApiState":{"loaded":true,"loading":false,"error":null,"dataMap":{"the-structure-and-interpretation-of-std-unicode-and-its-utf-encodings":{"type":"tsx","meta":{"id":"the-structure-and-interpretation-of-std-unicode-and-its-utf-encodings","title":"Unicode 标准及其 UTF 编码的构造和解释","author":"eczn","category":"注意力训练","time":"2024-03-31T11:50:00.000Z","type":"article","appTitle":"","appIcon":"","intro":"未定义 intro","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},"tsxDistPath":"./the-structure-and-interpretation-of-std-unicode-and-its-utf-encodings/index.blog.js","ssrContent":"<div class=\"std-img-dynamic-wrapper\" style=\"width:5em;float:right;margin-left:1em\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:100.00%\"><div class=\"std-img-dymanic-main __texttip __loading\">loading...</div><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/apple.718fff3e244bedf1.svg\"/></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><span class=\"std-sinking --fontTitle\">长</span>久以来对 unicode 的一些细节还是不够清晰，因此今天集中注意力深入研究并实现 Unicode 最常用的三种编码 UTF-32/16/8 来获得完全同步 (超长文警告)</div><h1 id=\"what-is-unicode\" class=\"std-title --fontTitle\"><a href=\"#what-is-unicode\" class=\"markdownIt-Anchor\">#</a> Unicode 是什么 ?<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">Unicode 与众所周知的 ASCII 是同一类的东西，是字符编码的一种方案，可以用来将 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">字符实体</div> 编码到某个整数空间中，比如 Unicode 里的数字 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">0x0041</div> 对应的是 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">&#x27;A&#x27;</div>，记作 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">U+0041</div>，称作 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">码点 Code Point</div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">截止到 2024，已经有上百亿设备上跑着 Unicode 了，是这个星球上最常见的字符编码方案了，如果哪天发现了外星人需要传点什么东西跟他们做文化交流，完全可以将 Unicode 标准发给他们。</div><h2 id=\"unicode-码点-(code-point)\" class=\"std-title --fontTitle\">Unicode 码点 (Code Point)</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">所谓码点就是我前面提到的那个数字了，Unicode 规范里的每一个字符实体都有唯一的「整数」作为其码点。</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">在现代浏览器上都支持 Unicode 编码，这意味着你在网页上输入的任意一个字符都对应一个码点，在下面这个 Demo 中可以输入字符串并将其转为对应码点信息, 可以试试</div><div class=\"std-window mode-windowed\"><div class=\"std-window-menus\"><div class=\"std-window-title\"><span></span></div><div class=\"std-window-btns\"><div class=\"std-icon std-window-menu-btn\" style=\"overflow:hidden;border-radius:1em;box-sizing:border-box\"></div><div class=\"std-icon std-window-menu-btn\" style=\"overflow:hidden;border-radius:1em;box-sizing:border-box\"></div></div></div><div style=\"height:auto\" class=\"std-window-content\"><div style=\"padding:2em\"><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><input value=\"ECZN\" style=\"font-size:1rem;margin-bottom:1em;display:block;width:100%;padding:.5em;box-sizing:border-box;border:1px solid #BBB;text-align:center\" placeholder=\"ECZN\"/><div style=\"display:flex;flex-wrap:wrap;justify-content:center\"><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f3e6e8;margin:1em\"><div style=\"font-size:2em;background-color:#d0bdc0;display:inline-block;width:2em;height:2em;line-height:2em\">E</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+0045</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f3e6e8;margin:1em\"><div style=\"font-size:2em;background-color:#d0bdc0;display:inline-block;width:2em;height:2em;line-height:2em\">C</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+0043</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#dfe6e8;margin:1em\"><div style=\"font-size:2em;background-color:#b3bdc0;display:inline-block;width:2em;height:2em;line-height:2em\">Z</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+005A</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#dce6e8;margin:1em\"><div style=\"font-size:2em;background-color:#afbdc0;display:inline-block;width:2em;height:2em;line-height:2em\">N</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+004E</div></div></div></div></div></div></div><div style=\"display:none;height:0px;background:#BBB\">placeholder</div><h2 id=\"unicode-编码空间-(encoding-space)\" class=\"std-title --fontTitle\">Unicode 编码空间 (Encoding-Space)</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">从 Unicode 规范来看，字符所对应的整数「码点」应该是一个 4 字节无符号整数，其编码空间相当大，即 2^32 这么大，但是在这么大的容量目前其实只用了一百一十多万而已，而且在这 100 多万里面还有很多还没用上呢，只是预先划分出来了。</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">Unicode 标准组织为了管理上的方便，提出了两种划分这个整数空间的方式，一种是 Unicode 平面划分，一种是 Unicode 区块划分。</div><h2 id=\"unicode-平面划分-(plane)\" class=\"std-title --fontTitle\">Unicode 平面划分 (Plane)</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">将码点的整数空间以 65536 (即 0x0 到 0xFFFF) 的长度来将这个四字节整数分割成不同的区间，在规范里这些区间的学名叫做平面</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">而这 4 字节证书容量为 2^32 即 4294967296。若以 65536 为区间划分的话刚好也能划分出 65536 个平面，即 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">0x0000xxxx ~ 0xFFFFxxxx</div>（xxxx 为平面内的偏移）</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">比如最开头的第一个区间 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">U+00000000</div> 到 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">U+0000FFFF</div> 是第一个平面，叫做 BMP，英文是 Basic Multilingual Plane, 里面包含了最常用的 65536 个字符，而在其中最前面的 128 个码点含义跟 ASCII 编码保持一致，以此来保证能向下兼容 ASCII</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">再比如，第二个平面是 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">U+010000</div> 到 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">U+01FFFF</div>, 名字是 SMP 平面，英文是 Supplementary Multilingual Plane, 字面意思是多语种辅助平面</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">目前 Unicode 官方定义了 17 个平面, 即 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">U+00xxxx</div> 到 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">U+10xxxx</div>，这个数量其实相当小，因此书写码点的时候通常会将前面的 0 省略掉，比如第一平面 BMP 的范围是: <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">U+0000</div> 到 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">U+FFFF</div>；又比如蛋糕的 emoji <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">🍰</div> 这个字符的码点是 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">U+1F370</div> 因此它位于第二平面 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">SMP</div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">或许你已经发现了，按 65536 为区间划分的好处了，就是以 16 进制表示的时候，最低 4 位就是平面内的偏移，高位则是平面的序号，比如 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">U+00xxxx</div> 是第一平面 BMP； <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">U+01xxxx</div> 是第二平面 SMP 以此类推，下面是官方定义的十七个平面定义，其中 4 号 到 13 号只是分配了但还没用到：</div><table style=\"width:100%;display:block;font-size:75%;text-align:center;border-collapse:collapse;margin-bottom:1em;font-family:var(--fontArticle)\"><thead><tr><th style=\"padding:.5em;border:1px solid #BBB;width:5em\">平面编号</th><th style=\"padding:.5em;border:1px solid #BBB\">码点区间</th><th style=\"padding:.5em;border:1px solid #BBB\">英文名</th><th style=\"padding:.5em;border:1px solid #BBB\">中文名</th></tr></thead><tbody><tr><td style=\"padding:.5em;border:1px solid #BBB\">0 号平面</td><td style=\"padding:.5em;border:1px solid #BBB;font-family:var(--fontCode)\">U+000000 - U+00FFFF</td><td style=\"padding:.5em;border:1px solid #BBB\">BMP: Basic Multilingual Plane</td><td style=\"padding:.5em;border:1px solid #BBB\">基本多文种平面</td></tr><tr><td style=\"padding:.5em;border:1px solid #BBB\">1 号平面</td><td style=\"padding:.5em;border:1px solid #BBB;font-family:var(--fontCode)\">U+010000 - U+01FFFF</td><td style=\"padding:.5em;border:1px solid #BBB\">SMP: Supplementary Multilingual Plane</td><td style=\"padding:.5em;border:1px solid #BBB\">多文种补充平面</td></tr><tr><td style=\"padding:.5em;border:1px solid #BBB\">2 号平面</td><td style=\"padding:.5em;border:1px solid #BBB;font-family:var(--fontCode)\">U+020000 - U+02FFFF</td><td style=\"padding:.5em;border:1px solid #BBB\">SIP: Supplementary Ideographic Plane</td><td style=\"padding:.5em;border:1px solid #BBB\">表意文字补充平面</td></tr><tr><td style=\"padding:.5em;border:1px solid #BBB\">3 号平面</td><td style=\"padding:.5em;border:1px solid #BBB;font-family:var(--fontCode)\">U+030000 - U+03FFFF</td><td style=\"padding:.5em;border:1px solid #BBB\">TIP: Tertiary Ideographic Plane</td><td style=\"padding:.5em;border:1px solid #BBB\">表意文字第三平面</td></tr><tr><td style=\"padding:.5em;border:1px solid #BBB\">4 号平面 ~ 13 号平面</td><td style=\"padding:.5em;border:1px solid #BBB;font-family:var(--fontCode)\">U+040000 - U+0DFFFF</td><td style=\"padding:.5em;border:1px solid #BBB\">已分配，但尚未使用</td><td style=\"padding:.5em;border:1px solid #BBB\">/</td></tr><tr><td style=\"padding:.5em;border:1px solid #BBB\">14 号平面</td><td style=\"padding:.5em;border:1px solid #BBB;font-family:var(--fontCode)\">U+0E0000 - U+0EFFFF</td><td style=\"padding:.5em;border:1px solid #BBB\">SSP: Supplementary Special-purpose Plane</td><td style=\"padding:.5em;border:1px solid #BBB\">特别用途补充平面</td></tr><tr><td style=\"padding:.5em;border:1px solid #BBB\">15 号平面</td><td style=\"padding:.5em;border:1px solid #BBB;font-family:var(--fontCode)\">U+0F0000 - U+0FFFFF</td><td style=\"padding:.5em;border:1px solid #BBB\">PUA-A: Private Use Area-A</td><td style=\"padding:.5em;border:1px solid #BBB\">保留作为私人使用区 (A区)</td></tr><tr><td style=\"padding:.5em;border:1px solid #BBB\">16 号平面</td><td style=\"padding:.5em;border:1px solid #BBB;font-family:var(--fontCode)\">U+100000 - U+10FFFF</td><td style=\"padding:.5em;border:1px solid #BBB\">PUA-B: Private Use Area-B</td><td style=\"padding:.5em;border:1px solid #BBB\">保留作为私人使用区 (B区)</td></tr></tbody></table><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">更具体平面的完整分配规则可以查看规范官网：</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><a href=\"https://www.unicode.org/roadmaps/index.html\" target=\"_blank\" style=\"background-color:#e6f6f6\" class=\"std-link --fontSansSerif  _block\" data-minimap-color=\"#e6f6f6\"><span class=\"std-link-icon r-link\" data-src=\"/get-favicon/www.unicode.org?h=182773085\" style=\"background-image:url(&quot;/get-favicon/www.unicode.org?h=182773085&quot;)\"></span><span class=\"std-link-txt\">Unicode Roadmap Define</span></a></div><h2 id=\"unicode-区块-(block)\" class=\"std-title --fontTitle\">Unicode 区块 (block)</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">Block 是对 Plane 进一步的划分，比如在 BMP 0x0000~0xFFFF 这个平面中，最开始的 128 位是 ASCII 编码, 从官网给出的 Plane 划分来看，区块就是表格上的这些格子：</div><div class=\"std-img-dynamic-wrapper\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:69.79%\"><img class=\"std-img-dymanic-main r-link __mosaic __loading\" src=\"/tsxs-esm/unicode-bmp.587739de631defec.png.mosaic.png\"/><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/unicode-bmp.587739de631defec.png\"/></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">其中最开头的 C0-Controls 加上 Basic Latain 其实就对应了 ASCII 编码，而汉字编码，主要存到 CKJ 区块中等等 —— 总之区块是对平面的再划分，一个平面上可以有很多区块，具体区块可以看 Unicode 官网说明</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><a href=\"https://www.unicode.org/roadmaps/index.html\" target=\"_blank\" style=\"background-color:#e6f6f6\" class=\"std-link --fontSansSerif  _block\" data-minimap-color=\"#e6f6f6\"><span class=\"std-link-icon r-link\" data-src=\"/get-favicon/www.unicode.org?h=182773085\" style=\"background-image:url(&quot;/get-favicon/www.unicode.org?h=182773085&quot;)\"></span><span class=\"std-link-txt\">Unicode Roadmap Define</span></a></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">前面 Unicode 平面里的 15 和 16 号平面是所谓的 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">A区</div> 和 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">B区</div> 这两个区间是保留给开发者随意定义的。而除了这两个平面外，在第一平面 BMP 内下面这个区块 0xE000 ~ 0xF8FF 也是一样的功能，用来用作 private use 的，共计 6400 个：</div><div class=\"std-img-dynamic-wrapper\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:114.33%\"><img class=\"std-img-dymanic-main r-link __mosaic __loading\" src=\"/tsxs-esm/bmp-private-use-area.67f51430862c5521.png.mosaic.png\"/><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/bmp-private-use-area.67f51430862c5521.png\"/></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">比如苹果系统的「 U+F8FF」图标就是在上面这个 Block 内的：(注意如果你不是苹果系统看不到这个 🍎 字符)</div><div class=\"std-window mode-windowed\"><div class=\"std-window-menus\"><div class=\"std-window-title\"><span></span></div><div class=\"std-window-btns\"><div class=\"std-icon std-window-menu-btn\" style=\"overflow:hidden;border-radius:1em;box-sizing:border-box\"></div><div class=\"std-icon std-window-menu-btn\" style=\"overflow:hidden;border-radius:1em;box-sizing:border-box\"></div></div></div><div style=\"height:auto\" class=\"std-window-content\"><div style=\"padding:2em\"><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><input value=\"🍎\" style=\"font-size:1rem;margin-bottom:1em;display:block;width:100%;padding:.5em;box-sizing:border-box;border:1px solid #BBB;text-align:center\" placeholder=\"🍎\"/><div style=\"display:flex;flex-wrap:wrap;justify-content:center\"><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e5e9e8;margin:1em\"><div style=\"font-size:2em;background-color:#bdc2c1;display:inline-block;width:2em;height:2em;line-height:2em\"></div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+F8FF</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f3dfeb;margin:1em\"><div style=\"font-size:2em;background-color:#d1b4c5;display:inline-block;width:2em;height:2em;line-height:2em\">🍎</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+1F34E</div></div></div></div></div></div></div><div style=\"display:none;height:0px;background:#BBB\">placeholder</div><h1 id=\"UTF-8\" class=\"std-title --fontTitle\"><a href=\"#UTF-8\" class=\"markdownIt-Anchor\">#</a> UTF-32<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">介绍完前面的码点和码点编码空间的平面和区块分配后，我们来讨论一下如何将码点编码成字节流 —— 这个工作几乎是 unicode 相关开发中最核心最重要的部分，即将码点编码成字节流，或者反过来将字节流解析为码点</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">前面提到，一个码点就是一个 uint32，因此一个一眼丁真的 unicode 编码办法就是将所有码点转成 4 字节无符号整数 —— 而这样的编码方式就是 UTF-32，它也因此得名 32</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">比如说将 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">&quot;Hello, 世界&quot;</div> 表达成对应码点并对齐到 4 字节整数</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span>字符    码点    对齐到 <span class=\"token number\">4</span> 字节整数\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token string\">'H'</span> <span class=\"token operator\">=></span> <span class=\"token constant\">U</span><span class=\"token operator\">+</span><span class=\"token number\">48</span> <span class=\"token operator\">=></span> <span class=\"token number\">0x00000048</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token string\">'e'</span> <span class=\"token operator\">=></span> <span class=\"token constant\">U</span><span class=\"token operator\">+</span><span class=\"token number\">65</span> <span class=\"token operator\">=></span> <span class=\"token number\">0x00000065</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token string\">'l'</span> <span class=\"token operator\">=></span> <span class=\"token constant\">U</span><span class=\"token operator\">+</span>6C <span class=\"token operator\">=></span> <span class=\"token number\">0x0000006C</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span><span class=\"token string\">'l'</span> <span class=\"token operator\">=></span> <span class=\"token constant\">U</span><span class=\"token operator\">+</span>6C <span class=\"token operator\">=></span> <span class=\"token number\">0x0000006C</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span><span class=\"token string\">'o'</span> <span class=\"token operator\">=></span> <span class=\"token constant\">U</span><span class=\"token operator\">+</span>6F <span class=\"token operator\">=></span> <span class=\"token number\">0x0000006F</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span><span class=\"token string\">','</span> <span class=\"token operator\">=></span> <span class=\"token constant\">U</span><span class=\"token operator\">+</span>2C <span class=\"token operator\">=></span> <span class=\"token number\">0x0000002C</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span><span class=\"token string\">' '</span> <span class=\"token operator\">=></span> <span class=\"token constant\">U</span><span class=\"token operator\">+</span><span class=\"token number\">20</span> <span class=\"token operator\">=></span> <span class=\"token number\">0x00000020</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span><span class=\"token string\">'世'</span> <span class=\"token operator\">=></span> <span class=\"token constant\">U</span><span class=\"token operator\">+</span><span class=\"token number\">4E16</span> <span class=\"token operator\">=></span> <span class=\"token number\">0x00004E16</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span><span class=\"token string\">'界'</span> <span class=\"token operator\">=></span> <span class=\"token constant\">U</span><span class=\"token operator\">+</span>754C <span class=\"token operator\">=></span> <span class=\"token number\">0x0000754C</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">再将上述对齐后的整数拼接在一起得到这样一段 Buffer 作为 UTF-32 字节流：</div><div class=\"buffer-view nth-0\"><style></style><div class=\"buffer-view-header\"><div class=\"std-icon  icon-bit-switch\" style=\"height:2em;width:2em;overflow:hidden;display:inline-block;box-sizing:border-box\"></div><div class=\"buffer-view-state\"><div>cursor=0x0000</div><div>length=40</div><div><a download=\"UTF-32 例子 (大端).txt\" href=\"\">download</a></div></div></div><div class=\"buffer-view-ranges\"><div class=\"_line-range\">0x0000</div><div class=\"_line-range\">0x0010</div><div class=\"_line-range\">0x0020</div></div><div class=\"buffer-view-lines\"><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"0\">00</div><div class=\"_hex-num\" data-index=\"1\">00</div><div class=\"_hex-num\" data-index=\"2\">FE</div><div class=\"_hex-num\" data-index=\"3\">FF</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"4\">00</div><div class=\"_hex-num\" data-index=\"5\">00</div><div class=\"_hex-num\" data-index=\"6\">00</div><div class=\"_hex-num\" data-index=\"7\">48</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"8\">00</div><div class=\"_hex-num\" data-index=\"9\">00</div><div class=\"_hex-num\" data-index=\"10\">00</div><div class=\"_hex-num\" data-index=\"11\">65</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"12\">00</div><div class=\"_hex-num\" data-index=\"13\">00</div><div class=\"_hex-num\" data-index=\"14\">00</div><div class=\"_hex-num\" data-index=\"15\">6C</div></div><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"16\">00</div><div class=\"_hex-num\" data-index=\"17\">00</div><div class=\"_hex-num\" data-index=\"18\">00</div><div class=\"_hex-num\" data-index=\"19\">6C</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"20\">00</div><div class=\"_hex-num\" data-index=\"21\">00</div><div class=\"_hex-num\" data-index=\"22\">00</div><div class=\"_hex-num\" data-index=\"23\">6F</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"24\">00</div><div class=\"_hex-num\" data-index=\"25\">00</div><div class=\"_hex-num\" data-index=\"26\">00</div><div class=\"_hex-num\" data-index=\"27\">2C</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"28\">00</div><div class=\"_hex-num\" data-index=\"29\">00</div><div class=\"_hex-num\" data-index=\"30\">00</div><div class=\"_hex-num\" data-index=\"31\">20</div></div><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"32\">00</div><div class=\"_hex-num\" data-index=\"33\">00</div><div class=\"_hex-num\" data-index=\"34\">4E</div><div class=\"_hex-num\" data-index=\"35\">16</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"36\">00</div><div class=\"_hex-num\" data-index=\"37\">00</div><div class=\"_hex-num\" data-index=\"38\">75</div><div class=\"_hex-num\" data-index=\"39\">4C</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\"> </div></div></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">你可能会发现开头的四个字节 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">0x0000FEFF</div> 貌似没有用到，实际这四个字节叫做 UTF BOM (Byte Order Mark) 是用来标记字节序的，此处表明是大端字节序，表示高位字节存储在左边，而如果是 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">0xFEFF0000</div> 则代表是小端存储，此时高 16 位和低 16 位顺序要调转一下，即：</div><div class=\"buffer-view nth-0\"><style></style><div class=\"buffer-view-header\"><div class=\"std-icon  icon-bit-switch\" style=\"height:2em;width:2em;overflow:hidden;display:inline-block;box-sizing:border-box\"></div><div class=\"buffer-view-state\"><div>cursor=0x0000</div><div>length=40</div><div><a download=\"UTF-32 例子 (小端).txt\" href=\"\">download</a></div></div></div><div class=\"buffer-view-ranges\"><div class=\"_line-range\">0x0000</div><div class=\"_line-range\">0x0010</div><div class=\"_line-range\">0x0020</div></div><div class=\"buffer-view-lines\"><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"0\">FE</div><div class=\"_hex-num\" data-index=\"1\">FF</div><div class=\"_hex-num\" data-index=\"2\">00</div><div class=\"_hex-num\" data-index=\"3\">00</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"4\">00</div><div class=\"_hex-num\" data-index=\"5\">48</div><div class=\"_hex-num\" data-index=\"6\">00</div><div class=\"_hex-num\" data-index=\"7\">00</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"8\">00</div><div class=\"_hex-num\" data-index=\"9\">65</div><div class=\"_hex-num\" data-index=\"10\">00</div><div class=\"_hex-num\" data-index=\"11\">00</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"12\">00</div><div class=\"_hex-num\" data-index=\"13\">6C</div><div class=\"_hex-num\" data-index=\"14\">00</div><div class=\"_hex-num\" data-index=\"15\">00</div></div><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"16\">00</div><div class=\"_hex-num\" data-index=\"17\">6C</div><div class=\"_hex-num\" data-index=\"18\">00</div><div class=\"_hex-num\" data-index=\"19\">00</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"20\">00</div><div class=\"_hex-num\" data-index=\"21\">6F</div><div class=\"_hex-num\" data-index=\"22\">00</div><div class=\"_hex-num\" data-index=\"23\">00</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"24\">00</div><div class=\"_hex-num\" data-index=\"25\">2C</div><div class=\"_hex-num\" data-index=\"26\">00</div><div class=\"_hex-num\" data-index=\"27\">00</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"28\">00</div><div class=\"_hex-num\" data-index=\"29\">20</div><div class=\"_hex-num\" data-index=\"30\">00</div><div class=\"_hex-num\" data-index=\"31\">00</div></div><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"32\">4E</div><div class=\"_hex-num\" data-index=\"33\">16</div><div class=\"_hex-num\" data-index=\"34\">00</div><div class=\"_hex-num\" data-index=\"35\">00</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"36\">75</div><div class=\"_hex-num\" data-index=\"37\">4C</div><div class=\"_hex-num\" data-index=\"38\">00</div><div class=\"_hex-num\" data-index=\"39\">00</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\"> </div></div></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">上述两种字节序都可以下载下来看看 (注意 VSCode 目前并不支持 UTF-32 编码, mac 的话用系统自带的编辑器就行了, vim 也可以)</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">看到这里可能很多人会问：FEFF 是随便写的吗？—— 涉及到后文的概念，可以先忽略，后文会解答</div><h1 id=\"UTF-16\" class=\"std-title --fontTitle\"><a href=\"#UTF-16\" class=\"markdownIt-Anchor\">#</a> UTF-16<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">由于 UTF-32 是一种定长编码，缺点就是比较大，并没有被广泛使用，实际场景中用的比较多的是 utf16 和 utf8，现在来看看 utf16 是怎么编码的吧</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">考虑到大多数人只使用第一平面，即 0x0000-0xFFFF, utf16 就是针对这种现象进行编码设计</div><ul class=\"numbering-main\" data-minimap-color=\"#DDDDDD\"><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">情况一：第一平面 BMP 内的字符，即 0x000000-0x00FFFF 中的字符直接用 2 字节存储，即直接存储低 16 位即可</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">情况二：后续 16 个平面，即 0x010000-0x10FFFF 中的字符使用 4 字节存储</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">其他情况：大于 0x10FFFF 的无法使用 UTF-16 进行编码</div></li></ul><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">那么，当我正在处理一段字节流的时候，比如我读取到 0xABCD，此时要怎么判断读取的这两个字节是对应情况一还是情况二的四字节的前半部分呢？</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">这里看似无解，但是 Unicode 标准单独给第一平面挖了一段 Block 来解决这个问题：在第一平面 0x0000 - 0xFFFF 中的 0xD800 - 0xDFFF 这段并没有编码含义，而是保留给 UTF-16 来使用：</div><div class=\"std-img-dynamic-wrapper\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:35.82%\"><img class=\"std-img-dymanic-main r-link __mosaic __loading\" src=\"/tsxs-esm/D800-DFFF.4bb58d8ee238882a.png.mosaic.png\"/><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/D800-DFFF.4bb58d8ee238882a.png\"/></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">利用这个区块，具体一点来说在处理字节流两字节两字节进行读取解析的时候，如果读取的两个字节不在这个区间，就是情况一，比如前面的 0xABCD 就不在这个区间，因此应该将其当作情况一来处理；而如果遇到在这个区间内的时候，说明此时读取的不是第一平面内的码点，应该按情况二来处理，此时额外读取后两个字节组成四个字节来解析。</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">再进一步来看，情况二中提到用 4 个字节来编码，这 4 字节又分为前后两个部分，每个部分各 2 个字节，对于这「2 个字节」如果：</div><ol class=\"numbering-main\" data-minimap-color=\"#DDDDDD\"><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">1.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">位于 high-half surrogates 中，称为高代理；范围是 0xD800 - 0xDBFF, 换成二进制为 110110/0000000000 - 110110/1111111111，即以 0b110110 开头的情况为高代理</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">2.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">位于 low-half surrogates 中，称为低代理；范围是 0xDC00 - 0xDFFF，换成二进制为 110111/0000000000 - 110111/1111111111，即以 0b110111 开头的情况为低代理</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">3.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">高低代理中的低 10 位是有效位，一共 20 位将其取出拼接在一起存储为 TMP</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">4.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">UTF-16 标准规定 TMP = 码点 - 0x10000, 此时将 TMP 加上 0x10000 即可得到码点 (后面会说为什么要减去 0x10000)</div></li></ol><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">情况二的 4 个字节分成前后两部分，其中，前面两个字节的前 6 位二进制固定为 110110，后面两个字节的前 6 位二进制固定为 110111, 前后部分各剩余 10 位二进制是码点减去 0x10000 的结果 —— 也就是说通过放弃 BMP 的一部分空间，将两个代理的低 10 位拼接来编码其他平面的码点。</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">好吧，看到这里估计都被绕晕了，我上面写的规则貌似很复杂，其实实际很好理解，关键在于「放弃 BMP 的一部分空间，用两个代理的方式凑出 20 位来编码其他平面的码点」</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">这里手把手给一个例子：我将以下面 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">🍰 (U+1F370)</div> 这个 emoji 来说明如何将其码点 0x1F370 编码为 UTF-16 字节流：</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">// ⬇️ 🍰 的 unicode 码点 (0x1F370 的二进制形式)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span>　  <span class=\"token number\">1</span> <span class=\"token number\">11110011</span> <span class=\"token number\">01110000</span>   <span class=\"token comment\">// ⬅️ 码点需要先减去 0x10000</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>　<span class=\"token operator\">-</span> <span class=\"token number\">1</span> <span class=\"token number\">00000000</span> <span class=\"token number\">00000000</span>   <span class=\"token comment\">//</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span>　<span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span> <span class=\"token comment\">// ⬇️ 高代理（两字节） ⬇️ 低代理（两字节）</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span>　    <span class=\"token number\">11110011</span> <span class=\"token number\">01110000</span>    <span class=\"token number\">1101100000111100</span>  <span class=\"token number\">1101111101110000</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span>　    aaaaaabb bbbbbbbb    <span class=\"token constant\">HHHHHH</span><span class=\"token operator\">**</span><span class=\"token operator\">**</span>aaaaaa  LLLLLLbbbbbbbbbb\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span>　                         将高低代理对写在一起就构成四字节的 utf16\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span>　                         <span class=\"token number\">0xD83C</span> <span class=\"token number\">0xDF70</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span>　<span class=\"token comment\">// ⚠️ 注意:</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span>　<span class=\"token comment\">// 1. HHHHHH 代表固定的高代理头, 110110 (0xD800 到 0xDBFF)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">10</span>　<span class=\"token comment\">//    LLLLLL 代表固定的低代理头, 110111</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">11</span>　<span class=\"token comment\">// 2. 上述标 a 标 b 的部分其实就对应右边的标 a 标 b 部分,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">12</span>　<span class=\"token comment\">//    从低位往左边填充，填完就就填 0 （也就是标星号 * 的那部分）</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">上述例子中标 * 的部分实际上就是平面的序号减一，这也说明了为什么要减去 0x10000：避免在高低代理对的 20 位整数空间中重复编码第一平面，而由于最多只能带 20 位，因此大于 0x100000 的码点是不能用 UTF-16 进行编码的。</div><h2 id=\"实现-utf16encodecodepoint\" class=\"std-title --fontTitle\">实现 utf16EncodeCodePoint</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">根据前面的讨论来实现 UTF-16 编码器的核心部分: 将给定的一个码点转为对应字节 number[] 数组, 比如说:</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token function\">utf16EncodeCodePoint</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x6C38</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 永 (码点为 U+6C38)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token comment\">// => [0x6C, 0x38]</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token function\">utf16EncodeCodePoint</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x1F370</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 🍰 (码点为 U+1F370)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token comment\">// => [0xD8, 0x3C, 0xDF, 0x70]</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">下面给一个我的实现:</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">/**\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span> * high-half surrogates 0xD800 0xDBFF\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span> * low-half surrogates 0xDC00 0xDFFF\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span> * surrogates 0xD800-0xDFFFF\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span> * @param codePoint 给定码点\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span> * @returns 返回二字节或四字节 number[]\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span> */</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">utf16EncodeCodePoint</span><span class=\"token punctuation\">(</span>codePoint<span class=\"token operator\">:</span> number<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> number<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>codePoint <span class=\"token operator\">&lt;</span> <span class=\"token number\">0x10000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// 第一平面 (BMP)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span>    <span class=\"token keyword\">const</span> byte0 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>codePoint <span class=\"token operator\">&amp;</span> <span class=\"token number\">0b1111111100000000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">10</span>    <span class=\"token keyword\">const</span> byte1 <span class=\"token operator\">=</span> codePoint <span class=\"token operator\">&amp;</span> <span class=\"token number\">0b0000000011111111</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">11</span>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>byte0<span class=\"token punctuation\">,</span> byte1<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">12</span>  <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">13</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">14</span>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>codePoint <span class=\"token operator\">>=</span> <span class=\"token number\">0x100000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">15</span>    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'不支持大于 0x100000 的码点'</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">16</span>  <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">17</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">18</span>  <span class=\"token comment\">// 需要减去 0x10000 避免对第一平面重复编码</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">19</span>  <span class=\"token keyword\">const</span> buf <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>codePoint <span class=\"token operator\">-</span> <span class=\"token number\">0x10000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">20</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">21</span>  <span class=\"token keyword\">const</span> l10 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>buf <span class=\"token operator\">&amp;</span> <span class=\"token number\">0b00000000001111111111</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">22</span>  <span class=\"token keyword\">const</span> h10 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>buf <span class=\"token operator\">&amp;</span> <span class=\"token number\">0b11111111110000000000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">23</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">24</span>  <span class=\"token keyword\">const</span> h16 <span class=\"token operator\">=</span> h10 <span class=\"token operator\">|</span> <span class=\"token number\">0b1101100000000000</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">25</span>  <span class=\"token keyword\">const</span> l16 <span class=\"token operator\">=</span> l10 <span class=\"token operator\">|</span> <span class=\"token number\">0b1101110000000000</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">26</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">27</span>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">28</span>    <span class=\"token punctuation\">(</span>h16 <span class=\"token operator\">&amp;</span> <span class=\"token number\">0b1111111100000000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">29</span>    <span class=\"token punctuation\">(</span>h16 <span class=\"token operator\">&amp;</span> <span class=\"token number\">0b0000000011111111</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">30</span>    <span class=\"token punctuation\">(</span>l16 <span class=\"token operator\">&amp;</span> <span class=\"token number\">0b1111111100000000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">31</span>    <span class=\"token punctuation\">(</span>l16 <span class=\"token operator\">&amp;</span> <span class=\"token number\">0b0000000011111111</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">32</span>  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">33</span><span class=\"token punctuation\">}</span></pre></div><h2 id=\"utf-16-demo\" class=\"std-title --fontTitle\">UTF-16 Demo</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">下面是根据我的 UTF-16 编码器写的 Demo, 可以下载下来看看能不能打开</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><input value=\"🍰 在这输入字符串将其编码为 UTF-16 流并在下面的 BufferView 中展示\" style=\"font-size:1rem;margin-bottom:1em;display:block;width:100%;padding:.5em;box-sizing:border-box;border:1px solid #BBB\" placeholder=\"🍰 在这输入字符串将其编码为 UTF-16 流并在下面的 BufferView 中展示\"/><div class=\"buffer-view nth-0\"><style></style><div class=\"buffer-view-header\"><div class=\"std-icon  icon-bit-switch\" style=\"height:2em;width:2em;overflow:hidden;display:inline-block;box-sizing:border-box\"></div><div class=\"buffer-view-state\"><div>cursor=0x0000</div><div>length=90</div><div><a download=\"UTF-16 大端 Demo.txt\" href=\"\">download</a></div></div></div><div class=\"buffer-view-ranges\"><div class=\"_line-range\">0x0000</div><div class=\"_line-range\">0x0010</div><div class=\"_line-range\">0x0020</div><div class=\"_line-range\">0x0030</div><div class=\"_line-range\">0x0040</div><div class=\"_line-range\">0x0050</div></div><div class=\"buffer-view-lines\"><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"0\">FE</div><div class=\"_hex-num\" data-index=\"1\">FF</div><div class=\"_hex-num\" data-index=\"2\">D8</div><div class=\"_hex-num\" data-index=\"3\">3C</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"4\">DF</div><div class=\"_hex-num\" data-index=\"5\">70</div><div class=\"_hex-num\" data-index=\"6\">00</div><div class=\"_hex-num\" data-index=\"7\">20</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"8\">57</div><div class=\"_hex-num\" data-index=\"9\">28</div><div class=\"_hex-num\" data-index=\"10\">8F</div><div class=\"_hex-num\" data-index=\"11\">D9</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"12\">8F</div><div class=\"_hex-num\" data-index=\"13\">93</div><div class=\"_hex-num\" data-index=\"14\">51</div><div class=\"_hex-num\" data-index=\"15\">65</div></div><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"16\">5B</div><div class=\"_hex-num\" data-index=\"17\">57</div><div class=\"_hex-num\" data-index=\"18\">7B</div><div class=\"_hex-num\" data-index=\"19\">26</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"20\">4E</div><div class=\"_hex-num\" data-index=\"21\">32</div><div class=\"_hex-num\" data-index=\"22\">5C</div><div class=\"_hex-num\" data-index=\"23\">06</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"24\">51</div><div class=\"_hex-num\" data-index=\"25\">76</div><div class=\"_hex-num\" data-index=\"26\">7F</div><div class=\"_hex-num\" data-index=\"27\">16</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"28\">78</div><div class=\"_hex-num\" data-index=\"29\">01</div><div class=\"_hex-num\" data-index=\"30\">4E</div><div class=\"_hex-num\" data-index=\"31\">3A</div></div><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"32\">00</div><div class=\"_hex-num\" data-index=\"33\">20</div><div class=\"_hex-num\" data-index=\"34\">00</div><div class=\"_hex-num\" data-index=\"35\">55</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"36\">00</div><div class=\"_hex-num\" data-index=\"37\">54</div><div class=\"_hex-num\" data-index=\"38\">00</div><div class=\"_hex-num\" data-index=\"39\">46</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"40\">00</div><div class=\"_hex-num\" data-index=\"41\">2D</div><div class=\"_hex-num\" data-index=\"42\">00</div><div class=\"_hex-num\" data-index=\"43\">31</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"44\">00</div><div class=\"_hex-num\" data-index=\"45\">36</div><div class=\"_hex-num\" data-index=\"46\">00</div><div class=\"_hex-num\" data-index=\"47\">20</div></div><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"48\">6D</div><div class=\"_hex-num\" data-index=\"49\">41</div><div class=\"_hex-num\" data-index=\"50\">5E</div><div class=\"_hex-num\" data-index=\"51\">76</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"52\">57</div><div class=\"_hex-num\" data-index=\"53\">28</div><div class=\"_hex-num\" data-index=\"54\">4E</div><div class=\"_hex-num\" data-index=\"55\">0B</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"56\">97</div><div class=\"_hex-num\" data-index=\"57\">62</div><div class=\"_hex-num\" data-index=\"58\">76</div><div class=\"_hex-num\" data-index=\"59\">84</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"60\">00</div><div class=\"_hex-num\" data-index=\"61\">20</div><div class=\"_hex-num\" data-index=\"62\">00</div><div class=\"_hex-num\" data-index=\"63\">42</div></div><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"64\">00</div><div class=\"_hex-num\" data-index=\"65\">75</div><div class=\"_hex-num\" data-index=\"66\">00</div><div class=\"_hex-num\" data-index=\"67\">66</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"68\">00</div><div class=\"_hex-num\" data-index=\"69\">66</div><div class=\"_hex-num\" data-index=\"70\">00</div><div class=\"_hex-num\" data-index=\"71\">65</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"72\">00</div><div class=\"_hex-num\" data-index=\"73\">72</div><div class=\"_hex-num\" data-index=\"74\">00</div><div class=\"_hex-num\" data-index=\"75\">56</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"76\">00</div><div class=\"_hex-num\" data-index=\"77\">69</div><div class=\"_hex-num\" data-index=\"78\">00</div><div class=\"_hex-num\" data-index=\"79\">65</div></div><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"80\">00</div><div class=\"_hex-num\" data-index=\"81\">77</div><div class=\"_hex-num\" data-index=\"82\">00</div><div class=\"_hex-num\" data-index=\"83\">20</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"84\">4E</div><div class=\"_hex-num\" data-index=\"85\">2D</div><div class=\"_hex-num\" data-index=\"86\">5C</div><div class=\"_hex-num\" data-index=\"87\">55</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"88\">79</div><div class=\"_hex-num\" data-index=\"89\">3A</div><div class=\"_hex-num\"> </div></div></div></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">注意，与 UTF-32 类似，UTF-16 也需要指定开头的 BOM，此处开头的 0xFEFF 代表大端存储，此时的编码叫做 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">UTF-16 BE</div> (big-endian) 如果需要小端存储则需要将 BOM 设置为 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">0xFFFE</div> 并把后续高低字节序调转一下 (我的实现都是大端，比较好理解）</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">比如 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">世界</div> 对应的大端编码 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">UTF-16 BE</div> 为 0xFE, 0xFF 0x4E, 0x16, 0x75, 0x4C 此时其小端编码 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">UTF-16 LE</div> (little-endian) 的结果为:</div><div class=\"buffer-view nth-0\"><style></style><div class=\"buffer-view-header\"><div class=\"std-icon  icon-bit-switch\" style=\"height:2em;width:2em;overflow:hidden;display:inline-block;box-sizing:border-box\"></div><div class=\"buffer-view-state\"><div>cursor=0x0000</div><div>length=6</div><div><a download=\"UTF-16 小端 Demo.txt\" href=\"\">download</a></div></div></div><div class=\"buffer-view-ranges\"><div class=\"_line-range\">0x0000</div></div><div class=\"buffer-view-lines\"><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"0\">FF</div><div class=\"_hex-num\" data-index=\"1\">FE</div><div class=\"_hex-num\" data-index=\"2\">16</div><div class=\"_hex-num\" data-index=\"3\">4E</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"4\">4C</div><div class=\"_hex-num\" data-index=\"5\">75</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\"> </div></div></div></div><h1 id=\"utf-16-in-js\" class=\"std-title --fontTitle\"><a href=\"#utf-16-in-js\" class=\"markdownIt-Anchor\">#</a> 题外话: JavaScript 里的 UTF-16<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">JS 里 string 底层是用 UTF-16 编码的，因此可这样验证前面 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">🍰 U+1F370</div> 的编码结果 0xD83C 和 0xDF70 :</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\uD83C\\uDF70'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token comment\">// 将会输出 '🍰'</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">从这也可以看到，JS 里可以用 \\uAAAA 的方式来通过 UTF-16 编码流来构造字符串。</div><h2 id=\"如何直接用-unicode-码点来构造-string-?\" class=\"std-title --fontTitle\">如何直接用 unicode 码点来构造 string ?</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">除了直接用 UTF-16 编码流，JS 也可以直接给定码点来构造字符串:</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\u{1F370}'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token comment\">// U+1F370 是 🍰 的码点, 将会输出 '🍰'</span></pre></div><h2 id=\"🍰.length-为什么是-2-的问题\" class=\"std-title --fontTitle\">&#x27;🍰&#x27;.length 为什么是 2 的问题</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">其实就是下面这种现象：</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'🍰'</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token comment\">// => 2</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">原因：js string 是 UTF-16 编码的，而 🍰 的编码需要走情况 2 来编码，最终结果是 0xD83C 0xDF70，统共 4 字节，而 length 是两字节算一个字符（UTF-16）因此最后 🍰 这类位于第二平面的码点在 js string 里 length 就是 2 了</div><h2 id=\".split()-并不能很好的识别-utf-16-内的字符\" class=\"std-title --fontTitle\">.split(&#x27;&#x27;) 并不能很好的识别 UTF-16 内的字符</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">.split 并不会识别 UTF-16 高低代理对，因此会出现这个问题：</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token string\">'🍰 Hello'</span><span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token comment\">// => ['\\uD83C', '\\uDF70', ' ', 'H', 'e', 'l', 'l', 'o']</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">可以看到，🍰 的高/低代理对被完全拆开了，无法正常显示了，很多场景下不符合预期，此时可以通过下面这两种方式都将 string 按 UTF-16 序进行切割，避免这类问题：</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span>Array<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">'🍰 Hello'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token comment\">// => ['🍰', ' ', 'H', 'e', 'l', 'l', 'o']</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token punctuation\">[</span><span class=\"token operator\">...</span><span class=\"token string\">'🍰 Hello'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span><span class=\"token comment\">// => ['🍰', ' ', 'H', 'e', 'l', 'l', 'o']</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">当然，也可以手动 for 循环遍历字符串来自己拆（判断在不在高低代理区块即可）</div><h2 id=\"如何将一段-string-转为码点数组-?\" class=\"std-title --fontTitle\">如何将一段 string 转为码点数组 ?</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">用前面提到的 Array.from 将字符拆开后再通过 codePointAt 方法取到码点:</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span>Array<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">'🍰 🍉'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>ch <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span>  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">'</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>ch<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">'=>U+</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>ch<span class=\"token punctuation\">.</span><span class=\"token function\">codePointAt</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token comment\">// 将会输出</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span><span class=\"token comment\">// '🍰'=>U+1f370</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span><span class=\"token comment\">// ' '=>U+20</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span><span class=\"token comment\">// '🍉'=>U+1f349</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">下面是根据上面这段写的一个小 demo (跟开头那个是同一个 Demo 组件)</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><input value=\"🍰 🍉\" style=\"font-size:1rem;margin-bottom:1em;display:block;width:100%;padding:.5em;box-sizing:border-box;border:1px solid #BBB;text-align:center\" placeholder=\"🍰 🍉\"/><div style=\"display:flex;flex-wrap:wrap;justify-content:center\"><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e2dfeb;margin:1em\"><div style=\"font-size:2em;background-color:#b7b4c5;display:inline-block;width:2em;height:2em;line-height:2em\">🍰</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+1F370</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#ece6e8;margin:1em\"><div style=\"font-size:2em;background-color:#c7bdc0;display:inline-block;width:2em;height:2em;line-height:2em\"> </div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+0020</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f2dfeb;margin:1em\"><div style=\"font-size:2em;background-color:#cfb4c5;display:inline-block;width:2em;height:2em;line-height:2em\">🍉</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+1F349</div></div></div></div><h1 id=\"ucs2-utf16\" class=\"std-title --fontTitle\"><a href=\"#ucs2-utf16\" class=\"markdownIt-Anchor\">#</a> UCS-2 与 UTF-16 的关系<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">UCS-2 是在 UTF-16 出现之前常用的 Unicode 编码方式：</div><ul class=\"numbering-main\" data-minimap-color=\"#DDDDDD\"><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">UCS-2 是成立于 1984 年的 UCS 组织于 1990 年提出的</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">而 UTF-16 是成立于 1991 年的 Unicode 组织于 1996 年提出</div></li></ul><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">UCS-2 早于 UTF-16 提出，其核心是用两字节编码第一平面 BMP 0x0000 到 0xFFFF 共计 65536 个字符，后来设计的 UTF-16 也考虑到这一点进行设计，对应的就是前面提到过的 UTF-16 情况一</div><h1 id=\"UTF-8\" class=\"std-title --fontTitle\"><a href=\"#UTF-8\" class=\"markdownIt-Anchor\">#</a> UTF-8<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">终于来到 UTF-8 了，它是一种变长编码，特点是最小可以一字节使用，在一字节的时候编码规则跟 ASCII 一样，实现了兼容，具体的规则如下</div><ol class=\"numbering-main\" data-minimap-color=\"#DDDDDD\"><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">1.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">对于长度为 1 字节的字符，将最高位设置为 0, 其余 7 位设置为 Unicode 码点。值得注意的是, ASCII 字符在 Unicode 字符集中占据了前 128 个码点。也就是说, UTF-8 编码可以向下兼容 ASCII 码, 这意味着我们可以直接使用 UTF-8 来打开年代久远的 ASCII 文本文件。</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">2.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">对于长度为 n 字节的字符 (n &gt; 1), 将首个字节的高 n 位都设置为 1，第 n+1 位设置为 0；从第二个字节开始，将每个字节的高 2 位都设置为 10；其余所有位用于填充字符的 Unicode 码点。</div></li></ol><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">下面以「永」字为例：</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">//　     unicode 码点               UTF-8</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span>永    <span class=\"token number\">11011000</span> <span class=\"token number\">0111000</span>    <span class=\"token number\">11100110</span> <span class=\"token number\">10110000</span> <span class=\"token number\">10111000</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>　                        <span class=\"token operator\">--</span><span class=\"token operator\">--</span>     <span class=\"token operator\">--</span>       <span class=\"token operator\">--</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span>　                                 <span class=\"token number\">10</span> 开头   <span class=\"token number\">10</span> 开头   \n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span>　        第一个字节开头的 <span class=\"token number\">1110</span> 代表总共 <span class=\"token number\">3</span> 个字节\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span>　        其后每一个字节的开头都是 <span class=\"token number\">10</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span>　        <span class=\"token function\">然后将码点按位填充到剩下的位得到最终结果</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span>　        <span class=\"token punctuation\">(</span>转 <span class=\"token number\">16</span> 进制后为<span class=\"token operator\">:</span> <span class=\"token number\">0xE6</span> <span class=\"token number\">0xB0</span> <span class=\"token number\">0xB8</span><span class=\"token punctuation\">)</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">核心是确定 utf 头总共多少字节，然后将码点位填充上去即可，下面给一个我自己的编码实现：</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">/** 将单个码点转为 utf-8 编码 */</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">utf8EncodeCodePoint</span><span class=\"token punctuation\">(</span>codePoint<span class=\"token operator\">:</span> number<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> number<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>  <span class=\"token comment\">// 0b01111111 及以下的情况跟 ASCII 保持一致，直接返回即可</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>codePoint <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0b01111111</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>codePoint<span class=\"token punctuation\">]</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span>  <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span>  <span class=\"token comment\">// 先将 codePoint 按 0b10 + 6 位的方式隔开成 number[]</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span>  <span class=\"token keyword\">const</span> result<span class=\"token operator\">:</span> number<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">10</span>    <span class=\"token keyword\">const</span> _6bit <span class=\"token operator\">=</span> codePoint <span class=\"token operator\">&amp;</span> <span class=\"token number\">0b111111</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">11</span>    <span class=\"token keyword\">const</span> _8bit <span class=\"token operator\">=</span> <span class=\"token number\">0b10000000</span> <span class=\"token operator\">|</span> _6bit<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">12</span>    result<span class=\"token punctuation\">.</span><span class=\"token function\">unshift</span><span class=\"token punctuation\">(</span>_8bit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">13</span>    codePoint <span class=\"token operator\">=</span> codePoint <span class=\"token operator\">>></span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">14</span>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>codePoint <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">15</span>  <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">16</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">17</span>  <span class=\"token comment\">// 处理 `utf 头`</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">18</span>  <span class=\"token keyword\">const</span> header <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> result<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">19</span>  <span class=\"token keyword\">const</span> restBits <span class=\"token operator\">=</span> <span class=\"token number\">8</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span> <span class=\"token operator\">-</span> result<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">20</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">21</span>  <span class=\"token comment\">// 判断第一位放不得下 header</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">22</span>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> restBits<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0b111111</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">23</span>    <span class=\"token keyword\">const</span> headerByte <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>header <span class=\"token operator\">&lt;&lt;</span> restBits<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">24</span>    result<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0b111111</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> headerByte<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">25</span>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">26</span>    <span class=\"token comment\">// 放不下则单独开一个字节塞到最前面</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">27</span>    result<span class=\"token punctuation\">.</span><span class=\"token function\">unshift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>header <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token punctuation\">(</span>restBits <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">28</span>  <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">29</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">30</span>  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">31</span><span class=\"token punctuation\">}</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">下面是解码的实现：</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">/**\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span> * 将 arr 当作 utf-8 buffer 进行解码，将其解码位码点数组\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span> */</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">utf8Decode</span><span class=\"token punctuation\">(</span>arr<span class=\"token operator\">:</span> ArrayLike<span class=\"token operator\">&lt;</span>number<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span>  <span class=\"token keyword\">let</span> result<span class=\"token operator\">:</span> number<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span>  <span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span>  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">&lt;</span> arr<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span>    <span class=\"token keyword\">const</span> firstByte <span class=\"token operator\">=</span> arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span>    <span class=\"token comment\">// 先扫描 utf 头搞到总长度</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">10</span>    <span class=\"token keyword\">let</span> scanner <span class=\"token operator\">=</span> <span class=\"token number\">0b10000000</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">11</span>    <span class=\"token keyword\">let</span> utfLength <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">12</span>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>firstByte <span class=\"token operator\">&amp;</span> scanner<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">13</span>      utfLength <span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">14</span>      scanner <span class=\"token operator\">=</span> scanner <span class=\"token operator\">>></span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">15</span>    <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">16</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">17</span>    <span class=\"token comment\">// 第一位通过前面的 scanner 就能快速取出其有效的数据位</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">18</span>    <span class=\"token keyword\">let</span> buf <span class=\"token operator\">=</span> firstByte <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>scanner <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">19</span>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> offset <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> offset <span class=\"token operator\">&lt;</span> utfLength<span class=\"token punctuation\">;</span> offset <span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">20</span>      buf <span class=\"token operator\">=</span> buf <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">21</span>      buf <span class=\"token operator\">=</span> buf <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0b00111111</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">22</span>    <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">23</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">24</span>    result<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">25</span>    i <span class=\"token operator\">=</span> i <span class=\"token operator\">+</span> utfLength<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">26</span>  <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">27</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">28</span>  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">29</span><span class=\"token punctuation\">}</span></pre></div><h2 id=\"utf-8-demo\" class=\"std-title --fontTitle\">UTF-8 Demo</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">我用上面的实现的 utf-8 编解码做了一个 Demo: </div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><input value=\"🍰 在这输入字符串将其编码为 UTF-8 流并在下面的 BufferView 中展示\" style=\"font-size:1rem;margin-bottom:1em;display:block;width:100%;padding:.5em;box-sizing:border-box;border:1px solid #BBB\" placeholder=\"🍰 在这输入字符串将其编码为 UTF-8 流并在下面的 BufferView 中展示\"/><div class=\"buffer-view nth-0\"><style></style><div class=\"buffer-view-header\"><div class=\"std-icon  icon-bit-switch\" style=\"height:2em;width:2em;overflow:hidden;display:inline-block;box-sizing:border-box\"></div><div class=\"buffer-view-state\"><div>cursor=0x0000</div><div>length=87</div><div><a download=\"UTF-8 Demo.txt\" href=\"\">download</a></div></div></div><div class=\"buffer-view-ranges\"><div class=\"_line-range\">0x0000</div><div class=\"_line-range\">0x0010</div><div class=\"_line-range\">0x0020</div><div class=\"_line-range\">0x0030</div><div class=\"_line-range\">0x0040</div><div class=\"_line-range\">0x0050</div></div><div class=\"buffer-view-lines\"><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"0\">F0</div><div class=\"_hex-num\" data-index=\"1\">9F</div><div class=\"_hex-num\" data-index=\"2\">8D</div><div class=\"_hex-num\" data-index=\"3\">B0</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"4\">20</div><div class=\"_hex-num\" data-index=\"5\">E5</div><div class=\"_hex-num\" data-index=\"6\">9C</div><div class=\"_hex-num\" data-index=\"7\">A8</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"8\">E8</div><div class=\"_hex-num\" data-index=\"9\">BF</div><div class=\"_hex-num\" data-index=\"10\">99</div><div class=\"_hex-num\" data-index=\"11\">E8</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"12\">BE</div><div class=\"_hex-num\" data-index=\"13\">93</div><div class=\"_hex-num\" data-index=\"14\">E5</div><div class=\"_hex-num\" data-index=\"15\">85</div></div><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"16\">A5</div><div class=\"_hex-num\" data-index=\"17\">E5</div><div class=\"_hex-num\" data-index=\"18\">AD</div><div class=\"_hex-num\" data-index=\"19\">97</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"20\">E7</div><div class=\"_hex-num\" data-index=\"21\">AC</div><div class=\"_hex-num\" data-index=\"22\">A6</div><div class=\"_hex-num\" data-index=\"23\">E4</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"24\">B8</div><div class=\"_hex-num\" data-index=\"25\">B2</div><div class=\"_hex-num\" data-index=\"26\">E5</div><div class=\"_hex-num\" data-index=\"27\">B0</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"28\">86</div><div class=\"_hex-num\" data-index=\"29\">E5</div><div class=\"_hex-num\" data-index=\"30\">85</div><div class=\"_hex-num\" data-index=\"31\">B6</div></div><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"32\">E7</div><div class=\"_hex-num\" data-index=\"33\">BC</div><div class=\"_hex-num\" data-index=\"34\">96</div><div class=\"_hex-num\" data-index=\"35\">E7</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"36\">A0</div><div class=\"_hex-num\" data-index=\"37\">81</div><div class=\"_hex-num\" data-index=\"38\">E4</div><div class=\"_hex-num\" data-index=\"39\">B8</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"40\">BA</div><div class=\"_hex-num\" data-index=\"41\">20</div><div class=\"_hex-num\" data-index=\"42\">55</div><div class=\"_hex-num\" data-index=\"43\">54</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"44\">46</div><div class=\"_hex-num\" data-index=\"45\">2D</div><div class=\"_hex-num\" data-index=\"46\">38</div><div class=\"_hex-num\" data-index=\"47\">20</div></div><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"48\">E6</div><div class=\"_hex-num\" data-index=\"49\">B5</div><div class=\"_hex-num\" data-index=\"50\">81</div><div class=\"_hex-num\" data-index=\"51\">E5</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"52\">B9</div><div class=\"_hex-num\" data-index=\"53\">B6</div><div class=\"_hex-num\" data-index=\"54\">E5</div><div class=\"_hex-num\" data-index=\"55\">9C</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"56\">A8</div><div class=\"_hex-num\" data-index=\"57\">E4</div><div class=\"_hex-num\" data-index=\"58\">B8</div><div class=\"_hex-num\" data-index=\"59\">8B</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"60\">E9</div><div class=\"_hex-num\" data-index=\"61\">9D</div><div class=\"_hex-num\" data-index=\"62\">A2</div><div class=\"_hex-num\" data-index=\"63\">E7</div></div><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"64\">9A</div><div class=\"_hex-num\" data-index=\"65\">84</div><div class=\"_hex-num\" data-index=\"66\">20</div><div class=\"_hex-num\" data-index=\"67\">42</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"68\">75</div><div class=\"_hex-num\" data-index=\"69\">66</div><div class=\"_hex-num\" data-index=\"70\">66</div><div class=\"_hex-num\" data-index=\"71\">65</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"72\">72</div><div class=\"_hex-num\" data-index=\"73\">56</div><div class=\"_hex-num\" data-index=\"74\">69</div><div class=\"_hex-num\" data-index=\"75\">65</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"76\">77</div><div class=\"_hex-num\" data-index=\"77\">20</div><div class=\"_hex-num\" data-index=\"78\">E4</div><div class=\"_hex-num\" data-index=\"79\">B8</div></div><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"80\">AD</div><div class=\"_hex-num\" data-index=\"81\">E5</div><div class=\"_hex-num\" data-index=\"82\">B1</div><div class=\"_hex-num\" data-index=\"83\">95</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"84\">E7</div><div class=\"_hex-num\" data-index=\"85\">A4</div><div class=\"_hex-num\" data-index=\"86\">BA</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\"> </div></div></div></div></div><h1 id=\"look-back-to-std-unicode\" class=\"std-title --fontTitle\"><a href=\"#look-back-to-std-unicode\" class=\"markdownIt-Anchor\">#</a> 回头看 Unicode 标准<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">前面主要讨论了 Unicode 的编码，但是编码部分只是 Unicode 标准的一部分，此处更具体的记录一下 Unicode 的诞生细节：</div><ol class=\"numbering-main\" data-minimap-color=\"#DDDDDD\"><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">1.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">Unicode 1987 年提出，目的是提供一种统一的字符编码</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">2.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">标准由 Unicode Consortium（Unicode 组织/联盟）维护，这个联盟的宗旨是让 Unicode 取代其他的编码，成为唯一标准</div></li></ol><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">根据 Unicode 组织的网站上的 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">Unicode 技术报告 #17</div> 显示，前面我写的那些编码方式只是整个 Unicode 标准一部分而已：</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><a href=\"https://www.unicode.org/reports/tr17/tr17-3.html\" target=\"_blank\" style=\"background-color:#e2f8de\" class=\"std-link --fontSansSerif  _block\" data-minimap-color=\"#e2f8de\"><span class=\"std-link-icon r-link\" data-src=\"/get-favicon/www.unicode.org?h=11477315382\" style=\"background-image:url(&quot;/get-favicon/www.unicode.org?h=11477315382&quot;)\"></span><span class=\"std-link-txt\">Unicode 技术报告 UTR#17</span></a></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">根据这份报告，Unicode 标准主要有五个部分构成，或者称为 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">五层模型</div>:</div><h2 id=\"acr:-abstract-character-repertoire-(抽象字符表)-\" class=\"std-title --fontTitle\">ACR: Abstract Character Repertoire (抽象字符表) </h2><blockquote lang=\"en\" class=\"std-quote\"><span class=\"std-quote-text\">the set of characters to be encoded, e.g., some alphabet or symbol set</span><span class=\"std-quote-by\">UTR#17 原文</span></blockquote><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">就是字符集收录，相当于字典，比如 🍰 就在 ACR 中, 比如我们的汉字也都在 Unicode 字符集中，称为 ACR</div><h2 id=\"ccs:-coded-character-set-(编码字符集)-\" class=\"std-title --fontTitle\">CCS: Coded Character Set (编码字符集) </h2><blockquote lang=\"en\" class=\"std-quote\"><span class=\"std-quote-text\">a mapping from an abstract character repertoire to a set of non-negative integers</span><span class=\"std-quote-by\">UTR#17 原文</span></blockquote><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">ACR 里每一个字符到码点的映射关系，将这些映射关系放置在 CCS 中，这其实就是 🍰 映射到其码点 U+1F370，定义了所有字符到码点的映射关系</div><h2 id=\"cef:-character-encoding-form-(字符编码方式)-\" class=\"std-title --fontTitle\">CEF: Character Encoding Form (字符编码方式) </h2><blockquote lang=\"en\" class=\"std-quote\"><span class=\"std-quote-text\">a mapping from a set of non-negative integers (from a CCS) to a set of sequences of particular code units of some specified width, such as bytes</span><span class=\"std-quote-by\">UTR#17 原文</span></blockquote><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">定义了码点如何编码为特定的 bit 位宽的「码元」，比如:</div><ul class=\"numbering-main\" data-minimap-color=\"#DDDDDD\"><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">UTF-32 直接用 4 字节将码点当成 uint32 无符号整数进行编码，其一个码元是 4 字节</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">UTF-16, 一个码元是 2 字节，根据读取到的第一个码元的范围，分两种情况:</div></li><li class=\"numbering-item\"><ol class=\"numbering-main\" data-minimap-color=\"#DDDDDD\"><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">1.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">码点位于 BMP 平面的 0x0000 ~ 0xFFFF 这个区间的时候直接用一个码元即两个字节进行编码</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">2.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">码元在后续平面，此时通过高低代理的方式将 20 位码点信息编码到 4 字节 2 个码元中</div></li></ol></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">UTF-8 用 1 字节的变长编码形式进行编码, 其码元位宽就是 1 字节, 而从其编码细节来看首字节最大可指定变长编码的长度为 7，因此最大可以有 8 个码元</div></li><li class=\"numbering-item\"><ol class=\"numbering-main\" data-minimap-color=\"#DDDDDD\"><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">1.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">0b0xxxxxxx: 能编码的位数是 7，跟 ASCII 刚好对应</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">2.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">0b10xxxxxx 0b10xxxxxx: 能编码的位数是 12 位</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">3.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">0b110xxxxx 0b10xxxxxx 0b10xxxxxx: 能编码的位数是 17 位</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">4.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">0b1110xxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx: 能编码的位数是 22 位</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">5.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">0b11110xxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx: 能编码的位数是 27 位</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">6.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">0b111110xx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx: 能编码的位数是 32 位</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">7.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">0b1111110x 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx: 能编码的位数是 37 位, 已经超过 32 位了，实际不可能出现</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-decimal\">8.</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">0b11111110 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx 0b10xxxxxx: 能编码的位数是 42 位，已经超过 32 位了，实际不可能出现</div></li></ol></li></ul><h2 id=\"ces:-character-encoding-scheme-(字符编码方案)\" class=\"std-title --fontTitle\">CES: Character Encoding Scheme (字符编码方案)</h2><blockquote lang=\"en\" class=\"std-quote\"><span class=\"std-quote-text\">a mapping from a set of sequences of codes units (from one or more CEFs) to a serialized sequence of bytes</span><span class=\"std-quote-by\">UTR#17 原文</span></blockquote><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">这层其实比较薄，就是将码点填充到前面 CEF 所允许那些位里面去，最后输出为 byte 流</div><h2 id=\"tes:-transfer-encoding-syntax-(传输编码句法)\" class=\"std-title --fontTitle\">TES: Transfer Encoding Syntax (传输编码句法)</h2><blockquote lang=\"en\" class=\"std-quote\"><span class=\"std-quote-text\">a reversible transform of encoded data. This data may or may not contain textual data</span><span class=\"std-quote-by\">UTR#17 原文</span></blockquote><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">我理解是在传输的过程中检测 UTF 编码的语法机制，比如两个 case：</div><ul class=\"numbering-main\" data-minimap-color=\"#DDDDDD\"><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">HTML 里指定编码: <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">&lt;meta charset=&quot;utf-8&quot; /&gt;</div></div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">Unicode UTF-32 和 UTF-16 里面出现的 BOM: FEFF0000 来表明大小端的情况也算是</div></li></ul><h1 id=\"-2853124934\" class=\"std-title --fontTitle\"><a href=\"#-2853124934\" class=\"markdownIt-Anchor\">#</a> 注意力大集中<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">这里写一下我在实现过程中注意到的几个问题，也许日后有机会参与 unicode 的完全重构的时候再认真考虑一下这几个问题（虽然这个 connecting the dots 绝不可能发生 ....）</div><h2 id=\"中文字符码点连续性问题\" class=\"std-title --fontTitle\">中文字符码点连续性问题</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">网上一个关于码点的设计问题：（算是五层模型里 CCS 的问题）</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><input value=\"一二三四五甲乙丙丁戊ABCDE\" style=\"font-size:1rem;margin-bottom:1em;display:block;width:100%;padding:.5em;box-sizing:border-box;border:1px solid #BBB;text-align:center\" placeholder=\"一二三四五甲乙丙丁戊ABCDE\"/><div style=\"display:flex;flex-wrap:wrap;justify-content:center\"><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#eee9e8;margin:1em\"><div style=\"font-size:2em;background-color:#cac2c0;display:inline-block;width:2em;height:2em;line-height:2em\">一</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+4E00</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#efe9e8;margin:1em\"><div style=\"font-size:2em;background-color:#cbc2c0;display:inline-block;width:2em;height:2em;line-height:2em\">二</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+4E8C</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#efe9e8;margin:1em\"><div style=\"font-size:2em;background-color:#cbc2c0;display:inline-block;width:2em;height:2em;line-height:2em\">三</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+4E09</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e4efe8;margin:1em\"><div style=\"font-size:2em;background-color:#bacac0;display:inline-block;width:2em;height:2em;line-height:2em\">四</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+56DB</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f1e9e8;margin:1em\"><div style=\"font-size:2em;background-color:#cec2c0;display:inline-block;width:2em;height:2em;line-height:2em\">五</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+4E94</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e0ece8;margin:1em\"><div style=\"font-size:2em;background-color:#b6c6c0;display:inline-block;width:2em;height:2em;line-height:2em\">甲</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+7532</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e6e9e8;margin:1em\"><div style=\"font-size:2em;background-color:#bdc2c0;display:inline-block;width:2em;height:2em;line-height:2em\">乙</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+4E59</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f2e9e8;margin:1em\"><div style=\"font-size:2em;background-color:#cfc2c0;display:inline-block;width:2em;height:2em;line-height:2em\">丙</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+4E19</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#eee9e8;margin:1em\"><div style=\"font-size:2em;background-color:#cac2c0;display:inline-block;width:2em;height:2em;line-height:2em\">丁</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+4E01</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e2e0e8;margin:1em\"><div style=\"font-size:2em;background-color:#b8b5c0;display:inline-block;width:2em;height:2em;line-height:2em\">戊</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+620A</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f2e6e8;margin:1em\"><div style=\"font-size:2em;background-color:#d0bdc0;display:inline-block;width:2em;height:2em;line-height:2em\">A</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+0041</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f2e6e8;margin:1em\"><div style=\"font-size:2em;background-color:#d0bdc0;display:inline-block;width:2em;height:2em;line-height:2em\">B</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+0042</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f3e6e8;margin:1em\"><div style=\"font-size:2em;background-color:#d0bdc0;display:inline-block;width:2em;height:2em;line-height:2em\">C</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+0043</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f3e6e8;margin:1em\"><div style=\"font-size:2em;background-color:#d0bdc0;display:inline-block;width:2em;height:2em;line-height:2em\">D</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+0044</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#f3e6e8;margin:1em\"><div style=\"font-size:2em;background-color:#d0bdc0;display:inline-block;width:2em;height:2em;line-height:2em\">E</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+0045</div></div></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">发现了吗？汉字的 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">一二三四甲乙丙丁</div> 在码点上并不是连续的, 而 ABCD 这些就是连续的，不过还好汉语拼音声母 ㄅBo ㄆPo ㄇMo ㄈFo ㄉDe 或者日语假名 あa いi うu えe おo 是符合正序排列的</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><input value=\"ㄅㄆㄇㄈㄉあいうえお\" style=\"font-size:1rem;margin-bottom:1em;display:block;width:100%;padding:.5em;box-sizing:border-box;border:1px solid #BBB;text-align:center\" placeholder=\"ㄅㄆㄇㄈㄉあいうえお\"/><div style=\"display:flex;flex-wrap:wrap;justify-content:center\"><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e4efe8;margin:1em\"><div style=\"font-size:2em;background-color:#bbcbc0;display:inline-block;width:2em;height:2em;line-height:2em\">ㄅ</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+3105</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e4efe8;margin:1em\"><div style=\"font-size:2em;background-color:#bbcbc0;display:inline-block;width:2em;height:2em;line-height:2em\">ㄆ</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+3106</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e4efe8;margin:1em\"><div style=\"font-size:2em;background-color:#bbcbc0;display:inline-block;width:2em;height:2em;line-height:2em\">ㄇ</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+3107</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e4efe8;margin:1em\"><div style=\"font-size:2em;background-color:#bbcbc0;display:inline-block;width:2em;height:2em;line-height:2em\">ㄈ</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+3108</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#e4efe8;margin:1em\"><div style=\"font-size:2em;background-color:#bbcbc0;display:inline-block;width:2em;height:2em;line-height:2em\">ㄉ</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+3109</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#ddeee8;margin:1em\"><div style=\"font-size:2em;background-color:#b1cac0;display:inline-block;width:2em;height:2em;line-height:2em\">あ</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+3042</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#ddeee8;margin:1em\"><div style=\"font-size:2em;background-color:#b1cac0;display:inline-block;width:2em;height:2em;line-height:2em\">い</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+3044</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#ddeee8;margin:1em\"><div style=\"font-size:2em;background-color:#b1cac0;display:inline-block;width:2em;height:2em;line-height:2em\">う</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+3046</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#deeee8;margin:1em\"><div style=\"font-size:2em;background-color:#b2cac0;display:inline-block;width:2em;height:2em;line-height:2em\">え</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+3048</div></div><div style=\"display:flex;flex-direction:column;justify-content:center;align-items:center;width:6em;height:7em;text-align:center;background-color:#dfeee8;margin:1em\"><div style=\"font-size:2em;background-color:#b3cac0;display:inline-block;width:2em;height:2em;line-height:2em\">お</div><div style=\"height:1em;line-height:1em;margin-top:.5em\">U+304A</div></div></div></div><h2 id=\"utf-16-高/低代理打洞的问题\" class=\"std-title --fontTitle\">UTF-16 高/低代理打洞的问题</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">前面的具体讨论中已经清楚，现在的 Unicode BMP 平面定义里单独给 UTF-16 做了高低代理区间的打洞来实现 20 位码点的编码</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">这个方式太 hack 了，我其实不太喜欢，但是这又是 trade-off 的艺术，UTF-16 其实非常好的兼顾了编码的时间复杂度和空间复杂度</div><h2 id=\"utf-24-可行性？\" class=\"std-title --fontTitle\">UTF-24 可行性？</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">UTF-16 通过高低代理对的方式编排了 20 位 bits，而这 20 位中高 4 位代表所在的 unicode 平面，低 16 位代表其平面的偏移 —— 总之 20 位足够编排 16 个平面了，如果期望包含全部的 17 个平面，用 21 位就行了，那么在这种情况下为什么没有 UTF-20 或 21 或 UTF-24 的编码方式呢？</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">理论上应该可行，不过估计会被狂喷，因为我在 zhihu 上问过</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><a href=\"https://www.zhihu.com/question/651260057\" target=\"_blank\" style=\"background-color:#e4e7ea\" class=\"std-link --fontSansSerif  _line\" data-minimap-color=\"#e4e7ea\"><span class=\"std-link-icon r-link\" data-src=\"/get-favicon/www.zhihu.com?h=9638207561\" style=\"background-image:url(&quot;/get-favicon/www.zhihu.com?h=9638207561&quot;)\"></span><span class=\"std-link-txt\">知乎 - 为什么没有 UTF-24 ？</span></a></div><h2 id=\"如何在第一个字节区分是-utf-8-还是-ascii\" class=\"std-title --fontTitle\">如何在第一个字节区分是 UTF-8 还是 ASCII</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">由于 UTF-8 是单字节编码，因此它没有 BOM，在这种情况下如果是纯英文文档 UTF-8 将跟 ASCII 输出一模一样的结果，而如果其中混入一两个中文 —— 这种情况下编辑器就不好判断该用哪个编码了, 可能就会出现你在浏览纯英文本的时候碰到一两个乱码这种情况</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">当然现代编辑器谁不支持 UTF-8 ?（我这里其实点草了微软系统里的记事本）</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">这个问题其实见仁见智，不过 UTF-8 确实可以带一个 BOM，这个 BOM 其实就只是标记了这是一个 UTF-8 文档，比如 VSCode 就支持这种带 BOM 的 utf8 编码:</div><div class=\"std-img-dynamic-wrapper\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:21.76%\"><img class=\"std-img-dymanic-main r-link __mosaic __loading\" src=\"/tsxs-esm/vscode-onsave.b6bd483a395a9ad3.png.mosaic.png\"/><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/vscode-onsave.b6bd483a395a9ad3.png\"/></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">下面我构造了一个带 BOM 的 UTF-8 例子，为 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">0xEF 0xBB 0xBF</div> 可以下载看看：</div><div class=\"buffer-view nth-0\"><style></style><div class=\"buffer-view-header\"><div class=\"std-icon  icon-bit-switch\" style=\"height:2em;width:2em;overflow:hidden;display:inline-block;box-sizing:border-box\"></div><div class=\"buffer-view-state\"><div>cursor=0x0000</div><div>length=7</div><div><a download=\"UTF-8 with BOM 例子.txt\" href=\"\">download</a></div></div></div><div class=\"buffer-view-ranges\"><div class=\"_line-range\">0x0000</div></div><div class=\"buffer-view-lines\"><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"0\">EF</div><div class=\"_hex-num\" data-index=\"1\">BB</div><div class=\"_hex-num\" data-index=\"2\">BF</div><div class=\"_hex-num\" data-index=\"3\">F0</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\" data-index=\"4\">9F</div><div class=\"_hex-num\" data-index=\"5\">8D</div><div class=\"_hex-num\" data-index=\"6\">B0</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\"> </div></div></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">为什么是 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">0xEF 0xBB 0xBF</div> 呢？ 我们不妨将其当成正常 UTF-8 流进行解析：</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token number\">0xEF</span> <span class=\"token operator\">=></span> <span class=\"token number\">11101111</span> <span class=\"token punctuation\">(</span>开头 <span class=\"token number\">1110</span> 代表一共 <span class=\"token number\">3</span> 字节<span class=\"token punctuation\">,</span> 低 <span class=\"token number\">4</span> 位是有效位<span class=\"token operator\">:</span> <span class=\"token number\">1111</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token number\">0xBB</span> <span class=\"token operator\">=></span> <span class=\"token number\">10111011</span> <span class=\"token punctuation\">(</span>低 <span class=\"token number\">6</span> 位是有效位<span class=\"token operator\">:</span> <span class=\"token number\">111011</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token number\">0xBF</span> <span class=\"token operator\">=></span> <span class=\"token number\">10111111</span> <span class=\"token punctuation\">(</span>低 <span class=\"token number\">6</span> 位是有效位<span class=\"token operator\">:</span> <span class=\"token number\">111111</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span>有效位拼接后得到 <span class=\"token number\">0b1111111011111111</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span>转成十六进制恰好就是 <span class=\"token number\">0xFEFF</span> 这恰好就是 <span class=\"token constant\">UTF</span><span class=\"token operator\">-</span><span class=\"token number\">16</span> 的 <span class=\"token constant\">BOM</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">换个角度来说，0xEF 0xBB 0xBF 最后会被当成码点 0xFEFF 被编辑器识别，它在编码层面是有意义的比如你可以这样构造它:</div><div class=\"std-code\"><pre class=\"prismjs ts rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">// Node REPL</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token operator\">></span> str <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0xEF</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xBB</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xBF</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x41</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token comment\">// => 显示为 'A'</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token operator\">></span> <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span><span class=\"token comment\">// => 2 实际为 '\\uFEFFA', 只是显示不出 0xFEFF 了</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">实际上 0xFEFF 除了用作 BOM 外，实际它还可以是一个合法的码点，即所谓的零宽度空格 ZWNBSP:</div><div class=\"std-img-dynamic-wrapper\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:70.22%\"><img class=\"std-img-dymanic-main r-link __mosaic __loading\" src=\"/tsxs-esm/U+FEFF.257a1b9e382662c2.png.mosaic.png\"/><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/U+FEFF.257a1b9e382662c2.png\"/></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\"><a href=\"https://compart.com/en/unicode/U+FEFF\" target=\"_blank\" style=\"background-color:#f5e4f0\" class=\"std-link --fontSansSerif  _block\" data-minimap-color=\"#f5e4f0\"><span class=\"std-link-icon r-link\" data-src=\"/get-favicon/compart.com?h=-13628651562\" style=\"background-image:url(&quot;/get-favicon/compart.com?h=-13628651562&quot;)\"></span><span class=\"std-link-txt\">U+FEFF - (BOM, ZWNBSP)</span></a></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">这下懂了吧，在首字节插入 U+FEFF 零宽度空格就能区分 ASCII 和 UTF-8 编码啦，这其实也是一种 trade-off 的艺术，单独定义了一个特殊码点用来实现特殊功能</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">此外这个零宽度空格在 Ctrl+A 全选的时候也会选中复制到剪贴板，在粘贴到 SQL 命令行写入 UTF-8 的时候有可能会遇到问题（如果 DB 不支持带 BOM 的 UTF-8 就 GG 了）</div><h2 id=\"utf-8-字节流传输截断问题\" class=\"std-title --fontTitle\">UTF-8 字节流传输截断问题</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">还是以零宽度空格的 0xEF 0xBB 0xBF 来说：</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token number\">0xEF</span> <span class=\"token operator\">=></span> <span class=\"token number\">11101111</span> <span class=\"token punctuation\">(</span>开头 <span class=\"token number\">1110</span> 代表一共 <span class=\"token number\">3</span> 字节<span class=\"token punctuation\">,</span> 低 <span class=\"token number\">4</span> 位是有效位<span class=\"token operator\">:</span> <span class=\"token number\">1111</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token number\">0xBB</span> <span class=\"token operator\">=></span> <span class=\"token number\">10111011</span> <span class=\"token punctuation\">(</span>低 <span class=\"token number\">6</span> 位是有效位<span class=\"token operator\">:</span> <span class=\"token number\">111011</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>0cBF <span class=\"token operator\">=></span> <span class=\"token number\">10111111</span> <span class=\"token punctuation\">(</span>低 <span class=\"token number\">6</span> 位是有效位<span class=\"token operator\">:</span> <span class=\"token number\">111111</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span>有效位拼接后得到 <span class=\"token number\">0b1111111011111111</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span>转成十六进制恰好就是 <span class=\"token number\">0xFEFF</span> 这恰好就是 <span class=\"token constant\">UTF</span><span class=\"token operator\">-</span><span class=\"token number\">16</span> 的 <span class=\"token constant\">BOM</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">试想如果只传输了 0xEF 就 TCP 断开或者服务端掉线了, 我这里就构造了这样的情况，服务返回了一个错误的 utf-8 字节流导致浏览器乱码的情况:</div><div class=\"std-code\"><pre class=\"prismjs ts rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token keyword\">const</span> http <span class=\"token operator\">=</span> <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span>http<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>  res<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'text/html; charset=utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span>  res<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0xEF</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span>  res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></div><div class=\"std-img-dynamic-wrapper\"><div class=\"std-img-dynamic\" data-minimap=\"Rect\" style=\"padding-bottom:44.08%\"><img class=\"std-img-dymanic-main r-link __mosaic __loading\" src=\"/tsxs-esm/utf8-decode-error.f13ac8390394bde4.png.mosaic.png\"/><img class=\"std-img-dymanic-main\" src=\"/tsxs-esm/utf8-decode-error.f13ac8390394bde4.png\"/></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">这种情况可能到处都有，只是日常都不怎么考虑到。</div><h3 id=\"进程-stdout-拼接问题\" class=\"std-title --fontTitle\">进程 stdout 拼接问题</h3><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">stdout 也是一段一段的字节流，可能两段输出就断在 UTF-8 的首字节了，具体来说，&#x27;永&#x27; 这个字可以用 UTF-8 编码为:</div><div class=\"buffer-view nth-0\"><style></style><div class=\"buffer-view-header\"><div class=\"std-icon  icon-bit-switch\" style=\"height:2em;width:2em;overflow:hidden;display:inline-block;box-sizing:border-box\"></div><div class=\"buffer-view-state\"><div>cursor=0x0000</div><div>length=3</div><div><a download=\"UTF-8 永.txt\" href=\"\">download</a></div></div></div><div class=\"buffer-view-ranges\"><div class=\"_line-range\">0x0000</div></div><div class=\"buffer-view-lines\"><div class=\"buffer-view-line\"><div class=\"_hex-num\" data-index=\"0\">E6</div><div class=\"_hex-num\" data-index=\"1\">B0</div><div class=\"_hex-num\" data-index=\"2\">B8</div><div class=\"_hex-num\"> </div><div class=\"_hex-num\"> </div><div class=\"_hex-num\"> </div></div></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">当我们监听 stdout 并收集 ondata 输出的时候，有可能不会一步到位，而是在中间截断得到两段 buffer (短文本很难遇到，长文本就经常遇到了)：</div><div class=\"std-code\"><pre class=\"prismjs ts rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token operator\">&lt;</span>Buffer <span class=\"token constant\">E6</span><span class=\"token operator\">></span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token operator\">&lt;</span>Buffer <span class=\"token constant\">B0</span> <span class=\"token constant\">B8</span><span class=\"token operator\">></span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">如果此时这样处理就会乱码了：</div><div class=\"std-code\"><pre class=\"prismjs ts rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token operator\">&lt;</span>Buffer <span class=\"token constant\">E6</span><span class=\"token operator\">></span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token operator\">&lt;</span>Buffer <span class=\"token constant\">B0</span> <span class=\"token constant\">B8</span><span class=\"token operator\">></span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">我们需要将其 concat 成单个 buffer 后再 toString 这样才没问题。</div><div class=\"std-code\"><pre class=\"prismjs ts rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span>Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span>  <span class=\"token operator\">&lt;</span>Buffer <span class=\"token constant\">E6</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>  <span class=\"token operator\">&lt;</span>Buffer <span class=\"token constant\">B0</span> <span class=\"token constant\">B8</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">这个 case 我是遇到过的，当时是调用的是 buffers.join(&#x27;&#x27;) 来拼接，实际这样就是给每个子元素跑一次 toString 在将其加起来，导致最后出现乱码的问题。</div><h1 id=\"EOF\" class=\"std-title --fontTitle\"><a href=\"#EOF\" class=\"markdownIt-Anchor\">#</a> EOF<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">好了，这篇长文终于写完了，这里写一下总结：</div><ul class=\"numbering-main\" data-minimap-color=\"#DDDDDD\"><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">Unicode 编码空间、码点、平面、区块</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">UTF-32: 将码点当成 4 字节 uint32 进行存储</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">UTF-16: 第一平面内的直接用 2 字节存储；后续平面的则通过高低代理对的方式填充 20 位 bits 进行码点的编码，这 20 位里高 4 位是平面编号，低 16 位是在平面内的偏移 —— 也因此要减去 0x10000 来避免对第一平面的重复编码</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">UTF-8: 通过 UTF-8 头的方式控制的变长编码，将编码位提出后提取并拼接有效载荷即可将码点编码进去</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">UCS-2: 即第一平面，UTF-16 可以完全兼容它</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">ASCII: 低 128 位，UTF-8 能完全兼容它</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">JavaScript 里的 UTF-16: 由于编码的原因可能会造成一些有趣的 case</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">Unicode 五层模型: ACR、CCS、CEF、CES、TES</div></li><li class=\"numbering-item\"><div class=\"numbering-marker numbering-marker-rect\"></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">对 Unicode 的个人思考</div></li></ul><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">不好，前面太集中了，现在开始注意力涣散了 ...</div>","props":{"codeUtf8EncodeCodePoint":"\n/** 将单个码点转为 utf-8 编码 */\nexport function utf8EncodeCodePoint(codePoint: number): number[] {\n  // 0b01111111 及以下的情况跟 ASCII 保持一致，直接返回即可\n  if (codePoint <= 0b01111111) {\n    return [codePoint]\n  }\n\n  // 先将 codePoint 按 0b10 + 6 位的方式隔开成 number[]\n  const result: number[] = [];\n  for (;;) {\n    const _6bit = codePoint & 0b111111;\n    const _8bit = 0b10000000 | _6bit;\n    result.unshift(_8bit);\n    codePoint = codePoint >> 6;\n    if (codePoint === 0) break;\n  }\n\n  // 处理 `utf 头`\n  const header = ((1 << result.length) - 1) << 1;\n  const restBits = 8 - 1 - result.length;\n\n  // 判断第一位放不得下 header\n  if ((1 << restBits) > (result[0] & 0b111111)) {\n    const headerByte = (header << restBits);\n    result[0] = (result[0] & 0b111111) | headerByte;\n  } else {\n    // 放不下则单独开一个字节塞到最前面\n    result.unshift(((header + 1) << 1) << (restBits - 1));\n  }\n\n  return result;\n}\n","codeUtf8Decode":"/**\n * 将 arr 当作 utf-8 buffer 进行解码，将其解码位码点数组\n */\nexport function utf8Decode(arr: ArrayLike<number>) {\n  let result: number[] = [];\n  let i = 0;\n  while (i < arr.length) {\n    const firstByte = arr[i];\n\n    // 先扫描 utf 头搞到总长度\n    let scanner = 0b10000000;\n    let utfLength = 0;\n    while (firstByte & scanner) {\n      utfLength ++;\n      scanner = scanner >> 1;\n    }\n\n    // 第一位通过前面的 scanner 就能快速取出其有效的数据位\n    let buf = firstByte & (scanner - 1);\n    for (let offset = 1; offset < utfLength; offset ++) {\n      buf = buf << 6;\n      buf = buf | (arr[i + offset] & 0b00111111);\n    }\n\n    result.push(buf);\n    i = i + utfLength;\n  }\n\n  return result;\n}\n","codeUtf16EncodeCodePoint":"/**\n * high-half surrogates 0xD800 0xDBFF\n * low-half surrogates 0xDC00 0xDFFF\n * surrogates 0xD800-0xDFFFF\n * @param codePoint 给定码点\n * @returns 返回二字节或四字节 number[]\n */\nexport function utf16EncodeCodePoint(codePoint: number): number[] {\n  if (codePoint < 0x10000) { // 第一平面 (BMP)\n    const byte0 = (codePoint & 0b1111111100000000) >> 8;\n    const byte1 = codePoint & 0b0000000011111111;\n    return [byte0, byte1];\n  }\n\n  if (codePoint >= 0x100000) {\n    throw new Error('不支持大于 0x100000 的码点')\n  }\n\n  // 需要减去 0x10000 避免对第一平面重复编码\n  const buf = (codePoint - 0x10000);\n\n  const l10 = (buf & 0b00000000001111111111);\n  const h10 = (buf & 0b11111111110000000000) >> 10;\n\n  const h16 = h10 | 0b1101100000000000;\n  const l16 = l10 | 0b1101110000000000;\n\n  return [\n    (h16 & 0b1111111100000000) >> 8,\n    (h16 & 0b0000000011111111),\n    (l16 & 0b1111111100000000) >> 8,\n    (l16 & 0b0000000011111111),\n  ];\n}\n"},"tocStack":[{"id":"what-is-unicode","level":1,"text":"Unicode 是什么 ?"},{"id":"unicode-码点-(code-point)","level":2,"text":"Unicode 码点 (Code Point)"},{"id":"unicode-编码空间-(encoding-space)","level":2,"text":"Unicode 编码空间 (Encoding-Space)"},{"id":"unicode-平面划分-(plane)","level":2,"text":"Unicode 平面划分 (Plane)"},{"id":"unicode-区块-(block)","level":2,"text":"Unicode 区块 (block)"},{"id":"UTF-8","level":1,"text":"UTF-32"},{"id":"UTF-16","level":1,"text":"UTF-16"},{"id":"实现-utf16encodecodepoint","level":2,"text":"实现 utf16EncodeCodePoint"},{"id":"utf-16-demo","level":2,"text":"UTF-16 Demo"},{"id":"utf-16-in-js","level":1,"text":"题外话: JavaScript 里的 UTF-16"},{"id":"如何直接用-unicode-码点来构造-string-?","level":2,"text":"如何直接用 unicode 码点来构造 string ?"},{"id":"🍰.length-为什么是-2-的问题","level":2,"text":"'🍰'.length 为什么是 2 的问题"},{"id":".split()-并不能很好的识别-utf-16-内的字符","level":2,"text":".split('') 并不能很好的识别 UTF-16 内的字符"},{"id":"如何将一段-string-转为码点数组-?","level":2,"text":"如何将一段 string 转为码点数组 ?"},{"id":"ucs2-utf16","level":1,"text":"UCS-2 与 UTF-16 的关系"},{"id":"UTF-8","level":1,"text":"UTF-8"},{"id":"utf-8-demo","level":2,"text":"UTF-8 Demo"},{"id":"look-back-to-std-unicode","level":1,"text":"回头看 Unicode 标准"},{"id":"acr:-abstract-character-repertoire-(抽象字符表)-","level":2,"text":"ACR: Abstract Character Repertoire (抽象字符表) "},{"id":"ccs:-coded-character-set-(编码字符集)-","level":2,"text":"CCS: Coded Character Set (编码字符集) "},{"id":"cef:-character-encoding-form-(字符编码方式)-","level":2,"text":"CEF: Character Encoding Form (字符编码方式) "},{"id":"ces:-character-encoding-scheme-(字符编码方案)","level":2,"text":"CES: Character Encoding Scheme (字符编码方案)"},{"id":"tes:-transfer-encoding-syntax-(传输编码句法)","level":2,"text":"TES: Transfer Encoding Syntax (传输编码句法)"},{"id":"-2853124934","level":1,"text":"注意力大集中"},{"id":"中文字符码点连续性问题","level":2,"text":"中文字符码点连续性问题"},{"id":"utf-16-高/低代理打洞的问题","level":2,"text":"UTF-16 高/低代理打洞的问题"},{"id":"utf-24-可行性？","level":2,"text":"UTF-24 可行性？"},{"id":"如何在第一个字节区分是-utf-8-还是-ascii","level":2,"text":"如何在第一个字节区分是 UTF-8 还是 ASCII"},{"id":"utf-8-字节流传输截断问题","level":2,"text":"UTF-8 字节流传输截断问题"},{"id":"进程-stdout-拼接问题","level":3,"text":"进程 stdout 拼接问题"},{"id":"EOF","level":1,"text":"EOF"}]}}},"HomeApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"TimeLineApiState":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"SettingApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"LaunchpadApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}}}</script>
<!--SCRIPT-->
</body>
</html>
