<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<title>Hello CSS 变量 | Eczn's Home</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,minimal-ui">
<meta name="format-detection" content="telephone=no">

<style id="CSS_VARS"></style>
<script>
(function() {
console.log('INIT CSS VAR');
function loadCSSVars() {
    const j = localStorage.getItem("CSS_VARS_2" /* STORAGE_KEY.CSS_VARS */);
    const initialVars = initialCSSVars();
    if (!j)
        return initialVars;
    try {
        const result = {
            ...initialVars,
            ...JSON.parse(j)
        };
        console.log('loadCSSVars from storage', result);
        return result;
    }
    catch (error) {
        console.error('load css vars with error', error);
        return initialVars;
    }
}
function renderCSSVars(vars, style) {
    const allDefine = Object.keys(vars).map(k => {
        const v = vars[k];
        const cssValue = typeof v === 'number' ? `${v}px` : v;
        return `--${k}:${cssValue};`;
    }).join('\n');
    if (style) {
        style.innerHTML = `:root { ${allDefine} }`;
    }
    else {
        console.error(`style#CSS_VARS NotFound !`);
    }
}
function initialCSSVars() {
    let rem = 16;
    // 移动端
    if (typeof window !== 'undefined' && window.innerWidth <= 500) {
        rem = Number(((window.innerWidth - 20) / 42).toFixed(1));
        console.log('mobile calculated rem =>', rem);
    }
    return {
        rem,
        enableSmallerFont: false,
        displayToc: 'block',
        fontSmcp: 'source serif pro, serif',
        fontCode: 'consolas, Menlo, monospace',
        fontTitle: 'Noto Serif SC, serif',
        fontArticle: 'source serif pro, LXGW WenKai',
        fontSansSerif: 'sans-serif',
    };
}
window.__initialCSSVars = loadCSSVars();
renderCSSVars(__initialCSSVars, document.querySelector('#CSS_VARS'));
})();
</script>

<link rel="icon" href="/favicon.png"><script defer="defer" src="/js/index.f7602db1.js"></script><script defer="defer" src="/js/chunk-lib.cbf60312.js"></script><link href="/css/index.791c12afdb2cecbd8bba.css" rel="stylesheet"><link href="/css/chunk-lib.5c7d4887bb8714b00c54.css" rel="stylesheet"></head>
<body x-apple-data-detectors="none">
<noscript>当前浏览器不支持 JavaScript, 建议使用支持 JavaScript 的浏览器来访问此网站 !</noscript>
<div id="rally-bg" style="opacity:0"></div>
<div id="app"><div class="ball-canvas-container"></div><nav class="nav-main --fontSmcp"><div class="_title default-max-width">Eczn&#x27;s Home</div><div class="smcphr"></div><div class="_links default-max-width"><a class="r-link _link clickable r-link" href="/">Home</a><a class="r-link _link clickable r-link" href="/tl/0/">Timeline</a><a class="r-link _link clickable r-link" href="/cate/all/">Category</a><a class="r-link _link clickable r-link" href="/setting/">Setting</a><a class="r-link _link clickable r-link" href="/launchpad/">Launchpad</a></div></nav><div class="std-box rally-page-content default-max-width"><div id="blog-box" class="std-box-content "><div id="start" class="blog-header-main"><div class="_infos"><div class="_info"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="clock" class="svg-inline--fa fa-clock fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256,8C119,8,8,119,8,256S119,504,256,504,504,393,504,256,393,8,256,8Zm92.49,313h0l-20,25a16,16,0,0,1-22.49,2.5h0l-67-49.72a40,40,0,0,1-15-31.23V112a16,16,0,0,1,16-16h32a16,16,0,0,1,16,16V256l58,42.5A16,16,0,0,1,348.49,321Z"></path></svg>2023-08-12</div></div><div class="_title --fontTitle">Hello CSS 变量</div></div><article class="r-article-wrapper"><div class="toc-wrapper"><div class="toc"><div class="toc-item _active" style="padding-left:0em"><a href="#define" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>声明和使用变量</a></div><div class="toc-item" style="padding-left:0em"><a href="#waht-is-root" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>:root 是什么</a></div><div class="toc-item" style="padding-left:0em"><a href="#site-theme-practice" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>站点主题实践</a></div><div class="toc-item" style="padding-left:1em"><a href="#define-types" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>定义类型</a></div><div class="toc-item" style="padding-left:1em"><a href="#render-cssvars" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>CSSVars 渲染到 &lt;style&gt;</a></div><div class="toc-item" style="padding-left:1em"><a href="#storage-cssvars" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>考虑持久化</a></div><div class="toc-item" style="padding-left:1em"><a href="#user-cssvars-demo" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>用户配置界面 (demo)</a></div><div class="toc-item" style="padding-left:0em"><a href="#end-of-file" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>EOF</a></div><div class="_index --fontSmcp" data-minimap="Ignore">Indexes</div><div class="smcphr"></div></div></div><div class="r-article"><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">很早就听过和简单看过 CSS 变量了，但是一直没有正式找场景使用过，这两天实装了一下本站的 Setting 页，里面用了 CSS 变量，本文总结一下经验:</div><a href="/setting/" target="_blank" style="background-color:#dddfde" class="std-link --fontSansSerif  _block" data-minimap-color="#dddfde"><span class="std-link-icon r-link" data-src="/get-favicon/eczn.github.io?h=-1911350002" style="background-image:url(&quot;/get-favicon/eczn.github.io?h=-1911350002&quot;)"></span><span class="std-link-txt">Setting | 系统设置</span></a><h1 id="define" class="std-title --fontTitle"><a href="#define" class="markdownIt-Anchor">#</a> 声明和使用变量<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">可以按照如下方式声明和使用一个 CSS 变量</div><div class="col-main" style="display:flex;margin-bottom:16px"><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-code"><pre  class="prismjs css rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token selector">:root</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">01</span>  <span class="token property">--REM</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token punctuation">}</span></pre></div></div><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-code"><pre  class="prismjs css rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token selector">html</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">01</span>  <span class="token property">font-site</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--REM<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token punctuation">}</span></pre></div></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">在上述两个例子中，声明了一个叫做 <div class="std-inline-code" data-minimap-color="#f5e9e9">--REM</div> 的变量，其值为 14px, 然后通过 <div class="std-inline-code" data-minimap-color="#f5e9e9">var()</div> 的方式将其绑定到 html 的 fontSizte 属性上</div><h1 id="waht-is-root" class="std-title --fontTitle"><a href="#waht-is-root" class="markdownIt-Anchor">#</a> :root 是什么<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">通过 :root 可以指定变量的作用域为全局。在大多数情况下我们只需要声明到 <div class="std-inline-code" data-minimap-color="#f5e9e9">:root</div> 全局中即可, 我暂时没有碰到需要单独定义作用域的情况, 可以通过这种方式单独指定变量作用域:</div><div class="std-code"><pre  class="prismjs css rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token selector">div</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">01</span>  <span class="token property">--PRIMARY-COLOR</span><span class="token punctuation">:</span> #BBB<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token punctuation">}</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">叙述 CSS 变量的用法不是本文重点，相关细节可以参考 MDN:</div><a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Using_CSS_custom_properties" target="_blank" style="background-color:#e1eae4" class="std-link --fontSansSerif  _block" data-minimap-color="#e1eae4"><span class="std-link-icon r-link" data-src="/get-favicon/developer.mozilla.org?h=-5095327696" style="background-image:url(&quot;/get-favicon/developer.mozilla.org?h=-5095327696&quot;)"></span><span class="std-link-txt">MDN - 使用 CSS 自定义属性（变量）</span></a><h1 id="site-theme-practice" class="std-title --fontTitle"><a href="#site-theme-practice" class="markdownIt-Anchor">#</a> 站点主题实践<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">CSS 变量一个最常见的用法就是实现站点主题的配置化、动态化 —— 以往 less / sass 那种预处理器的主题是要过静态编译才出来的，很多时候有各种限制，不好用, 现在借助 CSS 变量, 配合 js 就能做更完善的用户主题实践</div><h2 id="define-types" class="std-title --fontTitle">定义类型</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">实现站点主题配置，需要先设计相关类型，举个例子：实现按钮颜色的配置</div><div class="std-code"><pre  class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span>__NO_CODE__</pre></div><h2 id="render-cssvars" class="std-title --fontTitle">CSSVars 渲染到 &lt;style&gt;</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">还需要将这个 CSSVars 类型转成一段 CSS 内容并注入到 style 标签中才能使其作为 CSS 变量使用:</div><div class="std-code"><pre  class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span>__NO_CODE__</pre></div><h2 id="storage-cssvars" class="std-title --fontTitle">考虑持久化</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">在正式调用 renderCSSVars 之前我们还需要考虑怎么保存用户配置的 CSSVars, 即持久化, 可以使用 localStorage 进行存储:</div><div class="std-code"><pre  class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span>__NO_CODE__</pre></div><h2 id="user-cssvars-demo" class="std-title --fontTitle">用户配置界面 (demo)</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">最后一步是写组件让用户可以配置并持久化存储自己的 CSSVars, 以下是我实现的一个简单的组件 DEMO:</div><div class="col-main" style="display:flex;margin-bottom:16px"><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div><div>请点击下面色框选取颜色, <br/>当前色值: #e3e3e3</div><input type="color" value="#e3e3e3"/></div></div><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="button-main --fontSansSerif  normal" style="font-size:inherit;background-color:#e3e3e3"><span>这是一个空按钮</span></div></div></div><details><summary><div class="std-para --fontArticle" data-minimap-color="#CCCCCC" style="display:inline-block">完整实现如下，已折叠，点击展开</div></summary><div class="std-code"><pre  class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span>__NO_CODE__</pre></div></details><h1 id="end-of-file" class="std-title --fontTitle"><a href="#end-of-file" class="markdownIt-Anchor">#</a> EOF<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">至此一个基于 CSS 变量的主题化场景配置实践就算完成了 —— 在设置颜色的过程中，将最新的色值重新持久化存储，后续用户再刷新的时候就可以拿出来并且应用到 CSS 变量中从而主题化站点样式, 后续只需要横向拓展更多的样式选项即可</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">但是这里还有些可以优化的点，能想到的比如说持久化存储写到后台数据库，这样就可以多端保持主题同步。另外可以考虑弄一个 style CSS 变量直出服务, 让页面打开的一瞬间就主题化而不是等 js 和 ajax 加载完:</div><div class="std-code"><pre  class="prismjs html rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/api/cssvars<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token style"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">然后对应的这个服务其实就是去读用户配置的 css 变量并渲染直出到用户侧:</div><div class="std-code"><pre  class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/cssvars'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">01</span>  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>  <span class="token keyword">const</span> cssvars <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadUserCssVarsFromDB</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">03</span>  <span class="token keyword">const</span> styleContent <span class="token operator">=</span> <span class="token function">renderCssVars</span><span class="token punctuation">(</span>cssvars<span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">04</span>  ctx<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span>
<span class="line-numbers-rows" style="user-select: none;">05</span>    contentType<span class="token operator">:</span> <span class="token string">'.css'</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">06</span>    content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
<span class="line-numbers-rows" style="user-select: none;">07</span>      :root {
<span class="line-numbers-rows" style="user-select: none;">08</span>        buttonColor: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cssvars<span class="token punctuation">.</span>buttonColor<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;
<span class="line-numbers-rows" style="user-select: none;">09</span>      }
<span class="line-numbers-rows" style="user-select: none;">10</span>    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">11</span>  <span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">12</span><span class="token punctuation">}</span><span class="token punctuation">)</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">* 注意这里可能有各种注入或者其他 Web 安全问题, 如果你真的要搞一个这样的方案建议要好好 review 一下可能的安全漏洞</div></div></article></div></div><div class="smcphr rally-page-smcphr"></div><div class="std-box rally-giscus-wrapper default-max-width"><div class="std-box-content "></div></div></div>
<script>window.__INITIAL_STATE__ = {"CategoryApiState":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"BlogApiState":{"loaded":true,"loading":false,"error":null,"dataMap":{"hello-css-vars":{"type":"tsx","meta":{"id":"hello-css-vars","title":"Hello CSS 变量","author":"eczn","time":"2023-08-12T10:32:11.000Z","type":"article","appTitle":"","appIcon":"","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},"tsxDistPath":"./hello-css-vars/index.blog.js","ssrContent":"<div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">很早就听过和简单看过 CSS 变量了，但是一直没有正式找场景使用过，这两天实装了一下本站的 Setting 页，里面用了 CSS 变量，本文总结一下经验:</div><a href=\"/setting/\" target=\"_blank\" style=\"background-color:#dddfde\" class=\"std-link --fontSansSerif  _block\" data-minimap-color=\"#dddfde\"><span class=\"std-link-icon r-link\" data-src=\"/get-favicon/eczn.github.io?h=-1911350002\" style=\"background-image:url(&quot;/get-favicon/eczn.github.io?h=-1911350002&quot;)\"></span><span class=\"std-link-txt\">Setting | 系统设置</span></a><h1 id=\"define\" class=\"std-title --fontTitle\"><a href=\"#define\" class=\"markdownIt-Anchor\">#</a> 声明和使用变量<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">可以按照如下方式声明和使用一个 CSS 变量</div><div class=\"col-main\" style=\"display:flex;margin-bottom:16px\"><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-code\"><pre  class=\"prismjs css rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token selector\">:root</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span>  <span class=\"token property\">--REM</span><span class=\"token punctuation\">:</span> 14px<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token punctuation\">}</span></pre></div></div><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-code\"><pre  class=\"prismjs css rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token selector\">html</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span>  <span class=\"token property\">font-site</span><span class=\"token punctuation\">:</span> <span class=\"token function\">var</span><span class=\"token punctuation\">(</span>--REM<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token punctuation\">}</span></pre></div></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">在上述两个例子中，声明了一个叫做 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">--REM</div> 的变量，其值为 14px, 然后通过 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">var()</div> 的方式将其绑定到 html 的 fontSizte 属性上</div><h1 id=\"waht-is-root\" class=\"std-title --fontTitle\"><a href=\"#waht-is-root\" class=\"markdownIt-Anchor\">#</a> :root 是什么<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">通过 :root 可以指定变量的作用域为全局。在大多数情况下我们只需要声明到 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">:root</div> 全局中即可, 我暂时没有碰到需要单独定义作用域的情况, 可以通过这种方式单独指定变量作用域:</div><div class=\"std-code\"><pre  class=\"prismjs css rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token selector\">div</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span>  <span class=\"token property\">--PRIMARY-COLOR</span><span class=\"token punctuation\">:</span> #BBB<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token punctuation\">}</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">叙述 CSS 变量的用法不是本文重点，相关细节可以参考 MDN:</div><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/CSS/Using_CSS_custom_properties\" target=\"_blank\" style=\"background-color:#e1eae4\" class=\"std-link --fontSansSerif  _block\" data-minimap-color=\"#e1eae4\"><span class=\"std-link-icon r-link\" data-src=\"/get-favicon/developer.mozilla.org?h=-5095327696\" style=\"background-image:url(&quot;/get-favicon/developer.mozilla.org?h=-5095327696&quot;)\"></span><span class=\"std-link-txt\">MDN - 使用 CSS 自定义属性（变量）</span></a><h1 id=\"site-theme-practice\" class=\"std-title --fontTitle\"><a href=\"#site-theme-practice\" class=\"markdownIt-Anchor\">#</a> 站点主题实践<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">CSS 变量一个最常见的用法就是实现站点主题的配置化、动态化 —— 以往 less / sass 那种预处理器的主题是要过静态编译才出来的，很多时候有各种限制，不好用, 现在借助 CSS 变量, 配合 js 就能做更完善的用户主题实践</div><h2 id=\"define-types\" class=\"std-title --fontTitle\">定义类型</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">实现站点主题配置，需要先设计相关类型，举个例子：实现按钮颜色的配置</div><div class=\"std-code\"><pre  class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span>__NO_CODE__</pre></div><h2 id=\"render-cssvars\" class=\"std-title --fontTitle\">CSSVars 渲染到 &lt;style&gt;</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">还需要将这个 CSSVars 类型转成一段 CSS 内容并注入到 style 标签中才能使其作为 CSS 变量使用:</div><div class=\"std-code\"><pre  class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span>__NO_CODE__</pre></div><h2 id=\"storage-cssvars\" class=\"std-title --fontTitle\">考虑持久化</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">在正式调用 renderCSSVars 之前我们还需要考虑怎么保存用户配置的 CSSVars, 即持久化, 可以使用 localStorage 进行存储:</div><div class=\"std-code\"><pre  class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span>__NO_CODE__</pre></div><h2 id=\"user-cssvars-demo\" class=\"std-title --fontTitle\">用户配置界面 (demo)</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">最后一步是写组件让用户可以配置并持久化存储自己的 CSSVars, 以下是我实现的一个简单的组件 DEMO:</div><div class=\"col-main\" style=\"display:flex;margin-bottom:16px\"><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div><div>请点击下面色框选取颜色, <br/>当前色值: #e3e3e3</div><input type=\"color\" value=\"#e3e3e3\"/></div></div><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"button-main --fontSansSerif  normal\" style=\"font-size:inherit;background-color:#e3e3e3\"><span>这是一个空按钮</span></div></div></div><details><summary><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\" style=\"display:inline-block\">完整实现如下，已折叠，点击展开</div></summary><div class=\"std-code\"><pre  class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span>__NO_CODE__</pre></div></details><h1 id=\"end-of-file\" class=\"std-title --fontTitle\"><a href=\"#end-of-file\" class=\"markdownIt-Anchor\">#</a> EOF<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">至此一个基于 CSS 变量的主题化场景配置实践就算完成了 —— 在设置颜色的过程中，将最新的色值重新持久化存储，后续用户再刷新的时候就可以拿出来并且应用到 CSS 变量中从而主题化站点样式, 后续只需要横向拓展更多的样式选项即可</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">但是这里还有些可以优化的点，能想到的比如说持久化存储写到后台数据库，这样就可以多端保持主题同步。另外可以考虑弄一个 style CSS 变量直出服务, 让页面打开的一瞬间就主题化而不是等 js 和 ajax 加载完:</div><div class=\"std-code\"><pre  class=\"prismjs html rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/api/cssvars<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token style\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">></span></span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">然后对应的这个服务其实就是去读用户配置的 css 变量并渲染直出到用户侧:</div><div class=\"std-code\"><pre  class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span>app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/cssvars'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span>  <span class=\"token keyword\">await</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>  <span class=\"token keyword\">const</span> cssvars <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">loadUserCssVarsFromDB</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span>  <span class=\"token keyword\">const</span> styleContent <span class=\"token operator\">=</span> <span class=\"token function\">renderCssVars</span><span class=\"token punctuation\">(</span>cssvars<span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span>  ctx<span class=\"token punctuation\">.</span><span class=\"token function\">sendFile</span><span class=\"token punctuation\">(</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span>    contentType<span class=\"token operator\">:</span> <span class=\"token string\">'.css'</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span>    content<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span>      :root {\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span>        buttonColor: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>cssvars<span class=\"token punctuation\">.</span>buttonColor<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">;\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span>      }\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">10</span>    </span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">11</span>  <span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">12</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">* 注意这里可能有各种注入或者其他 Web 安全问题, 如果你真的要搞一个这样的方案建议要好好 review 一下可能的安全漏洞</div>","props":{"fileCssVars":"// css-vars.tsx\n// CSS 变量\nexport interface CSSVars {\n  buttonColor: string\n}\n\n// 获取默认变量配置\nexport function initialCSSVars(): CSSVars {\n  return {\n    buttonColor: '#e3e3e3'\n  }\n}\n","fileRenderCssVars":"// render-css-vars.tsx\nimport { CSSVars} from './css-vars'\n\n// 将 vars 的内容渲染到 style 中\n// 以此处的 CSSVars 来说，渲染结果类似这样：\n// <style>\n// :root { --buttonColor: #BBB; }\n// <\\/style>\nexport function renderCSSVars(\n  vars: CSSVars,\n  style?: Element\n): void {\n  const allDefine = Object.keys(vars).map(k => {\n    const v = vars[k as keyof CSSVars]\n    const cssValue = typeof v === 'number' ? `${v}px` : v\n    return `--${k}:${cssValue};`\n  }).join('\\n')\n\n  if (style) {\n    style.innerHTML = `:root { ${allDefine} }`\n  } else {\n    console.error(`style#CSS_VARS NotFound !`)\n  }\n}\n","fileStorageCssVars":"import {\n  CSSVars,\n  initialCSSVars,\n} from './css-vars'\n\n/** 保存 CSS Vars */\nexport function saveCSSVars(cssVars: CSSVars): void {\n  const j = JSON.stringify(cssVars)\n  localStorage.setItem('EXAMPLE_CSS_VARS', j)\n}\n\n/** 读取 CSSVars */\nexport function loadCSSVars(): CSSVars {\n  // 服务端渲染场景直接返回初始 CSS 变量即可\n  if (typeof window === 'undefined') {\n    return initialCSSVars()\n  }\n\n  const j = localStorage.getItem('EXAMPLE_CSS_VARS')\n  const initialVars = initialCSSVars()\n  // 如果之前没存过, 直接返回\n  if (!j) return initialVars\n\n  try {\n    // 注意这里是覆盖的\n    return {\n      ...initialVars,\n      ...JSON.parse(j) as CSSVars\n    }\n  } catch (error) {\n    console.error('load css vars with error', error)\n    // 出错后直接返回 initialVars\n    return initialVars\n  }\n}\n","fileUserCssVars":"// user-cssvars.tsx\nimport React from 'react'\nimport { Col, Button } from 'rally/@@'\nimport {\n  renderCSSVars\n} from './render-css-vars'\nimport {\n  loadCSSVars,\n  saveCSSVars,\n} from './storage-css-vars'\n\nfunction getStyleElement(): Element {\n  const styleId = 'example-style'\n  let style = document.querySelector(`#${styleId}`);\n  if (style) return style;\n  // 如果没有则构造一个并插入到 body 中\n  style = document.createElement('style')\n  style.id = styleId\n  document.body.appendChild(style)\n  return style\n}\n\nexport function UserCssVars() {\n  // 读取变量并作为 react state 使用\n  const [cssvars, setCssVars] = React.useState(\n    () => loadCSSVars()\n  );\n\n  React.useEffect(() => {\n    // 每次状态变化后渲染并存储\n    // 这里刷新比较频繁, 写个 timer 优化一下\n    const timer = setTimeout(() => {\n      renderCSSVars(cssvars, getStyleElement())\n      saveCSSVars(cssvars)\n    }, 32);\n    return () => {\n      clearTimeout(timer);\n    }\n  }, [cssvars.buttonColor]);\n\n  return (\n    <Col>\n      <div>\n        <div>\n          请点击下面色框选取颜色, <br />\n          当前色值: {cssvars.buttonColor}\n        </div>\n        <input\n          type=\"color\"\n          value={cssvars.buttonColor}\n          onChange={e => {\n            setCssVars({\n              buttonColor: e.target.value\n            });\n          }}\n        />\n      </div>\n      <Button\n        icon=\"play\"\n        style={{\n          backgroundColor: cssvars.buttonColor,\n        }}>\n        这是一个空按钮\n      </Button>\n    </Col>\n  )\n}\n"},"tocStack":[{"id":"define","level":1,"text":"声明和使用变量"},{"id":"waht-is-root","level":1,"text":":root 是什么"},{"id":"site-theme-practice","level":1,"text":"站点主题实践"},{"id":"define-types","level":2,"text":"定义类型"},{"id":"render-cssvars","level":2,"text":"CSSVars 渲染到 <style>"},{"id":"storage-cssvars","level":2,"text":"考虑持久化"},{"id":"user-cssvars-demo","level":2,"text":"用户配置界面 (demo)"},{"id":"end-of-file","level":1,"text":"EOF"}]}}},"HomeApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"TimeLineApiState":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"SettingApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"LaunchpadApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}}}</script>
<!--SCRIPT-->
</body>
</html>
