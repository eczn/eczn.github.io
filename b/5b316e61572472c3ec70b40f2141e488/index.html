<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<title>许愿墙 5.0 经验总结 | Eczn's Home</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,minimal-ui">
<meta name="format-detection" content="telephone=no">

<style id="CSS_VARS"></style>
<script>
(function() {
console.log('INIT CSS VAR');
function loadCSSVars() {
    const j = localStorage.getItem("CSS_VARS_2" /* STORAGE_KEY.CSS_VARS */);
    const initialVars = initialCSSVars();
    if (!j)
        return initialVars;
    try {
        const result = {
            ...initialVars,
            ...JSON.parse(j)
        };
        console.log('loadCSSVars from storage', result);
        return result;
    }
    catch (error) {
        console.error('load css vars with error', error);
        return initialVars;
    }
}
function renderCSSVars(vars, style) {
    const allDefine = Object.keys(vars).map(k => {
        const v = vars[k];
        const cssValue = typeof v === 'number' ? `${v}px` : v;
        return `--${k}:${cssValue};`;
    }).join('\n');
    if (style) {
        style.innerHTML = `:root { ${allDefine} }`;
    }
    else {
        console.error(`style#CSS_VARS NotFound !`);
    }
}
function initialCSSVars() {
    let rem = 16;
    // 移动端
    if (typeof window !== 'undefined' && window.innerWidth <= 500) {
        rem = Number(((window.innerWidth - 20) / 42).toFixed(1));
        console.log('mobile calculated rem =>', rem);
    }
    return {
        rem,
        enableSmallerFont: false,
        displayToc: 'block',
        fontSmcp: 'source serif pro, serif',
        fontCode: 'consolas, Menlo, monospace',
        fontTitle: 'Noto Serif SC, serif',
        fontArticle: 'source serif pro, LXGW WenKai',
        fontSansSerif: 'sans-serif',
    };
}
window.__initialCSSVars = loadCSSVars();
renderCSSVars(__initialCSSVars, document.querySelector('#CSS_VARS'));
})();
</script>

<link rel="icon" href="/favicon.png"><script defer="defer" src="/js/index.a1ff11e6.js"></script><script defer="defer" src="/js/chunk-lib.c90ce4c7.js"></script><link href="/css/index.b0e70e3c588e68d62835.css" rel="stylesheet"><link href="/css/chunk-lib.5c7d4887bb8714b00c54.css" rel="stylesheet"></head>
<body x-apple-data-detectors="none">
<noscript>当前浏览器不支持 JavaScript, 建议使用支持 JavaScript 的浏览器来访问此网站 !</noscript>
<div id="rally-bg" style="opacity:0"></div>
<div id="app"><div class="ball-canvas-container"></div><nav class="nav-main --fontSmcp"><div class="_title default-max-width">Eczn&#x27;s Home</div><div class="smcphr"></div><div class="_links default-max-width"><a class="r-link _link clickable r-link" href="/">Home</a><a class="r-link _link clickable r-link" href="/tl/0/">Timeline</a><a class="r-link _link clickable r-link" href="/cate/all/">Category</a><a class="r-link _link clickable r-link" href="/setting/">Setting</a><a class="r-link _link clickable r-link" href="/launchpad/">Launchpad</a></div></nav><div class="std-box rally-page-content default-max-width"><div id="blog-box" class="std-box-content "><div id="start" class="blog-header-main"><div class="_infos"><div class="_info"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="clock" class="svg-inline--fa fa-clock fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256,8C119,8,8,119,8,256S119,504,256,504,504,393,504,256,393,8,256,8Zm92.49,313h0l-20,25a16,16,0,0,1-22.49,2.5h0l-67-49.72a40,40,0,0,1-15-31.23V112a16,16,0,0,1,16-16h32a16,16,0,0,1,16,16V256l58,42.5A16,16,0,0,1,348.49,321Z"></path></svg>2017-11-23</div><div class="_info"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="tag" class="svg-inline--fa fa-tag fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"></path></svg>GW</div></div><div class="_title --fontTitle">许愿墙 5.0 经验总结</div></div><article><div class="r-article"><div class="std-img"><img class="std-img-bg r-link" data-minimap="Rect" src="/images/HAPPY-GIRLS-DAY-2.png"/></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">女生节告一段落了，广工大许愿墙 5.0 也差不多要下线了，终于有时间来谈谈许愿墙了，这次我主要负责电台和后台开发。</div>
<h1 id="技术栈选型" class="std-title --fontTitle"><a target="_blank" href="#技术栈选型" class="markdownIt-Anchor">#</a> 技术栈选型<i data-minimap="Ignore"> ↵ </i></h1>
<ul class="std-list">
<li>Vue.js With Webpack</li>
<li>MongoDB With Mongoose</li>
<li>Redis Cache</li>
<li>Nginx Gateway</li>
<li>Qiniu Cloud Service</li>
</ul>
<h1 id="git-版本管理" class="std-title --fontTitle"><a target="_blank" href="#git-版本管理" class="markdownIt-Anchor">#</a> Git 版本管理<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">许愿墙分前端部分和后台部分两份代码，但是我没有将他们做成两个仓库，而是使用一个仓库进行管理，目录结构如下：</div>
<div class="std-code"><pre class="prismjs bash rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span>- wall2017 
<span style="user-select:none" class="line-numbers-rows">01</span>  - .git    // Git Files 
<span style="user-select:none" class="line-numbers-rows">02</span>  - client  // 前端代码 
<span style="user-select:none" class="line-numbers-rows">03</span>    - package.json 
<span style="user-select:none" class="line-numbers-rows">04</span>    - <span class="token punctuation">..</span><span class="token punctuation">..</span> 
<span style="user-select:none" class="line-numbers-rows">05</span>  - server  // 后台代码 
<span style="user-select:none" class="line-numbers-rows">06</span>    - package.json 
<span style="user-select:none" class="line-numbers-rows">07</span>    - <span class="token punctuation">..</span><span class="token punctuation">..</span>. 
<span style="user-select:none" class="line-numbers-rows">08</span>  - doc     // 接口文档 
<span style="user-select:none" class="line-numbers-rows">09</span>    - 接口文档
<span style="user-select:none" class="line-numbers-rows">10</span>    - 设计稿</pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">也就是说，一个 Git 仓库放两个 package.json</div>
<h1 id="接口文档" class="std-title --fontTitle"><a target="_blank" href="#接口文档" class="markdownIt-Anchor">#</a> 接口文档<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">前后端分离SPA，需要编写接口文档供开发查阅，因此利用 Gitbook 起了一个服务来做接口文档网站。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">具体可查看 wall2017/doc/接口文档/book.json</div>
<h1 id="微信的问题" class="std-title --fontTitle"><a target="_blank" href="#微信的问题" class="markdownIt-Anchor">#</a> 微信的问题<i data-minimap="Ignore"> ↵ </i></h1>
<blockquote lang="en" class="std-quote"><span class="std-quote-text">
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">(微信开发) 一个重要的问题就是线下和线上的不同，微信开发里面几乎很少照顾到线下（非公网IP）的集成开发，年初的时候我用 node 开发过一个简单的营销页的后台，因为项目不算复杂，两张表的数据库还有一些微信登录相关的操作，因此我所有的后台代码，都是在线上的 Linux 服务器上用 SSH + Vim 的方式书写的，还好前端代码是在本地完成，并在 localhost 上开一个端口进行开发，前端会调用远在服务器的跨域 API 执行业务代码。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">实话说，这很不好，真的很麻烦，写起来也不方便做这样那样的调试，而且 SSH 时不时会掉线，又要重新登陆。</div>
</span></blockquote>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">以上摘抄于我先前写的 <a target="_blank" href="/blogs/6d168613caad79ede8a055500be6cca4/" style="background-color:#eef3ec" class="std-link --fontSansSerif  _line" data-minimap-color="#eef3ec"><span class="std-link-icon r-link" data-src="/get-favicon/eczn.github.io?h=9605858458" style="background-image:url(&quot;/get-favicon/eczn.github.io?h=9605858458&quot;)"></span><span class="std-link-txt">《微信开发的最佳配置》</span></a>，修改了局域网的 HOSTS 和本机的反向代理解决了这个问题。</div>
<h1 id="部署的问题" class="std-title --fontTitle"><a target="_blank" href="#部署的问题" class="markdownIt-Anchor">#</a> 部署的问题<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">许愿墙前端是用 vue-cli 起的，他已经写好了编译脚本用于产生生产环境的代码：</div>
<div class="std-code"><pre class="prismjs bash rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span>$ <span class="token function">npm</span> run build</pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">npm 处理上述命令的时候会在 package.json 的 script 字段寻找 <code>build</code> 的定义，在 vue-cli 中，build其实是 /build 下的一个 js 文件，也就是说执行上述代码其实就是执行这个文件 （webpack编译）</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">编译之后可以得到 index.html 以及对应的 js 文件，下一步就是将这些文件弄到线上去，这个过程叫做部署。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">许愿墙有两个资源域名，一个是对应 api 服务器的那个服务器 gw.chenpt.cc 还有一个是指向七牛存储空间的 io.chenpt.cc , 因此部署代码的过程应该是：</div>
<ol class="std-list">
<li>将 index.html 上传到 gw.chenpt.cc 上</li>
<li>将其余的资源文件存储到七牛上 （而且还要在 index.html 的资源前加上 io.chenpt.cc 的域名，这个可以通过修改 wall2017/config/index.js 里的 build 字段进行修改）</li>
</ol>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">而这整个过程，应该是一键化部署的，也就是说我希望这样就可以一键部署：</div>
<div class="std-code"><pre class="prismjs bash rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span>$ <span class="token function">npm</span> run build 
<span style="user-select:none" class="line-numbers-rows">01</span>$ <span class="token function">npm</span> run deploy</pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">进一步考虑，需要传文件到一个普通服务器和七牛服务器，拟定了方案是：</div>
<ol class="std-list">
<li>index.html 需要传输到我的服务器上，采用 sftp 上传</li>
<li>其他文件需要传输到七牛，应该查阅七牛提供的文档进行上传</li>
</ol>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">基于以上我完成了 auto-deploy.js ，整个部署上传过程很爽，完全一键化：</div>
<div class="std-code"><pre class="prismjs bash rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span>$ <span class="token function">npm</span> run build <span class="token operator">&amp;&amp;</span> <span class="token function">npm</span> run deploy</pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">最近时间比较多，整理了 sftp 上传的代码，并完成了一个简单的工具用于上传文件夹到服务器上 (<s>欢迎 star</s>)：</div>
<blockquote lang="en" class="std-quote"><span class="std-quote-text">
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><a target="_blank" href="https://github.com/eczn/sftp-folder-upload" style="background-color:#f5eef5" class="std-link --fontSansSerif  _line" data-minimap-color="#f5eef5"><span class="std-link-icon r-link" data-src="/get-favicon/github.com?h=-1797611307" style="background-image:url(&quot;/get-favicon/github.com?h=-1797611307&quot;)"></span><span class="std-link-txt">sftp-folder-upload: upload an entire folder to your server by sftp with a simple config</span></a></div>
</span></blockquote>
<h1 id="modal-controller" class="std-title --fontTitle"><a target="_blank" href="#modal-controller" class="markdownIt-Anchor">#</a> Modal Controller<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">在 Github 上我找了很久都没有找到可以将我们自己的组件作为模态框弹出来的控制器。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">Ionic2 上有这种东西 ———— ModalController 或者 AlertContoller 这样的。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这种模态框的使用方法可以像下面这样：</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">import</span> ModalController <span class="token keyword">from</span> <span class="token string">&#x27;xxx&#x27;</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">01</span>
<span style="user-select:none" class="line-numbers-rows">02</span><span class="token keyword">let</span> hello <span class="token operator">=</span> ModalController<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">03</span>    <span class="token literal-property property">component</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">04</span>        <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div @click=&quot;$emit(&#x27;hello&#x27;, &#x27;eczn&#x27;)&quot;&gt; Hello, World &lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span style="user-select:none" class="line-numbers-rows">05</span>        <span class="token literal-property property">von</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">06</span>            <span class="token function">hello</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">07</span>                <span class="token comment">// 打印输出 &#x27;eczn&#x27; 当上面的组件被点击的时候 </span>
<span style="user-select:none" class="line-numbers-rows">08</span>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">09</span>            <span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">10</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
<span style="user-select:none" class="line-numbers-rows">11</span>        <span class="token literal-property property">vbind</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">12</span>            <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">13</span>                <span class="token comment">// 换成白色的背景颜色</span>
<span style="user-select:none" class="line-numbers-rows">14</span>                <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> <span class="token string">&#x27;#FFF&#x27;</span> 
<span style="user-select:none" class="line-numbers-rows">15</span>            <span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">16</span>        <span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">17</span>    <span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">19</span>
<span style="user-select:none" class="line-numbers-rows">20</span><span class="token comment">// 弹出 `&lt;div&gt; Hello, World &lt;/div&gt;` 出来 </span>
<span style="user-select:none" class="line-numbers-rows">21</span>hello<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">因为找不到这种可以自定义内容的控制器，所以就自己写了一个 <code>GwPopup</code> 作为许愿墙的模态框、alert、吐司的控制器。</div>
<hr class="std-hr"/>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><div class="std-img"><img class="std-img-bg r-link" data-minimap="Rect" src="/images/routing-to-back.jpg" alt="点击&#x27;返回&#x27;会关闭最顶层的Modal"/><div class="std-img-text">点击&#x27;返回&#x27;会关闭最顶层的Modal</div></div></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">此外因为设计师的需求，当点击返回键的时候应该关闭顶层的模态框，所以还需要监听 <code>vue-router</code> 提供的路由切换触发的回调函数。</div>
<hr class="std-hr"/>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">最近空闲多，就把 GwPopup 重新按照当时的思路重写了一次，并改名 vue-ppp，欢迎 Star （<s>厚颜无耻</s>）：</div>
<blockquote lang="en" class="std-quote"><span class="std-quote-text">
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><a target="_blank" href="https://github.com/eczn/vue-ppp" style="background-color:#f1e0de" class="std-link --fontSansSerif  _line" data-minimap-color="#f1e0de"><span class="std-link-icon r-link" data-src="/get-favicon/github.com?h=-2984696394" style="background-image:url(&quot;/get-favicon/github.com?h=-2984696394&quot;)"></span><span class="std-link-txt">vue-ppp: A Popup Controller Based On Vue</span></a></div>
</span></blockquote>
<h1 id="httpclientjs" class="std-title --fontTitle"><a target="_blank" href="#httpclientjs" class="markdownIt-Anchor">#</a> http.client.js<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">该文件在 axios 的基础上，添加如下功能：</div>
<ol class="std-list">
<li>打印 http 日志 logger (参数、url、返回值等等)</li>
<li>触发 <code>加载中</code> 动画</li>
<li>修改了一下 API 的表现</li>
<li>封装 jsonp （电台要用）</li>
</ol>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">然后在许愿墙环境下调用一次 Get / Post 请求可以是这样：</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">import</span> http <span class="token keyword">from</span> <span class="token string">&#x27;@/utils/http.client&#x27;</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">01</span>
<span style="user-select:none" class="line-numbers-rows">02</span>http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/test&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">03</span>    <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">&#x27;hello&#x27;</span>
<span style="user-select:none" class="line-numbers-rows">04</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">05</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">06</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">07</span>
<span style="user-select:none" class="line-numbers-rows">08</span>http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/test&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">09</span>    <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">&#x27;world&#x27;</span>
<span style="user-select:none" class="line-numbers-rows">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">11</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">12</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div>
<h1 id="musicvue-apimusic" class="std-title --fontTitle"><a target="_blank" href="#musicvue-apimusic" class="markdownIt-Anchor">#</a> Music.vue &amp; /api/music/*<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><div class="std-img"><img class="std-img-bg r-link" data-minimap="Rect" src="/images/gw-music-2.png" alt="许愿墙电台"/><div class="std-img-text">许愿墙电台</div></div></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">电台是今年许愿墙的特色，它的功能是：</div>
<ol class="std-list">
<li>用户可以点歌，所点的歌进入队列</li>
<li>一个时间、电台只能播放一首歌曲，这个歌曲是队列的队头，到歌曲结束的时候弹出这个歌曲，播放下一首</li>
<li>所有的其他用户进来的时候都会听到当前播放的歌曲</li>
<li>用户可以发送弹幕评论</li>
<li>今天所有用户所点的歌曲最多只会播放到子时 0 点，此时再点歌就会报 <code>今天点歌人数已满、明日再来</code></li>
</ol>
<h3 id="怎么搞定乐库" class="std-title --fontTitle"><a target="_blank" href="#怎么搞定乐库" class="markdownIt-Anchor">#</a> 怎么搞定乐库</h3>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">要点歌最麻烦的还是乐库了，没有乐库点个毛线歌，可是乐库这种东西谁会公开呀，经过多方寻找，终于找到了酷狗有两个接口是公众可以访问的，一个用于搜索歌曲，另外一个用于获取歌曲详细信息。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">我对它具体的实现请见 <a target="_blank" href="/blogs/1c036d874a8a331ee80bff44b515f1e1/" style="background-color:#efe1e2" class="std-link --fontSansSerif  _line" data-minimap-color="#efe1e2"><span class="std-link-icon r-link" data-src="/get-favicon/eczn.github.io?h=11009403811" style="background-image:url(&quot;/get-favicon/eczn.github.io?h=11009403811&quot;)"></span><span class="std-link-txt">《jsonp、跨域和同源策略》</span></a></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">来说说要点：</div>
<ol class="std-list">
<li>接口是跨域的，因此要使用 jsonp</li>
<li>许愿墙用的是 https, 这意味着不能加载 http 域上的 js 文件, 需要中继代理</li>
</ol>
<h3 id="怎么设计数据结构" class="std-title --fontTitle"><a target="_blank" href="#怎么设计数据结构" class="markdownIt-Anchor">#</a> 怎么设计数据结构</h3>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">使用队列，毫无疑问。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">问题在于队列元素的结构要如何设计, 经过考虑我设计成如下的样子：</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">01</span>    <span class="token comment">// 歌曲封面 （专辑封面优先于歌手封面）</span>
<span style="user-select:none" class="line-numbers-rows">02</span>    <span class="token literal-property property">cover</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">03</span>        <span class="token literal-property property">type</span><span class="token operator">:</span> String 
<span style="user-select:none" class="line-numbers-rows">04</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> 
<span style="user-select:none" class="line-numbers-rows">05</span>    <span class="token comment">// 音乐 url </span>
<span style="user-select:none" class="line-numbers-rows">06</span>    <span class="token literal-property property">mp3</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">07</span>        <span class="token literal-property property">type</span><span class="token operator">:</span> String
<span style="user-select:none" class="line-numbers-rows">08</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> 
<span style="user-select:none" class="line-numbers-rows">09</span>    <span class="token comment">// 音乐的一些 meta data （来自酷狗）</span>
<span style="user-select:none" class="line-numbers-rows">10</span>    <span class="token literal-property property">kugou</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">11</span>        <span class="token literal-property property">type</span><span class="token operator">:</span> Object
<span style="user-select:none" class="line-numbers-rows">12</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span style="user-select:none" class="line-numbers-rows">13</span>    <span class="token comment">// 什么时候开始播放 </span>
<span style="user-select:none" class="line-numbers-rows">14</span>    <span class="token literal-property property">start_at</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">15</span>        <span class="token literal-property property">type</span><span class="token operator">:</span> Number
<span style="user-select:none" class="line-numbers-rows">16</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span style="user-select:none" class="line-numbers-rows">17</span>    <span class="token comment">// 时长</span>
<span style="user-select:none" class="line-numbers-rows">18</span>    <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">19</span>        <span class="token literal-property property">type</span><span class="token operator">:</span> Number 
<span style="user-select:none" class="line-numbers-rows">20</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span style="user-select:none" class="line-numbers-rows">21</span>    <span class="token comment">// 点歌者想要说的话 </span>
<span style="user-select:none" class="line-numbers-rows">22</span>    <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">23</span>        <span class="token literal-property property">type</span><span class="token operator">:</span> String 
<span style="user-select:none" class="line-numbers-rows">24</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span style="user-select:none" class="line-numbers-rows">25</span>    <span class="token comment">// 点歌者个人信息</span>
<span style="user-select:none" class="line-numbers-rows">26</span>    <span class="token literal-property property">who</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">27</span>        <span class="token literal-property property">type</span><span class="token operator">:</span> Object
<span style="user-select:none" class="line-numbers-rows">28</span>    <span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">29</span><span class="token punctuation">}</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">其中，最为重要的是 start_at 和 duration。</div>
<blockquote lang="en" class="std-quote"><span class="std-quote-text">
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">start_at: 从今天的 0 点到现在经过的秒数<br/>
duration: 一首歌的持续时间</div>
</span></blockquote>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">为了计算从今天的 0 点到现在经过的秒数、应该引入一个函数来处理：</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">function</span> <span class="token function">todayZero</span><span class="token punctuation">(</span><span class="token parameter">ts</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">01</span>	<span class="token keyword">return</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>ts <span class="token operator">%</span> <span class="token number">86400000</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">02</span><span class="token punctuation">}</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">此外，控制歌曲的播放还得引入几个全局性的变量：</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token comment">/**
<span style="user-select:none" class="line-numbers-rows">01</span> * 计数、每点一首自加一次 
<span style="user-select:none" class="line-numbers-rows">02</span> */</span>
<span style="user-select:none" class="line-numbers-rows">03</span><span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">04</span>
<span style="user-select:none" class="line-numbers-rows">05</span><span class="token comment">/** 
<span style="user-select:none" class="line-numbers-rows">06</span> * 歌曲队列 
<span style="user-select:none" class="line-numbers-rows">07</span> */</span>
<span style="user-select:none" class="line-numbers-rows">08</span><span class="token keyword">var</span> musicQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">09</span>
<span style="user-select:none" class="line-numbers-rows">10</span><span class="token comment">/** 
<span style="user-select:none" class="line-numbers-rows">11</span> * 零时刻 
<span style="user-select:none" class="line-numbers-rows">12</span> * 当新的一首歌入队的时候执行： 
<span style="user-select:none" class="line-numbers-rows">13</span> * zero = zero + duration; 
<span style="user-select:none" class="line-numbers-rows">14</span> * 
<span style="user-select:none" class="line-numbers-rows">15</span> * 利用这个来计算 start_at
<span style="user-select:none" class="line-numbers-rows">16</span> */</span>
<span style="user-select:none" class="line-numbers-rows">17</span><span class="token keyword">var</span> zero <span class="token operator">=</span> <span class="token function">todayZero</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">18</span>
<span style="user-select:none" class="line-numbers-rows">19</span><span class="token comment">/**
<span style="user-select:none" class="line-numbers-rows">20</span> * 今天所点的全部歌加起来的最大时长 
<span style="user-select:none" class="line-numbers-rows">21</span> */</span>
<span style="user-select:none" class="line-numbers-rows">22</span><span class="token keyword">var</span> <span class="token constant">MAX_TIME</span> <span class="token operator">=</span> <span class="token number">86400</span><span class="token punctuation">;</span></pre></div>
<h3 id="怎么记录-判断歌曲正在播放-超时-切换歌曲" class="std-title --fontTitle"><a target="_blank" href="#怎么记录-判断歌曲正在播放-超时-切换歌曲" class="markdownIt-Anchor">#</a> 怎么记录、判断歌曲正在播放、超时、切换歌曲</h3>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">切换歌曲其实就是当一首歌播放完的时候，切换到下一首的过程。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">实现这个过程是不可能写一个 setInterval 去轮询的，这很耗性能而且不实时，显得很蠢。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">我的做法是，在用户尝试获取当前播放的音乐的时候：</div>
<ol class="std-list">
<li>检查当前有没有歌曲正在播放，如果没有则返回 null 否则继续下一步</li>
<li>检查这个歌曲有没有播放完毕，如果播完了，则出队一首新歌作为当前播放的歌曲，如果没有则还是返回这个么有播放完毕的歌曲</li>
<li>特别的、如果当前的歌曲播放完毕了，而队列里没有下一首歌曲的时候，此时返回 null</li>
</ol>
<hr class="std-hr"/>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">再来谈谈怎么判断一首歌是否已经播完了：</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">在一天内，歌曲的播放从今日的 0 秒开始，到今日的 86399 秒，一共 86400 秒 （由 MAX_TIME 决定）</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">所有的歌曲播放都会落在 [0, 86400) 这个区间内，比如如果我在今天的 0 秒处点了第一首歌曲，该歌曲时长是 300 秒，那么这个歌曲的播放区间应该是： [0, 300)</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">若在一小时之后有个用户来请求获取当前播放的歌曲的时候，这时候就可以知道这个歌曲已经播完了，应该执行切歌。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">而且，只要遵循了上面这个设计思路，“你是今天第 N 位点歌的人，你的歌曲将会在几点几分播放” 也很容易做了：</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">N 由计数器变量 count 控制<br/>
几点几分其实就是距离今天 0 点多少秒，这由歌曲 start_at 决定</div>
<h3 id="怎么做一个播放器" class="std-title --fontTitle"><a target="_blank" href="#怎么做一个播放器" class="markdownIt-Anchor">#</a> 怎么做一个播放器</h3>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">播放器做了很多了，可以看看这篇：</div>
<blockquote lang="en" class="std-quote"><span class="std-quote-text">
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><a target="_blank" href="/blogs/9a985c5c3746b2145458fd5ce30fb9a6/" style="background-color:#f3ddec" class="std-link --fontSansSerif  _line" data-minimap-color="#f3ddec"><span class="std-link-icon r-link" data-src="/get-favicon/eczn.github.io?h=14421069256" style="background-image:url(&quot;/get-favicon/eczn.github.io?h=14421069256&quot;)"></span><span class="std-link-txt">eczn’s blog: 关于音乐播放器的前后端实现的思考</span></a></div>
</span></blockquote>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">因为这次是微信网页上的播放器，稍微有些不一样，在 iOS 上的歌曲绝不会执行一下 music.play 就自动播放，必须借助事件才能播放 （在点击事件的回调里面执行 play）</div>
<h3 id="怎么做弹幕系统" class="std-title --fontTitle"><a target="_blank" href="#怎么做弹幕系统" class="markdownIt-Anchor">#</a> 怎么做弹幕系统</h3>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这部分需要做 Websocket，这里我用的是 socket.io 去实现的。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><div class="std-img"><img class="std-img-bg r-link" data-minimap="Rect" src="/images/gw-send-danmaku.jpg" alt="发送、接收弹幕"/><div class="std-img-text">发送、接收弹幕</div></div></div>
<h1 id="nginx-mongoose-redis" class="std-title --fontTitle"><a target="_blank" href="#nginx-mongoose-redis" class="markdownIt-Anchor">#</a> Nginx &amp; Mongoose &amp; Redis<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">许愿墙挂在 https 上，还有七牛的存储也是 https 的，因此需要两个证书，具体的申请都是走腾讯云的免费 SSL 证书流程拿到的，很容易申请到。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">此外 nginx 还要负责 index.html 的存储，以及后台接口的反向代理。</div>
<hr class="std-hr"/>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">数据库用的是 Mongo，具体的使用是通过 Mongoose 进行的，不过 Mongoose 自带的 Promise 并不是原生的 Promise，而是 mpromise，它并不是 Promise A+ 规范的，行为上跟标准有差异（查了资料看到说是为了性能），因此吃了点屎。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">如果要使用原生的 Promise 作为 Mongoose 的 Promise 只需要执行如下代码即可：</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">let</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;mongoose&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">01</span>mongoose<span class="token punctuation">.</span>Promise <span class="token operator">=</span> Promise</pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">还有就是学了挺多一些查询技巧、模糊查找这些、有机会开一篇来谈。</div>
<hr class="std-hr"/>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">对 Mongoose 的利用可以看我的这篇博客：</div>
<blockquote lang="en" class="std-quote"><span class="std-quote-text">
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><a target="_blank" href="/blogs/d93263b0ddb121ff4b449cc06f202a58/" style="background-color:#e9f4e9" class="std-link --fontSansSerif  _line" data-minimap-color="#e9f4e9"><span class="std-link-icon r-link" data-src="/get-favicon/eczn.github.io?h=1802554736" style="background-image:url(&quot;/get-favicon/eczn.github.io?h=1802554736&quot;)"></span><span class="std-link-txt">eczn’s blog: 使用 Mongoose 的各种好处</span></a></div>
</span></blockquote>
<hr class="std-hr"/>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">缓存的话使用的是 redis，用来做… 做各种缓存…</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">比如首页分页，用户个人信息，cookie密文/明文组成的键值对，微信的AccessToken等等</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">主要是利用 JSON.stringify 存入缓存里面，需要用的时候还需要 JSON.parse 一次才可以使用。</div>
<h1 id="webscoket" class="std-title --fontTitle"><a target="_blank" href="#webscoket" class="markdownIt-Anchor">#</a> Webscoket<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">许愿墙的 Websocket 在页面加载的时候会尝试登录，登录成功之后会返回三条重要数据：</div>
<ol class="std-list">
<li>用户个人资料</li>
<li>许愿墙客服小哥的资料</li>
<li>未读消息</li>
</ol>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">前端代码接下来会处理这些，数据最终流到 localStorage 里并影响对应的页面。</div>
<h1 id="战报" class="std-title --fontTitle"><a target="_blank" href="#战报" class="markdownIt-Anchor">#</a> 战报<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">许愿墙，七天内：</div>
<ul class="std-list">
<li>5000+ 用户</li>
<li>1500+ 条愿望</li>
<li>100 G 流量</li>
</ul>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">最后我确信了一点，腾讯云1兆的服务器完全能撑得起整个应用，而且还非常有余力。</div>
<h1 id="tldr" class="std-title --fontTitle"><a target="_blank" href="#tldr" class="markdownIt-Anchor">#</a> TL;DR<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">啦啦啦，做完这个挺开心的，算是阶段性胜利啦 ~</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">好了，回宿舍。</div>
</div></article></div></div><div class="smcphr rally-page-smcphr"></div><div class="std-box rally-giscus-wrapper default-max-width"><div class="std-box-content "></div></div></div>
<script>window.__INITIAL_STATE__ = {"CategoryApiState":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"BlogApiState":{"loaded":true,"loading":false,"error":null,"dataMap":{"5b316e61572472c3ec70b40f2141e488":{"type":"markdown","meta":{"title":"许愿墙 5.0 经验总结","intro":"许愿墙 V5.0@2017 项目总结","date":"Thu Nov 23 2017 13:10:40 GMT+0800 (中国标准时间)","category":"code","tags":["GW"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"5b316e61572472c3ec70b40f2141e488","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-11-23T05:10:40.000Z","isDraft":false,"fileDeps":["/images/HAPPY-GIRLS-DAY-2.png","/images/routing-to-back.jpg","/images/gw-music-2.png","/images/gw-send-danmaku.jpg"],"wordCount":7159},"nodes":[{"type":"tag","children":[],"name":"img","attribs":{"src":"/images/HAPPY-GIRLS-DAY-2.png"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"女生节告一段落了，广工大许愿墙 5.0 也差不多要下线了，终于有时间来谈谈许愿墙了，这次我主要负责电台和后台开发。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#技术栈选型","className":"markdownIt-Anchor"}},{"type":"text","data":" 技术栈选型"}],"name":"h1","attribs":{"id":"技术栈选型"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"Vue.js With Webpack"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"MongoDB With Mongoose"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"Redis Cache"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"Nginx Gateway"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"Qiniu Cloud Service"}],"name":"li","attribs":{}},{"type":"text","data":"\n"}],"name":"ul","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#git-版本管理","className":"markdownIt-Anchor"}},{"type":"text","data":" Git 版本管理"}],"name":"h1","attribs":{"id":"git-版本管理"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"许愿墙分前端部分和后台部分两份代码，但是我没有将他们做成两个仓库，而是使用一个仓库进行管理，目录结构如下："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"- wall2017 \n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"  - .git    // Git Files \n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"  - client  // 前端代码 \n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    - package.json \n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    - "},{"type":"tag","children":[{"type":"text","data":".."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":".."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"  - server  // 后台代码 \n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    - package.json \n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    - "},{"type":"tag","children":[{"type":"text","data":".."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":".."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":". \n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"  - doc     // 接口文档 \n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    - 接口文档\n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    - 设计稿"}],"name":"pre","attribs":{"className":"prismjs bash rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"也就是说，一个 Git 仓库放两个 package.json"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#接口文档","className":"markdownIt-Anchor"}},{"type":"text","data":" 接口文档"}],"name":"h1","attribs":{"id":"接口文档"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"前后端分离SPA，需要编写接口文档供开发查阅，因此利用 Gitbook 起了一个服务来做接口文档网站。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"具体可查看 wall2017/doc/接口文档/book.json"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#微信的问题","className":"markdownIt-Anchor"}},{"type":"text","data":" 微信的问题"}],"name":"h1","attribs":{"id":"微信的问题"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"(微信开发) 一个重要的问题就是线下和线上的不同，微信开发里面几乎很少照顾到线下（非公网IP）的集成开发，年初的时候我用 node 开发过一个简单的营销页的后台，因为项目不算复杂，两张表的数据库还有一些微信登录相关的操作，因此我所有的后台代码，都是在线上的 Linux 服务器上用 SSH + Vim 的方式书写的，还好前端代码是在本地完成，并在 localhost 上开一个端口进行开发，前端会调用远在服务器的跨域 API 执行业务代码。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"实话说，这很不好，真的很麻烦，写起来也不方便做这样那样的调试，而且 SSH 时不时会掉线，又要重新登陆。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"}],"name":"blockquote","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"以上摘抄于我先前写的 "},{"type":"tag","children":[{"type":"text","data":"《微信开发的最佳配置》"}],"name":"a","attribs":{"href":"/blogs/6d168613caad79ede8a055500be6cca4/"}},{"type":"text","data":"，修改了局域网的 HOSTS 和本机的反向代理解决了这个问题。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#部署的问题","className":"markdownIt-Anchor"}},{"type":"text","data":" 部署的问题"}],"name":"h1","attribs":{"id":"部署的问题"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"许愿墙前端是用 vue-cli 起的，他已经写好了编译脚本用于产生生产环境的代码："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"$ "},{"type":"tag","children":[{"type":"text","data":"npm"}],"name":"span","attribs":{"className":"token function"}},{"type":"text","data":" run build"}],"name":"pre","attribs":{"className":"prismjs bash rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"npm 处理上述命令的时候会在 package.json 的 script 字段寻找 "},{"type":"tag","children":[{"type":"text","data":"build"}],"name":"code","attribs":{}},{"type":"text","data":" 的定义，在 vue-cli 中，build其实是 /build 下的一个 js 文件，也就是说执行上述代码其实就是执行这个文件 （webpack编译）"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"编译之后可以得到 index.html 以及对应的 js 文件，下一步就是将这些文件弄到线上去，这个过程叫做部署。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"许愿墙有两个资源域名，一个是对应 api 服务器的那个服务器 gw.chenpt.cc 还有一个是指向七牛存储空间的 io.chenpt.cc , 因此部署代码的过程应该是："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"将 index.html 上传到 gw.chenpt.cc 上"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"将其余的资源文件存储到七牛上 （而且还要在 index.html 的资源前加上 io.chenpt.cc 的域名，这个可以通过修改 wall2017/config/index.js 里的 build 字段进行修改）"}],"name":"li","attribs":{}},{"type":"text","data":"\n"}],"name":"ol","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"而这整个过程，应该是一键化部署的，也就是说我希望这样就可以一键部署："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"$ "},{"type":"tag","children":[{"type":"text","data":"npm"}],"name":"span","attribs":{"className":"token function"}},{"type":"text","data":" run build \n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"$ "},{"type":"tag","children":[{"type":"text","data":"npm"}],"name":"span","attribs":{"className":"token function"}},{"type":"text","data":" run deploy"}],"name":"pre","attribs":{"className":"prismjs bash rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"进一步考虑，需要传文件到一个普通服务器和七牛服务器，拟定了方案是："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"index.html 需要传输到我的服务器上，采用 sftp 上传"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"其他文件需要传输到七牛，应该查阅七牛提供的文档进行上传"}],"name":"li","attribs":{}},{"type":"text","data":"\n"}],"name":"ol","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"基于以上我完成了 auto-deploy.js ，整个部署上传过程很爽，完全一键化："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"$ "},{"type":"tag","children":[{"type":"text","data":"npm"}],"name":"span","attribs":{"className":"token function"}},{"type":"text","data":" run build "},{"type":"tag","children":[{"type":"text","data":"&amp;&amp;"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"npm"}],"name":"span","attribs":{"className":"token function"}},{"type":"text","data":" run deploy"}],"name":"pre","attribs":{"className":"prismjs bash rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"最近时间比较多，整理了 sftp 上传的代码，并完成了一个简单的工具用于上传文件夹到服务器上 ("},{"type":"tag","children":[{"type":"text","data":"欢迎 star"}],"name":"s","attribs":{}},{"type":"text","data":")："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"sftp-folder-upload: upload an entire folder to your server by sftp with a simple config"}],"name":"a","attribs":{"href":"https://github.com/eczn/sftp-folder-upload"}}],"name":"p","attribs":{}},{"type":"text","data":"\n"}],"name":"blockquote","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#modal-controller","className":"markdownIt-Anchor"}},{"type":"text","data":" Modal Controller"}],"name":"h1","attribs":{"id":"modal-controller"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"在 Github 上我找了很久都没有找到可以将我们自己的组件作为模态框弹出来的控制器。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"Ionic2 上有这种东西 ———— ModalController 或者 AlertContoller 这样的。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"这种模态框的使用方法可以像下面这样："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"import"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" ModalController "},{"type":"tag","children":[{"type":"text","data":"from"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'xxx'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" hello "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" ModalController"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"create"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"component"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"template"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"`"}],"name":"span","attribs":{"className":"token template-punctuation string"}},{"type":"tag","children":[{"type":"text","data":"&lt;div @click=\"$emit('hello', 'eczn')\"> Hello, World &lt;/div>"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":"`"}],"name":"span","attribs":{"className":"token template-punctuation string"}}],"name":"span","attribs":{"className":"token template-string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"von"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"hello"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"msg"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                "},{"type":"tag","children":[{"type":"text","data":"// 打印输出 'eczn' 当上面的组件被点击的时候 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"msg"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"vbind"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"style"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                "},{"type":"tag","children":[{"type":"text","data":"// 换成白色的背景颜色"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"14"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                "},{"type":"tag","children":[{"type":"text","data":"backgroundColor"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'#FFF'"}],"name":"span","attribs":{"className":"token string"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"15"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"16"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"17"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"18"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"19"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"20"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 弹出 `&lt;div> Hello, World &lt;/div>` 出来 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"21"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"hello"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"launch"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"因为找不到这种可以自定义内容的控制器，所以就自己写了一个 "},{"type":"tag","children":[{"type":"text","data":"GwPopup"}],"name":"code","attribs":{}},{"type":"text","data":" 作为许愿墙的模态框、alert、吐司的控制器。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[],"name":"hr","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[],"name":"img","attribs":{"src":"/images/routing-to-back.jpg","alt":"点击'返回'会关闭最顶层的Modal"}}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"此外因为设计师的需求，当点击返回键的时候应该关闭顶层的模态框，所以还需要监听 "},{"type":"tag","children":[{"type":"text","data":"vue-router"}],"name":"code","attribs":{}},{"type":"text","data":" 提供的路由切换触发的回调函数。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[],"name":"hr","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"最近空闲多，就把 GwPopup 重新按照当时的思路重写了一次，并改名 vue-ppp，欢迎 Star （"},{"type":"tag","children":[{"type":"text","data":"厚颜无耻"}],"name":"s","attribs":{}},{"type":"text","data":"）："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"vue-ppp: A Popup Controller Based On Vue"}],"name":"a","attribs":{"href":"https://github.com/eczn/vue-ppp"}}],"name":"p","attribs":{}},{"type":"text","data":"\n"}],"name":"blockquote","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#httpclientjs","className":"markdownIt-Anchor"}},{"type":"text","data":" http.client.js"}],"name":"h1","attribs":{"id":"httpclientjs"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"该文件在 axios 的基础上，添加如下功能："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"打印 http 日志 logger (参数、url、返回值等等)"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"触发 "},{"type":"tag","children":[{"type":"text","data":"加载中"}],"name":"code","attribs":{}},{"type":"text","data":" 动画"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"修改了一下 API 的表现"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"封装 jsonp （电台要用）"}],"name":"li","attribs":{}},{"type":"text","data":"\n"}],"name":"ol","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"然后在许愿墙环境下调用一次 Get / Post 请求可以是这样："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"import"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" http "},{"type":"tag","children":[{"type":"text","data":"from"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'@/utils/http.client'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"http"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"get"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'/api/test'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"msg"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'hello'"}],"name":"span","attribs":{"className":"token string"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"then"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"res"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"res"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"http"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"post"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'/api/test'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"msg"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'world'"}],"name":"span","attribs":{"className":"token string"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"then"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"res"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"res"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#musicvue-apimusic","className":"markdownIt-Anchor"}},{"type":"text","data":" Music.vue &amp; /api/music/*"}],"name":"h1","attribs":{"id":"musicvue-apimusic"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[],"name":"img","attribs":{"src":"/images/gw-music-2.png","alt":"许愿墙电台"}}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"电台是今年许愿墙的特色，它的功能是："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"用户可以点歌，所点的歌进入队列"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"一个时间、电台只能播放一首歌曲，这个歌曲是队列的队头，到歌曲结束的时候弹出这个歌曲，播放下一首"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"所有的其他用户进来的时候都会听到当前播放的歌曲"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"用户可以发送弹幕评论"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"今天所有用户所点的歌曲最多只会播放到子时 0 点，此时再点歌就会报 "},{"type":"tag","children":[{"type":"text","data":"今天点歌人数已满、明日再来"}],"name":"code","attribs":{}}],"name":"li","attribs":{}},{"type":"text","data":"\n"}],"name":"ol","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#怎么搞定乐库","className":"markdownIt-Anchor"}},{"type":"text","data":" 怎么搞定乐库"}],"name":"h3","attribs":{"id":"怎么搞定乐库"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"要点歌最麻烦的还是乐库了，没有乐库点个毛线歌，可是乐库这种东西谁会公开呀，经过多方寻找，终于找到了酷狗有两个接口是公众可以访问的，一个用于搜索歌曲，另外一个用于获取歌曲详细信息。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"我对它具体的实现请见 "},{"type":"tag","children":[{"type":"text","data":"《jsonp、跨域和同源策略》"}],"name":"a","attribs":{"href":"/blogs/1c036d874a8a331ee80bff44b515f1e1/"}}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"来说说要点："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"接口是跨域的，因此要使用 jsonp"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"许愿墙用的是 https, 这意味着不能加载 http 域上的 js 文件, 需要中继代理"}],"name":"li","attribs":{}},{"type":"text","data":"\n"}],"name":"ol","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#怎么设计数据结构","className":"markdownIt-Anchor"}},{"type":"text","data":" 怎么设计数据结构"}],"name":"h3","attribs":{"id":"怎么设计数据结构"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"使用队列，毫无疑问。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"问题在于队列元素的结构要如何设计, 经过考虑我设计成如下的样子："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 歌曲封面 （专辑封面优先于歌手封面）"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"cover"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"type"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" String \n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 音乐 url "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"mp3"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"type"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" String\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 音乐的一些 meta data （来自酷狗）"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"kugou"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"type"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" Object\n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 什么时候开始播放 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"14"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"start_at"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"15"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"type"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" Number\n"},{"type":"tag","children":[{"type":"text","data":"16"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"17"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 时长"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"18"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"duration"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"19"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"type"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" Number \n"},{"type":"tag","children":[{"type":"text","data":"20"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"21"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 点歌者想要说的话 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"22"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"content"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"23"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"type"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" String \n"},{"type":"tag","children":[{"type":"text","data":"24"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"25"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 点歌者个人信息"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"26"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"who"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"27"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"type"}],"name":"span","attribs":{"className":"token literal-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" Object\n"},{"type":"tag","children":[{"type":"text","data":"28"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"29"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"其中，最为重要的是 start_at 和 duration。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"start_at: 从今天的 0 点到现在经过的秒数"},{"type":"tag","children":[],"name":"br","attribs":{}},{"type":"text","data":"\nduration: 一首歌的持续时间"}],"name":"p","attribs":{}},{"type":"text","data":"\n"}],"name":"blockquote","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"为了计算从今天的 0 点到现在经过的秒数、应该引入一个函数来处理："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"function"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"todayZero"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"ts"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\t"},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"parseInt"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"ts "},{"type":"tag","children":[{"type":"text","data":"%"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"86400000"}],"name":"span","attribs":{"className":"token number"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"/"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"1000"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"此外，控制歌曲的播放还得引入几个全局性的变量："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"/**\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" * 计数、每点一首自加一次 \n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" */"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"var"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" count "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"0"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"/** \n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" * 歌曲队列 \n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" */"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"var"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" musicQueue "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"/** \n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" * 零时刻 \n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" * 当新的一首歌入队的时候执行： \n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" * zero = zero + duration; \n"},{"type":"tag","children":[{"type":"text","data":"14"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" * \n"},{"type":"tag","children":[{"type":"text","data":"15"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" * 利用这个来计算 start_at\n"},{"type":"tag","children":[{"type":"text","data":"16"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" */"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"17"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"var"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" zero "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"todayZero"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"Date"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"now"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"18"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"19"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"/**\n"},{"type":"tag","children":[{"type":"text","data":"20"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" * 今天所点的全部歌加起来的最大时长 \n"},{"type":"tag","children":[{"type":"text","data":"21"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" */"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"22"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"var"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"MAX_TIME"}],"name":"span","attribs":{"className":"token constant"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"86400"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#怎么记录-判断歌曲正在播放-超时-切换歌曲","className":"markdownIt-Anchor"}},{"type":"text","data":" 怎么记录、判断歌曲正在播放、超时、切换歌曲"}],"name":"h3","attribs":{"id":"怎么记录-判断歌曲正在播放-超时-切换歌曲"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"切换歌曲其实就是当一首歌播放完的时候，切换到下一首的过程。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"实现这个过程是不可能写一个 setInterval 去轮询的，这很耗性能而且不实时，显得很蠢。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"我的做法是，在用户尝试获取当前播放的音乐的时候："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"检查当前有没有歌曲正在播放，如果没有则返回 null 否则继续下一步"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"检查这个歌曲有没有播放完毕，如果播完了，则出队一首新歌作为当前播放的歌曲，如果没有则还是返回这个么有播放完毕的歌曲"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"特别的、如果当前的歌曲播放完毕了，而队列里没有下一首歌曲的时候，此时返回 null"}],"name":"li","attribs":{}},{"type":"text","data":"\n"}],"name":"ol","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[],"name":"hr","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"再来谈谈怎么判断一首歌是否已经播完了："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"在一天内，歌曲的播放从今日的 0 秒开始，到今日的 86399 秒，一共 86400 秒 （由 MAX_TIME 决定）"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"所有的歌曲播放都会落在 [0, 86400) 这个区间内，比如如果我在今天的 0 秒处点了第一首歌曲，该歌曲时长是 300 秒，那么这个歌曲的播放区间应该是： [0, 300)"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"若在一小时之后有个用户来请求获取当前播放的歌曲的时候，这时候就可以知道这个歌曲已经播完了，应该执行切歌。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"而且，只要遵循了上面这个设计思路，“你是今天第 N 位点歌的人，你的歌曲将会在几点几分播放” 也很容易做了："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"N 由计数器变量 count 控制"},{"type":"tag","children":[],"name":"br","attribs":{}},{"type":"text","data":"\n几点几分其实就是距离今天 0 点多少秒，这由歌曲 start_at 决定"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#怎么做一个播放器","className":"markdownIt-Anchor"}},{"type":"text","data":" 怎么做一个播放器"}],"name":"h3","attribs":{"id":"怎么做一个播放器"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"播放器做了很多了，可以看看这篇："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"eczn’s blog: 关于音乐播放器的前后端实现的思考"}],"name":"a","attribs":{"href":"/blogs/9a985c5c3746b2145458fd5ce30fb9a6/"}}],"name":"p","attribs":{}},{"type":"text","data":"\n"}],"name":"blockquote","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"因为这次是微信网页上的播放器，稍微有些不一样，在 iOS 上的歌曲绝不会执行一下 music.play 就自动播放，必须借助事件才能播放 （在点击事件的回调里面执行 play）"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#怎么做弹幕系统","className":"markdownIt-Anchor"}},{"type":"text","data":" 怎么做弹幕系统"}],"name":"h3","attribs":{"id":"怎么做弹幕系统"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"这部分需要做 Websocket，这里我用的是 socket.io 去实现的。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[],"name":"img","attribs":{"src":"/images/gw-send-danmaku.jpg","alt":"发送、接收弹幕"}}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#nginx-mongoose-redis","className":"markdownIt-Anchor"}},{"type":"text","data":" Nginx &amp; Mongoose &amp; Redis"}],"name":"h1","attribs":{"id":"nginx-mongoose-redis"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"许愿墙挂在 https 上，还有七牛的存储也是 https 的，因此需要两个证书，具体的申请都是走腾讯云的免费 SSL 证书流程拿到的，很容易申请到。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"此外 nginx 还要负责 index.html 的存储，以及后台接口的反向代理。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[],"name":"hr","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"数据库用的是 Mongo，具体的使用是通过 Mongoose 进行的，不过 Mongoose 自带的 Promise 并不是原生的 Promise，而是 mpromise，它并不是 Promise A+ 规范的，行为上跟标准有差异（查了资料看到说是为了性能），因此吃了点屎。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"如果要使用原生的 Promise 作为 Mongoose 的 Promise 只需要执行如下代码即可："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" mongoose "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"require"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'mongoose'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"mongoose"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"Promise "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" Promise"}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"还有就是学了挺多一些查询技巧、模糊查找这些、有机会开一篇来谈。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[],"name":"hr","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"对 Mongoose 的利用可以看我的这篇博客："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"eczn’s blog: 使用 Mongoose 的各种好处"}],"name":"a","attribs":{"href":"/blogs/d93263b0ddb121ff4b449cc06f202a58/"}}],"name":"p","attribs":{}},{"type":"text","data":"\n"}],"name":"blockquote","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[],"name":"hr","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"缓存的话使用的是 redis，用来做… 做各种缓存…"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"比如首页分页，用户个人信息，cookie密文/明文组成的键值对，微信的AccessToken等等"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"主要是利用 JSON.stringify 存入缓存里面，需要用的时候还需要 JSON.parse 一次才可以使用。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#webscoket","className":"markdownIt-Anchor"}},{"type":"text","data":" Webscoket"}],"name":"h1","attribs":{"id":"webscoket"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"许愿墙的 Websocket 在页面加载的时候会尝试登录，登录成功之后会返回三条重要数据："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"用户个人资料"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"许愿墙客服小哥的资料"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"未读消息"}],"name":"li","attribs":{}},{"type":"text","data":"\n"}],"name":"ol","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"前端代码接下来会处理这些，数据最终流到 localStorage 里并影响对应的页面。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#战报","className":"markdownIt-Anchor"}},{"type":"text","data":" 战报"}],"name":"h1","attribs":{"id":"战报"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"许愿墙，七天内："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"5000+ 用户"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"1500+ 条愿望"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"100 G 流量"}],"name":"li","attribs":{}},{"type":"text","data":"\n"}],"name":"ul","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"最后我确信了一点，腾讯云1兆的服务器完全能撑得起整个应用，而且还非常有余力。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#tldr","className":"markdownIt-Anchor"}},{"type":"text","data":" TL;DR"}],"name":"h1","attribs":{"id":"tldr"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"啦啦啦，做完这个挺开心的，算是阶段性胜利啦 ~"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"好了，回宿舍。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"}],"rawContent":""}}},"HomeApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"TimeLineApiState":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"SettingApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"LaunchpadApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}}}</script>
<!--SCRIPT-->
</body>
</html>
