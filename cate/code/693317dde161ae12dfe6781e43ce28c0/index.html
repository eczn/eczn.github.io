<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<title>code | [Callback, Promise, Async] | Eczn's Home</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,minimal-ui">
<meta name="format-detection" content="telephone=no">

<style id="CSS_VARS"></style>
<script>
(function() {
console.log('INIT CSS VAR');
function loadCSSVars() {
    const j = localStorage.getItem("CSS_VARS_2" /* STORAGE_KEY.CSS_VARS */);
    const initialVars = initialCSSVars();
    if (!j)
        return initialVars;
    try {
        const result = {
            ...initialVars,
            ...JSON.parse(j)
        };
        console.log('loadCSSVars from storage', result);
        return result;
    }
    catch (error) {
        console.error('load css vars with error', error);
        return initialVars;
    }
}
function renderCSSVars(vars, style) {
    const allDefine = Object.keys(vars).map(k => {
        const v = vars[k];
        const cssValue = typeof v === 'number' ? `${v}px` : v;
        return `--${k}:${cssValue};`;
    }).join('\n');
    if (style) {
        style.innerHTML = `:root { ${allDefine} }`;
    }
    else {
        console.error(`style#CSS_VARS NotFound !`);
    }
}
function initialCSSVars() {
    let rem = 16;
    // 移动端
    if (typeof window !== 'undefined' && window.innerWidth <= 500) {
        rem = Number(((window.innerWidth - 20) / 42).toFixed(1));
        console.log('mobile calculated rem =>', rem);
    }
    return {
        rem,
        enableSmallerFont: false,
        displayToc: 'block',
        fontSmcp: 'source serif pro, serif',
        fontCode: 'consolas, Menlo, monospace',
        fontTitle: 'Noto Serif SC, serif',
        fontArticle: 'source serif pro, LXGW WenKai',
        fontSansSerif: 'sans-serif',
    };
}
window.__initialCSSVars = loadCSSVars();
renderCSSVars(__initialCSSVars, document.querySelector('#CSS_VARS'));
})();
</script>

<link rel="icon" href="/favicon.png"><script defer="defer" src="/js/index.270aa71f.js"></script><script defer="defer" src="/js/chunk-lib.715ec57d.js"></script><link href="/css/index.e97fb24d92d908fa6714.css" rel="stylesheet"><link href="/css/chunk-lib.52ef56d7b74c3b48efdf.css" rel="stylesheet"></head>
<body x-apple-data-detectors="none">
<noscript>当前浏览器不支持 JavaScript, 建议使用支持 JavaScript 的浏览器来访问此网站 !</noscript>
<div id="rally-bg" style="opacity:0"></div>
<div id="app"><div class="ball-canvas-container"></div><nav class="nav-main --fontSmcp"><div class="_title default-max-width">Eczn&#x27;s Home</div><div class="smcphr"></div><div class="_links default-max-width"><a class="r-link _link clickable r-link" href="/">Home</a><a class="r-link _link clickable r-link" href="/tl/0/">Timeline</a><a class="r-link _link clickable r-link" href="/cate/all/">Category</a><a class="r-link _link clickable r-link" href="/setting/">Setting</a><a class="r-link _link clickable r-link" href="/launchpad/">Launchpad</a></div></nav><div class="std-box category-main category-detail default-max-width"><div class="std-box-content "><div class="_cate-header"><div class="_blog-links"><a class="r-link _blog-link --fontTitle" href="/cate/code/7160d323740df57ea08a87fb966acf0c/"><span class="_nth">#<!-- -->0</span>JavaScript Array</a><a class="r-link _blog-link --fontTitle" href="/cate/code/06bfca16df0a3946476c33daaa2b2ee6/"><span class="_nth">#<!-- -->1</span>JavaScript 有限状态机</a><a class="r-link _blog-link --fontTitle" href="/cate/code/76bfd9d6896b7c19b4c67ee0599a5c37/"><span class="_nth">#<!-- -->2</span>语义化和文章排版</a><a class="r-link _blog-link --fontTitle" href="/cate/code/b94c4706883c37293b9c0382caf015e0/"><span class="_nth">#<!-- -->3</span>This, Closure</a><a class="r-link _blog-link --fontTitle" href="/cate/code/64c861a95b26916c0648b25bd76adaae/"><span class="_nth">#<!-- -->4</span>gulp 基本使用</a><a class="r-link _blog-link --fontTitle" href="/cate/code/cbcd6b8e32ddce02368312696ac445a6/"><span class="_nth">#<!-- -->5</span>一道闭包相关的面试题</a><a class="r-link _blog-link --fontTitle" href="/cate/code/18f3d295ffec2edfee91fa5e4bfe8549/"><span class="_nth">#<!-- -->6</span>window.localStorage</a><a class="r-link _blog-link --fontTitle" href="/cate/code/955729c424219487dd259575d1b07a64/"><span class="_nth">#<!-- -->7</span>3px</a><a class="r-link _blog-link --fontTitle" href="/cate/code/d1010fb555e008d2cd13ebe0bb8ea37f/"><span class="_nth">#<!-- -->8</span>This, Function</a><a class="r-link _blog-link --fontTitle" href="/cate/code/e23ec6747bee37bbea564269ac595dd8/"><span class="_nth">#<!-- -->9</span>制作图片轮播组件</a><a class="r-link _blog-link --fontTitle" href="/cate/code/650ea3740c12a08e6ea2db84591c0145/"><span class="_nth">#<!-- -->10</span>活用函数作为一等公民的权利</a><a class="r-link _blog-link --fontTitle" href="/cate/code/818f9f8550a39e7d6be6c38e685f5f32/"><span class="_nth">#<!-- -->11</span>给自己写一篇有趣的简历</a><a class="r-link _blog-link --fontTitle" href="/cate/code/0eaa1cf1a29fb69449702bb628803bfd/"><span class="_nth">#<!-- -->12</span>一个递归问题</a><a class="r-link _blog-link --fontTitle" href="/cate/code/b408fd7d085f1f3123fa040add221d91/"><span class="_nth">#<!-- -->13</span>异步发射器</a><a class="r-link _blog-link --fontTitle" href="/cate/code/a576940553a72bc504e38a1e9e4659c1/"><span class="_nth">#<!-- -->14</span>配置式表单验证 (1)</a><a class="r-link _blog-link --fontTitle" href="/cate/code/c7631f87030581275f1224928f29a1f0/"><span class="_nth">#<!-- -->15</span>配置式表单验证 (2)</a><a class="r-link _blog-link --fontTitle" href="/cate/code/d5787c6cd30674c4a3db11fbe59bde7c/"><span class="_nth">#<!-- -->16</span>递归穷举所有子字符串</a><a class="r-link _blog-link --fontTitle" href="/cate/code/ea28731fd9bf34a08d559079cfa4c49d/"><span class="_nth">#<!-- -->17</span>递归 DOM树 得到深度</a><a class="r-link _blog-link --fontTitle" href="/cate/code/0adcb81b319b3eafbe493cc974f64f17/"><span class="_nth">#<!-- -->18</span>Array.prototype.sort</a><a class="r-link _blog-link --fontTitle" href="/cate/code/6e42a7ef1329462a0cb4b42a35575f7c/"><span class="_nth">#<!-- -->19</span>活用原生方法解决数组问题</a><a class="r-link _blog-link --fontTitle" href="/cate/code/700f4764003c1c142779e083df2fecef/"><span class="_nth">#<!-- -->20</span>两类铺平问题和它们的逆</a><a class="r-link _blog-link --fontTitle" href="/cate/code/b61ca28cfec6d41ba2e80da6204b29d5/"><span class="_nth">#<!-- -->21</span>微信小程序的授权问题</a><a class="r-link _blog-link --fontTitle" href="/cate/code/d93263b0ddb121ff4b449cc06f202a58/"><span class="_nth">#<!-- -->22</span>使用 Mongoose 的各种好处</a><a class="r-link _blog-link --fontTitle" href="/cate/code/1c036d874a8a331ee80bff44b515f1e1/"><span class="_nth">#<!-- -->23</span>jsonp、跨域和同源策略</a><a class="r-link _blog-link --fontTitle" href="/cate/code/the-best-conf-for-wechat-dev/"><span class="_nth">#<!-- -->24</span>微信开发的最佳配置</a><a class="r-link _blog-link --fontTitle" href="/cate/code/1c5a40a7350b8857c90e1f491d82275b/"><span class="_nth">#<!-- -->25</span>Vue路由重载以及iOS的自动播放问题</a><a class="r-link _blog-link --fontTitle" href="/cate/code/e4ae4b6560c36ddddc92f7cb63f90989/"><span class="_nth">#<!-- -->26</span>Fun with Single-Element CSS Spinner</a><a class="r-link _blog-link --fontTitle" href="/cate/code/5b316e61572472c3ec70b40f2141e488/"><span class="_nth">#<!-- -->27</span>许愿墙 5.0 经验总结</a><a class="r-link _blog-link --fontTitle" href="/cate/code/39d612362a82e1192ae85738f48f9382/"><span class="_nth">#<!-- -->28</span>Anything As A Service ?</a><a class="r-link _blog-link --fontTitle" href="/cate/code/proxy-in-web-engineering-and-practice/"><span class="_nth">#<!-- -->29</span>Web 工程中的代理以及实际应用</a><a class="r-link _blog-link --fontTitle" href="/cate/code/36939f44284eaf1203e198a65000eb70/"><span class="_nth">#<!-- -->30</span>用 node.js 模拟一个文件系统</a><a class="r-link _blog-link --fontTitle" href="/cate/code/0a5c15b17fbf9d7762ca9ba7b3256552/"><span class="_nth">#<!-- -->31</span>JSON String Parse</a><a class="r-link _blog-link --fontTitle" href="/cate/code/4023cc5e1afad68761e88b2473168392/"><span class="_nth">#<!-- -->32</span>函数式的 Promise 对异步的抽象</a><a class="r-link _blog-link --fontTitle" href="/cate/code/c563dd34435eefc4e8dafc342eefeb27/"><span class="_nth">#<!-- -->33</span>Ramda 里的 Promise</a><a class="r-link _blog-link --fontTitle" href="/cate/code/e50320d2fbfedf577c391869eefddda3/"><span class="_nth">#<!-- -->34</span>CSS 的解析</a><a class="r-link _blog-link --fontTitle" href="/cate/code/bfb7f9538e7fdf001dfad7146da7882c/"><span class="_nth">#<!-- -->35</span>数组和计算式</a><a class="r-link _blog-link --fontTitle" href="/cate/code/vars-functions-applys/"><span class="_nth">#<!-- -->36</span>变量、函数、调用</a><a class="r-link _blog-link --fontTitle" href="/cate/code/1cdbe34735e488e2451b6c75b6c0f000/"><span class="_nth">#<!-- -->37</span>EventEmitter</a><a class="r-link _blog-link --fontTitle" href="/cate/code/3a4ed698fbf1451be9ef2df8a0132556/"><span class="_nth">#<!-- -->38</span>网络安全与 SSL</a><a class="r-link _blog-link --fontTitle _active" href="/cate/code/693317dde161ae12dfe6781e43ce28c0/"><span class="_nth">#<!-- -->39</span>[Callback, Promise, Async]</a><a class="r-link _blog-link --fontTitle" href="/cate/code/ea3db00f8e2f7c38c2a3b05bd3b84334/"><span class="_nth">#<!-- -->40</span>函数默认值与 TDZ</a><a class="r-link _blog-link --fontTitle" href="/cate/code/cc2509c14d409f17e9bde0b344d530ab/"><span class="_nth">#<!-- -->41</span>再谈函数和一等公民</a><a class="r-link _blog-link --fontTitle" href="/cate/code/a24239f54c26dccfa7abdfe90a08a367/"><span class="_nth">#<!-- -->42</span>Church Encoding</a></div><div class="_cate-title --fontTitle">分类「 <!-- -->code<!-- --> 」</div></div><div><div id="start" class="blog-header-main"><div class="_infos"><div class="_info"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="clock" class="svg-inline--fa fa-clock fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256,8C119,8,8,119,8,256S119,504,256,504,504,393,504,256,393,8,256,8Zm92.49,313h0l-20,25a16,16,0,0,1-22.49,2.5h0l-67-49.72a40,40,0,0,1-15-31.23V112a16,16,0,0,1,16-16h32a16,16,0,0,1,16,16V256l58,42.5A16,16,0,0,1,348.49,321Z"></path></svg>2018-03-20</div><div class="_info"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="tag" class="svg-inline--fa fa-tag fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"></path></svg>Asynchronous</div></div><div class="_title --fontTitle">[Callback, Promise, Async]</div></div><article class="r-article-wrapper"><div class="toc-wrapper"></div><div class="r-article"><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">JavaScript 到处都是异步, 没有异步根本没法编程, 对异步的处理，一直以来都是一条主线，那就是尽可能的以同步的方式来写异步，使得异步过程变得清晰可控。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">本文将会从过去谈到现今，着重介绍回调，Promise，async三种方案的发展和思想。 <s>超长文警告</s></div>
<h1 id="回调" class="std-title --fontTitle"><a target="_blank" href="#回调" class="markdownIt-Anchor">#</a> 回调<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">一个 setTimeout 接受一个函数，一个时间作为参数，将会在给定的时间后执行那个函数。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这是很多人第一次接触到的异步，也是最为直观的 ———— 异步过程即函数过程，异步执行即函数的异步执行，异步坏境即函数的执行环境（this 和 arguments）</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">01</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;hello, world&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">02</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">03</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">04</span>
<span style="user-select:none" class="line-numbers-rows">05</span><span class="token comment">// 先打印 &#x27;js&#x27;, 一秒后打印 &#x27;hello, world&#x27;</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">而很多 api，都有回调的身影，传入回调，是希望异步操作完成之后能 catch 到执行结果，比如读取文件，在操作系统完成了 IO 读取之后，把数据返回给 js，js 执行回调函数，并把参数传入回调中。</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;fs&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">01</span>
<span style="user-select:none" class="line-numbers-rows">02</span>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&#x27;a.md&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">03</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">04</span>    <span class="token keyword">else</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">05</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">而且，你会发现，标准的异步回调 API，回调函数都是最后一个，而且回调函数的第一个参数是 err，第二个是异步过程蕴含的结果。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这不是巧合，而是为了把一个异步函数方便的 thunk 化。</div>
<h1 id="thunk-函数" class="std-title --fontTitle"><a target="_blank" href="#thunk-函数" class="markdownIt-Anchor">#</a> thunk 函数<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">参阅了阮一峰的 ES6，上面指出了，thunk 函数是用来实现传名调用的。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">以下是例子修改自那本书。</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">01</span>    <span class="token keyword">return</span> m <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">02</span><span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">03</span>
<span style="user-select:none" class="line-numbers-rows">04</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">05</span><span class="token comment">// 其实就是 f(9)</span>
<span style="user-select:none" class="line-numbers-rows">06</span><span class="token comment">// 最后返回 18 </span>
<span style="user-select:none" class="line-numbers-rows">07</span><span class="token comment">// 这种先求值的调用方式叫做传值调用 CBC (Call-By-Value)</span>
<span style="user-select:none" class="line-numbers-rows">08</span>
<span style="user-select:none" class="line-numbers-rows">09</span><span class="token comment">// 如果这样来写 ... </span>
<span style="user-select:none" class="line-numbers-rows">10</span><span class="token keyword">var</span> <span class="token function-variable function">thunk</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">11</span>
<span style="user-select:none" class="line-numbers-rows">12</span><span class="token function">thunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">13</span><span class="token comment">// =&gt; 返回 9 </span>
<span style="user-select:none" class="line-numbers-rows">14</span>
<span style="user-select:none" class="line-numbers-rows">15</span><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">16</span>    <span class="token keyword">return</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">17</span><span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">18</span>
<span style="user-select:none" class="line-numbers-rows">19</span><span class="token function">f</span><span class="token punctuation">(</span>thunk<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">20</span><span class="token comment">// 其实就是传入  (4 + 5) </span>
<span style="user-select:none" class="line-numbers-rows">21</span><span class="token comment">// 等到 f return 的时候才求值 thunk 从而达到传名调用的效果 (Call By Name)</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">我觉得，与其说实现了传名调用，倒不如说 thunk 更像是一种函数的柯里化形式，比如 thunk 版本的 readFile:</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;fs&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">01</span>
<span style="user-select:none" class="line-numbers-rows">02</span><span class="token comment">// 普通版本 </span>
<span style="user-select:none" class="line-numbers-rows">03</span>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&#x27;./a.md&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">04</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">05</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">06</span>
<span style="user-select:none" class="line-numbers-rows">07</span><span class="token keyword">let</span> <span class="token function-variable function">Thunk</span> <span class="token operator">=</span> <span class="token parameter">file_path</span> <span class="token operator">=&gt;</span> <span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">08</span>    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
<span style="user-select:none" class="line-numbers-rows">09</span><span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">10</span>
<span style="user-select:none" class="line-numbers-rows">11</span><span class="token keyword">let</span> read_a_Thunk <span class="token operator">=</span> <span class="token function">Thunk</span><span class="token punctuation">(</span><span class="token string">&#x27;./a.md&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">12</span><span class="token comment">// 等同于 cb =&gt; fs.readFile(&#x27;./a.md&#x27;, cb); </span>
<span style="user-select:none" class="line-numbers-rows">13</span>
<span style="user-select:none" class="line-numbers-rows">14</span><span class="token function">read_a_Thunk</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">15</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">16</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这样来看，readFile 的执行被分为两步，一步是文件路径的指定，一步是回调的喂入，只有把参数补齐，函数才会真正的运行，因此传名调用只是一个现象，最关键的是：异步被拖延了，异步的执行变成了一个函数，异步过程的完成需要一个回调函数来发动。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">而前面我提到，标准的异步回调 API，回调函数都是最后一个，而且其参数的位置也总是第一个是err，后面是蕴含值，其原因是为了更好的将一个函数 Thunk 化。</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">let</span> <span class="token function-variable function">Thunk</span> <span class="token operator">=</span> <span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">01</span>    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">02</span><span class="token punctuation">}</span>   <span class="token comment">// Thunk 是比较通用的 thunkify 函数 </span>
<span style="user-select:none" class="line-numbers-rows">03</span>
<span style="user-select:none" class="line-numbers-rows">04</span><span class="token keyword">let</span> readFileThunk <span class="token operator">=</span> <span class="token function">Thunk</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readFile<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">05</span>
<span style="user-select:none" class="line-numbers-rows">06</span><span class="token keyword">let</span> read_a_md <span class="token operator">=</span> <span class="token function">readFileThunk</span><span class="token punctuation">(</span><span class="token string">&#x27;./a.md&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">07</span>
<span style="user-select:none" class="line-numbers-rows">08</span><span class="token function">read_a_md</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">09</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">不过，一般来说，生产环境就不要自己写 Thunk 函数了，用别人写好的优质库是最好的, 如 <code>thunkify</code>。（更好的测试，更多人使用，更长的维护时间）</div>
<div class="std-code"><pre class="prismjs bash rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span>$ <span class="token function">npm</span> i <span class="token parameter variable">--save</span> thunkify</pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">安装好后，这样子使用：</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">const</span> thunkify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;thunkify&#x27;</span><span class="token punctuation">)</span>
<span style="user-select:none" class="line-numbers-rows">01</span>    <span class="token punctuation">,</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;fs&#x27;</span><span class="token punctuation">)</span>
<span style="user-select:none" class="line-numbers-rows">02</span> 
<span style="user-select:none" class="line-numbers-rows">03</span><span class="token keyword">let</span> read <span class="token operator">=</span> <span class="token function">thunkify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">04</span> 
<span style="user-select:none" class="line-numbers-rows">05</span><span class="token keyword">let</span> readPackage <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token string">&#x27;package.json&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;utf8&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">06</span>
<span style="user-select:none" class="line-numbers-rows">07</span><span class="token function">readPackage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> str</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">08</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">09</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">thunk 函数的执行，似乎是把异步的函数执行了一半一样，只传入了部分参数，直到最后把 callback 喂进去，异步过程才真正开始，在使用 Generator 的时候可以利用这一点，完成异步过程的终极解决方案。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">在此，还得说明一下其他的异步方案。</div>
<h1 id="事件里的异步" class="std-title --fontTitle"><a target="_blank" href="#事件里的异步" class="markdownIt-Anchor">#</a> 事件里的异步<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">事件的触发常常是异步的，在未来的某个点上执行的，如点击事件，如 onload 事件，关于它的描述，我在 《EventEmitter》 里已经有所解释，此处就不多说，不过，我自己做 Promise-pollyfill 的时候就用到了事件机制来写，可以用来传递消息。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">不过说来，不论是事件，还是 thunk 还是 callback 他们均把函数看成是异步的一等公民，没有函数的异步执行就没有异步过程。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">因而，它们都有回调地域的问题，例如要将文件内容全部大写化，再重新写入：</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;fs&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">01</span>
<span style="user-select:none" class="line-numbers-rows">02</span><span class="token comment">/**
<span style="user-select:none" class="line-numbers-rows">03</span> * @description 读取文件转化成大写
<span style="user-select:none" class="line-numbers-rows">04</span> * @params { String } file 文件路径 
<span style="user-select:none" class="line-numbers-rows">05</span> * @params { Function } ok_cb 回调函数
<span style="user-select:none" class="line-numbers-rows">06</span> */</span>
<span style="user-select:none" class="line-numbers-rows">07</span><span class="token keyword">function</span> <span class="token function">fileUpperCase</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> ok_cb</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">08</span>    <span class="token comment">// 默认参数 </span>
<span style="user-select:none" class="line-numbers-rows">09</span>    ok_cb <span class="token operator">=</span> ok_cb <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">10</span>
<span style="user-select:none" class="line-numbers-rows">11</span>    <span class="token comment">// 参数限制 </span>
<span style="user-select:none" class="line-numbers-rows">12</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file <span class="token operator">||</span> <span class="token keyword">typeof</span> file <span class="token operator">!==</span> <span class="token string">&#x27;string&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">13</span>        <span class="token keyword">return</span> <span class="token function">ok_cb</span><span class="token punctuation">(</span><span class="token string">&#x27;file should be string&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">14</span>    <span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">15</span>
<span style="user-select:none" class="line-numbers-rows">16</span>    <span class="token comment">// 读取 </span>
<span style="user-select:none" class="line-numbers-rows">17</span>    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">read_err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">18</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>read_err<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">19</span>            <span class="token function">ok_cb</span><span class="token punctuation">(</span>read_err<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">20</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">21</span>            <span class="token comment">// 写入 </span>
<span style="user-select:none" class="line-numbers-rows">22</span>            <span class="token keyword">let</span> toWrite <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">23</span>            fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> toWrite<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">write_err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">24</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>write_err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">25</span>                    <span class="token function">ok_cb</span><span class="token punctuation">(</span>write_err<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">26</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">27</span>                    <span class="token function">ok_cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> toWrite<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">28</span>                <span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">29</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">30</span>        <span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">31</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">32</span><span class="token punctuation">}</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">仅仅两层，对错误的 if 判断就很杂乱了，要是再深一点，恐怕就很难维护了，毕竟回调过于粗暴，将异步的先后用嵌套关系来表达，因此就会这样，越嵌越深。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">对，这种异步方式的问题在于，其异步流的先继问题实际上是括号的嵌套问题，而不是我们期望中的 ———— 异步流的先继其实是代码的先继问题。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">那么，如果，将先后关系，表达成代码的先后呢？</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这是一个好的思路，Promise 就有这种影子了，很好地抽象了异步过程，使得以同步的方式写异步，成为了可能。</div>
<h1 id="promise" class="std-title --fontTitle"><a target="_blank" href="#promise" class="markdownIt-Anchor">#</a> Promise<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">以上的回调，thunk，还有事件其实都摆脱不了传递函数所造成的嵌套问题。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">在我看来，Promise 抽象了异步过程，把异步的过程当成了数值来看待，异步说到底也总是某个数据的异步获取，在未来的时候取得，也就是说，一个 Promise 一般来说都会蕴含一个值。</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token comment">/**
<span style="user-select:none" class="line-numbers-rows">01</span> * @description 返回一个 Promise 蕴含的值为 val，将会在 500 ms 后 resolved 
<span style="user-select:none" class="line-numbers-rows">02</span> * @params { * } val 返回的 Promise 所蕴含的值
<span style="user-select:none" class="line-numbers-rows">03</span> * @returns { Promise } 
<span style="user-select:none" class="line-numbers-rows">04</span> */</span>
<span style="user-select:none" class="line-numbers-rows">05</span><span class="token keyword">let</span> <span class="token function-variable function">wait</span> <span class="token operator">=</span> <span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">06</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">07</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">08</span>        <span class="token function">res</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">09</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span style="user-select:none" class="line-numbers-rows">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">11</span>
<span style="user-select:none" class="line-numbers-rows">12</span><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">13</span><span class="token comment">// p1 蕴含着 1 </span>
<span style="user-select:none" class="line-numbers-rows">14</span><span class="token comment">// 500ms 后 console.log(1)</span>
<span style="user-select:none" class="line-numbers-rows">15</span>
<span style="user-select:none" class="line-numbers-rows">16</span><span class="token keyword">let</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> e <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">17</span><span class="token comment">// p2 蕴含着 2 </span>
<span style="user-select:none" class="line-numbers-rows">18</span><span class="token comment">// 5000ms 后 console.log(2)</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">而且，最为关键的是，then 会返回一个新 Promise，其蕴含的值是原先的值关于 then 所接收的函数的一个映射。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">换言之，then 即 map，Promise 是一类 Container 是一类 functor。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这是 Promise 的函数式特性，使得异步流变得很清晰可见了，因为在 then 函数内，异步的先后关系，其实看起来更像是代码的先后关系了。</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span>
<span style="user-select:none" class="line-numbers-rows">01</span><span class="token keyword">let</span> p3 <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">02</span><span class="token comment">// 500ms 后 console.log(3)</span>
<span style="user-select:none" class="line-numbers-rows">03</span>
<span style="user-select:none" class="line-numbers-rows">04</span><span class="token keyword">let</span> p4 <span class="token operator">=</span> p3<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">_3</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">05</span>    <span class="token keyword">return</span> <span class="token function">wait</span><span class="token punctuation">(</span>_3 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">06</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">_4</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">07</span>    <span class="token keyword">return</span> <span class="token function">wait</span><span class="token punctuation">(</span>_4 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">08</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">_5</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">09</span>    <span class="token keyword">return</span> <span class="token function">wait</span><span class="token punctuation">(</span>_5 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">11</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">12</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">13</span><span class="token comment">// p3 先 resolved， 输出 3 </span>
<span style="user-select:none" class="line-numbers-rows">14</span><span class="token comment">// 紧接着执行 第一个 then 里面的，里面 return 一个 Promise，等待其 resolved 后继续执行之后的 then </span>
<span style="user-select:none" class="line-numbers-rows">15</span><span class="token comment">// 然后 500 ms 后输出 4 </span>
<span style="user-select:none" class="line-numbers-rows">16</span><span class="token comment">// 再 500ms 后输出 5</span>
<span style="user-select:none" class="line-numbers-rows">17</span><span class="token comment">// 再 500ms 后输出 6</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">看起来就是以同步的方式写异步了，而且，报错将会被轻而易举的 catch 到。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">看起来好像异步的问题已经解决的差不多了。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">其实并没有，Promise 还缺点什么，你会发现，所谓的同步写异步必须 then 包着才能做到。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">你想过为什么吗？</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">原因在于，只有被 then 包着了，才能监控到 then 里面那个函数的返回值，换言之，异步的过程中，有一段时间 CPU 控制权交给 Promise 了。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">在这个时间里，Promise 判断返回值是不是 Promise，而且还找出了下一个 then 在哪，然后在时机成熟的时候执行它。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">是 Promise 调度了异步的流程，才使得一切如此清晰。</div>
<h1 id="generator" class="std-title --fontTitle"><a target="_blank" href="#generator" class="markdownIt-Anchor">#</a> Generator<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">上面提到过，Promise 调度了异步的流程，才使得一切如此清晰。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">与操作系统调度进程一样，Promise 需要一个 CPU 控制权来调度异步。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">如果语言层面上能提供这样的特性，即切换上下文的特性，也许我们可以在形式上做出一个飞跃。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">Generator 应运而生，它允许函数暂停执行，交出上下文，在之后可以继续执行之。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这就为下一步的终极异步方案打下了语言基础。</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">01</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;wait 开始执行 ... yield 一个 5 出来&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">02</span>    
<span style="user-select:none" class="line-numbers-rows">03</span>    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">5</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">04</span>
<span style="user-select:none" class="line-numbers-rows">05</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;wait 继续执行 ... 外面给进来的 a = &#x27;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">06</span>    
<span style="user-select:none" class="line-numbers-rows">07</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;wait 返回 2&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">08</span>
<span style="user-select:none" class="line-numbers-rows">09</span>    <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">10</span><span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">11</span>
<span style="user-select:none" class="line-numbers-rows">12</span><span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">13</span><span class="token comment">// 得到一个遍历器 </span>
<span style="user-select:none" class="line-numbers-rows">14</span>
<span style="user-select:none" class="line-numbers-rows">15</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">16</span><span class="token comment">// 输出：wait 开始执行 ... yield 一个 5 出来</span>
<span style="user-select:none" class="line-numbers-rows">17</span><span class="token comment">// 返回：{value: 5, done: false} </span>
<span style="user-select:none" class="line-numbers-rows">18</span>
<span style="user-select:none" class="line-numbers-rows">19</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">20</span><span class="token comment">// 输出：wait 继续执行 ... 外面给进来的 a =  123</span>
<span style="user-select:none" class="line-numbers-rows">21</span><span class="token comment">// 返回：{value: 2, done: true}</span>
<span style="user-select:none" class="line-numbers-rows">22</span>
<span style="user-select:none" class="line-numbers-rows">23</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">24</span><span class="token comment">// 返回：{value: undefined, done: true}</span>
<span style="user-select:none" class="line-numbers-rows">25</span><span class="token comment">// 函数执行完毕</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">一开始我觉得这种方式执行函数很古怪，但细细想来，发现了这种函数执行的方式，似乎是将函数的执行，变成某种数据结构的遍历了，Generator 函数执行的结果是返回一个遍历器实例，可以调用 next 方法遍历它，其中 yield 关键字的右边是传递出去的值，而 yield 本身的值，是外部传进来的值。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">如：</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">yield</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">01</span><span class="token comment">// yield 表达式 ;</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">上面的内部的 5，也是一个表达式，会被传递出去。而整个括号，也会有返回值，也是一个 <code>表达式</code>，比如：在外部调用 next, 会得到 5, 但下一次调用 next(10) 继续执行 Generator 函数时，这个 a 就变成 10 了。</div>
<hr class="std-hr"/>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">如果我们不同步的调用 next，而是异步的调用 next，Generator 内部的异步过程，是不是可以变成同步了？</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">好像是！试想想：</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;fs&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">01</span>
<span style="user-select:none" class="line-numbers-rows">02</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">double_read</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">03</span>    <span class="token keyword">let</span> fileA   <span class="token operator">=</span> <span class="token keyword">yield</span> file<span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">04</span>    <span class="token keyword">let</span> fileA_2 <span class="token operator">=</span> <span class="token keyword">yield</span> file<span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">05</span>
<span style="user-select:none" class="line-numbers-rows">06</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fileA <span class="token operator">+</span> fileA_2<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">07</span><span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">08</span>
<span style="user-select:none" class="line-numbers-rows">09</span><span class="token comment">// 来，现在让 double_read 变成 `同步` 的</span>
<span style="user-select:none" class="line-numbers-rows">10</span>
<span style="user-select:none" class="line-numbers-rows">11</span><span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">double_read</span><span class="token punctuation">(</span><span class="token string">&#x27;./po.js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">12</span>
<span style="user-select:none" class="line-numbers-rows">13</span><span class="token keyword">let</span> fileA_name <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">14</span>
<span style="user-select:none" class="line-numbers-rows">15</span><span class="token comment">// 为了讨论方便，在此不做错误处理 </span>
<span style="user-select:none" class="line-numbers-rows">16</span>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>fileA_name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">17</span>    <span class="token keyword">let</span> fileB_name <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">18</span>
<span style="user-select:none" class="line-numbers-rows">19</span>    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>fileB_name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">20</span>        it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">21</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">22</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">可以看见，如果要执行 Generator 函数，得要有相应的代码去遍历返回的遍历器，这个代码叫做遍历器，也就是说，Generator 函数的执行离不开遍历器。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">遍历器，或者说是执行器，实际上，可以用来做调度，这就为同步的写异步代码做足了基础。上述的例子里，我们已经完成了用同步的方法写异步的形式，不过这需要一个复杂的执行器才能进行。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">因此 double_read 的执行，看起来是同步的，但是其内部执行是完全异步的。yield 把函数卡住了，这时候就可以跳出来执行调度代码了，之后再继续执行函数，这样函数的执行看起来就好像是同步的了，形式上也跟同步代码保持一致了。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">而如果能写一个通用的执行器，那么异步问题将会有一个较好的解决方案：以同步的方式写异步，以下是 <code>po</code> 模块</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">const</span> po <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./po&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">01</span><span class="token comment">// 假想中的通用执行器 </span>
<span style="user-select:none" class="line-numbers-rows">02</span><span class="token comment">// 下文会实现它 </span>
<span style="user-select:none" class="line-numbers-rows">03</span>
<span style="user-select:none" class="line-numbers-rows">04</span><span class="token comment">// 前文的 wait 函数 会返回一个 Promise </span>
<span style="user-select:none" class="line-numbers-rows">05</span><span class="token keyword">let</span> <span class="token function-variable function">wait</span> <span class="token operator">=</span> <span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">06</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">07</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">08</span>        <span class="token function">res</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">09</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span style="user-select:none" class="line-numbers-rows">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">11</span>
<span style="user-select:none" class="line-numbers-rows">12</span><span class="token function">po</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">looooong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">13</span>    <span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">14</span>
<span style="user-select:none" class="line-numbers-rows">15</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> val<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">16</span>        val<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">wait</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">17</span>        <span class="token comment">// 假想中的执行器在遇到 yield 的时候会跳出</span>
<span style="user-select:none" class="line-numbers-rows">18</span>        <span class="token comment">// 接着执行器调用 wait(idx).then 来取出 Promise 的蕴含值 </span>
<span style="user-select:none" class="line-numbers-rows">19</span>        <span class="token comment">// 取得蕴含值后继续执行函数</span>
<span style="user-select:none" class="line-numbers-rows">20</span>    <span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">21</span>
<span style="user-select:none" class="line-numbers-rows">22</span>    <span class="token comment">// 理想中的执行情况: </span>
<span style="user-select:none" class="line-numbers-rows">23</span>    <span class="token comment">// 500ms 0</span>
<span style="user-select:none" class="line-numbers-rows">24</span>    <span class="token comment">// 1000ms 1 </span>
<span style="user-select:none" class="line-numbers-rows">25</span>    <span class="token comment">// 1500ms 2 </span>
<span style="user-select:none" class="line-numbers-rows">26</span>    <span class="token comment">// 2000ms 3</span>
<span style="user-select:none" class="line-numbers-rows">27</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">以下，是 <code>po</code> 模块的实现, 为了谈论方便，我没有考虑错误处理。</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token comment">// po </span>
<span style="user-select:none" class="line-numbers-rows">01</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> po<span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">02</span>
<span style="user-select:none" class="line-numbers-rows">03</span><span class="token keyword">function</span> <span class="token function">po</span><span class="token punctuation">(</span><span class="token parameter">generator_func</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">04</span>    <span class="token keyword">let</span> iter <span class="token operator">=</span> <span class="token function">generator_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">05</span>
<span style="user-select:none" class="line-numbers-rows">06</span>    <span class="token keyword">return</span> <span class="token function">_po</span><span class="token punctuation">(</span>iter<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">07</span><span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">08</span>
<span style="user-select:none" class="line-numbers-rows">09</span><span class="token keyword">function</span> <span class="token function">_po</span><span class="token punctuation">(</span><span class="token parameter">iter<span class="token punctuation">,</span> para <span class="token operator">=</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">10</span>    <span class="token keyword">let</span> p <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>para<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">11</span>
<span style="user-select:none" class="line-numbers-rows">12</span>    <span class="token comment">// 如果 Generator 函数执行完毕，return 结束</span>
<span style="user-select:none" class="line-numbers-rows">13</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">14</span>
<span style="user-select:none" class="line-numbers-rows">15</span>    <span class="token comment">// p.value 是 yield 右边的表达式的值 </span>
<span style="user-select:none" class="line-numbers-rows">16</span>    <span class="token comment">// 这里是 Promise，利用 then 方法取出其蕴含值</span>
<span style="user-select:none" class="line-numbers-rows">17</span>    <span class="token comment">// 取得值后继续执行 generator 函数 (递归的执行)</span>
<span style="user-select:none" class="line-numbers-rows">18</span>    p<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">async_val</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">19</span>        <span class="token function">_po</span><span class="token punctuation">(</span>iter<span class="token punctuation">,</span> async_val<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">20</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">21</span><span class="token punctuation">}</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">当然，早有人实现了上述所说的执行器，那就是 <code>co</code> 模块，它不仅仅支持 Promise 的 yield 还支持 thunk 函数。</div>
<div class="std-code"><pre class="prismjs bash rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span>$ <span class="token function">npm</span> i <span class="token parameter variable">--save</span> co</pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">安装好之后如下使用：</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">const</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;co&#x27;</span><span class="token punctuation">)</span>
<span style="user-select:none" class="line-numbers-rows">01</span>    <span class="token punctuation">,</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;fs&#x27;</span><span class="token punctuation">)</span>
<span style="user-select:none" class="line-numbers-rows">02</span>    <span class="token punctuation">,</span> thunkify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;thunkify&#x27;</span><span class="token punctuation">)</span>
<span style="user-select:none" class="line-numbers-rows">03</span>    <span class="token punctuation">,</span> readFile <span class="token operator">=</span> <span class="token function">thunkify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readFile<span class="token punctuation">)</span>
<span style="user-select:none" class="line-numbers-rows">04</span>
<span style="user-select:none" class="line-numbers-rows">05</span><span class="token keyword">let</span> read_po <span class="token operator">=</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&#x27;./po.js&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;utf-8&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">06</span>
<span style="user-select:none" class="line-numbers-rows">07</span><span class="token function">co</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">08</span>    <span class="token keyword">let</span> _1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">09</span>    <span class="token keyword">let</span> pojs <span class="token operator">=</span> <span class="token keyword">yield</span> read_po
<span style="user-select:none" class="line-numbers-rows">10</span>
<span style="user-select:none" class="line-numbers-rows">11</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_1<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">12</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pojs<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">13</span><span class="token punctuation">}</span><span class="token punctuation">)</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">可以看到，只 yield 了一个 read_po 函数出去，co 模块就可以完成读取 po.js 的异步过程。仔细想想，读取 po.js 实际上就差一个 callback 了而已，此处由 co 模块提供这个 callback 去执行这个异步过程，进而将结果返回到 Generator 函数里继续执行。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这就是为什么要 thunk 的原因，补齐异步所需的参数，只差最终的一个调度。</div>
<hr class="std-hr"/>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">额，前文所述的都是一个接着一个的执行，那可不可以并发呢？ 当然可以：</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token function">co</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">01</span>    <span class="token keyword">let</span> _1_p <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">02</span>    <span class="token keyword">let</span> _2_p <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">03</span>
<span style="user-select:none" class="line-numbers-rows">04</span>    <span class="token keyword">let</span> _1_2 <span class="token operator">=</span> <span class="token keyword">yield</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>_1_p<span class="token punctuation">,</span> _2_p<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">05</span>    <span class="token comment">// let _1_2 = yield ([_1_p, _2_p]); </span>
<span style="user-select:none" class="line-numbers-rows">06</span>    <span class="token comment">// 这样写也是可以的。 co 模块也支持处理 Promises</span>
<span style="user-select:none" class="line-numbers-rows">07</span>
<span style="user-select:none" class="line-numbers-rows">08</span>    <span class="token keyword">let</span> <span class="token punctuation">[</span>_1<span class="token punctuation">,</span> _2<span class="token punctuation">]</span> <span class="token operator">=</span> _1_2<span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">09</span>
<span style="user-select:none" class="line-numbers-rows">10</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;函数结束:&#x27;</span><span class="token punctuation">,</span> _1<span class="token punctuation">,</span> _2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">11</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">yield 意味着等待，函数暂停执行，切换上下文到 co 模块，co 模块做完处理后重启函数的执行，因此函数的执行看起来就像是同步的方式执行异步代码了。</div>
<h1 id="async-await" class="std-title --fontTitle"><a target="_blank" href="#async-await" class="markdownIt-Anchor">#</a> Async / Await<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">即上文的 Generator / Co 的一个语法糖。</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token function">co</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">01</span>    <span class="token keyword">let</span> _1_p <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">02</span>    <span class="token keyword">let</span> _2_p <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">03</span>
<span style="user-select:none" class="line-numbers-rows">04</span>    <span class="token keyword">let</span> _1_2 <span class="token operator">=</span> <span class="token keyword">yield</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>_1_p<span class="token punctuation">,</span> _2_p<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">05</span>    <span class="token comment">// let _1_2 = yield ([_1_p, _2_p]); </span>
<span style="user-select:none" class="line-numbers-rows">06</span>    <span class="token comment">// 这样写也是可以的。 co 模块也支持处理 Promises</span>
<span style="user-select:none" class="line-numbers-rows">07</span>
<span style="user-select:none" class="line-numbers-rows">08</span>    <span class="token keyword">let</span> <span class="token punctuation">[</span>_1<span class="token punctuation">,</span> _2<span class="token punctuation">]</span> <span class="token operator">=</span> _1_2<span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">09</span>
<span style="user-select:none" class="line-numbers-rows">10</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;函数结束:&#x27;</span><span class="token punctuation">,</span> _1<span class="token punctuation">,</span> _2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">11</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">12</span>
<span style="user-select:none" class="line-numbers-rows">13</span><span class="token comment">// 等于 ==&gt; </span>
<span style="user-select:none" class="line-numbers-rows">14</span>
<span style="user-select:none" class="line-numbers-rows">15</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">16</span>    <span class="token keyword">let</span> _1_p <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">17</span>    <span class="token keyword">let</span> _2_p <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">18</span>
<span style="user-select:none" class="line-numbers-rows">19</span>    <span class="token keyword">let</span> _1_2 <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>_1_p<span class="token punctuation">,</span> _2_p<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">20</span>    <span class="token comment">// 注意, 此处就不支持下面这种省略的写法了 </span>
<span style="user-select:none" class="line-numbers-rows">21</span>    <span class="token comment">// let _1_2 = await ([_1_p, _2_p]); </span>
<span style="user-select:none" class="line-numbers-rows">22</span>
<span style="user-select:none" class="line-numbers-rows">23</span>    <span class="token keyword">let</span> <span class="token punctuation">[</span>_1<span class="token punctuation">,</span> _2<span class="token punctuation">]</span> <span class="token operator">=</span> _1_2<span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">24</span>
<span style="user-select:none" class="line-numbers-rows">25</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;函数结束:&#x27;</span><span class="token punctuation">,</span> _1<span class="token punctuation">,</span> _2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">26</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">async / await 是语言层面上的实现，性能比 co / generaotr 要好，因此建议直接使用 async 函数，而不是利用 co 模块。 (koa1 本来是 co / generator 实现的，但出了 asnyc 函数之后就全套使用 async 函数了，变成 koa2 了)</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">async 也不用像 generator 一样需要执行器，其执行器是语言内部实现的，无需自己导入 co 模块。</div>
<h1 id="各方案错误处理" class="std-title --fontTitle"><a target="_blank" href="#各方案错误处理" class="markdownIt-Anchor">#</a> 各方案错误处理<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">异步有个问题，那就是错误处理的问题。</div>
<h2 id="回调函数-thunk-的错误处理" class="std-title --fontTitle"><a target="_blank" href="#回调函数-thunk-的错误处理" class="markdownIt-Anchor">#</a> 回调函数 / thunk 的错误处理</h2>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">标准的异步 API 里，回调函数的第一个参数总是错误 err，这是约定。如果无错误，则 err 是 null，如果有则是错误对象。</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;fs&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">01</span>
<span style="user-select:none" class="line-numbers-rows">02</span>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&#x27;test.md&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;utf-8&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">03</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">04</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">05</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">06</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">07</span>    <span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">08</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">在回调地狱的情况下，这样的处理方式实在是难以接受，代码复杂度会一下子上去，会写很多的 if 分支去判断情况，很难追踪，嵌套愈深，愈难理清关系。</div>
<h2 id="promise-的错误处理" class="std-title --fontTitle"><a target="_blank" href="#promise-的错误处理" class="markdownIt-Anchor">#</a> Promise 的错误处理</h2>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">相比前者，Promise 的方案就清晰多了。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">前文说过，Promise 把异步过程抽象成数值 (容器) 了，整个容器蕴含着数值，将会在 resolved 的时候变得可用，其错误也是一样，将会在 rejected 的时候可用。</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token comment">// 前文的 wait 函数 </span>
<span style="user-select:none" class="line-numbers-rows">01</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">_1</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">02</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_1<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">03</span>    <span class="token comment">// =&gt; 1 </span>
<span style="user-select:none" class="line-numbers-rows">04</span>
<span style="user-select:none" class="line-numbers-rows">05</span>    <span class="token comment">// 如果此处抛出错误 </span>
<span style="user-select:none" class="line-numbers-rows">06</span>    <span class="token keyword">throw</span> <span class="token string">&#x27;error !&#x27;</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">07</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">_2</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">08</span>    <span class="token comment">// 那么此处不会执行 </span>
<span style="user-select:none" class="line-numbers-rows">09</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_2<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">11</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">12</span>    <span class="token comment">// `error !`</span>
<span style="user-select:none" class="line-numbers-rows">13</span>
<span style="user-select:none" class="line-numbers-rows">14</span>    <span class="token comment">// 如果此处返回了一个非 rejected 的 promise</span>
<span style="user-select:none" class="line-numbers-rows">15</span>    <span class="token keyword">return</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">16</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">_2</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">17</span>    <span class="token comment">// promise 执行流将会回归正常</span>
<span style="user-select:none" class="line-numbers-rows">18</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_2<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">19</span>
<span style="user-select:none" class="line-numbers-rows">20</span>    <span class="token comment">// 否则 如果返回一个 rejected 的 Promise </span>
<span style="user-select:none" class="line-numbers-rows">21</span>    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">&#x27;i am error!&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">22</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">23</span>    <span class="token comment">// 那么又会跳回错误流的执行</span>
<span style="user-select:none" class="line-numbers-rows">24</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;err&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">25</span>    <span class="token comment">// `i am error!`; </span>
<span style="user-select:none" class="line-numbers-rows">26</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div>
<h2 id="co-async" class="std-title --fontTitle"><a target="_blank" href="#co-async" class="markdownIt-Anchor">#</a> co / async</h2>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">co 和 async 的本质上是一样的，以同步的方式写异步，因此错误处理，也一样是以同步的方式去处理，使得可以使用同步的 try / catch 去捕获错误。</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">01</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">02</span>        <span class="token keyword">let</span> _1 <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">03</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">04</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">05</span>    <span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">06</span><span class="token punctuation">}</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这也带来了，以同步的方式处理错误的回归。</div>
<h1 id="tldr" class="std-title --fontTitle"><a target="_blank" href="#tldr" class="markdownIt-Anchor">#</a> TL;DR<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">JavaScript 近十几年的发展，终于摆脱了回调地狱，拥抱 Promise。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">直到看到了切换上下文的 Generator，意识到了异步不过是跳出和返回，才有了 co 模块，才有了现今 async / await 的终极解决方案。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">对异步的探索，其实一直都是一条主线，那就是同步的方式写异步，使得异步流尽可能的清晰可见。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><div class="std-img"><img class="std-img-bg r-link" data-minimap="Rect" src="/images/callback-promise-async.jpg" alt="应该配张图的"/><div class="std-img-text">应该配张图的</div></div></div>
</div></article></div><hr class="std-hr"/><hr class="std-hr"/><div class="blog-footer-main"><a class="r-link _prev" href="/cate/code/3a4ed698fbf1451be9ef2df8a0132556/"><span class="_icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="caret-left" class="svg-inline--fa fa-caret-left fa-w-6 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 512"><path fill="currentColor" d="M192 127.338v257.324c0 17.818-21.543 26.741-34.142 14.142L29.196 270.142c-7.81-7.81-7.81-20.474 0-28.284l128.662-128.662c12.599-12.6 34.142-3.676 34.142 14.142z"></path></svg></span><span>网络安全与 SSL</span></a><div class="_current"><span class="_smaller _grey">第</span><span class="_nums _grey">40</span><span class="_smaller _grey">篇</span><div class="_now-id">[Callback, Promise, Async]</div></div><a class="r-link _next" href="/cate/code/ea3db00f8e2f7c38c2a3b05bd3b84334/"><span>函数默认值与 TDZ</span><span class="_icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="caret-right" class="svg-inline--fa fa-caret-right fa-w-6 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 512"><path fill="currentColor" d="M0 384.662V127.338c0-17.818 21.543-26.741 34.142-14.142l128.662 128.662c7.81 7.81 7.81 20.474 0 28.284L34.142 398.804C21.543 411.404 0 402.48 0 384.662z"></path></svg></span></a></div><hr class="std-hr"/><hr class="std-hr"/><div class="back-to-top-main"><span class="_icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="caret-up" class="svg-inline--fa fa-caret-up fa-w-10 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M288.662 352H31.338c-17.818 0-26.741-21.543-14.142-34.142l128.662-128.662c7.81-7.81 20.474-7.81 28.284 0l128.662 128.662c12.6 12.599 3.676 34.142-14.142 34.142z"></path></svg></span><span class="_icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="caret-up" class="svg-inline--fa fa-caret-up fa-w-10 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M288.662 352H31.338c-17.818 0-26.741-21.543-14.142-34.142l128.662-128.662c7.81-7.81 20.474-7.81 28.284 0l128.662 128.662c12.6 12.599 3.676 34.142-14.142 34.142z"></path></svg></span><span class="_icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="caret-up" class="svg-inline--fa fa-caret-up fa-w-10 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M288.662 352H31.338c-17.818 0-26.741-21.543-14.142-34.142l128.662-128.662c7.81-7.81 20.474-7.81 28.284 0l128.662 128.662c12.6 12.599 3.676 34.142-14.142 34.142z"></path></svg></span><div class="_text-intro">回到顶部</div></div><hr class="std-hr"/><hr class="std-hr"/></div></div></div>
<script>window.__INITIAL_STATE__ = {"CategoryApiState":{"loaded":true,"loading":false,"error":null,"dataMap":{"/code/693317dde161ae12dfe6781e43ce28c0":{"type":"detail","categoryId":"code","list":[{"title":"JavaScript Array","date":"2016-12-15 01:11:11","category":"code","tags":["JavaScript"],"intro":"数组太常见了，以至于经常忽略它 【老文章恢复】","head":["http://ogz5pg6y8.bkt.clouddn.com/array100.png","center","100%"],"type":"article","id":"7160d323740df57ea08a87fb966acf0c","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2016-12-14T17:11:11.000Z","isDraft":false,"fileDeps":["/images/node.png","/images/Iteration.png","/images/stack_queue.png"],"wordCount":7997},{"title":"JavaScript 有限状态机","date":"2017-02-09 02:01:11","intro":"读了阮哥的一篇关于JavaScript FSM库的介绍，然后就自己写了一个红绿灯过过瘾","headPic":"/images/trafLights.jpg","category":"code","type":"article","id":"06bfca16df0a3946476c33daaa2b2ee6","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"tags":[],"time":"2017-02-08T18:01:11.000Z","isDraft":false,"fileDeps":[],"wordCount":3537},{"title":"语义化和文章排版","date":"2017-02-10 02:01:11","category":"code","tags":["FE"],"intro":"语义化的目的是提高机器对文章的阅读能力，排版是为了更好地供人阅读，两者都跟阅读产生了或虚或实的关系，语义化标准看到了这点，并给出了较好的方案，现代的语义化主要构造在文章排版之上。","type":"article","id":"76bfd9d6896b7c19b4c67ee0599a5c37","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-02-09T18:01:11.000Z","isDraft":false,"fileDeps":[],"wordCount":1285},{"title":"This, Closure","date":"2017-02-12 20:21:11","intro":"学一门语言往往在洞晓了某个知识点后就能渐入佳境。对于JavaScript， <code>闭包(Closure)</code> 和 <code>this</code> 这两个知识点毫无疑问将是渐入佳境的最佳候选人之二","headPic":"http://ogz5pg6y8.bkt.clouddn.com/shit-callback2.png","category":"code","type":"article","id":"b94c4706883c37293b9c0382caf015e0","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"tags":[],"time":"2017-02-12T12:21:11.000Z","isDraft":false,"fileDeps":[],"wordCount":4491},{"title":"gulp 基本使用","intro":"用自动化构建工具增强你的工作流程！","date":"Tue Feb 21 2017 18:27:22 GMT+0800 (中国标准时间)","category":"code","tags":["gulp"],"head":false,"headerStyle":["line-height: 628px;"],"type":"article","id":"64c861a95b26916c0648b25bd76adaae","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-02-21T10:27:22.000Z","isDraft":false,"fileDeps":["/images/gulp_learn.png"],"wordCount":2697},{"title":"一道闭包相关的面试题","intro":"在知乎上看到了 转了过来 挺有意思","date":"Sun Feb 26 2017 22:58:19 GMT+0800 (中国标准时间)","category":"code","tags":["面试","JS"],"type":"article","id":"cbcd6b8e32ddce02368312696ac445a6","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-02-26T14:58:19.000Z","isDraft":false,"fileDeps":[],"wordCount":2142},{"title":"window.localStorage","intro":"使用浏览器的本地存储做离线数据存储","date":"Thu April 1 2017 16:15:45 GMT+0800 (中国标准时间)","category":"code","tags":["FE"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"isDraft":false,"type":"article","id":"18f3d295ffec2edfee91fa5e4bfe8549","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-04-01T08:15:45.000Z","fileDeps":[],"wordCount":3648},{"title":"3px","intro":"一般浏览器会将html文档里面的回车换行解析为空格，这会造成很多意想不到的问题","date":"Sat Apr 01 2017 21:35:00 GMT+0800 (中国标准时间)","category":"code","tags":["FE"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"955729c424219487dd259575d1b07a64","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-04-01T13:35:00.000Z","isDraft":false,"fileDeps":["/images/3px_001.png","/images/3px_002.png"],"wordCount":2825},{"title":"This, Function","intro":"the .call .apply and .bind methods on the Function.prototype","date":"Sat Apr 08 2017 12:37:36 GMT+0800 (中国标准时间)","category":"code","tags":["FP"],"head":true,"headerText":"λ","headPic":false,"customCSS":[".vally-header { ","line-height: 549px;","color: #333;","font-size: 180px;","text-shadow: 0.5rem 0.3rem 0 rgba(255,255,255,.8), -1.5rem -.5rem 0 rgba(0,0,0,.05), 1rem 0.6rem 0 rgba(0,0,0,.1);","transition: all .4s;","background-color: #EEE;","background-image: repeating-linear-gradient(-45deg,","    #FFF,","    #FFF 6px,","    transparent 4px,","    transparent 8px","), repeating-linear-gradient(0deg,","    #FFF,","    #FFF 6px,","    transparent 4px,","    transparent 8px",");","animation-name: toright;","animation-duration: 16s; ","animation-timing-function: linear;","animation-iteration-count: infinite;","-webkit-animation-name: toright;","-webkit-animation-duration: 16s; ","-webkit-animation-timing-function: linear;","-webkit-animation-iteration-count: infinite;","}","@keyframes toright {","    0%   {background-position-x: 0px;}","    100% {background-position-x: 500px;}","}","@-webkit-keyframes toright {","    0%   {background-position-x: 0px;}","    100% {background-position-x: 500px;}","}","header:after { height: 0px }"],"type":"article","id":"d1010fb555e008d2cd13ebe0bb8ea37f","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-04-08T04:37:36.000Z","isDraft":false,"fileDeps":[],"wordCount":8617},{"title":"制作图片轮播组件","intro":"造轮子以学习实践知识：学于装，装于学","date":"Sun Apr 09 2017 13:21:33 GMT+0800 (中国标准时间)","category":"code","tags":["FE"],"head":true,"headerText":"<span cus-b>B</span><span cus-g>G</span><span cus-s>S</span>","headPic":false,"customCSS":[".vally-header { ","text-align: center;","position: relative;","background-color: #EEE;","background-image: repeating-linear-gradient(-45deg,","    #FFF,","    #FFF 6px,","    transparent 4px,","    transparent 8px",");","line-height: 500px;","font-size: 3.5rem;","text-shadow: none;","transition: all .4s;","}",".vally-header::after {","position: absolute;","content: \"\";","background: linear-gradient(","    0deg, #FFF 50%, transparent 0","), rgba(0,0,0,0);","top: 0;","width: 100%;","height: 100%;","background-size: 100% 4px;","z-index: 10;","left: 0;","}","[cus-b], [cus-g], [cus-s] {","margin: 0 .5rem;","}","[cus-b] {","color: #3498DB;","}","[cus-g] {","color: #1ABC9C;","}","[cus-s] {","color: #9B59B6;","}"],"type":"article","id":"e23ec6747bee37bbea564269ac595dd8","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-04-09T05:21:33.000Z","isDraft":false,"fileDeps":["/images/101793.jpg"],"wordCount":15887},{"title":"活用函数作为一等公民的权利","intro":"JavaScript 里的函数既可以作为参数传递给一个函数，也可以作为函数返回值返回","date":"Tue Apr 18 2017 22:51:11 GMT+0800 (中国标准时间)","category":"code","tags":["FE","JavaScript","FP"],"head":true,"headerStyle":["line-height: 549px;","color: #333;","font-size: 14rem;","text-shadow: 0.5rem 0.3rem 0 rgba(255,255,255,.8), -1.5rem -.5rem 0 rgba(0,0,0,.05), 1rem 0.6rem 0 rgba(0,0,0,.1);","transition: all .4s;"],"headerText":"λ","headPic":false,"customCSS":["header { ","background-color: #EEE;","background-image: repeating-linear-gradient(-45deg,","    #FFF,","    #FFF 6px,","    transparent 4px,","    transparent 8px","), repeating-linear-gradient(0deg,","    #FFF,","    #FFF 6px,","    transparent 4px,","    transparent 8px",");","}","header:after { height: 0px }"],"type":"article","id":"650ea3740c12a08e6ea2db84591c0145","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-04-18T14:51:11.000Z","isDraft":false,"fileDeps":[],"wordCount":4865},{"title":"给自己写一篇有趣的简历","intro":"前几天我写了一篇有趣的简历 ———— 当然是用前端方法写的","date":"Tue May 09 2017 21:21:51 GMT+0800 (中国标准时间)","category":"code","tags":["resume"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"818f9f8550a39e7d6be6c38e685f5f32","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-05-09T13:21:51.000Z","isDraft":false,"fileDeps":["/images/randstr001.jpg","/images/randstr002.png"],"wordCount":3300},{"title":"一个递归问题","intro":"迭代者为人 递归者为神","date":"Tue May 09 2017 22:16:39 GMT+0800 (中国标准时间)","category":"code","tags":["算法"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"0eaa1cf1a29fb69449702bb628803bfd","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-05-09T14:16:39.000Z","isDraft":false,"fileDeps":["/images/digui0509.png"],"wordCount":3331},{"title":"异步发射器","intro":"很多时候，我们有多个异步操作，而且需要每个异步操作的返回值 在这里我有一个可行的方法去抽象这个过程","date":"Tue May 09 2017 22:51:36 GMT+0800 (中国标准时间)","category":"code","tags":["Async"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"b408fd7d085f1f3123fa040add221d91","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-05-09T14:51:36.000Z","isDraft":false,"fileDeps":["/images/launcher_todos.png","/images/launcher_result.png"],"wordCount":2714},{"title":"配置式表单验证 (1)","intro":"以前我写表单验证：一坨坨的 `if else` 混搭，很混乱，而且 很容易出错，如果能像写配置文件那样去处理表单验证问题 ...... 这篇主要讨论表单校验中的 校验器集、值集 以及如何建立关联。 ","date":"Tue May 16 2017 22:19:50 GMT+0800 (中国标准时间)","category":"code","tags":["JavaScript","FE"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"a576940553a72bc504e38a1e9e4659c1","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-05-16T14:19:50.000Z","isDraft":false,"fileDeps":[],"wordCount":3746},{"title":"配置式表单验证 (2)","intro":"这篇是上篇的续篇，主要讨论更加完善的的配置式表单验证","date":"Tue May 17 2017 01:17:32 GMT+0800 (中国标准时间)","category":"code","tags":["JavaScript","FE"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"c7631f87030581275f1224928f29a1f0","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-05-16T17:17:32.000Z","isDraft":false,"fileDeps":[],"wordCount":2885},{"title":"递归穷举所有子字符串","intro":"This is a NEW BLOG Generated By Vally","date":"Sun May 28 2017 02:00:08 GMT+0800 (中国标准时间)","category":"code","tags":["算法"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"d5787c6cd30674c4a3db11fbe59bde7c","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-05-27T18:00:08.000Z","isDraft":false,"fileDeps":["/images/2950274920-5929a2bb95cc4_articlex.png","/images/3525304496-5929a347a1ee2_articlex.png","/images/1616814515-5929a474c2afc.png"],"wordCount":2432},{"title":"递归 DOM树 得到深度","intro":"递归 DOM树 得到深度","date":"Thu Jun 01 2017 16:59:13 GMT+0800 (中国标准时间)","category":"code","tags":["算法"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"ea28731fd9bf34a08d559079cfa4c49d","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-06-01T08:59:13.000Z","isDraft":false,"fileDeps":["/images/dom-tree-res.png"],"wordCount":1743},{"title":"Array.prototype.sort","intro":"数组的原型方法 sort 用于对数组的排序","date":"Sat Jun 03 2017 01:30:58 GMT+0800 (中国标准时间)","category":"code","tags":["FE"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"0adcb81b319b3eafbe493cc974f64f17","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-06-02T17:30:58.000Z","isDraft":false,"fileDeps":[],"wordCount":2971},{"title":"活用原生方法解决数组问题","intro":"本文主要讨论 forEach map filter 这些比较函数式的方法","date":"Wed Jun 07 2017 00:25:14 GMT+0800 (中国标准时间)","category":"code","tags":["JavaScript","编程"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"6e42a7ef1329462a0cb4b42a35575f7c","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-06-06T16:25:14.000Z","isDraft":false,"fileDeps":["/images/forEach-result-20170607.png"],"wordCount":6240},{"title":"两类铺平问题和它们的逆","intro":"数组和对象都可以构成递归结构，暂且把使这类结构平铺成单个对象或者数组的过程称之为平铺","date":"Thu Jun 08 2017 22:18:31 GMT+0800 (中国标准时间)","category":"code","tags":["JavaScript","算法"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"700f4764003c1c142779e083df2fecef","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-06-08T14:18:31.000Z","isDraft":false,"fileDeps":[],"wordCount":6220},{"title":"微信小程序的授权问题","intro":"要说小程序开发有什么一开始没有认真注意的问题，我想应该是授权问题","date":"Sat Aug 05 2017 22:11:17 GMT+0800 (中国标准时间)","category":"code","cateIntro":"Introdution Of This Category","tags":["wx","xcx"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"b61ca28cfec6d41ba2e80da6204b29d5","appTitle":"","appIcon":"","author":"eczn","imgs":[],"time":"2017-08-05T14:11:17.000Z","isDraft":false,"fileDeps":[],"wordCount":4270},{"title":"使用 Mongoose 的各种好处","intro":"原生自然有原生的好处，但是，Mongo 自身的某些特性不太适合开发，比如没有统一的'表'，这会造成很多问题。Mongoose 在很大程度上弥补了这些不足","date":"Sun Sep 10 2017 18:32:03 GMT+0800 (中国标准时间)","category":"code","tags":["DB","Mongo"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"d93263b0ddb121ff4b449cc06f202a58","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-09-10T10:32:03.000Z","isDraft":false,"fileDeps":[],"wordCount":4579},{"title":"jsonp、跨域和同源策略","intro":"jsonp (JSON with Padding) 是一种解决浏览器跨域请求的一种方案，它需要前端代码和后台的共同努力才能实现","date":"Sun Oct 01 2017 02:17:18 GMT+0800 (中国标准时间)","category":"code","cateIntro":"Introdution Of This Category","tags":["jsonp"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"1c036d874a8a331ee80bff44b515f1e1","appTitle":"","appIcon":"","author":"eczn","imgs":[],"time":"2017-09-30T18:17:18.000Z","isDraft":false,"fileDeps":["/images/jsonp-test-result.png","/images/eromanga-sensei.jpg"],"wordCount":4049},{"id":"the-best-conf-for-wechat-dev","title":"微信开发的最佳配置","intro":"微信小程序、网页等开发的某些痛点和解决方案","date":"Mon Oct 02 2017 23:13:33 GMT+0800 (中国标准时间)","category":"code","cateIntro":"Introdution Of This Category","tags":["wechat"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","appTitle":"","appIcon":"","author":"eczn","imgs":[],"time":"2017-10-02T15:13:33.000Z","isDraft":false,"fileDeps":[],"wordCount":1838},{"title":"Vue路由重载以及iOS的自动播放问题","intro":"移动端开发的坑","date":"Wed Oct 25 2017 13:11:16 GMT+0800 (中国标准时间)","category":"code","tags":["微信开发"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"1c5a40a7350b8857c90e1f491d82275b","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-10-25T05:11:16.000Z","isDraft":false,"fileDeps":[],"wordCount":1995},{"title":"Fun with Single-Element CSS Spinner","intro":"转载一篇文章","date":"Thu Nov 02 2017 20:56:15 GMT+0800 (中国标准时间)","category":"code","cateIntro":"Introdution Of This Category","tags":["CSS"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"e4ae4b6560c36ddddc92f7cb63f90989","appTitle":"","appIcon":"","author":"eczn","imgs":[],"time":"2017-11-02T12:56:15.000Z","isDraft":false,"fileDeps":[],"wordCount":3514},{"title":"许愿墙 5.0 经验总结","intro":"许愿墙 V5.0@2017 项目总结","date":"Thu Nov 23 2017 13:10:40 GMT+0800 (中国标准时间)","category":"code","tags":["GW"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"5b316e61572472c3ec70b40f2141e488","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-11-23T05:10:40.000Z","isDraft":false,"fileDeps":["/images/HAPPY-GIRLS-DAY-2.png","/images/routing-to-back.jpg","/images/gw-music-2.png","/images/gw-send-danmaku.jpg"],"wordCount":7139},{"title":"Anything As A Service ?","intro":"各种 XaaS 服务","date":"Thu Nov 30 2017 20:02:02 GMT+0800 (中国标准时间)","category":"code","tags":["Cloud"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"39d612362a82e1192ae85738f48f9382","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-11-30T12:02:02.000Z","isDraft":false,"fileDeps":[],"wordCount":1793},{"id":"proxy-in-web-engineering-and-practice","title":"Web 工程中的代理以及实际应用","intro":"web 开发中遇到的各种代理","date":"Wed Dec 06 2017 10:00:52 GMT+0800 (CST)","category":"code","tags":["Proxy"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-12-06T02:00:52.000Z","isDraft":false,"fileDeps":["/images/diff-proxy.png"],"wordCount":3545},{"title":"用 node.js 模拟一个文件系统","intro":"~~","date":"Fri Dec 15 2017 21:28:58 GMT+0800 (中国标准时间)","category":"code","tags":["OS"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"36939f44284eaf1203e198a65000eb70","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-12-15T13:28:58.000Z","isDraft":false,"fileDeps":[],"wordCount":11333},{"title":"JSON String Parse","intro":"json string parse","date":"Sun Dec 17 2017 21:18:43 GMT+0800 (中国标准时间)","category":"code","tags":["JSON"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"0a5c15b17fbf9d7762ca9ba7b3256552","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-12-17T13:18:43.000Z","isDraft":false,"fileDeps":[],"wordCount":2387},{"title":"函数式的 Promise 对异步的抽象","intro":"没有 Promise 根本没法编程了","date":"Mon Dec 18 2017 21:08:51 GMT+0800 (中国标准时间)","category":"code","tags":["Promise"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"isDraft":false,"type":"article","id":"4023cc5e1afad68761e88b2473168392","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-12-18T13:08:51.000Z","fileDeps":[],"wordCount":5115},{"title":"Ramda 里的 Promise","intro":"ramda 是一个函数式编程的库","date":"Sat Jan 06 2018 16:00:04 GMT+0800 (中国标准时间)","category":"code","tags":["fp"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"isDraft":false,"type":"article","id":"c563dd34435eefc4e8dafc342eefeb27","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2018-01-06T08:00:04.000Z","fileDeps":[],"wordCount":4189},{"title":"CSS 的解析","intro":"怎么样解析 CSS","date":"Sun Jan 14 2018 23:22:22 GMT+0800 (中国标准时间)","category":"code","tags":["CSS","Parser"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"e50320d2fbfedf577c391869eefddda3","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2018-01-14T15:22:22.000Z","isDraft":false,"fileDeps":["/images/css-parse-result.png","/images/css-parse-result-2.png"],"wordCount":4050},{"title":"数组和计算式","intro":"数组可以作为计算式进行计算","date":"Sat Feb 9 2018 16:38:30 GMT+0800 (中国标准时间)","category":"code","tags":["Exp"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"bfb7f9538e7fdf001dfad7146da7882c","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2018-02-09T08:38:30.000Z","isDraft":false,"fileDeps":["/images/calc-result-array-exp.png","/images/calc-result-array-exp-var.png"],"wordCount":2774},{"id":"vars-functions-applys","title":"变量、函数、调用","intro":"实现一个很简单很简单的玩具语言","date":"Sun Feb 11 2018 00:23:25 GMT+0800 (中国标准时间)","category":"code","tags":["Evaluation","very-long"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2018-02-10T16:23:25.000Z","isDraft":false,"fileDeps":["/images/var-fn-call-parse-res.png","/images/scope-intro.svg"],"wordCount":14222},{"title":"EventEmitter","intro":"是什么？怎么用？怎么实现？","date":"Tue Feb 20 2018 13:36:09 GMT+0800 (中国标准时间)","category":"code","tags":["JavaScript"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"1cdbe34735e488e2451b6c75b6c0f000","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2018-02-20T05:36:09.000Z","isDraft":false,"fileDeps":[],"wordCount":4404},{"title":"网络安全与 SSL","intro":"https","date":"Tue Mar 06 2018 15:08:52 GMT+0800 (中国标准时间)","category":"code","tags":["计算机网络"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"3a4ed698fbf1451be9ef2df8a0132556","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2018-03-06T07:08:52.000Z","isDraft":false,"fileDeps":["/images/SSL_handshake_with_two_way_authentication_with_certificates.svg"],"wordCount":4609},{"title":"[Callback, Promise, Async]","intro":"JavaScript 异步解决方案的进化史","date":"Tue Mar 20 2018 01:06:06 GMT+0800 (中国标准时间)","category":"code","tags":["Asynchronous"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"693317dde161ae12dfe6781e43ce28c0","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2018-03-19T17:06:06.000Z","isDraft":false,"fileDeps":["/images/callback-promise-async.jpg"],"wordCount":11802},{"title":"函数默认值与 TDZ","intro":"hello","time":"2018-12-14T16:22:55.000Z","category":"code","tags":["let","TDZ"],"type":"article","id":"ea3db00f8e2f7c38c2a3b05bd3b84334","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"isDraft":false,"fileDeps":[],"wordCount":1766},{"title":"再谈函数和一等公民","intro":"仅用函数实现Pair/链表/二叉树","time":"2019-01-15T21:14:32.000Z","category":"code","tags":["Scheme"],"type":"article","id":"cc2509c14d409f17e9bde0b344d530ab","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"isDraft":false,"fileDeps":[],"wordCount":3885},{"title":"Church Encoding","intro":"Church Encoding 是一种以函数的调用次数为计数方式的编码模式。","date":"Sun Jun 30 2019 01:45:24 GMT+0800 (中国标准时间)","category":"code","tags":["Scheme"],"type":"article","id":"a24239f54c26dccfa7abdfe90a08a367","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2019-06-29T17:45:24.000Z","isDraft":false,"fileDeps":[],"wordCount":2057}],"current":{"type":"markdown","meta":{"title":"[Callback, Promise, Async]","intro":"JavaScript 异步解决方案的进化史","date":"Tue Mar 20 2018 01:06:06 GMT+0800 (中国标准时间)","category":"code","tags":["Asynchronous"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"type":"article","id":"693317dde161ae12dfe6781e43ce28c0","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2018-03-19T17:06:06.000Z","isDraft":false,"fileDeps":["/images/callback-promise-async.jpg"],"wordCount":11802},"nodes":[{"type":"tag","children":[{"type":"text","data":"JavaScript 到处都是异步, 没有异步根本没法编程, 对异步的处理，一直以来都是一条主线，那就是尽可能的以同步的方式来写异步，使得异步过程变得清晰可控。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"本文将会从过去谈到现今，着重介绍回调，Promise，async三种方案的发展和思想。 "},{"type":"tag","children":[{"type":"text","data":"超长文警告"}],"name":"s","attribs":{}}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#回调","className":"markdownIt-Anchor"}},{"type":"text","data":" 回调"}],"name":"h1","attribs":{"id":"回调"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"一个 setTimeout 接受一个函数，一个时间作为参数，将会在给定的时间后执行那个函数。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"这是很多人第一次接触到的异步，也是最为直观的 ———— 异步过程即函数过程，异步执行即函数的异步执行，异步坏境即函数的执行环境（this 和 arguments）"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"setTimeout"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'hello, world'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"1000"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'js'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 先打印 'js', 一秒后打印 'hello, world'"}],"name":"span","attribs":{"className":"token comment"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"而很多 api，都有回调的身影，传入回调，是希望异步操作完成之后能 catch 到执行结果，比如读取文件，在操作系统完成了 IO 读取之后，把数据返回给 js，js 执行回调函数，并把参数传入回调中。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"const"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" fs "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"require"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'fs'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"fs"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"readFile"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'a.md'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"function"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" data"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"if"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"error"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"else"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"data"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"而且，你会发现，标准的异步回调 API，回调函数都是最后一个，而且回调函数的第一个参数是 err，第二个是异步过程蕴含的结果。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"这不是巧合，而是为了把一个异步函数方便的 thunk 化。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#thunk-函数","className":"markdownIt-Anchor"}},{"type":"text","data":" thunk 函数"}],"name":"h1","attribs":{"id":"thunk-函数"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"参阅了阮一峰的 ES6，上面指出了，thunk 函数是用来实现传名调用的。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"以下是例子修改自那本书。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"function"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"f"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"m"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" m "},{"type":"tag","children":[{"type":"text","data":"*"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"2"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"f"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"4"}],"name":"span","attribs":{"className":"token number"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"+"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"5"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 其实就是 f(9)"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 最后返回 18 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 这种先求值的调用方式叫做传值调用 CBC (Call-By-Value)"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 如果这样来写 ... "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"var"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"thunk"}],"name":"span","attribs":{"className":"token function-variable function"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"4"}],"name":"span","attribs":{"className":"token number"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"+"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"5"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"thunk"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// => 返回 9 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"14"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"15"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"function"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"f"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"name"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"16"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"name"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"*"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"2"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"17"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"18"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"19"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"f"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"thunk"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"20"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 其实就是传入  (4 + 5) "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"21"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 等到 f return 的时候才求值 thunk 从而达到传名调用的效果 (Call By Name)"}],"name":"span","attribs":{"className":"token comment"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"我觉得，与其说实现了传名调用，倒不如说 thunk 更像是一种函数的柯里化形式，比如 thunk 版本的 readFile:"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"const"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" fs "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"require"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'fs'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 普通版本 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"fs"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"readFile"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'./a.md'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" data"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" data"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"Thunk"}],"name":"span","attribs":{"className":"token function-variable function"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"file_path"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"callback"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    fs"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"readFile"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"file_path"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" callback"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" read_a_Thunk "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"Thunk"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'./a.md'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 等同于 cb => fs.readFile('./a.md', cb); "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"14"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"read_a_Thunk"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" data"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"15"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" data"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"16"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"这样来看，readFile 的执行被分为两步，一步是文件路径的指定，一步是回调的喂入，只有把参数补齐，函数才会真正的运行，因此传名调用只是一个现象，最关键的是：异步被拖延了，异步的执行变成了一个函数，异步过程的完成需要一个回调函数来发动。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"而前面我提到，标准的异步回调 API，回调函数都是最后一个，而且其参数的位置也总是第一个是err，后面是蕴含值，其原因是为了更好的将一个函数 Thunk 化。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"Thunk"}],"name":"span","attribs":{"className":"token function-variable function"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"fn"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"..."}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":"args"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"callback"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"fn"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"..."}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":"args"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" callback"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"   "},{"type":"tag","children":[{"type":"text","data":"// Thunk 是比较通用的 thunkify 函数 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" readFileThunk "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"Thunk"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"fs"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"readFile"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" read_a_md "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"readFileThunk"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'./a.md'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"read_a_md"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" data"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" data"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"不过，一般来说，生产环境就不要自己写 Thunk 函数了，用别人写好的优质库是最好的, 如 "},{"type":"tag","children":[{"type":"text","data":"thunkify"}],"name":"code","attribs":{}},{"type":"text","data":"。（更好的测试，更多人使用，更长的维护时间）"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"$ "},{"type":"tag","children":[{"type":"text","data":"npm"}],"name":"span","attribs":{"className":"token function"}},{"type":"text","data":" i "},{"type":"tag","children":[{"type":"text","data":"--save"}],"name":"span","attribs":{"className":"token parameter variable"}},{"type":"text","data":" thunkify"}],"name":"pre","attribs":{"className":"prismjs bash rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"安装好后，这样子使用："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"const"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" thunkify "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"require"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'thunkify'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" fs "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"require"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'fs'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" read "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"thunkify"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"fs"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"readFile"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" readPackage "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"read"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'package.json'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'utf8'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"readPackage"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" str"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" str"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"thunk 函数的执行，似乎是把异步的函数执行了一半一样，只传入了部分参数，直到最后把 callback 喂进去，异步过程才真正开始，在使用 Generator 的时候可以利用这一点，完成异步过程的终极解决方案。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"在此，还得说明一下其他的异步方案。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#事件里的异步","className":"markdownIt-Anchor"}},{"type":"text","data":" 事件里的异步"}],"name":"h1","attribs":{"id":"事件里的异步"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"事件的触发常常是异步的，在未来的某个点上执行的，如点击事件，如 onload 事件，关于它的描述，我在 《EventEmitter》 里已经有所解释，此处就不多说，不过，我自己做 Promise-pollyfill 的时候就用到了事件机制来写，可以用来传递消息。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"不过说来，不论是事件，还是 thunk 还是 callback 他们均把函数看成是异步的一等公民，没有函数的异步执行就没有异步过程。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"因而，它们都有回调地域的问题，例如要将文件内容全部大写化，再重新写入："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"const"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" fs "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"require"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'fs'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"/**\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" * @description 读取文件转化成大写\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" * @params { String } file 文件路径 \n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" * @params { Function } ok_cb 回调函数\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" */"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"function"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"fileUpperCase"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"file"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" ok_cb"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 默认参数 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    ok_cb "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" ok_cb "},{"type":"tag","children":[{"type":"text","data":"||"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 参数限制 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"if"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"!"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":"file "},{"type":"tag","children":[{"type":"text","data":"||"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"typeof"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" file "},{"type":"tag","children":[{"type":"text","data":"!=="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'string'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"ok_cb"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'file should be string'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"null"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"14"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"15"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"16"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 读取 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"17"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    fs"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"readFile"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"file"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"read_err"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" data"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"18"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"if"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"read_err"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"19"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"ok_cb"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"read_err"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"null"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"20"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"else"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"21"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"// 写入 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"22"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" toWrite "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" data"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"toString"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"toUpperCase"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"23"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            fs"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"writeFile"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"file"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" toWrite"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"write_err"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" data"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"24"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                "},{"type":"tag","children":[{"type":"text","data":"if"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"write_err"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"25"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                    "},{"type":"tag","children":[{"type":"text","data":"ok_cb"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"write_err"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"null"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"26"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"else"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"27"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                    "},{"type":"tag","children":[{"type":"text","data":"ok_cb"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"null"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" toWrite"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"28"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"29"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"30"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"31"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"32"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"仅仅两层，对错误的 if 判断就很杂乱了，要是再深一点，恐怕就很难维护了，毕竟回调过于粗暴，将异步的先后用嵌套关系来表达，因此就会这样，越嵌越深。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"对，这种异步方式的问题在于，其异步流的先继问题实际上是括号的嵌套问题，而不是我们期望中的 ———— 异步流的先继其实是代码的先继问题。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"那么，如果，将先后关系，表达成代码的先后呢？"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"这是一个好的思路，Promise 就有这种影子了，很好地抽象了异步过程，使得以同步的方式写异步，成为了可能。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#promise","className":"markdownIt-Anchor"}},{"type":"text","data":" Promise"}],"name":"h1","attribs":{"id":"promise"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"以上的回调，thunk，还有事件其实都摆脱不了传递函数所造成的嵌套问题。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"在我看来，Promise 抽象了异步过程，把异步的过程当成了数值来看待，异步说到底也总是某个数据的异步获取，在未来的时候取得，也就是说，一个 Promise 一般来说都会蕴含一个值。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"/**\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" * @description 返回一个 Promise 蕴含的值为 val，将会在 500 ms 后 resolved \n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" * @params { * } val 返回的 Promise 所蕴含的值\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" * @returns { Promise } \n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":" */"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function-variable function"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"val"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"new"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"Promise"}],"name":"span","attribs":{"className":"token class-name"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"res"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"setTimeout"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"val"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"res"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"val"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"500"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"  \n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" p1 "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"1"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// p1 蕴含着 1 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"14"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 500ms 后 console.log(1)"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"15"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"16"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" p2 "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" p1"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"then"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"e"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" e "},{"type":"tag","children":[{"type":"text","data":"+"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"1"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"17"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// p2 蕴含着 2 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"18"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 5000ms 后 console.log(2)"}],"name":"span","attribs":{"className":"token comment"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"而且，最为关键的是，then 会返回一个新 Promise，其蕴含的值是原先的值关于 then 所接收的函数的一个映射。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"换言之，then 即 map，Promise 是一类 Container 是一类 functor。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"这是 Promise 的函数式特性，使得异步流变得很清晰可见了，因为在 then 函数内，异步的先后关系，其实看起来更像是代码的先后关系了。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" p3 "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"3"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 500ms 后 console.log(3)"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" p4 "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" p3"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"then"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"_3"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"_3 "},{"type":"tag","children":[{"type":"text","data":"+"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"1"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"then"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"_4"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"_4 "},{"type":"tag","children":[{"type":"text","data":"+"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"1"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"then"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"_5"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"_5 "},{"type":"tag","children":[{"type":"text","data":"+"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"1"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"catch"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"err"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// p3 先 resolved， 输出 3 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"14"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 紧接着执行 第一个 then 里面的，里面 return 一个 Promise，等待其 resolved 后继续执行之后的 then "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"15"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 然后 500 ms 后输出 4 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"16"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 再 500ms 后输出 5"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"17"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 再 500ms 后输出 6"}],"name":"span","attribs":{"className":"token comment"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"看起来就是以同步的方式写异步了，而且，报错将会被轻而易举的 catch 到。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"看起来好像异步的问题已经解决的差不多了。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"其实并没有，Promise 还缺点什么，你会发现，所谓的同步写异步必须 then 包着才能做到。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"你想过为什么吗？"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"原因在于，只有被 then 包着了，才能监控到 then 里面那个函数的返回值，换言之，异步的过程中，有一段时间 CPU 控制权交给 Promise 了。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"在这个时间里，Promise 判断返回值是不是 Promise，而且还找出了下一个 then 在哪，然后在时机成熟的时候执行它。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"是 Promise 调度了异步的流程，才使得一切如此清晰。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#generator","className":"markdownIt-Anchor"}},{"type":"text","data":" Generator"}],"name":"h1","attribs":{"id":"generator"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"上面提到过，Promise 调度了异步的流程，才使得一切如此清晰。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"与操作系统调度进程一样，Promise 需要一个 CPU 控制权来调度异步。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"如果语言层面上能提供这样的特性，即切换上下文的特性，也许我们可以在形式上做出一个飞跃。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"Generator 应运而生，它允许函数暂停执行，交出上下文，在之后可以继续执行之。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"这就为下一步的终极异步方案打下了语言基础。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"function"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"tag","children":[{"type":"text","data":"*"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'wait 开始执行 ... yield 一个 5 出来'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    \n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" a "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"yield"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"5"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'wait 继续执行 ... 外面给进来的 a = '"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" a"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    \n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'wait 返回 2'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"2"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" it "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 得到一个遍历器 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"14"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"15"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"it"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"next"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"16"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 输出：wait 开始执行 ... yield 一个 5 出来"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"17"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 返回：{value: 5, done: false} "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"18"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"19"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"it"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"next"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"123"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"20"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 输出：wait 继续执行 ... 外面给进来的 a =  123"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"21"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 返回：{value: 2, done: true}"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"22"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"23"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"it"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"next"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"24"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 返回：{value: undefined, done: true}"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"25"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 函数执行完毕"}],"name":"span","attribs":{"className":"token comment"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"一开始我觉得这种方式执行函数很古怪，但细细想来，发现了这种函数执行的方式，似乎是将函数的执行，变成某种数据结构的遍历了，Generator 函数执行的结果是返回一个遍历器实例，可以调用 next 方法遍历它，其中 yield 关键字的右边是传递出去的值，而 yield 本身的值，是外部传进来的值。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"如："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" a "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"yield"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"5"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// yield 表达式 ;"}],"name":"span","attribs":{"className":"token comment"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"上面的内部的 5，也是一个表达式，会被传递出去。而整个括号，也会有返回值，也是一个 "},{"type":"tag","children":[{"type":"text","data":"表达式"}],"name":"code","attribs":{}},{"type":"text","data":"，比如：在外部调用 next, 会得到 5, 但下一次调用 next(10) 继续执行 Generator 函数时，这个 a 就变成 10 了。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[],"name":"hr","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"如果我们不同步的调用 next，而是异步的调用 next，Generator 内部的异步过程，是不是可以变成同步了？"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"好像是！试想想："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"const"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" fs "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"require"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'fs'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"function"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"tag","children":[{"type":"text","data":"*"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"double_read"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"file"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" fileA   "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"yield"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" file"},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" fileA_2 "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"yield"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" file"},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"fileA "},{"type":"tag","children":[{"type":"text","data":"+"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" fileA_2"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 来，现在让 double_read 变成 `同步` 的"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" it "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"double_read"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'./po.js'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" fileA_name "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" it"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"next"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"value"},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"14"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"15"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 为了讨论方便，在此不做错误处理 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"16"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"fs"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"readFile"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"fileA_name"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" data"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"17"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" fileB_name "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" it"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"next"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"data"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"toString"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"value"},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"18"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"19"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    fs"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"readFile"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"fileB_name"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" data"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"20"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        it"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"next"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"data"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"toString"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"21"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"22"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"可以看见，如果要执行 Generator 函数，得要有相应的代码去遍历返回的遍历器，这个代码叫做遍历器，也就是说，Generator 函数的执行离不开遍历器。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"遍历器，或者说是执行器，实际上，可以用来做调度，这就为同步的写异步代码做足了基础。上述的例子里，我们已经完成了用同步的方法写异步的形式，不过这需要一个复杂的执行器才能进行。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"因此 double_read 的执行，看起来是同步的，但是其内部执行是完全异步的。yield 把函数卡住了，这时候就可以跳出来执行调度代码了，之后再继续执行函数，这样函数的执行看起来就好像是同步的了，形式上也跟同步代码保持一致了。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"而如果能写一个通用的执行器，那么异步问题将会有一个较好的解决方案：以同步的方式写异步，以下是 "},{"type":"tag","children":[{"type":"text","data":"po"}],"name":"code","attribs":{}},{"type":"text","data":" 模块"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"const"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" po "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"require"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'./po'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 假想中的通用执行器 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 下文会实现它 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 前文的 wait 函数 会返回一个 Promise "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function-variable function"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"val"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"new"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"Promise"}],"name":"span","attribs":{"className":"token class-name"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"res"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"setTimeout"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"val"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"res"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"val"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"500"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"  \n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"po"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"function"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"*"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"looooong"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" val "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"0"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"0"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"0"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"0"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"14"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"15"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"for"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" i "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"0"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" i "},{"type":"tag","children":[{"type":"text","data":"&lt;"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" val"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"length"},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" i"},{"type":"tag","children":[{"type":"text","data":"++"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"16"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        val"},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"i"},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"yield"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"i"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"17"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"// 假想中的执行器在遇到 yield 的时候会跳出"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"18"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"// 接着执行器调用 wait(idx).then 来取出 Promise 的蕴含值 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"19"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"// 取得蕴含值后继续执行函数"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"20"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"21"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"22"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 理想中的执行情况: "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"23"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 500ms 0"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"24"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 1000ms 1 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"25"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 1500ms 2 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"26"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 2000ms 3"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"27"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"以下，是 "},{"type":"tag","children":[{"type":"text","data":"po"}],"name":"code","attribs":{}},{"type":"text","data":" 模块的实现, 为了谈论方便，我没有考虑错误处理。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// po "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"module"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"exports "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" po"},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"function"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"po"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"generator_func"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" iter "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"generator_func"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"_po"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"iter"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"function"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"_po"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"iter"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" para "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"null"}],"name":"span","attribs":{"className":"token keyword"}}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" p "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" iter"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"next"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"para"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 如果 Generator 函数执行完毕，return 结束"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"if"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"p"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"done"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"14"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"15"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// p.value 是 yield 右边的表达式的值 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"16"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 这里是 Promise，利用 then 方法取出其蕴含值"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"17"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 取得值后继续执行 generator 函数 (递归的执行)"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"18"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    p"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"value"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"then"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"async_val"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"19"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"_po"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"iter"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" async_val"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"20"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"21"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"当然，早有人实现了上述所说的执行器，那就是 "},{"type":"tag","children":[{"type":"text","data":"co"}],"name":"code","attribs":{}},{"type":"text","data":" 模块，它不仅仅支持 Promise 的 yield 还支持 thunk 函数。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"$ "},{"type":"tag","children":[{"type":"text","data":"npm"}],"name":"span","attribs":{"className":"token function"}},{"type":"text","data":" i "},{"type":"tag","children":[{"type":"text","data":"--save"}],"name":"span","attribs":{"className":"token parameter variable"}},{"type":"text","data":" co"}],"name":"pre","attribs":{"className":"prismjs bash rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"安装好之后如下使用："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"const"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" co "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"require"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'co'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" fs "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"require"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'fs'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" thunkify "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"require"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'thunkify'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" readFile "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"thunkify"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"fs"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"readFile"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" read_po "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"readFile"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'./po.js'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'utf-8'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"co"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"function"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"*"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" _1 "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"yield"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"1"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" pojs "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"yield"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" read_po\n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"_1"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"pojs"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"可以看到，只 yield 了一个 read_po 函数出去，co 模块就可以完成读取 po.js 的异步过程。仔细想想，读取 po.js 实际上就差一个 callback 了而已，此处由 co 模块提供这个 callback 去执行这个异步过程，进而将结果返回到 Generator 函数里继续执行。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"这就是为什么要 thunk 的原因，补齐异步所需的参数，只差最终的一个调度。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[],"name":"hr","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"额，前文所述的都是一个接着一个的执行，那可不可以并发呢？ 当然可以："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"co"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"function"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"*"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" _1_p "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"1"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" _2_p "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"2"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" _1_2 "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"yield"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" Promise"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"all"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"_1_p"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" _2_p"},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// let _1_2 = yield ([_1_p, _2_p]); "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 这样写也是可以的。 co 模块也支持处理 Promises"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"_1"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" _2"},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" _1_2"},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'函数结束:'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" _1"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" _2"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"yield 意味着等待，函数暂停执行，切换上下文到 co 模块，co 模块做完处理后重启函数的执行，因此函数的执行看起来就像是同步的方式执行异步代码了。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#async-await","className":"markdownIt-Anchor"}},{"type":"text","data":" Async / Await"}],"name":"h1","attribs":{"id":"async-await"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"即上文的 Generator / Co 的一个语法糖。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"co"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"function"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"*"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" _1_p "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"1"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" _2_p "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"2"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" _1_2 "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"yield"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" Promise"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"all"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"_1_p"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" _2_p"},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// let _1_2 = yield ([_1_p, _2_p]); "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 这样写也是可以的。 co 模块也支持处理 Promises"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"_1"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" _2"},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" _1_2"},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'函数结束:'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" _1"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" _2"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 等于 ==> "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"14"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"15"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"async"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"function"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"16"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" _1_p "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"1"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"17"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" _2_p "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"2"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"18"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"19"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" _1_2 "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"await"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" Promise"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"all"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"_1_p"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" _2_p"},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"20"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 注意, 此处就不支持下面这种省略的写法了 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"21"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// let _1_2 = await ([_1_p, _2_p]); "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"22"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"23"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"_1"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" _2"},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" _1_2"},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"24"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"25"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'函数结束:'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" _1"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" _2"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"26"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"async / await 是语言层面上的实现，性能比 co / generaotr 要好，因此建议直接使用 async 函数，而不是利用 co 模块。 (koa1 本来是 co / generator 实现的，但出了 asnyc 函数之后就全套使用 async 函数了，变成 koa2 了)"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"async 也不用像 generator 一样需要执行器，其执行器是语言内部实现的，无需自己导入 co 模块。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#各方案错误处理","className":"markdownIt-Anchor"}},{"type":"text","data":" 各方案错误处理"}],"name":"h1","attribs":{"id":"各方案错误处理"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"异步有个问题，那就是错误处理的问题。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#回调函数-thunk-的错误处理","className":"markdownIt-Anchor"}},{"type":"text","data":" 回调函数 / thunk 的错误处理"}],"name":"h2","attribs":{"id":"回调函数-thunk-的错误处理"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"标准的异步 API 里，回调函数的第一个参数总是错误 err，这是约定。如果无错误，则 err 是 null，如果有则是错误对象。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"const"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" fs "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"require"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'fs'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"fs"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"readFile"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'test.md'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'utf-8'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" data"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"if"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"else"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"data"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"在回调地狱的情况下，这样的处理方式实在是难以接受，代码复杂度会一下子上去，会写很多的 if 分支去判断情况，很难追踪，嵌套愈深，愈难理清关系。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#promise-的错误处理","className":"markdownIt-Anchor"}},{"type":"text","data":" Promise 的错误处理"}],"name":"h2","attribs":{"id":"promise-的错误处理"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"相比前者，Promise 的方案就清晰多了。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"前文说过，Promise 把异步过程抽象成数值 (容器) 了，整个容器蕴含着数值，将会在 resolved 的时候变得可用，其错误也是一样，将会在 rejected 的时候可用。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 前文的 wait 函数 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"1"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"then"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"_1"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"_1"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// => 1 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 如果此处抛出错误 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"throw"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'error !'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"then"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"_2"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 那么此处不会执行 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"_2"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"catch"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"err"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// `error !`"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"14"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 如果此处返回了一个非 rejected 的 promise"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"15"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"2"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"16"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"then"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"_2"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"17"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// promise 执行流将会回归正常"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"18"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"_2"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"19"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"20"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 否则 如果返回一个 rejected 的 Promise "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"21"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" Promise"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"reject"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'i am error!'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"22"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"catch"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"err"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"23"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// 那么又会跳回错误流的执行"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"24"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'err'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"25"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"// `i am error!`; "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"26"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#co-async","className":"markdownIt-Anchor"}},{"type":"text","data":" co / async"}],"name":"h2","attribs":{"id":"co-async"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"co 和 async 的本质上是一样的，以同步的方式写异步，因此错误处理，也一样是以同步的方式去处理，使得可以使用同步的 try / catch 去捕获错误。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"async"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"function"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"try"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" _1 "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"wait"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"1"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"catch"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"err"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"这也带来了，以同步的方式处理错误的回归。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#tldr","className":"markdownIt-Anchor"}},{"type":"text","data":" TL;DR"}],"name":"h1","attribs":{"id":"tldr"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"JavaScript 近十几年的发展，终于摆脱了回调地狱，拥抱 Promise。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"直到看到了切换上下文的 Generator，意识到了异步不过是跳出和返回，才有了 co 模块，才有了现今 async / await 的终极解决方案。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"对异步的探索，其实一直都是一条主线，那就是同步的方式写异步，使得异步流尽可能的清晰可见。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[],"name":"img","attribs":{"src":"/images/callback-promise-async.jpg","alt":"应该配张图的"}}],"name":"p","attribs":{}},{"type":"text","data":"\n"}],"rawContent":""}}}},"BlogApiState":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"HomeApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"TimeLineApiState":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"SettingApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"LaunchpadApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}}}</script>
<!--SCRIPT-->
</body>
</html>
