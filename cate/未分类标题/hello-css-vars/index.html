<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<title>未分类标题 | Hello CSS 变量 | Eczn's Home</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,minimal-ui">
<meta name="format-detection" content="telephone=no">

<style id="CSS_VARS"></style>
<script>
(function() {
console.log('INIT CSS VAR');
function loadCSSVars() {
    const j = localStorage.getItem("CSS_VARS_2" /* STORAGE_KEY.CSS_VARS */);
    const initialVars = initialCSSVars();
    if (!j)
        return initialVars;
    try {
        const result = {
            ...initialVars,
            ...JSON.parse(j)
        };
        console.log('loadCSSVars from storage', result);
        return result;
    }
    catch (error) {
        console.error('load css vars with error', error);
        return initialVars;
    }
}
function renderCSSVars(vars, style) {
    const allDefine = Object.keys(vars).map(k => {
        const v = vars[k];
        const cssValue = typeof v === 'number' ? `${v}px` : v;
        return `--${k}:${cssValue};`;
    }).join('\n');
    if (style) {
        style.innerHTML = `:root { ${allDefine} }`;
    }
    else {
        console.error(`style#CSS_VARS NotFound !`);
    }
}
function initialCSSVars() {
    let rem = 16;
    // 移动端
    if (typeof window !== 'undefined' && window.innerWidth <= 500) {
        rem = Number(((window.innerWidth - 20) / 42).toFixed(1));
        console.log('mobile calculated rem =>', rem);
    }
    return {
        rem,
        enableSmallerFont: false,
        displayToc: 'block',
        fontSmcp: 'source serif pro, serif',
        fontCode: 'consolas, Menlo, monospace',
        fontTitle: 'Noto Serif SC, serif',
        fontArticle: 'source serif pro, LXGW WenKai',
        fontSansSerif: 'sans-serif',
    };
}
window.__initialCSSVars = loadCSSVars();
renderCSSVars(__initialCSSVars, document.querySelector('#CSS_VARS'));
})();
</script>

<link rel="icon" href="/favicon.png"><script defer="defer" src="/js/index.c464742b.js"></script><script defer="defer" src="/js/chunk-lib.c90ce4c7.js"></script><link href="/css/index.b0e70e3c588e68d62835.css" rel="stylesheet"><link href="/css/chunk-lib.5c7d4887bb8714b00c54.css" rel="stylesheet"></head>
<body x-apple-data-detectors="none">
<noscript>当前浏览器不支持 JavaScript, 建议使用支持 JavaScript 的浏览器来访问此网站 !</noscript>
<div id="rally-bg" style="opacity:0"></div>
<div id="app"><div class="ball-canvas-container"></div><nav class="nav-main --fontSmcp"><div class="_title default-max-width">Eczn&#x27;s Home</div><div class="smcphr"></div><div class="_links default-max-width"><a class="r-link _link clickable r-link" href="/">Home</a><a class="r-link _link clickable r-link" href="/tl/0/">Timeline</a><a class="r-link _link clickable r-link" href="/cate/all/">Category</a><a class="r-link _link clickable r-link" href="/setting/">Setting</a><a class="r-link _link clickable r-link" href="/launchpad/">Launchpad</a></div></nav><div class="std-box category-main category-detail default-max-width"><div class="std-box-content "><div class="_cate-header"><div class="_blog-links"><a class="r-link _blog-link --fontTitle" href="/cate/未分类标题/test-tsx-article-for-new-version/"><span class="_nth">#<!-- -->0</span>新版博客测试文章 (.tsx)</a><a class="r-link _blog-link --fontTitle" href="/cate/未分类标题/62ca7f2093a59fcbab91ce9ad5fd9c37/"><span class="_nth">#<!-- -->1</span>Markdown 快速上手</a><a class="r-link _blog-link --fontTitle" href="/cate/未分类标题/three-body-emulator/"><span class="_nth">#<!-- -->2</span>三体运动模拟器</a><a class="r-link _blog-link --fontTitle" href="/cate/未分类标题/is-esm-robust-enough-in-broswer/"><span class="_nth">#<!-- -->3</span>浏览器内的 ESM 是否已足够强大</a><a class="r-link _blog-link --fontTitle" href="/cate/未分类标题/white-noise-webgl/"><span class="_nth">#<!-- -->4</span>从白噪声开始学习 WebGL</a><a class="r-link _blog-link --fontTitle" href="/cate/未分类标题/the-adt-in-ts/"><span class="_nth">#<!-- -->5</span>TypeScript 里的 ADT</a><a class="r-link _blog-link --fontTitle _active" href="/cate/未分类标题/hello-css-vars/"><span class="_nth">#<!-- -->6</span>Hello CSS 变量</a><a class="r-link _blog-link --fontTitle" href="/cate/未分类标题/css-matrix3d-calc/"><span class="_nth">#<!-- -->7</span>CSS Matrix3D 中的矩阵运算</a><a class="r-link _blog-link --fontTitle" href="/cate/未分类标题/latex-notes/"><span class="_nth">#<!-- -->8</span>LaTeX 笔记</a><a class="r-link _blog-link --fontTitle" href="/cate/未分类标题/ipod-spin-gesture/"><span class="_nth">#<!-- -->9</span>iPod 转盘手势</a><a class="r-link _blog-link --fontTitle" href="/cate/未分类标题/app-pinch/"><span class="_nth">#<!-- -->10</span>Pinch 捏放手势</a><a class="r-link _blog-link --fontTitle" href="/cate/未分类标题/old-demos/"><span class="_nth">#<!-- -->11</span>早期 DEMO 集</a><a class="r-link _blog-link --fontTitle" href="/cate/未分类标题/binary-complement-principle/"><span class="_nth">#<!-- -->12</span>二进制补码的数学原理</a><a class="r-link _blog-link --fontTitle" href="/cate/未分类标题/moonbit-start/"><span class="_nth">#<!-- -->13</span>Moonbit, 启动</a><a class="r-link _blog-link --fontTitle" href="/cate/未分类标题/parser-combinator/"><span class="_nth">#<!-- -->14</span>Parser Combinator</a></div><div class="_cate-title --fontTitle">分类「 <!-- -->未分类标题<!-- --> 」</div></div><div><div id="start" class="blog-header-main"><div class="_infos"><div class="_info"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="clock" class="svg-inline--fa fa-clock fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256,8C119,8,8,119,8,256S119,504,256,504,504,393,504,256,393,8,256,8Zm92.49,313h0l-20,25a16,16,0,0,1-22.49,2.5h0l-67-49.72a40,40,0,0,1-15-31.23V112a16,16,0,0,1,16-16h32a16,16,0,0,1,16,16V256l58,42.5A16,16,0,0,1,348.49,321Z"></path></svg>2023-08-12</div></div><div class="_title --fontTitle">Hello CSS 变量</div></div><article><div class="toc"><div class="toc-item _active" style="padding-left:0em"><a href="#define" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>声明和使用变量</a></div><div class="toc-item" style="padding-left:0em"><a href="#waht-is-root" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>:root 是什么</a></div><div class="toc-item" style="padding-left:0em"><a href="#site-theme-practice" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>站点主题实践</a></div><div class="toc-item" style="padding-left:1em"><a href="#define-types" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>定义类型</a></div><div class="toc-item" style="padding-left:1em"><a href="#render-cssvars" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>CSSVars 渲染到 &lt;style&gt;</a></div><div class="toc-item" style="padding-left:1em"><a href="#storage-cssvars" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>考虑持久化</a></div><div class="toc-item" style="padding-left:1em"><a href="#user-cssvars-demo" data-minimap-color="#CCCCCC"><span class="_hashtag">##</span>用户配置界面 (demo)</a></div><div class="toc-item" style="padding-left:0em"><a href="#end-of-file" data-minimap-color="#CCCCCC"><span class="_hashtag">#</span>EOF</a></div><div class="_index --fontSmcp" data-minimap="Ignore">Indexes</div><div class="smcphr"></div></div><div class="r-article"><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">很早就听过和简单看过 CSS 变量了，但是一直没有正式找场景使用过，这两天实装了一下本站的 Setting 页，里面用了 CSS 变量，本文总结一下经验:</div><a href="/setting/" target="_blank" style="background-color:#dddfde" class="std-link --fontSansSerif  _block" data-minimap-color="#dddfde"><span class="std-link-icon r-link" data-src="/get-favicon/eczn.github.io?h=-1911350002" style="background-image:url(&quot;/get-favicon/eczn.github.io?h=-1911350002&quot;)"></span><span class="std-link-txt">Setting | 系统设置</span></a><h1 id="define" class="std-title --fontTitle"><a href="#define" class="markdownIt-Anchor">#</a> 声明和使用变量<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">可以按照如下方式声明和使用一个 CSS 变量</div><div class="col-main" style="display:flex;margin-bottom:16px"><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-code"><pre class="prismjs css rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token selector">:root</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">01</span>  <span class="token property">--REM</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token punctuation">}</span></pre></div></div><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="std-code"><pre class="prismjs css rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token selector">html</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">01</span>  <span class="token property">font-site</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--REM<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token punctuation">}</span></pre></div></div></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">在上述两个例子中，声明了一个叫做 <div class="std-inline-code" data-minimap-color="#f5e9e9">--REM</div> 的变量，其值为 14px, 然后通过 <div class="std-inline-code" data-minimap-color="#f5e9e9">var()</div> 的方式将其绑定到 html 的 fontSizte 属性上</div><h1 id="waht-is-root" class="std-title --fontTitle"><a href="#waht-is-root" class="markdownIt-Anchor">#</a> :root 是什么<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">通过 :root 可以指定变量的作用域为全局。在大多数情况下我们只需要声明到 <div class="std-inline-code" data-minimap-color="#f5e9e9">:root</div> 全局中即可, 我暂时没有碰到需要单独定义作用域的情况, 可以通过这种方式单独指定变量作用域:</div><div class="std-code"><pre class="prismjs css rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token selector">div</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">01</span>  <span class="token property">--PRIMARY-COLOR</span><span class="token punctuation">:</span> #BBB<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token punctuation">}</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">叙述 CSS 变量的用法不是本文重点，相关细节可以参考 MDN:</div><a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Using_CSS_custom_properties" target="_blank" style="background-color:#e1eae4" class="std-link --fontSansSerif  _block" data-minimap-color="#e1eae4"><span class="std-link-icon r-link" data-src="/get-favicon/developer.mozilla.org?h=-5095327696" style="background-image:url(&quot;/get-favicon/developer.mozilla.org?h=-5095327696&quot;)"></span><span class="std-link-txt">MDN - 使用 CSS 自定义属性（变量）</span></a><h1 id="site-theme-practice" class="std-title --fontTitle"><a href="#site-theme-practice" class="markdownIt-Anchor">#</a> 站点主题实践<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">CSS 变量一个最常见的用法就是实现站点主题的配置化、动态化 —— 以往 less / sass 那种预处理器的主题是要过静态编译才出来的，很多时候有各种限制，不好用, 现在借助 CSS 变量, 配合 js 就能做更完善的用户主题实践</div><h2 id="define-types" class="std-title --fontTitle">定义类型</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">实现站点主题配置，需要先设计相关类型，举个例子：实现按钮颜色的配置</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">// css-vars.tsx</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token comment">// CSS 变量</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">CSSVars</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">03</span>  buttonColor<span class="token operator">:</span> string
<span class="line-numbers-rows" style="user-select: none;">04</span><span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">05</span>
<span class="line-numbers-rows" style="user-select: none;">06</span><span class="token comment">// 获取默认变量配置</span>
<span class="line-numbers-rows" style="user-select: none;">07</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initialCSSVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> CSSVars <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">08</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">09</span>    buttonColor<span class="token operator">:</span> <span class="token string">'#e3e3e3'</span>
<span class="line-numbers-rows" style="user-select: none;">10</span>  <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">11</span><span class="token punctuation">}</span></pre></div><h2 id="render-cssvars" class="std-title --fontTitle">CSSVars 渲染到 &lt;style&gt;</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">还需要将这个 CSSVars 类型转成一段 CSS 内容并注入到 style 标签中才能使其作为 CSS 变量使用:</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">// render-css-vars.tsx</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token keyword">import</span> <span class="token punctuation">{</span> CSSVars<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./css-vars'</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token comment">// 将 vars 的内容渲染到 style 中</span>
<span class="line-numbers-rows" style="user-select: none;">04</span><span class="token comment">// 以此处的 CSSVars 来说，渲染结果类似这样：</span>
<span class="line-numbers-rows" style="user-select: none;">05</span><span class="token comment">// &lt;style></span>
<span class="line-numbers-rows" style="user-select: none;">06</span><span class="token comment">// :root { --buttonColor: #BBB; }</span>
<span class="line-numbers-rows" style="user-select: none;">07</span><span class="token comment">// &lt;\/style></span>
<span class="line-numbers-rows" style="user-select: none;">08</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderCSSVars</span><span class="token punctuation">(</span>
<span class="line-numbers-rows" style="user-select: none;">09</span>  vars<span class="token operator">:</span> CSSVars<span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">10</span>  style<span class="token operator">?</span><span class="token operator">:</span> Element
<span class="line-numbers-rows" style="user-select: none;">11</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">12</span>  <span class="token keyword">const</span> allDefine <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>vars<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>k <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">13</span>    <span class="token keyword">const</span> v <span class="token operator">=</span> vars<span class="token punctuation">[</span>k <span class="token keyword">as</span> keyof CSSVars<span class="token punctuation">]</span>
<span class="line-numbers-rows" style="user-select: none;">14</span>    <span class="token keyword">const</span> cssValue <span class="token operator">=</span> <span class="token keyword">typeof</span> v <span class="token operator">===</span> <span class="token string">'number'</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>v<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> v
<span class="line-numbers-rows" style="user-select: none;">15</span>    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">--</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cssValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span>
<span class="line-numbers-rows" style="user-select: none;">16</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">17</span>
<span class="line-numbers-rows" style="user-select: none;">18</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>style<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">19</span>    style<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">:root { </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>allDefine<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> }</span><span class="token template-punctuation string">`</span></span>
<span class="line-numbers-rows" style="user-select: none;">20</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">21</span>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">style#CSS_VARS NotFound !</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">22</span>  <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">23</span><span class="token punctuation">}</span></pre></div><h2 id="storage-cssvars" class="std-title --fontTitle">考虑持久化</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">在正式调用 renderCSSVars 之前我们还需要考虑怎么保存用户配置的 CSSVars, 即持久化, 可以使用 localStorage 进行存储:</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token keyword">import</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">01</span>  CSSVars<span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>  initialCSSVars<span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./css-vars'</span>
<span class="line-numbers-rows" style="user-select: none;">04</span>
<span class="line-numbers-rows" style="user-select: none;">05</span><span class="token comment">/** 保存 CSS Vars */</span>
<span class="line-numbers-rows" style="user-select: none;">06</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">saveCSSVars</span><span class="token punctuation">(</span>cssVars<span class="token operator">:</span> CSSVars<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">07</span>  <span class="token keyword">const</span> j <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>cssVars<span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">08</span>  localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'EXAMPLE_CSS_VARS'</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">09</span><span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">10</span>
<span class="line-numbers-rows" style="user-select: none;">11</span><span class="token comment">/** 读取 CSSVars */</span>
<span class="line-numbers-rows" style="user-select: none;">12</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">loadCSSVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> CSSVars <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">13</span>  <span class="token comment">// 服务端渲染场景直接返回初始 CSS 变量即可</span>
<span class="line-numbers-rows" style="user-select: none;">14</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">15</span>    <span class="token keyword">return</span> <span class="token function">initialCSSVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">16</span>  <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">17</span>
<span class="line-numbers-rows" style="user-select: none;">18</span>  <span class="token keyword">const</span> j <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'EXAMPLE_CSS_VARS'</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">19</span>  <span class="token keyword">const</span> initialVars <span class="token operator">=</span> <span class="token function">initialCSSVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">20</span>  <span class="token comment">// 如果之前没存过, 直接返回</span>
<span class="line-numbers-rows" style="user-select: none;">21</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>j<span class="token punctuation">)</span> <span class="token keyword">return</span> initialVars
<span class="line-numbers-rows" style="user-select: none;">22</span>
<span class="line-numbers-rows" style="user-select: none;">23</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">24</span>    <span class="token comment">// 注意这里是覆盖的</span>
<span class="line-numbers-rows" style="user-select: none;">25</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">26</span>      <span class="token operator">...</span>initialVars<span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">27</span>      <span class="token operator">...</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token keyword">as</span> CSSVars
<span class="line-numbers-rows" style="user-select: none;">28</span>    <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">29</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">30</span>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'load css vars with error'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">31</span>    <span class="token comment">// 出错后直接返回 initialVars</span>
<span class="line-numbers-rows" style="user-select: none;">32</span>    <span class="token keyword">return</span> initialVars
<span class="line-numbers-rows" style="user-select: none;">33</span>  <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">34</span><span class="token punctuation">}</span></pre></div><h2 id="user-cssvars-demo" class="std-title --fontTitle">用户配置界面 (demo)</h2><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">最后一步是写组件让用户可以配置并持久化存储自己的 CSSVars, 以下是我实现的一个简单的组件 DEMO:</div><div class="col-main" style="display:flex;margin-bottom:16px"><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div><div>请点击下面色框选取颜色, <br/>当前色值: #e3e3e3</div><input type="color" value="#e3e3e3"/></div></div><div style="width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px"><div class="button-main --fontSansSerif  normal" style="font-size:inherit;background-color:#e3e3e3"><span>这是一个空按钮</span></div></div></div><details><summary><div class="std-para --fontArticle" data-minimap-color="#CCCCCC" style="display:inline-block">完整实现如下，已折叠，点击展开</div></summary><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token comment">// user-cssvars.tsx</span>
<span class="line-numbers-rows" style="user-select: none;">01</span><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="line-numbers-rows" style="user-select: none;">02</span><span class="token keyword">import</span> <span class="token punctuation">{</span> Col<span class="token punctuation">,</span> Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rally/@@'</span>
<span class="line-numbers-rows" style="user-select: none;">03</span><span class="token keyword">import</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">04</span>  renderCSSVars
<span class="line-numbers-rows" style="user-select: none;">05</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./render-css-vars'</span>
<span class="line-numbers-rows" style="user-select: none;">06</span><span class="token keyword">import</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">07</span>  loadCSSVars<span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">08</span>  saveCSSVars<span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">09</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./storage-css-vars'</span>
<span class="line-numbers-rows" style="user-select: none;">10</span>
<span class="line-numbers-rows" style="user-select: none;">11</span><span class="token keyword">function</span> <span class="token function">getStyleElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Element <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">12</span>  <span class="token keyword">const</span> styleId <span class="token operator">=</span> <span class="token string">'example-style'</span>
<span class="line-numbers-rows" style="user-select: none;">13</span>  <span class="token keyword">let</span> style <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>styleId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">14</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>style<span class="token punctuation">)</span> <span class="token keyword">return</span> style<span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">15</span>  <span class="token comment">// 如果没有则构造一个并插入到 body 中</span>
<span class="line-numbers-rows" style="user-select: none;">16</span>  style <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">17</span>  style<span class="token punctuation">.</span>id <span class="token operator">=</span> styleId
<span class="line-numbers-rows" style="user-select: none;">18</span>  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">19</span>  <span class="token keyword">return</span> style
<span class="line-numbers-rows" style="user-select: none;">20</span><span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">21</span>
<span class="line-numbers-rows" style="user-select: none;">22</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">UserCssVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">23</span>  <span class="token comment">// 读取变量并作为 react state 使用</span>
<span class="line-numbers-rows" style="user-select: none;">24</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>cssvars<span class="token punctuation">,</span> setCssVars<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span>
<span class="line-numbers-rows" style="user-select: none;">25</span>    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">loadCSSVars</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">26</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">27</span>
<span class="line-numbers-rows" style="user-select: none;">28</span>  React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">29</span>    <span class="token comment">// 每次状态变化后渲染并存储</span>
<span class="line-numbers-rows" style="user-select: none;">30</span>    <span class="token comment">// 这里刷新比较频繁, 写个 timer 优化一下</span>
<span class="line-numbers-rows" style="user-select: none;">31</span>    <span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">32</span>      <span class="token function">renderCSSVars</span><span class="token punctuation">(</span>cssvars<span class="token punctuation">,</span> <span class="token function">getStyleElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">33</span>      <span class="token function">saveCSSVars</span><span class="token punctuation">(</span>cssvars<span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">34</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">35</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">36</span>      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">37</span>    <span class="token punctuation">}</span>
<span class="line-numbers-rows" style="user-select: none;">38</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>cssvars<span class="token punctuation">.</span>buttonColor<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">39</span>
<span class="line-numbers-rows" style="user-select: none;">40</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>
<span class="line-numbers-rows" style="user-select: none;">41</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Col</span></span><span class="token punctuation">></span></span><span class="token plain-text">
<span class="line-numbers-rows" style="user-select: none;">42</span>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
<span class="line-numbers-rows" style="user-select: none;">43</span>        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
<span class="line-numbers-rows" style="user-select: none;">44</span>          请点击下面色框选取颜色, </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span><span class="token plain-text">
<span class="line-numbers-rows" style="user-select: none;">45</span>          当前色值: </span><span class="token punctuation">{</span>cssvars<span class="token punctuation">.</span>buttonColor<span class="token punctuation">}</span><span class="token plain-text">
<span class="line-numbers-rows" style="user-select: none;">46</span>        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
<span class="line-numbers-rows" style="user-select: none;">47</span>        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
<span class="line-numbers-rows" style="user-select: none;">48</span>          <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>color<span class="token punctuation">"</span></span>
<span class="line-numbers-rows" style="user-select: none;">49</span>          <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>cssvars<span class="token punctuation">.</span>buttonColor<span class="token punctuation">}</span></span>
<span class="line-numbers-rows" style="user-select: none;">50</span>          <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>e <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">51</span>            <span class="token function">setCssVars</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">52</span>              buttonColor<span class="token operator">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value
<span class="line-numbers-rows" style="user-select: none;">53</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" style="user-select: none;">54</span>          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line-numbers-rows" style="user-select: none;">55</span>        <span class="token punctuation">/></span></span><span class="token plain-text">
<span class="line-numbers-rows" style="user-select: none;">56</span>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
<span class="line-numbers-rows" style="user-select: none;">57</span>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Button</span></span>
<span class="line-numbers-rows" style="user-select: none;">58</span>        <span class="token attr-name">icon</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>play<span class="token punctuation">"</span></span>
<span class="line-numbers-rows" style="user-select: none;">59</span>        <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">60</span>          backgroundColor<span class="token operator">:</span> cssvars<span class="token punctuation">.</span>buttonColor<span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">61</span>        <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
<span class="line-numbers-rows" style="user-select: none;">62</span>        这是一个空按钮
<span class="line-numbers-rows" style="user-select: none;">63</span>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Button</span></span><span class="token punctuation">></span></span><span class="token plain-text">
<span class="line-numbers-rows" style="user-select: none;">64</span>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Col</span></span><span class="token punctuation">></span></span>
<span class="line-numbers-rows" style="user-select: none;">65</span>  <span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">66</span><span class="token punctuation">}</span></pre></div></details><h1 id="end-of-file" class="std-title --fontTitle"><a href="#end-of-file" class="markdownIt-Anchor">#</a> EOF<i data-minimap="Ignore"> ↵ </i></h1><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">至此一个基于 CSS 变量的主题化场景配置实践就算完成了 —— 在设置颜色的过程中，将最新的色值重新持久化存储，后续用户再刷新的时候就可以拿出来并且应用到 CSS 变量中从而主题化站点样式, 后续只需要横向拓展更多的样式选项即可</div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">但是这里还有些可以优化的点，能想到的比如说持久化存储写到后台数据库，这样就可以多端保持主题同步。另外可以考虑弄一个 style CSS 变量直出服务, 让页面打开的一瞬间就主题化而不是等 js 和 ajax 加载完:</div><div class="std-code"><pre class="prismjs html rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/api/cssvars<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token style"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">然后对应的这个服务其实就是去读用户配置的 css 变量并渲染直出到用户侧:</div><div class="std-code"><pre class="prismjs tsx rally-runner  " ><span class="line-numbers-rows" style="user-select: none;">00</span>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/cssvars'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="line-numbers-rows" style="user-select: none;">01</span>  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">02</span>  <span class="token keyword">const</span> cssvars <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadUserCssVarsFromDB</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">03</span>  <span class="token keyword">const</span> styleContent <span class="token operator">=</span> <span class="token function">renderCssVars</span><span class="token punctuation">(</span>cssvars<span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">04</span>  ctx<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span>
<span class="line-numbers-rows" style="user-select: none;">05</span>    contentType<span class="token operator">:</span> <span class="token string">'.css'</span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">06</span>    content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
<span class="line-numbers-rows" style="user-select: none;">07</span>      :root {
<span class="line-numbers-rows" style="user-select: none;">08</span>        buttonColor: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cssvars<span class="token punctuation">.</span>buttonColor<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;
<span class="line-numbers-rows" style="user-select: none;">09</span>      }
<span class="line-numbers-rows" style="user-select: none;">10</span>    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="line-numbers-rows" style="user-select: none;">11</span>  <span class="token punctuation">)</span>
<span class="line-numbers-rows" style="user-select: none;">12</span><span class="token punctuation">}</span><span class="token punctuation">)</span></pre></div><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">* 注意这里可能有各种注入或者其他 Web 安全问题, 如果你真的要搞一个这样的方案建议要好好 review 一下可能的安全漏洞</div></div></article></div><hr class="std-hr"/><hr class="std-hr"/><div class="blog-footer-main"><a class="r-link _prev" href="/cate/未分类标题/the-adt-in-ts/"><span class="_icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="caret-left" class="svg-inline--fa fa-caret-left fa-w-6 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 512"><path fill="currentColor" d="M192 127.338v257.324c0 17.818-21.543 26.741-34.142 14.142L29.196 270.142c-7.81-7.81-7.81-20.474 0-28.284l128.662-128.662c12.599-12.6 34.142-3.676 34.142 14.142z"></path></svg></span><span>TypeScript 里的 ADT</span></a><div class="_current"><span class="_smaller _grey">第</span><span class="_nums _grey">7</span><span class="_smaller _grey">篇</span><div class="_now-id">Hello CSS 变量</div></div><a class="r-link _next" href="/cate/未分类标题/css-matrix3d-calc/"><span>CSS Matrix3D 中的矩阵运算</span><span class="_icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="caret-right" class="svg-inline--fa fa-caret-right fa-w-6 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 512"><path fill="currentColor" d="M0 384.662V127.338c0-17.818 21.543-26.741 34.142-14.142l128.662 128.662c7.81 7.81 7.81 20.474 0 28.284L34.142 398.804C21.543 411.404 0 402.48 0 384.662z"></path></svg></span></a></div><hr class="std-hr"/><hr class="std-hr"/><div class="back-to-top-main"><span class="_icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="caret-up" class="svg-inline--fa fa-caret-up fa-w-10 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M288.662 352H31.338c-17.818 0-26.741-21.543-14.142-34.142l128.662-128.662c7.81-7.81 20.474-7.81 28.284 0l128.662 128.662c12.6 12.599 3.676 34.142-14.142 34.142z"></path></svg></span><span class="_icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="caret-up" class="svg-inline--fa fa-caret-up fa-w-10 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M288.662 352H31.338c-17.818 0-26.741-21.543-14.142-34.142l128.662-128.662c7.81-7.81 20.474-7.81 28.284 0l128.662 128.662c12.6 12.599 3.676 34.142-14.142 34.142z"></path></svg></span><span class="_icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="caret-up" class="svg-inline--fa fa-caret-up fa-w-10 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M288.662 352H31.338c-17.818 0-26.741-21.543-14.142-34.142l128.662-128.662c7.81-7.81 20.474-7.81 28.284 0l128.662 128.662c12.6 12.599 3.676 34.142-14.142 34.142z"></path></svg></span><div class="_text-intro">回到顶部</div></div><hr class="std-hr"/><hr class="std-hr"/></div></div></div>
<script>window.__INITIAL_STATE__ = {"CategoryApiState":{"loaded":true,"loading":false,"error":null,"dataMap":{"/未分类标题/hello-css-vars":{"type":"detail","categoryId":"未分类标题","list":[{"id":"test-tsx-article-for-new-version","title":"新版博客测试文章 (.tsx)","author":"eczn","time":"1999-12-31T16:00:02.000Z","type":"article","appTitle":"","appIcon":"","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},{"title":"Markdown 快速上手","date":"2017-02-07 02:21:11","intro":"Markdown 是一种轻量级标记语言，创始人为约翰·格鲁伯，写文章经常用的到，它可以被编译成HTML，比起直接用HTML写文章，Markdown书写起来更简洁快速，写作体验会好很多。 ","headPic":"http://2.im.guokr.com/YtavWcYpNiA3PDc9nI3VlKABHBwMwev-sVT_rHUQJAjEAQAA_wAAAEpQ.jpg","type":"article","id":"62ca7f2093a59fcbab91ce9ad5fd9c37","appTitle":"","appIcon":"","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"tags":[],"time":"2017-02-06T18:21:11.000Z","isDraft":false,"fileDeps":[],"wordCount":1322},{"id":"three-body-emulator","title":"三体运动模拟器","time":"2021-06-16T10:33:00.000Z","author":"eczn","type":"article","appTitle":"","appIcon":"","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},{"id":"is-esm-robust-enough-in-broswer","title":"浏览器内的 ESM 是否已足够强大","author":"eczn","time":"2022-01-04T15:33:00.000Z","type":"article","appTitle":"","appIcon":"","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},{"id":"white-noise-webgl","title":"从白噪声开始学习 WebGL","author":"eczn","time":"2023-03-28T16:34:00.000Z","type":"article","appTitle":"","appIcon":"","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},{"id":"the-adt-in-ts","title":"TypeScript 里的 ADT","author":"eczn","time":"2023-07-25T13:38:00.000Z","type":"article","appTitle":"","appIcon":"","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},{"id":"hello-css-vars","title":"Hello CSS 变量","author":"eczn","time":"2023-08-12T10:32:11.000Z","type":"article","appTitle":"","appIcon":"","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},{"type":"app","id":"css-matrix3d-calc","title":"CSS Matrix3D 中的矩阵运算","appTitle":"CSS Matrix","appIcon":"/tsxs-esm/matrix2x2.831ca9df4adfae73.svg","author":"eczn","time":"2023-08-17T16:00:00.000Z","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},{"id":"latex-notes","title":"LaTeX 笔记","author":"eczn","time":"2023-10-20T16:00:00.000Z","type":"article","appTitle":"","appIcon":"","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},{"id":"ipod-spin-gesture","title":"iPod 转盘手势","author":"eczn","time":"2023-11-19T17:20:00.000Z","type":"article","appTitle":"","appIcon":"","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},{"type":"app","id":"app-pinch","title":"Pinch 捏放手势","appTitle":"Pinch 捏放手势","appIcon":"/tsxs-esm/pinch.daef4e8852186e91.svg","author":"eczn","time":"2024-01-01T15:33:00.000Z","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},{"id":"old-demos","type":"app","appTitle":"早期 DEMO 集","appIcon":"/tsxs-esm/demo-book.dc04159dd4134c99.svg","title":"早期 DEMO 集","author":"eczn","time":"2024-03-16T10:50:00.000Z","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},{"id":"binary-complement-principle","title":"二进制补码的数学原理","author":"author","time":"2024-04-29T15:58:00.000Z","type":"article","appTitle":"","appIcon":"","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},{"id":"moonbit-start","title":"Moonbit, 启动","author":"eczn","time":"2024-05-01T03:33:00.000Z","type":"article","appTitle":"","appIcon":"","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},{"id":"parser-combinator","title":"Parser Combinator","author":"eczn","time":"2024-05-01T23:00:00.000Z","type":"article","appTitle":"","appIcon":"","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0}],"current":{"type":"tsx","meta":{"id":"hello-css-vars","title":"Hello CSS 变量","author":"eczn","time":"2023-08-12T10:32:11.000Z","type":"article","appTitle":"","appIcon":"","intro":"未定义 intro","category":"未分类标题","cateIntro":"该分类暂无介绍 ~","imgs":[],"tags":[],"isDraft":false,"fileDeps":[],"wordCount":0},"tsxDistPath":"./hello-css-vars/index.blog.js","ssrContent":"<div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">很早就听过和简单看过 CSS 变量了，但是一直没有正式找场景使用过，这两天实装了一下本站的 Setting 页，里面用了 CSS 变量，本文总结一下经验:</div><a href=\"/setting/\" target=\"_blank\" style=\"background-color:#dddfde\" class=\"std-link --fontSansSerif  _block\" data-minimap-color=\"#dddfde\"><span class=\"std-link-icon r-link\" data-src=\"/get-favicon/eczn.github.io?h=-1911350002\" style=\"background-image:url(&quot;/get-favicon/eczn.github.io?h=-1911350002&quot;)\"></span><span class=\"std-link-txt\">Setting | 系统设置</span></a><h1 id=\"define\" class=\"std-title --fontTitle\"><a href=\"#define\" class=\"markdownIt-Anchor\">#</a> 声明和使用变量<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">可以按照如下方式声明和使用一个 CSS 变量</div><div class=\"col-main\" style=\"display:flex;margin-bottom:16px\"><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-code\"><pre class=\"prismjs css rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token selector\">:root</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span>  <span class=\"token property\">--REM</span><span class=\"token punctuation\">:</span> 14px<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token punctuation\">}</span></pre></div></div><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"std-code\"><pre class=\"prismjs css rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token selector\">html</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span>  <span class=\"token property\">font-site</span><span class=\"token punctuation\">:</span> <span class=\"token function\">var</span><span class=\"token punctuation\">(</span>--REM<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token punctuation\">}</span></pre></div></div></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">在上述两个例子中，声明了一个叫做 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">--REM</div> 的变量，其值为 14px, 然后通过 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">var()</div> 的方式将其绑定到 html 的 fontSizte 属性上</div><h1 id=\"waht-is-root\" class=\"std-title --fontTitle\"><a href=\"#waht-is-root\" class=\"markdownIt-Anchor\">#</a> :root 是什么<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">通过 :root 可以指定变量的作用域为全局。在大多数情况下我们只需要声明到 <div class=\"std-inline-code\" data-minimap-color=\"#f5e9e9\">:root</div> 全局中即可, 我暂时没有碰到需要单独定义作用域的情况, 可以通过这种方式单独指定变量作用域:</div><div class=\"std-code\"><pre class=\"prismjs css rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token selector\">div</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span>  <span class=\"token property\">--PRIMARY-COLOR</span><span class=\"token punctuation\">:</span> #BBB<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token punctuation\">}</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">叙述 CSS 变量的用法不是本文重点，相关细节可以参考 MDN:</div><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/CSS/Using_CSS_custom_properties\" target=\"_blank\" style=\"background-color:#e1eae4\" class=\"std-link --fontSansSerif  _block\" data-minimap-color=\"#e1eae4\"><span class=\"std-link-icon r-link\" data-src=\"/get-favicon/developer.mozilla.org?h=-5095327696\" style=\"background-image:url(&quot;/get-favicon/developer.mozilla.org?h=-5095327696&quot;)\"></span><span class=\"std-link-txt\">MDN - 使用 CSS 自定义属性（变量）</span></a><h1 id=\"site-theme-practice\" class=\"std-title --fontTitle\"><a href=\"#site-theme-practice\" class=\"markdownIt-Anchor\">#</a> 站点主题实践<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">CSS 变量一个最常见的用法就是实现站点主题的配置化、动态化 —— 以往 less / sass 那种预处理器的主题是要过静态编译才出来的，很多时候有各种限制，不好用, 现在借助 CSS 变量, 配合 js 就能做更完善的用户主题实践</div><h2 id=\"define-types\" class=\"std-title --fontTitle\">定义类型</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">实现站点主题配置，需要先设计相关类型，举个例子：实现按钮颜色的配置</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">// css-vars.tsx</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token comment\">// CSS 变量</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">CSSVars</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span>  buttonColor<span class=\"token operator\">:</span> string\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span><span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span><span class=\"token comment\">// 获取默认变量配置</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">initialCSSVars</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> CSSVars <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span>    buttonColor<span class=\"token operator\">:</span> <span class=\"token string\">'#e3e3e3'</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">10</span>  <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">11</span><span class=\"token punctuation\">}</span></pre></div><h2 id=\"render-cssvars\" class=\"std-title --fontTitle\">CSSVars 渲染到 &lt;style&gt;</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">还需要将这个 CSSVars 类型转成一段 CSS 内容并注入到 style 标签中才能使其作为 CSS 变量使用:</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">// render-css-vars.tsx</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> CSSVars<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./css-vars'</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token comment\">// 将 vars 的内容渲染到 style 中</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span><span class=\"token comment\">// 以此处的 CSSVars 来说，渲染结果类似这样：</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span><span class=\"token comment\">// &lt;style></span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span><span class=\"token comment\">// :root { --buttonColor: #BBB; }</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span><span class=\"token comment\">// &lt;\\/style></span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">renderCSSVars</span><span class=\"token punctuation\">(</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span>  vars<span class=\"token operator\">:</span> CSSVars<span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">10</span>  style<span class=\"token operator\">?</span><span class=\"token operator\">:</span> Element\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">11</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">12</span>  <span class=\"token keyword\">const</span> allDefine <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>vars<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">13</span>    <span class=\"token keyword\">const</span> v <span class=\"token operator\">=</span> vars<span class=\"token punctuation\">[</span>k <span class=\"token keyword\">as</span> keyof CSSVars<span class=\"token punctuation\">]</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">14</span>    <span class=\"token keyword\">const</span> cssValue <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> v <span class=\"token operator\">===</span> <span class=\"token string\">'number'</span> <span class=\"token operator\">?</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>v<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">px</span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token operator\">:</span> v\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">15</span>    <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">--</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>k<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>cssValue<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">;</span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">16</span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">17</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">18</span>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>style<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">19</span>    style<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">:root { </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>allDefine<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> }</span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">20</span>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">21</span>    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">style#CSS_VARS NotFound !</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">22</span>  <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">23</span><span class=\"token punctuation\">}</span></pre></div><h2 id=\"storage-cssvars\" class=\"std-title --fontTitle\">考虑持久化</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">在正式调用 renderCSSVars 之前我们还需要考虑怎么保存用户配置的 CSSVars, 即持久化, 可以使用 localStorage 进行存储:</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span>  CSSVars<span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>  initialCSSVars<span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./css-vars'</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span><span class=\"token comment\">/** 保存 CSS Vars */</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">saveCSSVars</span><span class=\"token punctuation\">(</span>cssVars<span class=\"token operator\">:</span> CSSVars<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span>  <span class=\"token keyword\">const</span> j <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>cssVars<span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span>  localStorage<span class=\"token punctuation\">.</span><span class=\"token function\">setItem</span><span class=\"token punctuation\">(</span><span class=\"token string\">'EXAMPLE_CSS_VARS'</span><span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span><span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">10</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">11</span><span class=\"token comment\">/** 读取 CSSVars */</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">12</span><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">loadCSSVars</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> CSSVars <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">13</span>  <span class=\"token comment\">// 服务端渲染场景直接返回初始 CSS 变量即可</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">14</span>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> window <span class=\"token operator\">===</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">15</span>    <span class=\"token keyword\">return</span> <span class=\"token function\">initialCSSVars</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">16</span>  <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">17</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">18</span>  <span class=\"token keyword\">const</span> j <span class=\"token operator\">=</span> localStorage<span class=\"token punctuation\">.</span><span class=\"token function\">getItem</span><span class=\"token punctuation\">(</span><span class=\"token string\">'EXAMPLE_CSS_VARS'</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">19</span>  <span class=\"token keyword\">const</span> initialVars <span class=\"token operator\">=</span> <span class=\"token function\">initialCSSVars</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">20</span>  <span class=\"token comment\">// 如果之前没存过, 直接返回</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">21</span>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>j<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> initialVars\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">22</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">23</span>  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">24</span>    <span class=\"token comment\">// 注意这里是覆盖的</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">25</span>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">26</span>      <span class=\"token operator\">...</span>initialVars<span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">27</span>      <span class=\"token operator\">...</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>j<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> CSSVars\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">28</span>    <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">29</span>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">30</span>    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'load css vars with error'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">31</span>    <span class=\"token comment\">// 出错后直接返回 initialVars</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">32</span>    <span class=\"token keyword\">return</span> initialVars\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">33</span>  <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">34</span><span class=\"token punctuation\">}</span></pre></div><h2 id=\"user-cssvars-demo\" class=\"std-title --fontTitle\">用户配置界面 (demo)</h2><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">最后一步是写组件让用户可以配置并持久化存储自己的 CSSVars, 以下是我实现的一个简单的组件 DEMO:</div><div class=\"col-main\" style=\"display:flex;margin-bottom:16px\"><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div><div>请点击下面色框选取颜色, <br/>当前色值: #e3e3e3</div><input type=\"color\" value=\"#e3e3e3\"/></div></div><div style=\"width:50%;text-align:justify;box-sizing:border-box;padding-left:8px;padding-right:8px\"><div class=\"button-main --fontSansSerif  normal\" style=\"font-size:inherit;background-color:#e3e3e3\"><span>这是一个空按钮</span></div></div></div><details><summary><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\" style=\"display:inline-block\">完整实现如下，已折叠，点击展开</div></summary><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token comment\">// user-cssvars.tsx</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Col<span class=\"token punctuation\">,</span> Button <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'rally/@@'</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span>  renderCSSVars\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span><span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./render-css-vars'</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span>  loadCSSVars<span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span>  saveCSSVars<span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span><span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./storage-css-vars'</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">10</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">11</span><span class=\"token keyword\">function</span> <span class=\"token function\">getStyleElement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Element <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">12</span>  <span class=\"token keyword\">const</span> styleId <span class=\"token operator\">=</span> <span class=\"token string\">'example-style'</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">13</span>  <span class=\"token keyword\">let</span> style <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">#</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>styleId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">14</span>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>style<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> style<span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">15</span>  <span class=\"token comment\">// 如果没有则构造一个并插入到 body 中</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">16</span>  style <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'style'</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">17</span>  style<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> styleId\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">18</span>  document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>style<span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">19</span>  <span class=\"token keyword\">return</span> style\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">20</span><span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">21</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">22</span><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">UserCssVars</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">23</span>  <span class=\"token comment\">// 读取变量并作为 react state 使用</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">24</span>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>cssvars<span class=\"token punctuation\">,</span> setCssVars<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">25</span>    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">loadCSSVars</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">26</span>  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">27</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">28</span>  React<span class=\"token punctuation\">.</span><span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">29</span>    <span class=\"token comment\">// 每次状态变化后渲染并存储</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">30</span>    <span class=\"token comment\">// 这里刷新比较频繁, 写个 timer 优化一下</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">31</span>    <span class=\"token keyword\">const</span> timer <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">32</span>      <span class=\"token function\">renderCSSVars</span><span class=\"token punctuation\">(</span>cssvars<span class=\"token punctuation\">,</span> <span class=\"token function\">getStyleElement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">33</span>      <span class=\"token function\">saveCSSVars</span><span class=\"token punctuation\">(</span>cssvars<span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">34</span>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">35</span>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">36</span>      <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>timer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">37</span>    <span class=\"token punctuation\">}</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">38</span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>cssvars<span class=\"token punctuation\">.</span>buttonColor<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">39</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">40</span>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">41</span>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Col</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">42</span>      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">43</span>        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">44</span>          请点击下面色框选取颜色, </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>br</span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">45</span>          当前色值: </span><span class=\"token punctuation\">{</span>cssvars<span class=\"token punctuation\">.</span>buttonColor<span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">46</span>        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">47</span>        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">48</span>          <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>color<span class=\"token punctuation\">\"</span></span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">49</span>          <span class=\"token attr-name\">value</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>cssvars<span class=\"token punctuation\">.</span>buttonColor<span class=\"token punctuation\">}</span></span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">50</span>          <span class=\"token attr-name\">onChange</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>e <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">51</span>            <span class=\"token function\">setCssVars</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">52</span>              buttonColor<span class=\"token operator\">:</span> e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>value\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">53</span>            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">54</span>          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">55</span>        <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">56</span>      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">57</span>      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Button</span></span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">58</span>        <span class=\"token attr-name\">icon</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>play<span class=\"token punctuation\">\"</span></span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">59</span>        <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">60</span>          backgroundColor<span class=\"token operator\">:</span> cssvars<span class=\"token punctuation\">.</span>buttonColor<span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">61</span>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">62</span>        这是一个空按钮\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">63</span>      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Button</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">64</span>    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Col</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">65</span>  <span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">66</span><span class=\"token punctuation\">}</span></pre></div></details><h1 id=\"end-of-file\" class=\"std-title --fontTitle\"><a href=\"#end-of-file\" class=\"markdownIt-Anchor\">#</a> EOF<i data-minimap=\"Ignore\"> ↵ </i></h1><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">至此一个基于 CSS 变量的主题化场景配置实践就算完成了 —— 在设置颜色的过程中，将最新的色值重新持久化存储，后续用户再刷新的时候就可以拿出来并且应用到 CSS 变量中从而主题化站点样式, 后续只需要横向拓展更多的样式选项即可</div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">但是这里还有些可以优化的点，能想到的比如说持久化存储写到后台数据库，这样就可以多端保持主题同步。另外可以考虑弄一个 style CSS 变量直出服务, 让页面打开的一瞬间就主题化而不是等 js 和 ajax 加载完:</div><div class=\"std-code\"><pre class=\"prismjs html rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/api/cssvars<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token style\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">></span></span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">然后对应的这个服务其实就是去读用户配置的 css 变量并渲染直出到用户侧:</div><div class=\"std-code\"><pre class=\"prismjs tsx rally-runner  \" ><span class=\"line-numbers-rows\" style=\"user-select: none;\">00</span>app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/cssvars'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">01</span>  <span class=\"token keyword\">await</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">02</span>  <span class=\"token keyword\">const</span> cssvars <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">loadUserCssVarsFromDB</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">03</span>  <span class=\"token keyword\">const</span> styleContent <span class=\"token operator\">=</span> <span class=\"token function\">renderCssVars</span><span class=\"token punctuation\">(</span>cssvars<span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">04</span>  ctx<span class=\"token punctuation\">.</span><span class=\"token function\">sendFile</span><span class=\"token punctuation\">(</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">05</span>    contentType<span class=\"token operator\">:</span> <span class=\"token string\">'.css'</span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">06</span>    content<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">07</span>      :root {\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">08</span>        buttonColor: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>cssvars<span class=\"token punctuation\">.</span>buttonColor<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">;\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">09</span>      }\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">10</span>    </span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">11</span>  <span class=\"token punctuation\">)</span>\n<span class=\"line-numbers-rows\" style=\"user-select: none;\">12</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></pre></div><div class=\"std-para --fontArticle\" data-minimap-color=\"#CCCCCC\">* 注意这里可能有各种注入或者其他 Web 安全问题, 如果你真的要搞一个这样的方案建议要好好 review 一下可能的安全漏洞</div>","props":{"fileCssVars":"// css-vars.tsx\n// CSS 变量\nexport interface CSSVars {\n  buttonColor: string\n}\n\n// 获取默认变量配置\nexport function initialCSSVars(): CSSVars {\n  return {\n    buttonColor: '#e3e3e3'\n  }\n}\n","fileRenderCssVars":"// render-css-vars.tsx\nimport { CSSVars} from './css-vars'\n\n// 将 vars 的内容渲染到 style 中\n// 以此处的 CSSVars 来说，渲染结果类似这样：\n// <style>\n// :root { --buttonColor: #BBB; }\n// <\\/style>\nexport function renderCSSVars(\n  vars: CSSVars,\n  style?: Element\n): void {\n  const allDefine = Object.keys(vars).map(k => {\n    const v = vars[k as keyof CSSVars]\n    const cssValue = typeof v === 'number' ? `${v}px` : v\n    return `--${k}:${cssValue};`\n  }).join('\\n')\n\n  if (style) {\n    style.innerHTML = `:root { ${allDefine} }`\n  } else {\n    console.error(`style#CSS_VARS NotFound !`)\n  }\n}\n","fileStorageCssVars":"import {\n  CSSVars,\n  initialCSSVars,\n} from './css-vars'\n\n/** 保存 CSS Vars */\nexport function saveCSSVars(cssVars: CSSVars): void {\n  const j = JSON.stringify(cssVars)\n  localStorage.setItem('EXAMPLE_CSS_VARS', j)\n}\n\n/** 读取 CSSVars */\nexport function loadCSSVars(): CSSVars {\n  // 服务端渲染场景直接返回初始 CSS 变量即可\n  if (typeof window === 'undefined') {\n    return initialCSSVars()\n  }\n\n  const j = localStorage.getItem('EXAMPLE_CSS_VARS')\n  const initialVars = initialCSSVars()\n  // 如果之前没存过, 直接返回\n  if (!j) return initialVars\n\n  try {\n    // 注意这里是覆盖的\n    return {\n      ...initialVars,\n      ...JSON.parse(j) as CSSVars\n    }\n  } catch (error) {\n    console.error('load css vars with error', error)\n    // 出错后直接返回 initialVars\n    return initialVars\n  }\n}\n","fileUserCssVars":"// user-cssvars.tsx\nimport React from 'react'\nimport { Col, Button } from 'rally/@@'\nimport {\n  renderCSSVars\n} from './render-css-vars'\nimport {\n  loadCSSVars,\n  saveCSSVars,\n} from './storage-css-vars'\n\nfunction getStyleElement(): Element {\n  const styleId = 'example-style'\n  let style = document.querySelector(`#${styleId}`);\n  if (style) return style;\n  // 如果没有则构造一个并插入到 body 中\n  style = document.createElement('style')\n  style.id = styleId\n  document.body.appendChild(style)\n  return style\n}\n\nexport function UserCssVars() {\n  // 读取变量并作为 react state 使用\n  const [cssvars, setCssVars] = React.useState(\n    () => loadCSSVars()\n  );\n\n  React.useEffect(() => {\n    // 每次状态变化后渲染并存储\n    // 这里刷新比较频繁, 写个 timer 优化一下\n    const timer = setTimeout(() => {\n      renderCSSVars(cssvars, getStyleElement())\n      saveCSSVars(cssvars)\n    }, 32);\n    return () => {\n      clearTimeout(timer);\n    }\n  }, [cssvars.buttonColor]);\n\n  return (\n    <Col>\n      <div>\n        <div>\n          请点击下面色框选取颜色, <br />\n          当前色值: {cssvars.buttonColor}\n        </div>\n        <input\n          type=\"color\"\n          value={cssvars.buttonColor}\n          onChange={e => {\n            setCssVars({\n              buttonColor: e.target.value\n            });\n          }}\n        />\n      </div>\n      <Button\n        icon=\"play\"\n        style={{\n          backgroundColor: cssvars.buttonColor,\n        }}>\n        这是一个空按钮\n      </Button>\n    </Col>\n  )\n}\n"},"tocStack":[{"id":"define","level":1,"text":"声明和使用变量"},{"id":"waht-is-root","level":1,"text":":root 是什么"},{"id":"site-theme-practice","level":1,"text":"站点主题实践"},{"id":"define-types","level":2,"text":"定义类型"},{"id":"render-cssvars","level":2,"text":"CSSVars 渲染到 <style>"},{"id":"storage-cssvars","level":2,"text":"考虑持久化"},{"id":"user-cssvars-demo","level":2,"text":"用户配置界面 (demo)"},{"id":"end-of-file","level":1,"text":"EOF"}]}}}},"BlogApiState":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"HomeApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"TimeLineApiState":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"SettingApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"LaunchpadApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}}}</script>
<!--SCRIPT-->
</body>
</html>
