<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<title>自制解释器 | 自制解释器 - 函数及作用域 | Eczn's Home</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,minimal-ui">
<meta name="format-detection" content="telephone=no">

<style id="CSS_VARS"></style>
<script>
(function() {
console.log('INIT CSS VAR');
function loadCSSVars() {
    const j = localStorage.getItem("CSS_VARS_2" /* STORAGE_KEY.CSS_VARS */);
    const initialVars = initialCSSVars();
    if (!j)
        return initialVars;
    try {
        const result = {
            ...initialVars,
            ...JSON.parse(j)
        };
        console.log('loadCSSVars from storage', result);
        return result;
    }
    catch (error) {
        console.error('load css vars with error', error);
        return initialVars;
    }
}
function renderCSSVars(vars, style) {
    const allDefine = Object.keys(vars).map(k => {
        const v = vars[k];
        const cssValue = typeof v === 'number' ? `${v}px` : v;
        return `--${k}:${cssValue};`;
    }).join('\n');
    if (style) {
        style.innerHTML = `:root { ${allDefine} }`;
    }
    else {
        console.error(`style#CSS_VARS NotFound !`);
    }
}
function initialCSSVars() {
    let rem = 16;
    // 移动端
    if (typeof window !== 'undefined' && window.innerWidth <= 500) {
        rem = Number(((window.innerWidth - 20) / 42).toFixed(1));
        console.log('mobile calculated rem =>', rem);
    }
    return {
        rem,
        enableSmallerFont: false,
        displayToc: 'block',
        fontSmcp: 'source serif pro, serif',
        fontCode: 'consolas, Menlo, monospace',
        fontTitle: 'Noto Serif SC, serif',
        fontArticle: 'source serif pro, LXGW WenKai',
        fontSansSerif: 'sans-serif',
    };
}
window.__initialCSSVars = loadCSSVars();
renderCSSVars(__initialCSSVars, document.querySelector('#CSS_VARS'));
})();
</script>

<link rel="icon" href="/favicon.png"><script defer="defer" src="/js/index.c464742b.js"></script><script defer="defer" src="/js/chunk-lib.c90ce4c7.js"></script><link href="/css/index.b0e70e3c588e68d62835.css" rel="stylesheet"><link href="/css/chunk-lib.5c7d4887bb8714b00c54.css" rel="stylesheet"></head>
<body x-apple-data-detectors="none">
<noscript>当前浏览器不支持 JavaScript, 建议使用支持 JavaScript 的浏览器来访问此网站 !</noscript>
<div id="rally-bg" style="opacity:0"></div>
<div id="app"><div class="ball-canvas-container"></div><nav class="nav-main --fontSmcp"><div class="_title default-max-width">Eczn&#x27;s Home</div><div class="smcphr"></div><div class="_links default-max-width"><a class="r-link _link clickable r-link" href="/">Home</a><a class="r-link _link clickable r-link" href="/tl/0/">Timeline</a><a class="r-link _link clickable r-link" href="/cate/all/">Category</a><a class="r-link _link clickable r-link" href="/setting/">Setting</a><a class="r-link _link clickable r-link" href="/launchpad/">Launchpad</a></div></nav><div class="std-box category-main category-detail default-max-width"><div class="std-box-content "><div class="_cate-header"><div class="_blog-links"><a class="r-link _blog-link --fontTitle" href="/cate/自制解释器/4daaa023319471bb6c9693ae5cc8593a/"><span class="_nth">#<!-- -->0</span>自制解释器 - S 表达式</a><a class="r-link _blog-link --fontTitle" href="/cate/自制解释器/998dd2d94474baae9f6472394dbb0fd2/"><span class="_nth">#<!-- -->1</span>自制解释器 - 改进 parse 及绑定变量</a><a class="r-link _blog-link --fontTitle _active" href="/cate/自制解释器/304b7c65eb8b89e9c3f69e5a45cca563/"><span class="_nth">#<!-- -->2</span>自制解释器 - 函数及作用域</a></div><div class="_cate-title --fontTitle">分类「 <!-- -->自制解释器<!-- --> 」</div></div><div><div id="start" class="blog-header-main"><div class="_infos"><div class="_info"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="clock" class="svg-inline--fa fa-clock fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256,8C119,8,8,119,8,256S119,504,256,504,504,393,504,256,393,8,256,8Zm92.49,313h0l-20,25a16,16,0,0,1-22.49,2.5h0l-67-49.72a40,40,0,0,1-15-31.23V112a16,16,0,0,1,16-16h32a16,16,0,0,1,16,16V256l58,42.5A16,16,0,0,1,348.49,321Z"></path></svg>2017-05-30</div><div class="_info"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="tag" class="svg-inline--fa fa-tag fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"></path></svg>编程语言</div><div class="_info"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="tag" class="svg-inline--fa fa-tag fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"></path></svg>解释器</div></div><div class="_title --fontTitle">自制解释器 - 函数及作用域</div></div><article><div class="r-article"><div class="std-para --fontArticle" data-minimap-color="#CCCCCC">第一篇解决了解析 S-表达式 的问题<br/>
第二篇引入了变量声明和一个简单的作用域模型（堆栈）</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">在上面的基础上实现了解释以下代码的能力</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token constant">Q</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
<span style="user-select:none" class="line-numbers-rows">01</span>(
<span style="user-select:none" class="line-numbers-rows">02</span>    (let [x 5])
<span style="user-select:none" class="line-numbers-rows">03</span>    (+ 1 x)
<span style="user-select:none" class="line-numbers-rows">04</span>)
<span style="user-select:none" class="line-numbers-rows">05</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">06</span><span class="token comment">// 得到结果 6</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这一篇要在上面的基础上，完成函数声明和调用，以及完成动态作用域。</div>
<h1 id="什么是动态作用域" class="std-title --fontTitle"><a target="_blank" href="#什么是动态作用域" class="markdownIt-Anchor">#</a> 什么是动态作用域<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">var</span> hello <span class="token operator">=</span> <span class="token string">&#x27;world in global&#x27;</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">01</span>
<span style="user-select:none" class="line-numbers-rows">02</span><span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">03</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hello<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">04</span><span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">05</span>
<span style="user-select:none" class="line-numbers-rows">06</span><span class="token keyword">function</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">07</span>    <span class="token keyword">var</span> hello <span class="token operator">=</span> <span class="token string">&#x27;world in b&#x27;</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">08</span>
<span style="user-select:none" class="line-numbers-rows">09</span>    <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">10</span><span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">11</span>
<span style="user-select:none" class="line-numbers-rows">12</span><span class="token comment">// 调用 b </span>
<span style="user-select:none" class="line-numbers-rows">13</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">上面的代码在 JavaScript 这种词法作用域（也称作静态作用域）的语言里面输出 <code>world in global</code>，而动态作用域则输出 <code>world in b</code>，动态体现在函数执行调用的时候，静态则体现在代码的词法上。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">这里的 <code>Q-lang</code> 采用动态作用域。</div>
<h1 id="函数调用的细节" class="std-title --fontTitle"><a target="_blank" href="#函数调用的细节" class="markdownIt-Anchor">#</a> 函数调用的细节<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">当调用函数的时候，读取参数列表（形参），然后读取函数后跟的参数（实参），然后创建一个新作用域 <code>newScope</code> 然后在上面用上一篇的方法 <code>声明形参</code> 把实参的值 <code>绑定</code> 上去，然后执行函数体。</div>
<ol class="std-list">
<li>寻找形参 比如函数 function test(a, b){ }  a 和 b 就是形参（形式参数）</li>
<li>寻找实参 比如调用 test(1, 2) 其中的 1 和 2 就是实参（实际参数）</li>
<li>创建空作用域并把它压入栈</li>
<li>绑定实参到形参 <code>let a = 2</code> 把 2 绑定到变量 a 上。（声明初始化变量的意味）</li>
<li>执行函数体 在 <code>Q-lang</code> 里函数体就是 <code>S-表达式</code></li>
<li>返回值 弹出顶部作用域</li>
</ol>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">上述就是 <code>Q-lang</code> 函数调用的过程。</div>
<h1 id="每一个s-表达式都是一次函数调用" class="std-title --fontTitle"><a target="_blank" href="#每一个s-表达式都是一次函数调用" class="markdownIt-Anchor">#</a> 每一个S-表达式都是一次函数调用<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">回头看看一个简单的 S-表达式 <code>(+ 1 2)</code> 他的值是 <code>3</code></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">再看看 <code>(add 1 2)</code></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">对比一下前后，我们发现除了 <code>函数名</code> 不同，其他都一样，他们具有形式一致性，加法这样的四则运算其实也是 <code>函数</code> ，进一步来讲每一个 <code>S-表达式</code> 其实都是类似的结构，他们都是函数调用的形式。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">所以每进入一个 S-表达式其实就是调用一次函数 都会创建一个新作用域（入栈），而每从一个 <code>S-表达式</code> 里返回值的时候都会销毁一个作用域（出栈）</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">在入栈的时候，我们把形参声明出来，并把实参绑定上去，出栈的时候这些东西都会被销毁，这样就可以完成调用函数而不留下痕迹了。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">因为连 <code>+</code> <code>-</code> <code>*</code> <code>/</code> 等四则运算都是函数，即每一个 S-表达式 都是函数。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">所以，每一次对 S-表达式 求值的时候都应该压入一个新作用域到 <code>scopes</code> ，每一次求值结束准备返回值的时候都应该把顶部作用域弹出。</div>
<h1 id="声明的语法" class="std-title --fontTitle"><a target="_blank" href="#声明的语法" class="markdownIt-Anchor">#</a> 声明的语法<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">函数调用很简单，前面说过每一个 <code>S-表达式</code> 都是函数，所以S-表达式的第一个元素是函数，其余紧接着参数。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">而声明，上一篇的变量声明是利用 let 关键字辅助中括号实现的，这一次也采取类似的做法：</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token constant">Q</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
<span style="user-select:none" class="line-numbers-rows">01</span>(
<span style="user-select:none" class="line-numbers-rows">02</span>    (let [
<span style="user-select:none" class="line-numbers-rows">03</span>        add4 (lambda (x y) (+ x y))
<span style="user-select:none" class="line-numbers-rows">04</span>    ])
<span style="user-select:none" class="line-numbers-rows">05</span>    (add4 2 3)
<span style="user-select:none" class="line-numbers-rows">06</span>)
<span style="user-select:none" class="line-numbers-rows">07</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div>
<blockquote lang="en" class="std-quote"><span class="std-quote-text">
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">语法格式：<br/>
<code>let [函数名 (lambda (参数列表) (函数体))]</code></div>
</span></blockquote>
<h1 id="观察-ast-结构" class="std-title --fontTitle"><a target="_blank" href="#观察-ast-结构" class="markdownIt-Anchor">#</a> 观察 AST 结构<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">直接用上一篇写的代码来解析刚刚的代码，看看生成的 AST 是如何的。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><div class="std-img"><img class="std-img-bg r-link" data-minimap="Rect" src="/images/parse-ast-structure-3.png" alt="AST 结构"/><div class="std-img-text">AST 结构</div></div></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">格式化之后像下面这样</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">var</span> ast <span class="token operator">=</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">01</span>    <span class="token string-property property">&quot;o&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">02</span>        <span class="token string-property property">&quot;o&quot;</span><span class="token operator">:</span><span class="token string">&quot;let&quot;</span><span class="token punctuation">,</span>
<span style="user-select:none" class="line-numbers-rows">03</span>        <span class="token string-property property">&quot;a&quot;</span><span class="token operator">:</span><span class="token string">&quot;[&quot;</span><span class="token punctuation">,</span>
<span style="user-select:none" class="line-numbers-rows">04</span>        <span class="token string-property property">&quot;b&quot;</span><span class="token operator">:</span><span class="token string">&quot;add4&quot;</span><span class="token punctuation">,</span>
<span style="user-select:none" class="line-numbers-rows">05</span>        <span class="token string-property property">&quot;c&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">06</span>            <span class="token string-property property">&quot;o&quot;</span><span class="token operator">:</span><span class="token string">&quot;lambda&quot;</span><span class="token punctuation">,</span>
<span style="user-select:none" class="line-numbers-rows">07</span>            <span class="token string-property property">&quot;a&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">08</span>                <span class="token string-property property">&quot;o&quot;</span><span class="token operator">:</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">,</span>
<span style="user-select:none" class="line-numbers-rows">09</span>                <span class="token string-property property">&quot;a&quot;</span><span class="token operator">:</span><span class="token string">&quot;y&quot;</span>
<span style="user-select:none" class="line-numbers-rows">10</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span style="user-select:none" class="line-numbers-rows">11</span>            <span class="token string-property property">&quot;b&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">12</span>                <span class="token string-property property">&quot;o&quot;</span><span class="token operator">:</span><span class="token string">&quot;+&quot;</span><span class="token punctuation">,</span>
<span style="user-select:none" class="line-numbers-rows">13</span>                <span class="token string-property property">&quot;a&quot;</span><span class="token operator">:</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">,</span>
<span style="user-select:none" class="line-numbers-rows">14</span>                <span class="token string-property property">&quot;b&quot;</span><span class="token operator">:</span><span class="token string">&quot;y&quot;</span>
<span style="user-select:none" class="line-numbers-rows">15</span>            <span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">16</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span style="user-select:none" class="line-numbers-rows">17</span>        <span class="token string-property property">&quot;d&quot;</span><span class="token operator">:</span><span class="token string">&quot;]&quot;</span>
<span style="user-select:none" class="line-numbers-rows">18</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span style="user-select:none" class="line-numbers-rows">19</span>    <span class="token string-property property">&quot;a&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">20</span>        <span class="token string-property property">&quot;o&quot;</span><span class="token operator">:</span><span class="token string">&quot;add4&quot;</span><span class="token punctuation">,</span>
<span style="user-select:none" class="line-numbers-rows">21</span>        <span class="token string-property property">&quot;a&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>
<span style="user-select:none" class="line-numbers-rows">22</span>        <span class="token string-property property">&quot;b&quot;</span><span class="token operator">:</span><span class="token number">3</span>
<span style="user-select:none" class="line-numbers-rows">23</span>    <span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">24</span><span class="token punctuation">}</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">ast.a 如预期所想，o是函数，a b都是参数，这点没问题。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">关键在于 ast.o ：</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">把 ast.o 下的元素排列起来就是： let [ add4 Lambda表达式 ]</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">上一节写的对 <code>let关键字</code> 的读取在这里依然可以用。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">因此我们能解析出 <code>add4</code> 和 <code>lambda</code> 表达式：(lambda (x y) (+ x y))</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">而 lambda 表达式其实也是 S-表达式，只是没那么标准。 调用第一篇用的去括号的方法，把lambda表达式的tokens取出来就可以得到形参和函数体了。</div>
<h1 id="实现" class="std-title --fontTitle"><a target="_blank" href="#实现" class="markdownIt-Anchor">#</a> 实现<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">先引入工具函数 <code>treeToArr</code> <code>pop</code> <code>push</code></div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">var</span> <span class="token function-variable function">treeToArr</span> <span class="token operator">=</span> <span class="token parameter">tree</span> <span class="token operator">=&gt;</span> keysTo<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">01</span>    <span class="token keyword">return</span> tree<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
<span style="user-select:none" class="line-numbers-rows">02</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> e <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">03</span>
<span style="user-select:none" class="line-numbers-rows">04</span><span class="token keyword">var</span> <span class="token function-variable function">pop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> scopes<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">05</span>
<span style="user-select:none" class="line-numbers-rows">06</span><span class="token keyword">var</span> <span class="token function-variable function">push</span> <span class="token operator">=</span> <span class="token parameter">newScope</span> <span class="token operator">=&gt;</span> scopes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newScope<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">treeToArr 可以把树转化成数组（根据 keysTo 上的顺序）<br/>
pop用于弹出顶部作用域, push用于创建一个作用域。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">只需要改动遍历 AST 的时候调用的 calc 就可以了。</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token comment">// 从语法树得到值 </span>
<span style="user-select:none" class="line-numbers-rows">01</span><span class="token comment">// 遍历 </span>
<span style="user-select:none" class="line-numbers-rows">02</span><span class="token keyword">var</span> <span class="token function-variable function">calc</span> <span class="token operator">=</span> <span class="token parameter">tree</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">03</span>    <span class="token keyword">let</span> oType <span class="token operator">=</span> <span class="token keyword">typeof</span> tree<span class="token punctuation">.</span>o<span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">04</span>
<span style="user-select:none" class="line-numbers-rows">05</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oType <span class="token operator">===</span> <span class="token string">&#x27;object&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">06</span>        <span class="token comment">// 调用 scopeCalc 去处理作用域 </span>
<span style="user-select:none" class="line-numbers-rows">07</span>        <span class="token function">scopeCalc</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">08</span>        
<span style="user-select:none" class="line-numbers-rows">09</span>        <span class="token comment">// 如果存在下一个S-表达式 则继续递归树 </span>
<span style="user-select:none" class="line-numbers-rows">10</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>tree<span class="token punctuation">.</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">11</span>            <span class="token keyword">let</span> returnVal <span class="token operator">=</span> <span class="token function">calc</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">12</span>            <span class="token comment">// returnVal 表示 tree.a 已经求出值 需要弹出顶部作用域</span>
<span style="user-select:none" class="line-numbers-rows">13</span>            <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">14</span>            <span class="token keyword">return</span> returnVal<span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">15</span>        <span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">16</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oType <span class="token operator">===</span> <span class="token string">&#x27;string&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">17</span>        <span class="token comment">// 创建一个作用域 </span>
<span style="user-select:none" class="line-numbers-rows">18</span>        <span class="token function">push</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">19</span>
<span style="user-select:none" class="line-numbers-rows">20</span>        <span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">21</span>        
<span style="user-select:none" class="line-numbers-rows">22</span>        <span class="token comment">// 这里需要改动 return 前应该 pop() 弹出顶部作用域 </span>
<span style="user-select:none" class="line-numbers-rows">23</span>        <span class="token keyword">var</span> vals <span class="token operator">=</span> keysTo<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> tree<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cur<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> its</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">24</span>            <span class="token keyword">let</span> t <span class="token operator">=</span> tree<span class="token punctuation">[</span>cur<span class="token punctuation">]</span>
<span style="user-select:none" class="line-numbers-rows">25</span>              <span class="token punctuation">,</span> is_ns <span class="token operator">=</span> <span class="token keyword">typeof</span> t <span class="token operator">===</span> <span class="token string">&#x27;number&#x27;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> t <span class="token operator">===</span> <span class="token string">&#x27;string&#x27;</span>
<span style="user-select:none" class="line-numbers-rows">26</span>              <span class="token punctuation">,</span> keyInTree <span class="token operator">=</span> tree<span class="token punctuation">[</span>its<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">]</span>
<span style="user-select:none" class="line-numbers-rows">27</span>
<span style="user-select:none" class="line-numbers-rows">28</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>is_ns<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">29</span>                <span class="token keyword">return</span> <span class="token function">find</span><span class="token punctuation">(</span>keyInTree<span class="token punctuation">)</span>
<span style="user-select:none" class="line-numbers-rows">30</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">31</span>                <span class="token keyword">let</span> returnVal <span class="token operator">=</span> <span class="token function">calc</span><span class="token punctuation">(</span>keyInTree<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">32</span>                <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">33</span>                <span class="token keyword">return</span> returnVal<span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">34</span>            <span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">35</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">36</span>
<span style="user-select:none" class="line-numbers-rows">37</span>        <span class="token comment">// 这里是新增的 </span>
<span style="user-select:none" class="line-numbers-rows">38</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span>o <span class="token operator">===</span> <span class="token string">&#x27;lambda&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">39</span>            <span class="token comment">// lambda 的处理 </span>
<span style="user-select:none" class="line-numbers-rows">40</span>            <span class="token keyword">let</span> lambda <span class="token operator">=</span> <span class="token function">treeToArr</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">41</span>            <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token function">treeToArr</span><span class="token punctuation">(</span>lambda<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">42</span>            <span class="token comment">// 创建新作用域 newScope </span>
<span style="user-select:none" class="line-numbers-rows">43</span>            <span class="token keyword">let</span> newScope <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> name<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">44</span>                acc<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> vals<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">45</span>                <span class="token keyword">return</span> acc<span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">46</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">47</span>  
<span style="user-select:none" class="line-numbers-rows">48</span>            <span class="token comment">// 把新作用域压入栈 </span>
<span style="user-select:none" class="line-numbers-rows">49</span>            <span class="token function">push</span><span class="token punctuation">(</span>newScope<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">50</span>
<span style="user-select:none" class="line-numbers-rows">51</span>            <span class="token comment">// 执行函数体 </span>
<span style="user-select:none" class="line-numbers-rows">52</span>            <span class="token keyword">var</span> returnVal <span class="token operator">=</span> <span class="token function">calc</span><span class="token punctuation">(</span>lambda<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">53</span>
<span style="user-select:none" class="line-numbers-rows">54</span>            <span class="token comment">// 弹出作用域</span>
<span style="user-select:none" class="line-numbers-rows">55</span>            <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">56</span>
<span style="user-select:none" class="line-numbers-rows">57</span>            <span class="token comment">// 调试 </span>
<span style="user-select:none" class="line-numbers-rows">58</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;newScope:&#x27;</span><span class="token punctuation">,</span> newScope<span class="token punctuation">)</span>
<span style="user-select:none" class="line-numbers-rows">59</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;returnVal:&#x27;</span><span class="token punctuation">,</span> returnVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">60</span>            <span class="token keyword">return</span> returnVal<span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">61</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">62</span>            <span class="token comment">// 从这里可以看出一个一个参数的传递 </span>
<span style="user-select:none" class="line-numbers-rows">63</span>            <span class="token comment">// 换言之 Q-lang 只接受柯里化的函数 </span>
<span style="user-select:none" class="line-numbers-rows">64</span>            <span class="token keyword">let</span> returnVal <span class="token operator">=</span> vals<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span style="user-select:none" class="line-numbers-rows">65</span>                <span class="token keyword">return</span> <span class="token function">acc</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">66</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span style="user-select:none" class="line-numbers-rows">67</span>
<span style="user-select:none" class="line-numbers-rows">68</span>            <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">69</span>            <span class="token keyword">return</span> returnVal<span class="token punctuation">;</span>
<span style="user-select:none" class="line-numbers-rows">70</span>        <span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">71</span>    <span class="token punctuation">}</span>
<span style="user-select:none" class="line-numbers-rows">72</span><span class="token punctuation">}</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">做测试：</div>
<div class="std-code"><pre class="prismjs js rally-runner  "><span style="user-select:none" class="line-numbers-rows">00</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token constant">Q</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
<span style="user-select:none" class="line-numbers-rows">01</span>(
<span style="user-select:none" class="line-numbers-rows">02</span>    (let [
<span style="user-select:none" class="line-numbers-rows">03</span>        add4 (lambda (x y) (+ x y))
<span style="user-select:none" class="line-numbers-rows">04</span>    ])
<span style="user-select:none" class="line-numbers-rows">05</span>    (add4 2 3)
<span style="user-select:none" class="line-numbers-rows">06</span>)
<span style="user-select:none" class="line-numbers-rows">07</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 期望 a 等于 5 </span>
<span style="user-select:none" class="line-numbers-rows">08</span>
<span style="user-select:none" class="line-numbers-rows">09</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token constant">Q</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
<span style="user-select:none" class="line-numbers-rows">10</span>(
<span style="user-select:none" class="line-numbers-rows">11</span>    (let [
<span style="user-select:none" class="line-numbers-rows">12</span>        mul (lambda (x y) (* x y))
<span style="user-select:none" class="line-numbers-rows">13</span>    ])
<span style="user-select:none" class="line-numbers-rows">14</span>    (mul 1 (mul 2 (mul 3 (mul 4 5))))
<span style="user-select:none" class="line-numbers-rows">15</span>)
<span style="user-select:none" class="line-numbers-rows">16</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 期望 b 等于 120 </span>
<span style="user-select:none" class="line-numbers-rows">17</span>
<span style="user-select:none" class="line-numbers-rows">18</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;&gt;&gt;&gt;&gt; Q-lang:&#x27;</span><span class="token punctuation">)</span>
<span style="user-select:none" class="line-numbers-rows">19</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;&gt;&gt;&gt;&gt; a:&#x27;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token string">&#x27;b:&#x27;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC"><div class="std-img"><img class="std-img-bg r-link" data-minimap="Rect" src="/images/function-test-result-a-b.png" alt="测试结果"/><div class="std-img-text">测试结果</div></div></div>
<h1 id="不和谐" class="std-title --fontTitle"><a target="_blank" href="#不和谐" class="markdownIt-Anchor">#</a> 不和谐<i data-minimap="Ignore"> ↵ </i></h1>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">或许你注意到了，lambda表达式声明的函数不是柯里化的，它跟定义在全局的那些函数不一样，换句话说，不是一视同仁，这个问题将会在后几篇里面解决。</div>
<div class="std-para --fontArticle" data-minimap-color="#CCCCCC">( 本次写的代码都已注入本页面 打开浏览器 F12 即可使用 Q )</div>
<script>
// Qscope.js

var scopes = [
    {
        &#x27;+&#x27;: ap =&gt; bp =&gt; ap + bp, 
        &#x27;-&#x27;: as =&gt; bs =&gt; as - bs,
        &#x27;*&#x27;: am =&gt; bm =&gt; am * bm,
        &#x27;/&#x27;: ad =&gt; bd =&gt; ad / bd,
        &#x27;&gt;&#x27;: a =&gt; b =&gt; a &gt; b, 
        &#x27;&gt;=&#x27;: a =&gt; b =&gt; a &gt;= b, 
        &#x27;&lt;=&#x27;: a =&gt; b =&gt; a &lt;= b, 
        &#x27;&lt;&#x27;: a =&gt; b =&gt; a &lt; b, 
        &#x27;==&#x27;: a =&gt; b =&gt; a === b, 
        &#x27;doubleSum&#x27;: a =&gt; b =&gt; a * 2 + b * 2,
        &#x27;++&#x27;: d =&gt; d + 1,
        &#x27;--&#x27;: d =&gt; d - 1, 
        &#x27;if&#x27;: condition =&gt; trueTodo =&gt; falseTodo =&gt; condition ? trueTodo : falseTodo
    }
]; 

var find = key =&gt; {
    let val; 

    if (typeof key === &#x27;number&#x27;) return key; 

    for (let i = scopes.length - 1; i &gt;= 0; i--){
        let scope = scopes[i]; 

        if (typeof scope[key] !== &#x27;undefined&#x27;){
            val = scope[key]; 
            break; 
        }
    }

    if (typeof val !== &#x27;undefined&#x27;) return val 
    else throw new Error(`${key} is not defined` ); 
}

var add = (key, val) =&gt; {
    let top = scopes.pop(); 
    top[key] = val; 
    scopes.push(top); 
}

var push = newScope =&gt; scopes.push(newScope); 

var pop = () =&gt; scopes.pop(); 

var keysTo = [
    &#x27;o&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;, &#x27;e&#x27;, &#x27;f&#x27;, &#x27;g&#x27;
]

var parseToArr = str =&gt; str.split(&#x27;\t&#x27;).join(&#x27; &#x27;).split(&#x27;&#x27;).reduce((acc, cur) =&gt; {
    if (cur === &#x27;(&#x27; || cur === &#x27;[&#x27;){
        acc.push(&#x27; &#x27;); 
        acc.push(cur); 
        acc.push(&#x27; &#x27;); 
        return acc;
    } else if (cur === &#x27;)&#x27; || cur === &#x27;]&#x27;) {
        acc.push(&#x27; &#x27;); 
        acc.push(cur); 
        acc.push(&#x27; &#x27;); 
    } else {
        acc.push(cur); 
    }

    return acc; 
}, []).join(&#x27;&#x27;).split(&#x27; &#x27;).map(ch =&gt; {
    if (!Number.isNaN(parseInt(ch))){
        return parseInt(ch); 
    } else {
        return ch; 
    }
}).filter(e =&gt; e !== &#x27;&#x27; &amp;&amp; e!== &#x27;\n&#x27;); 

// 语法分析 求 AST
// (* (+ 1 1) (+ 2 2))
var _parse = arr =&gt; {
    var deep = 0; 
    var temp = []; 
    var tokens = []; 

    if (arr.length === 1) return arr[0]; 

    arr.forEach((ch, idx, its) =&gt; {
        if (ch === &#x27;(&#x27;) {
            deep ++ ; 

            if (deep === 2){
                temp.push(idx); 
            }
        } else if (ch === &#x27;)&#x27;) {
            deep -- ; 

            if (deep === 1){
                let pre = temp.pop(); 
                tokens.push({
                    from: pre, 
                    to: idx
                }); 
            }
        } else {
            // 除了括号 其他都是 标识符 或者 立即数 
            if (deep === 1){
                tokens.push({
                    from: idx, 
                    to: idx
                }); 
            }
        }
    }); 

    return tokens.reduce((acc, cur, idx) =&gt; {
        let block = arr.slice(cur.from, cur.to + 1);

        acc[keysTo[idx]] = _parse(block); 

        return acc; 
    }, Object.create(null)); 
}


var treeToArr = tree =&gt; keysTo.map(key =&gt; {
    return tree[key]
}).filter(e =&gt; e !== undefined);

// 从语法树得到值 
// 遍历 
var calc = tree =&gt; {
    let oType = typeof tree.o;

    if (oType === &#x27;object&#x27;){ // 说明该节点不是表达式 而是声明 
        // 这里修改作用域 
        // tree.o 原本应该是函数名 应该 typeof 出来是 string 
        // 这里是 object 说明应该是 let 关键字 
        // 调用 scopeCalc 去处理作用域 
        scopeCalc(tree.o); 
        
        // 如果存在下一个S-表达式 则继续递归树 
        if (tree.a) {
            let returnVal = calc(tree.a);
            pop(); 
            return returnVal; 
        }
    } else if (oType === &#x27;string&#x27;) {
        push(Object.create(null));
        // 以下的代码可能有些晦涩 
        // 主要是实现多参函数而写的 
        // 简单的四则运算都是两个参数 都是函数 被定义在全局上 
        // 但是实际情况中 o 的参数列表可能不只两个 
        // 因此要把 tokens 第二个元素之后的所有值求出来 再应用到 o 上 

        let o = find(tree.o); 
    
        // 这段执行完后得到结果是 vals 
        // vals 的结构类似这样： [函数, 值, 值, 值 .... ] 长度取决于 keysTo.length 
        // 注意有 .slice(1) 
        var vals = keysTo.slice(1).filter(key =&gt; tree[key]).map((cur, idx, its) =&gt; {
            // 取出键名 比如 tree.a tree.b 等等 
            let t = tree[cur]
                // is_ns: t 是数字或者变量吗？ 
              , is_ns = typeof t === &#x27;number&#x27; || typeof t === &#x27;string&#x27;
                // its 是这样的： [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27; .... ] 
                // 这里从tree取出 tree.a tree.b 这些 
              , keyInTree = tree[its[idx]]

            if (is_ns){
                return find(keyInTree)
            } else {
                let returnVal = calc(keyInTree); 
                pop(); 
                return returnVal; 
            }
        }); 



        if (o.o === &#x27;lambda&#x27;){
            // lambda 的处理 
            let lambda = treeToArr(o);
            let list = treeToArr(lambda[1]); 

            // 创建一个作用域 
            let newScope = list.reduce((acc, name, idx) =&gt; {
                acc[name] = vals[idx]; 
                return acc; 
            }, Object.create(null)); 

            
            // 把新作用域压入栈 
            push(newScope); 

            var returnVal = calc(lambda[2]);

            pop(); 

            console.log(&#x27;newScope:&#x27;, newScope)
            console.log(&#x27;returnVal:&#x27;, returnVal);

            return returnVal;
        } else {
            // 从这里可以看出一个一个参数的传递 
            // 换言之 Q-lang 只接受柯里化的函数 
            let returnVal = vals.reduce((acc, val) =&gt; {
                return acc(val); 
            }, o); 

            pop();
            return returnVal;
        }
    }
}

var scopeCalc = todo =&gt; {
    var p = keysTo.slice(1).reduce((acc, cur) =&gt; {
        if (todo[cur]) acc.push(todo[cur]); 
        
        return acc; 
    }, []).filter(e =&gt; e !== &#x27;[&#x27; &amp;&amp; e !== &#x27;]&#x27;); 

    if (todo.o === &#x27;let&#x27;) {
        p.forEach((item, idx, its) =&gt; {
            if (idx % 2 === 0){ // 偶数
                let key = item
                  , val = its[idx + 1]; 
                
                add(key, val); 
            }
        })
    }
} 

// var lambdaCreate = tree =&gt; {
//  var lambda = treeToArr(tree); 

//  var list = lambda[0]; 
//  var exp = lambda[1]; 
    
// }




// Q 
var parse = str =&gt; _parse(parseToArr(str)); 
var Q = str =&gt; calc(parse(str)); 


</script></div></article></div><hr class="std-hr"/><hr class="std-hr"/><div class="blog-footer-main"><a class="r-link _prev" href="/cate/自制解释器/998dd2d94474baae9f6472394dbb0fd2/"><span class="_icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="caret-left" class="svg-inline--fa fa-caret-left fa-w-6 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 512"><path fill="currentColor" d="M192 127.338v257.324c0 17.818-21.543 26.741-34.142 14.142L29.196 270.142c-7.81-7.81-7.81-20.474 0-28.284l128.662-128.662c12.599-12.6 34.142-3.676 34.142 14.142z"></path></svg></span><span>自制解释器 - 改进 parse 及绑定变量</span></a><div class="_current"><span class="_smaller _grey">第</span><span class="_nums _grey">3</span><span class="_smaller _grey">篇</span><div class="_now-id">自制解释器 - 函数及作用域</div></div><a class="r-link _next" href="/cate/all/"><span>回到列表</span><span class="_icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="caret-right" class="svg-inline--fa fa-caret-right fa-w-6 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 512"><path fill="currentColor" d="M0 384.662V127.338c0-17.818 21.543-26.741 34.142-14.142l128.662 128.662c7.81 7.81 7.81 20.474 0 28.284L34.142 398.804C21.543 411.404 0 402.48 0 384.662z"></path></svg></span></a></div><hr class="std-hr"/><hr class="std-hr"/><div class="back-to-top-main"><span class="_icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="caret-up" class="svg-inline--fa fa-caret-up fa-w-10 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M288.662 352H31.338c-17.818 0-26.741-21.543-14.142-34.142l128.662-128.662c7.81-7.81 20.474-7.81 28.284 0l128.662 128.662c12.6 12.599 3.676 34.142-14.142 34.142z"></path></svg></span><span class="_icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="caret-up" class="svg-inline--fa fa-caret-up fa-w-10 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M288.662 352H31.338c-17.818 0-26.741-21.543-14.142-34.142l128.662-128.662c7.81-7.81 20.474-7.81 28.284 0l128.662 128.662c12.6 12.599 3.676 34.142-14.142 34.142z"></path></svg></span><span class="_icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="caret-up" class="svg-inline--fa fa-caret-up fa-w-10 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M288.662 352H31.338c-17.818 0-26.741-21.543-14.142-34.142l128.662-128.662c7.81-7.81 20.474-7.81 28.284 0l128.662 128.662c12.6 12.599 3.676 34.142-14.142 34.142z"></path></svg></span><div class="_text-intro">回到顶部</div></div><hr class="std-hr"/><hr class="std-hr"/></div></div></div>
<script>window.__INITIAL_STATE__ = {"CategoryApiState":{"loaded":true,"loading":false,"error":null,"dataMap":{"/自制解释器/304b7c65eb8b89e9c3f69e5a45cca563":{"type":"detail","categoryId":"自制解释器","list":[{"title":"自制解释器 - S 表达式","intro":"自制一门比 BASIC 还糟糕的语言 叫做 Q-lang","date":"Sun May 28 2017 22:39:35 GMT+0800 (中国标准时间)","category":"自制解释器","cateIntro":"设计一个解释器","tags":["编程语言","解释器"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"headerText":"S-Expression ?","customCSS":["header { ","font-size: 1rem;","}"],"type":"article","id":"4daaa023319471bb6c9693ae5cc8593a","appTitle":"","appIcon":"","author":"eczn","imgs":[],"time":"2017-05-28T14:39:35.000Z","isDraft":false,"fileDeps":["/images/what-ast.jpg","/images/parseToArr001.jpg","/images/s-express-2-ast.png","/images/calc-result-test.png","/images/Q-calc-s-expression.png"],"wordCount":10103},{"title":"自制解释器 - 改进 parse 及绑定变量","intro":"上一篇主要完成了算数表达式的解析，这一篇着重讨论变量与作用域问题","date":"Mon May 29 2017 17:27:03 GMT+0800 (中国标准时间)","category":"自制解释器","tags":["编程语言","解释器"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"headerText":"let 关键字 ?","customCSS":["header { ","font-size: 1rem;","}"],"type":"article","id":"998dd2d94474baae9f6472394dbb0fd2","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-05-29T09:27:03.000Z","isDraft":false,"fileDeps":["/images/parseToArrV2.png","/images/_parseV2.png","/images/parse_let_01.png","/images/test-v2-Q-lang.png"],"wordCount":13212},{"title":"自制解释器 - 函数及作用域","intro":"Q-lang 的函数调用、函数声明、以及它的动态作用域","date":"Tue May 30 2017 02:40:28 GMT+0800 (中国标准时间)","category":"自制解释器","tags":["编程语言","解释器"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"headerText":"λambda ?","customCSS":["header { ","font-size: 1rem;","}"],"type":"article","id":"304b7c65eb8b89e9c3f69e5a45cca563","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-05-29T18:40:28.000Z","isDraft":false,"fileDeps":["/images/parse-ast-structure-3.png","/images/function-test-result-a-b.png"],"wordCount":11380}],"current":{"type":"markdown","meta":{"title":"自制解释器 - 函数及作用域","intro":"Q-lang 的函数调用、函数声明、以及它的动态作用域","date":"Tue May 30 2017 02:40:28 GMT+0800 (中国标准时间)","category":"自制解释器","tags":["编程语言","解释器"],"head":false,"headerStyle":["line-height: 314px;"],"headPic":false,"headerText":"λambda ?","customCSS":["header { ","font-size: 1rem;","}"],"type":"article","id":"304b7c65eb8b89e9c3f69e5a45cca563","appTitle":"","appIcon":"","cateIntro":"该分类暂无介绍 ~","author":"eczn","imgs":[],"time":"2017-05-29T18:40:28.000Z","isDraft":false,"fileDeps":["/images/parse-ast-structure-3.png","/images/function-test-result-a-b.png"],"wordCount":11380},"nodes":[{"type":"tag","children":[{"type":"text","data":"第一篇解决了解析 S-表达式 的问题"},{"type":"tag","children":[],"name":"br","attribs":{}},{"type":"text","data":"\n第二篇引入了变量声明和一个简单的作用域模型（堆栈）"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"在上面的基础上实现了解释以下代码的能力"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"Q"}],"name":"span","attribs":{"className":"token constant"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"`"}],"name":"span","attribs":{"className":"token template-punctuation string"}},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"(\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    (let [x 5])\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    (+ 1 x)\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":")\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":"`"}],"name":"span","attribs":{"className":"token template-punctuation string"}}],"name":"span","attribs":{"className":"token template-string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 得到结果 6"}],"name":"span","attribs":{"className":"token comment"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"这一篇要在上面的基础上，完成函数声明和调用，以及完成动态作用域。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#什么是动态作用域","className":"markdownIt-Anchor"}},{"type":"text","data":" 什么是动态作用域"}],"name":"h1","attribs":{"id":"什么是动态作用域"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"var"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" hello "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'world in global'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"function"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"a"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"hello"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"function"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"b"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"var"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" hello "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'world in b'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"a"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 调用 b "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"b"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"上面的代码在 JavaScript 这种词法作用域（也称作静态作用域）的语言里面输出 "},{"type":"tag","children":[{"type":"text","data":"world in global"}],"name":"code","attribs":{}},{"type":"text","data":"，而动态作用域则输出 "},{"type":"tag","children":[{"type":"text","data":"world in b"}],"name":"code","attribs":{}},{"type":"text","data":"，动态体现在函数执行调用的时候，静态则体现在代码的词法上。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"这里的 "},{"type":"tag","children":[{"type":"text","data":"Q-lang"}],"name":"code","attribs":{}},{"type":"text","data":" 采用动态作用域。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#函数调用的细节","className":"markdownIt-Anchor"}},{"type":"text","data":" 函数调用的细节"}],"name":"h1","attribs":{"id":"函数调用的细节"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"当调用函数的时候，读取参数列表（形参），然后读取函数后跟的参数（实参），然后创建一个新作用域 "},{"type":"tag","children":[{"type":"text","data":"newScope"}],"name":"code","attribs":{}},{"type":"text","data":" 然后在上面用上一篇的方法 "},{"type":"tag","children":[{"type":"text","data":"声明形参"}],"name":"code","attribs":{}},{"type":"text","data":" 把实参的值 "},{"type":"tag","children":[{"type":"text","data":"绑定"}],"name":"code","attribs":{}},{"type":"text","data":" 上去，然后执行函数体。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"寻找形参 比如函数 function test(a, b){ }  a 和 b 就是形参（形式参数）"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"寻找实参 比如调用 test(1, 2) 其中的 1 和 2 就是实参（实际参数）"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"创建空作用域并把它压入栈"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"绑定实参到形参 "},{"type":"tag","children":[{"type":"text","data":"let a = 2"}],"name":"code","attribs":{}},{"type":"text","data":" 把 2 绑定到变量 a 上。（声明初始化变量的意味）"}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"执行函数体 在 "},{"type":"tag","children":[{"type":"text","data":"Q-lang"}],"name":"code","attribs":{}},{"type":"text","data":" 里函数体就是 "},{"type":"tag","children":[{"type":"text","data":"S-表达式"}],"name":"code","attribs":{}}],"name":"li","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"返回值 弹出顶部作用域"}],"name":"li","attribs":{}},{"type":"text","data":"\n"}],"name":"ol","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"上述就是 "},{"type":"tag","children":[{"type":"text","data":"Q-lang"}],"name":"code","attribs":{}},{"type":"text","data":" 函数调用的过程。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#每一个s-表达式都是一次函数调用","className":"markdownIt-Anchor"}},{"type":"text","data":" 每一个S-表达式都是一次函数调用"}],"name":"h1","attribs":{"id":"每一个s-表达式都是一次函数调用"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"回头看看一个简单的 S-表达式 "},{"type":"tag","children":[{"type":"text","data":"(+ 1 2)"}],"name":"code","attribs":{}},{"type":"text","data":" 他的值是 "},{"type":"tag","children":[{"type":"text","data":"3"}],"name":"code","attribs":{}}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"再看看 "},{"type":"tag","children":[{"type":"text","data":"(add 1 2)"}],"name":"code","attribs":{}}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"对比一下前后，我们发现除了 "},{"type":"tag","children":[{"type":"text","data":"函数名"}],"name":"code","attribs":{}},{"type":"text","data":" 不同，其他都一样，他们具有形式一致性，加法这样的四则运算其实也是 "},{"type":"tag","children":[{"type":"text","data":"函数"}],"name":"code","attribs":{}},{"type":"text","data":" ，进一步来讲每一个 "},{"type":"tag","children":[{"type":"text","data":"S-表达式"}],"name":"code","attribs":{}},{"type":"text","data":" 其实都是类似的结构，他们都是函数调用的形式。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"所以每进入一个 S-表达式其实就是调用一次函数 都会创建一个新作用域（入栈），而每从一个 "},{"type":"tag","children":[{"type":"text","data":"S-表达式"}],"name":"code","attribs":{}},{"type":"text","data":" 里返回值的时候都会销毁一个作用域（出栈）"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"在入栈的时候，我们把形参声明出来，并把实参绑定上去，出栈的时候这些东西都会被销毁，这样就可以完成调用函数而不留下痕迹了。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"因为连 "},{"type":"tag","children":[{"type":"text","data":"+"}],"name":"code","attribs":{}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"-"}],"name":"code","attribs":{}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"*"}],"name":"code","attribs":{}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"/"}],"name":"code","attribs":{}},{"type":"text","data":" 等四则运算都是函数，即每一个 S-表达式 都是函数。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"所以，每一次对 S-表达式 求值的时候都应该压入一个新作用域到 "},{"type":"tag","children":[{"type":"text","data":"scopes"}],"name":"code","attribs":{}},{"type":"text","data":" ，每一次求值结束准备返回值的时候都应该把顶部作用域弹出。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#声明的语法","className":"markdownIt-Anchor"}},{"type":"text","data":" 声明的语法"}],"name":"h1","attribs":{"id":"声明的语法"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"函数调用很简单，前面说过每一个 "},{"type":"tag","children":[{"type":"text","data":"S-表达式"}],"name":"code","attribs":{}},{"type":"text","data":" 都是函数，所以S-表达式的第一个元素是函数，其余紧接着参数。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"而声明，上一篇的变量声明是利用 let 关键字辅助中括号实现的，这一次也采取类似的做法："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"Q"}],"name":"span","attribs":{"className":"token constant"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"`"}],"name":"span","attribs":{"className":"token template-punctuation string"}},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"(\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    (let [\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        add4 (lambda (x y) (+ x y))\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    ])\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    (add4 2 3)\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":")\n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":"`"}],"name":"span","attribs":{"className":"token template-punctuation string"}}],"name":"span","attribs":{"className":"token template-string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"语法格式："},{"type":"tag","children":[],"name":"br","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"let [函数名 (lambda (参数列表) (函数体))]"}],"name":"code","attribs":{}}],"name":"p","attribs":{}},{"type":"text","data":"\n"}],"name":"blockquote","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#观察-ast-结构","className":"markdownIt-Anchor"}},{"type":"text","data":" 观察 AST 结构"}],"name":"h1","attribs":{"id":"观察-ast-结构"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"直接用上一篇写的代码来解析刚刚的代码，看看生成的 AST 是如何的。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[],"name":"img","attribs":{"src":"/images/parse-ast-structure-3.png","alt":"AST 结构","title":"AST 结构"}}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"格式化之后像下面这样"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"var"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" ast "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"\"o\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"\"o\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"\"let\""}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"\"a\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"\"[\""}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"\"b\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"\"add4\""}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"\"c\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"\"o\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"\"lambda\""}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"\"a\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                "},{"type":"tag","children":[{"type":"text","data":"\"o\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"\"x\""}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                "},{"type":"tag","children":[{"type":"text","data":"\"a\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"\"y\""}],"name":"span","attribs":{"className":"token string"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"\"b\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                "},{"type":"tag","children":[{"type":"text","data":"\"o\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"\"+\""}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                "},{"type":"tag","children":[{"type":"text","data":"\"a\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"\"x\""}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"14"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                "},{"type":"tag","children":[{"type":"text","data":"\"b\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"\"y\""}],"name":"span","attribs":{"className":"token string"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"15"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"16"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"17"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"\"d\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"\"]\""}],"name":"span","attribs":{"className":"token string"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"18"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"19"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"\"a\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"20"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"\"o\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"\"add4\""}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"21"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"\"a\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"2"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"22"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"\"b\""}],"name":"span","attribs":{"className":"token string-property property"}},{"type":"tag","children":[{"type":"text","data":":"}],"name":"span","attribs":{"className":"token operator"}},{"type":"tag","children":[{"type":"text","data":"3"}],"name":"span","attribs":{"className":"token number"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"23"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"24"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"ast.a 如预期所想，o是函数，a b都是参数，这点没问题。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"关键在于 ast.o ："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"把 ast.o 下的元素排列起来就是： let [ add4 Lambda表达式 ]"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"上一节写的对 "},{"type":"tag","children":[{"type":"text","data":"let关键字"}],"name":"code","attribs":{}},{"type":"text","data":" 的读取在这里依然可以用。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"因此我们能解析出 "},{"type":"tag","children":[{"type":"text","data":"add4"}],"name":"code","attribs":{}},{"type":"text","data":" 和 "},{"type":"tag","children":[{"type":"text","data":"lambda"}],"name":"code","attribs":{}},{"type":"text","data":" 表达式：(lambda (x y) (+ x y))"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"而 lambda 表达式其实也是 S-表达式，只是没那么标准。 调用第一篇用的去括号的方法，把lambda表达式的tokens取出来就可以得到形参和函数体了。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#实现","className":"markdownIt-Anchor"}},{"type":"text","data":" 实现"}],"name":"h1","attribs":{"id":"实现"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"先引入工具函数 "},{"type":"tag","children":[{"type":"text","data":"treeToArr"}],"name":"code","attribs":{}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"pop"}],"name":"code","attribs":{}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"push"}],"name":"code","attribs":{}}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"var"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"treeToArr"}],"name":"span","attribs":{"className":"token function-variable function"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"tree"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" keysTo"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"map"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"key"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" tree"},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"key"},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"filter"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"e"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" e "},{"type":"tag","children":[{"type":"text","data":"!=="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"undefined"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"var"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"pop"}],"name":"span","attribs":{"className":"token function-variable function"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" scopes"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"pop"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"var"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"push"}],"name":"span","attribs":{"className":"token function-variable function"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"newScope"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" scopes"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"push"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"newScope"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"treeToArr 可以把树转化成数组（根据 keysTo 上的顺序）"},{"type":"tag","children":[],"name":"br","attribs":{}},{"type":"text","data":"\npop用于弹出顶部作用域, push用于创建一个作用域。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"只需要改动遍历 AST 的时候调用的 calc 就可以了。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 从语法树得到值 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"// 遍历 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"var"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"calc"}],"name":"span","attribs":{"className":"token function-variable function"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"tree"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" oType "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"typeof"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" tree"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"o"},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"if"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"oType "},{"type":"tag","children":[{"type":"text","data":"==="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'object'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"// 调用 scopeCalc 去处理作用域 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"scopeCalc"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"tree"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"o"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        \n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"// 如果存在下一个S-表达式 则继续递归树 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"if"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"tree"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"a"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" returnVal "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"calc"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"tree"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"a"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"// returnVal 表示 tree.a 已经求出值 需要弹出顶部作用域"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"pop"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"14"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" returnVal"},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"15"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"16"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"else"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"if"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"oType "},{"type":"tag","children":[{"type":"text","data":"==="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'string'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"17"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"// 创建一个作用域 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"18"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"push"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"Object"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"create"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"null"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"19"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"20"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" o "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"find"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"tree"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"o"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"21"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        \n"},{"type":"tag","children":[{"type":"text","data":"22"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"// 这里需要改动 return 前应该 pop() 弹出顶部作用域 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"23"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"var"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" vals "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" keysTo"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"slice"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"1"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"filter"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"key"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" tree"},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"key"},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"map"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"cur"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" idx"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" its"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"24"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" t "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" tree"},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"cur"},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"25"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"              "},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" is_ns "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"typeof"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" t "},{"type":"tag","children":[{"type":"text","data":"==="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'number'"}],"name":"span","attribs":{"className":"token string"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"||"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"typeof"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" t "},{"type":"tag","children":[{"type":"text","data":"==="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'string'"}],"name":"span","attribs":{"className":"token string"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"26"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"              "},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" keyInTree "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" tree"},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"its"},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"idx"},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"27"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"28"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"if"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"is_ns"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"29"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"find"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"keyInTree"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"30"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"else"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"31"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" returnVal "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"calc"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"keyInTree"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"32"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                "},{"type":"tag","children":[{"type":"text","data":"pop"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"33"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" returnVal"},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"34"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"35"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"36"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"37"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"// 这里是新增的 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"38"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"if"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"o"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"o "},{"type":"tag","children":[{"type":"text","data":"==="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'lambda'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"39"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"// lambda 的处理 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"40"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" lambda "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"treeToArr"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"o"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"41"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" list "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"treeToArr"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"lambda"},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"1"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"42"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"// 创建新作用域 newScope "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"43"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" newScope "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" list"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"reduce"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"acc"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" name"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" idx"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"44"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                acc"},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"name"},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" vals"},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"idx"},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"45"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" acc"},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"46"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" Object"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"create"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"null"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"47"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"  \n"},{"type":"tag","children":[{"type":"text","data":"48"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"// 把新作用域压入栈 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"49"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"push"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"newScope"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"50"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"51"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"// 执行函数体 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"52"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"var"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" returnVal "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"calc"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"lambda"},{"type":"tag","children":[{"type":"text","data":"["}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"2"}],"name":"span","attribs":{"className":"token number"}},{"type":"tag","children":[{"type":"text","data":"]"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"53"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"54"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"// 弹出作用域"}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"55"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"pop"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"56"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"57"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"// 调试 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"58"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'newScope:'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" newScope"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"59"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'returnVal:'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" returnVal"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"60"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" returnVal"},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"61"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"else"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"62"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"// 从这里可以看出一个一个参数的传递 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"63"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"// 换言之 Q-lang 只接受柯里化的函数 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"64"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"let"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" returnVal "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" vals"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"reduce"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"acc"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" val"}],"name":"span","attribs":{"className":"token parameter"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"=>"}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"{"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"65"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"                "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"acc"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"val"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"66"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" o"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" \n"},{"type":"tag","children":[{"type":"text","data":"67"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"68"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"pop"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"69"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"            "},{"type":"tag","children":[{"type":"text","data":"return"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" returnVal"},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"70"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"71"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    "},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"72"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"}"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"做测试："}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"00"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"var"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" a "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"Q"}],"name":"span","attribs":{"className":"token constant"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"`"}],"name":"span","attribs":{"className":"token template-punctuation string"}},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"01"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"(\n"},{"type":"tag","children":[{"type":"text","data":"02"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    (let [\n"},{"type":"tag","children":[{"type":"text","data":"03"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        add4 (lambda (x y) (+ x y))\n"},{"type":"tag","children":[{"type":"text","data":"04"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    ])\n"},{"type":"tag","children":[{"type":"text","data":"05"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    (add4 2 3)\n"},{"type":"tag","children":[{"type":"text","data":"06"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":")\n"},{"type":"tag","children":[{"type":"text","data":"07"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":"`"}],"name":"span","attribs":{"className":"token template-punctuation string"}}],"name":"span","attribs":{"className":"token template-string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"// 期望 a 等于 5 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"08"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"09"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"tag","children":[{"type":"text","data":"var"}],"name":"span","attribs":{"className":"token keyword"}},{"type":"text","data":" b "},{"type":"tag","children":[{"type":"text","data":"="}],"name":"span","attribs":{"className":"token operator"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"Q"}],"name":"span","attribs":{"className":"token constant"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"`"}],"name":"span","attribs":{"className":"token template-punctuation string"}},{"type":"tag","children":[{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"10"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"(\n"},{"type":"tag","children":[{"type":"text","data":"11"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    (let [\n"},{"type":"tag","children":[{"type":"text","data":"12"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"        mul (lambda (x y) (* x y))\n"},{"type":"tag","children":[{"type":"text","data":"13"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    ])\n"},{"type":"tag","children":[{"type":"text","data":"14"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"    (mul 1 (mul 2 (mul 3 (mul 4 5))))\n"},{"type":"tag","children":[{"type":"text","data":"15"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":")\n"},{"type":"tag","children":[{"type":"text","data":"16"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":"`"}],"name":"span","attribs":{"className":"token template-punctuation string"}}],"name":"span","attribs":{"className":"token template-string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"// 期望 b 等于 120 "}],"name":"span","attribs":{"className":"token comment"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"17"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"18"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'>>>> Q-lang:'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"19"}],"name":"span","attribs":{"style":{"userSelect":"none"},"className":"line-numbers-rows"}},{"type":"text","data":"console"},{"type":"tag","children":[{"type":"text","data":"."}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"log"}],"name":"span","attribs":{"className":"token function"}},{"type":"tag","children":[{"type":"text","data":"("}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":"'>>>> a:'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" a"},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" "},{"type":"tag","children":[{"type":"text","data":"'b:'"}],"name":"span","attribs":{"className":"token string"}},{"type":"tag","children":[{"type":"text","data":","}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"text","data":" b"},{"type":"tag","children":[{"type":"text","data":")"}],"name":"span","attribs":{"className":"token punctuation"}},{"type":"tag","children":[{"type":"text","data":";"}],"name":"span","attribs":{"className":"token punctuation"}}],"name":"pre","attribs":{"className":"prismjs js rally-runner  "}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[],"name":"img","attribs":{"src":"/images/function-test-result-a-b.png","alt":"测试结果","title":"测试结果"}}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"tag","children":[{"type":"text","data":"#"}],"name":"a","attribs":{"href":"#不和谐","className":"markdownIt-Anchor"}},{"type":"text","data":" 不和谐"}],"name":"h1","attribs":{"id":"不和谐"}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"或许你注意到了，lambda表达式声明的函数不是柯里化的，它跟定义在全局的那些函数不一样，换句话说，不是一视同仁，这个问题将会在后几篇里面解决。"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"tag","children":[{"type":"text","data":"( 本次写的代码都已注入本页面 打开浏览器 F12 即可使用 Q )"}],"name":"p","attribs":{}},{"type":"text","data":"\n"},{"type":"script","children":[{"type":"text","data":"\n// Qscope.js\n\nvar scopes = [\n    {\n        '+': ap => bp => ap + bp, \n        '-': as => bs => as - bs,\n        '*': am => bm => am * bm,\n        '/': ad => bd => ad / bd,\n        '>': a => b => a > b, \n        '>=': a => b => a >= b, \n        '<=': a => b => a <= b, \n        '<': a => b => a < b, \n        '==': a => b => a === b, \n        'doubleSum': a => b => a * 2 + b * 2,\n        '++': d => d + 1,\n        '--': d => d - 1, \n        'if': condition => trueTodo => falseTodo => condition ? trueTodo : falseTodo\n    }\n]; \n\nvar find = key => {\n    let val; \n\n    if (typeof key === 'number') return key; \n\n    for (let i = scopes.length - 1; i >= 0; i--){\n        let scope = scopes[i]; \n\n        if (typeof scope[key] !== 'undefined'){\n            val = scope[key]; \n            break; \n        }\n    }\n\n    if (typeof val !== 'undefined') return val \n    else throw new Error(`${key} is not defined` ); \n}\n\nvar add = (key, val) => {\n    let top = scopes.pop(); \n    top[key] = val; \n    scopes.push(top); \n}\n\nvar push = newScope => scopes.push(newScope); \n\nvar pop = () => scopes.pop(); \n\nvar keysTo = [\n    'o', 'a', 'b', 'c', 'd', 'e', 'f', 'g'\n]\n\nvar parseToArr = str => str.split('\\t').join(' ').split('').reduce((acc, cur) => {\n    if (cur === '(' || cur === '['){\n        acc.push(' '); \n        acc.push(cur); \n        acc.push(' '); \n        return acc;\n    } else if (cur === ')' || cur === ']') {\n        acc.push(' '); \n        acc.push(cur); \n        acc.push(' '); \n    } else {\n        acc.push(cur); \n    }\n\n    return acc; \n}, []).join('').split(' ').map(ch => {\n    if (!Number.isNaN(parseInt(ch))){\n        return parseInt(ch); \n    } else {\n        return ch; \n    }\n}).filter(e => e !== '' && e!== '\\n'); \n\n// 语法分析 求 AST\n// (* (+ 1 1) (+ 2 2))\nvar _parse = arr => {\n    var deep = 0; \n    var temp = []; \n    var tokens = []; \n\n    if (arr.length === 1) return arr[0]; \n\n    arr.forEach((ch, idx, its) => {\n        if (ch === '(') {\n            deep ++ ; \n\n            if (deep === 2){\n                temp.push(idx); \n            }\n        } else if (ch === ')') {\n            deep -- ; \n\n            if (deep === 1){\n                let pre = temp.pop(); \n                tokens.push({\n                    from: pre, \n                    to: idx\n                }); \n            }\n        } else {\n            // 除了括号 其他都是 标识符 或者 立即数 \n            if (deep === 1){\n                tokens.push({\n                    from: idx, \n                    to: idx\n                }); \n            }\n        }\n    }); \n\n    return tokens.reduce((acc, cur, idx) => {\n        let block = arr.slice(cur.from, cur.to + 1);\n\n        acc[keysTo[idx]] = _parse(block); \n\n        return acc; \n    }, Object.create(null)); \n}\n\n\nvar treeToArr = tree => keysTo.map(key => {\n    return tree[key]\n}).filter(e => e !== undefined);\n\n// 从语法树得到值 \n// 遍历 \nvar calc = tree => {\n    let oType = typeof tree.o;\n\n    if (oType === 'object'){ // 说明该节点不是表达式 而是声明 \n        // 这里修改作用域 \n        // tree.o 原本应该是函数名 应该 typeof 出来是 string \n        // 这里是 object 说明应该是 let 关键字 \n        // 调用 scopeCalc 去处理作用域 \n        scopeCalc(tree.o); \n        \n        // 如果存在下一个S-表达式 则继续递归树 \n        if (tree.a) {\n            let returnVal = calc(tree.a);\n            pop(); \n            return returnVal; \n        }\n    } else if (oType === 'string') {\n        push(Object.create(null));\n        // 以下的代码可能有些晦涩 \n        // 主要是实现多参函数而写的 \n        // 简单的四则运算都是两个参数 都是函数 被定义在全局上 \n        // 但是实际情况中 o 的参数列表可能不只两个 \n        // 因此要把 tokens 第二个元素之后的所有值求出来 再应用到 o 上 \n\n        let o = find(tree.o); \n    \n        // 这段执行完后得到结果是 vals \n        // vals 的结构类似这样： [函数, 值, 值, 值 .... ] 长度取决于 keysTo.length \n        // 注意有 .slice(1) \n        var vals = keysTo.slice(1).filter(key => tree[key]).map((cur, idx, its) => {\n            // 取出键名 比如 tree.a tree.b 等等 \n            let t = tree[cur]\n                // is_ns: t 是数字或者变量吗？ \n              , is_ns = typeof t === 'number' || typeof t === 'string'\n                // its 是这样的： ['a', 'b', 'c', 'd' .... ] \n                // 这里从tree取出 tree.a tree.b 这些 \n              , keyInTree = tree[its[idx]]\n\n            if (is_ns){\n                return find(keyInTree)\n            } else {\n                let returnVal = calc(keyInTree); \n                pop(); \n                return returnVal; \n            }\n        }); \n\n\n\n        if (o.o === 'lambda'){\n            // lambda 的处理 \n            let lambda = treeToArr(o);\n            let list = treeToArr(lambda[1]); \n\n            // 创建一个作用域 \n            let newScope = list.reduce((acc, name, idx) => {\n                acc[name] = vals[idx]; \n                return acc; \n            }, Object.create(null)); \n\n            \n            // 把新作用域压入栈 \n            push(newScope); \n\n            var returnVal = calc(lambda[2]);\n\n            pop(); \n\n            console.log('newScope:', newScope)\n            console.log('returnVal:', returnVal);\n\n            return returnVal;\n        } else {\n            // 从这里可以看出一个一个参数的传递 \n            // 换言之 Q-lang 只接受柯里化的函数 \n            let returnVal = vals.reduce((acc, val) => {\n                return acc(val); \n            }, o); \n\n            pop();\n            return returnVal;\n        }\n    }\n}\n\nvar scopeCalc = todo => {\n    var p = keysTo.slice(1).reduce((acc, cur) => {\n        if (todo[cur]) acc.push(todo[cur]); \n        \n        return acc; \n    }, []).filter(e => e !== '[' && e !== ']'); \n\n    if (todo.o === 'let') {\n        p.forEach((item, idx, its) => {\n            if (idx % 2 === 0){ // 偶数\n                let key = item\n                  , val = its[idx + 1]; \n                \n                add(key, val); \n            }\n        })\n    }\n} \n\n// var lambdaCreate = tree => {\n//  var lambda = treeToArr(tree); \n\n//  var list = lambda[0]; \n//  var exp = lambda[1]; \n    \n// }\n\n\n\n\n// Q \nvar parse = str => _parse(parseToArr(str)); \nvar Q = str => calc(parse(str)); \n\n\n"}],"name":"script","attribs":{}}],"rawContent":""}}}},"BlogApiState":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"HomeApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"TimeLineApiState":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"SettingApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}},"LaunchpadApi":{"loaded":false,"loading":false,"error":null,"dataMap":{}}}</script>
<!--SCRIPT-->
</body>
</html>
